


<!DOCTYPE html>

<html lang="de">
<head>
  <!-- Build-Version: 1.0.1 - Cache-Bypass -->
  <link href="icon-192.png" rel="apple-touch-icon"/>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>TE 15 Reparaturauftrag 03</title>
<style>
  body {
      font-family: Arial, sans-serif;
      margin: 20px;
  }
  .header, .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .header div, .footer div {
      margin: 5px;
  }
  .section {
      margin-bottom: 20px;
  }
  .section label {
      display: block;
      margin-bottom: 5px;
  }
  .section input, .section select, .section textarea {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
  }
  .signature {
      border: 1px solid #000;
      height: 100px;
      margin-bottom: 20px;
  }

  /* Style f√ºr die Buttons */
  button#saveDraftJsonButton,
  button#loadDraftJsonButton,
  button#closeOrderButton {
      margin: 5px;
      padding: 8px 15px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #0078d4;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s;
  }
  button#saveDraftJsonButton:hover,
  button#loadDraftJsonButton:hover,
  button#closeOrderButton:hover {
      background-color: #005ea0;
  }

  /* ‚úÖ Hier einf√ºgen: Container f√ºr PDF */

</style>
<style>
  /* Druckfarben & Seitenumbr√ºche */
  @media print {
    body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .page-break { page-break-before: always; }
    .no-print { display: none !important; }
  }

  /* Sauberes A4-Layout */
  #pdfExportContainer{
    width:210mm; max-width:210mm;
    padding:10mm 10mm 12mm;
    margin:0 auto;
    background:#fff; color:#000; box-sizing:border-box;
  }

  /* 2-Spalten-Layout f√ºr ‚ÄûLabel : Wert‚Äú */
  .print-field{
    display:grid; grid-template-columns:38% 62%;
    column-gap:12px; align-items:start; padding:6px 0;
    border-bottom:1px solid #e9e9e9;
  }
  .print-label{
    font-weight:700;
    white-space:nowrap;
    min-width:0;
  }
  .print-value{
    white-space:pre-wrap;
    word-break:break-word;
    overflow-wrap:anywhere;
    line-height:1.35;
    min-width:0;
  }

  /* Silbentrennung au√üerhalb des Iframes */
  html[lang="de"] .print-value { hyphens:auto; }

  .print-field > * { min-width:0; }

  .avoid-break{ break-inside:avoid; page-break-inside:avoid; }
  @media (max-width: 820px) { #pdfExportContainer { width:100%; max-width:100%; } }
  canvas { display:block !important; }
  img { max-width:100% !important; height:auto !important; }
</style>



 <style>
  #updateModal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #updateModalContent {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
  }
  #confirmationMessage {
    display: none;
    margin-top: 20px;
    padding: 10px;
    background-color: #e0ffe0;
    border: 1px solid #00aa00;
    border-radius: 5px;
  }
</style>


<style>
/* Snapshot: zweispaltig halten */
/* Snapshot: zweispaltig (Flex statt Grid -> kein √úberlapp-Bug in html2canvas) */
.pdf-snapshot .print-field{
  display: flex !important;
  flex-wrap: nowrap !important;
  align-items: flex-start !important;
  padding: 8px 0 !important;
  border-bottom: 1px solid #e9e9e9 !important;
  gap: 12px !important;               /* moderne Browser; falls kein gap, regelt padding rechts am Label */
}

.pdf-snapshot .print-label{
  white-space: normal !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  min-width: 0 !important;

  flex: 0 0 38% !important;           /* feste Spaltenbreite links */
  max-width: 38% !important;
  padding-right: 12px !important;     /* fallback, wenn gap fehlt */
}

.pdf-snapshot .print-value{
  white-space: pre-wrap !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  hyphens: auto !important;
  line-height: 1.4 !important;
  margin-bottom: 6px !important;
  min-width: 0 !important;

  flex: 1 1 62% !important;           /* rechte Spalte f√ºllt */
  max-width: 62% !important;
}



/* Label darf umbrechen */
.pdf-snapshot .print-label{
  white-space: normal !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  min-width: 0 !important;
}

/* Wert: vollst√§ndiger Umbruch + Silbentrennung */
.pdf-snapshot .print-value{
  white-space: pre-wrap !important;     /* Zeilenumbr√ºche erhalten + umbrechen */
  overflow-wrap: anywhere !important;   /* lange ‚ÄûW√∂rter‚Äú umbrechen */
  word-break: break-word !important;
  hyphens: auto !important;             /* Silbentrennung (de) */
  line-height: 1.4 !important;          /* etwas mehr Luft */
  margin-bottom: 6px !important;
  min-width: 0 !important;
}
</style>


<style>
  .field-error { border: 2px solid #d9534f !important; background:#fff6f6; }
  .error-text  { color:#d9534f; font-size:12px; margin:-6px 0 10px 0; }
</style>

<!-- üîé Analytics-Styles (NEU) -->
<style>
  .analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .bar-row{display:grid;grid-template-columns:1fr auto 40px;gap:8px;align-items:center;padding:4px 0;cursor:pointer}
  .bar{height:10px;background:#eee;border-radius:6px;overflow:hidden}
  .bar-fill{height:100%;background:#0f6cbd}
  .bar-label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bar-count{font-variant-numeric:tabular-nums;text-align:right}
  @media (max-width:720px){.analytics-grid{grid-template-columns:1fr}}
</style>

<!-- html2pdf einmalig laden (ohne defer!) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Fallback, falls das CDN mal nicht l√§dt -->
<script>
async function loadHtml2PdfIfNeeded(){
  if (window.html2pdf) return;
  await new Promise(r => setTimeout(r, 0));
  if (window.html2pdf) return;

  await new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
    s.onload = resolve;
    s.onerror = () => reject(new Error('html2pdf konnte nicht geladen werden'));
    document.head.appendChild(s);
  });
}
</script>

  


</head>

<body>
  <!-- Offscreen-Renderframe nur f√ºr den PDF-Export -->
  <iframe id="pdfSandbox"
          style="position:fixed;left:-99999px;top:-99999px;width:820px;height:1200px;visibility:hidden;border:0;"></iframe>

  <div id="updateModal">
<div id="updateModalContent">
<p><strong>Die App wurde aktualisiert.</strong><br/>Bitte best√§tigen Sie die neue Version.</p>
<button onclick="confirmUpdate()">OK</button>
</div>
</div>
<div id="confirmationMessage" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 25px 30px; background-color: #d4edda; color: #155724; border: 3px solid #28a745; border-radius: 12px; font-size: 22px; text-align: center; font-weight: bold; z-index: 9999; box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);"></div>

<div id="abschlussScreen" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;align-items:center;justify-content:center;flex-direction:column;font-size:20px;font-family:sans-serif;z-index:999;">
  <p>‚úÖ Auftrag wurde abgeschlossen.</p>
  <button onclick="window.location.href = 'index.html';" style="margin-top:20px;padding:10px 20px;font-size:16px;background:#007BFF;color:white;border:none;border-radius:6px;">
    Neuen Auftrag starten
  </button>
</div>

<!-- üîê Login/Logout Bereich -->
<div style="margin-bottom: 20px;">
  <button onclick="signInAndAcquireToken(true)" class="no-print"
          style="padding:8px 15px; background:#0078d4; color:white; border:none; border-radius:5px; cursor:pointer;">
    Microsoft anmelden
  </button>
  <button onclick="signOut()" class="no-print"
          style="padding:8px 15px; margin-left:10px; background:#d9534f; color:white; border:none; border-radius:5px; cursor:pointer;">
    Abmelden / Konto wechseln
  </button>
  <!-- Wartung: Toggle-Button im Kopf -->
  <button id="wartungToggleHead" class="no-print"
          style="padding:8px 12px; margin-left:10px; background:#198754; color:white; border:none; border-radius:6px; cursor:pointer;">
    üõ†Ô∏è Wartung
  </button>
</div>

<!-- üîî Globale Wartungswarnung (nur App, nicht im PDF) -->
<div id="wpGlobalAlert" class="no-print"
     style="display:none; margin:-8px 0 20px 0; padding:10px 12px;
            border:1px solid #dc3545; background:#f8d7da; color:#842029;
            border-radius:6px; font-size:14px;">
  <!-- Inhalt wird per JS gesetzt -->
</div>

<div id="loginHint" class="no-print" 
     style="margin-bottom: 20px; padding: 10px; background: #fffbe6; border: 1px solid #e6c200; 
            border-radius: 6px; color: #7a6600; font-size: 14px;">
  ‚ö†Ô∏è Bitte zuerst mit Microsoft anmelden ‚Äì sonst k√∂nnen keine Daten in OneDrive gespeichert oder geladen werden.
</div>

  <!-- üî¥ Globale Wartungswarnung (sichtbar auch bei zuem Panel) -->
<div id="wpGlobalOverdueBanner" class="no-print"
     style="display:none;margin:10px 0;padding:10px 12px;border-left:6px solid #dc3545;
            background:#f8d7da;color:#842029;border-radius:6px;align-items:center;
            gap:10px;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:10px;">
    <span style="font-size:20px;line-height:1;">‚ö†Ô∏è</span>
    <span data-msg>Es gibt √ºberf√§llige Wartungen.</span>
  </div>
  <button id="wpOpenFromBanner"
          style="border:0;border-radius:6px;background:#dc3545;color:#fff;
                 padding:6px 10px;cursor:pointer;">
    Wartung √∂ffnen
  </button>
</div>


<!-- === üìä Dashboard (auf/zu klappbar) === -->
<div id="ordersDashboard" class="no-print" style="margin:16px 0;">
  <button type="button" id="toggleDashBtn"
          style="padding:8px 12px;border:0;border-radius:6px;background:#0f6cbd;color:#fff;cursor:pointer;">
    üìä Dashboard anzeigen
  </button>

  <!-- z-index-Kapselung f√ºrs Sticky-Header -->
  <div id="dashPanel" style="display:none;margin-top:10px;border:1px solid #ddd;border-radius:8px;padding:12px;position:relative;">
    <div style="display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;align-items:end;">
      <div>
        <label for="f_bearbeitet_am">Bearbeitet am</label>
        <input type="date" id="f_bearbeitet_am" style="width:100%;padding:6px;">
      </div>
      <div>
        <label for="f_techniker">Techniker</label>
        <input type="text" id="f_techniker" placeholder="z. B. Merker" style="width:100%;padding:6px;">
      </div>
      <div>
        <label for="f_maschine">Maschine</label>
        <input type="text" id="f_maschine" placeholder="z. B. Multivac" style="width:100%;padding:6px;">
      </div>
      <div>
        <label for="f_anlagenteil">Anlagenteil</label>
        <input type="text" id="f_anlagenteil" placeholder="z. B. Sensor" style="width:100%;padding:6px;">
      </div>
    </div>

    <div style="margin:10px 0;">
      <button type="button" id="dashReload"
              style="padding:6px 10px;border:0;border-radius:6px;background:#e5e5e5;cursor:pointer;">
        üîÑ Neu laden
      </button>
      <button type="button" id="dashClear"
              style="padding:6px 10px;border:0;border-radius:6px;background:#f3f3f3;cursor:pointer;margin-left:6px;">
        ‚ùå Filter l√∂schen
      </button>
      <button type="button" id="dashRangeBtn" data-mode="30"
              style="padding:6px 10px;border:0;border-radius:6px;background:#d9edf7;margin-left:6px;cursor:pointer;">
       üóìÔ∏è Letzte 30 Tage
      </button>
    </div>

    <div style="overflow:auto;max-height:50vh;border:1px solid #eee;border-radius:6px;">
      <table id="dashTable" style="width:100%;border-collapse:collapse;font-size:14px;">
        <!-- Sticky-Header bleibt innerhalb des Panels -->
        <thead style="position:sticky;top:0;background:#fafafa;z-index:1;">
          <tr>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Bearbeitet am</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Techniker</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Maschine</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Anlagenteil</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Auftrags-ID</th>
          </tr>
        </thead>
        <tbody id="dashboardBody"></tbody>
      </table>
    </div>

    <div id="dashEmpty" style="display:none;padding:8px;color:#666;">Keine Auftr√§ge gefunden.</div>

    <!-- üîé Analytics-Bl√∂cke -->
    <div id="dashAnalytics" style="display:none; margin-top:12px; padding-top:10px; border-top:1px solid #eee;">
      <div style="font-weight:600; margin-bottom:6px;">üîé H√§ufigste Eintr√§ge (aktuelle Filter)</div>
      <div class="analytics-grid">
        <div>
          <div style="font-weight:600; margin-bottom:6px;">Maschinen ‚Äì Top 5</div>
          <div id="topMachines"></div>
        </div>
        <div>
          <div style="font-weight:600; margin-bottom:6px;">Anlagenteile ‚Äì Top 5</div>
          <div id="topParts"></div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ‚¨áÔ∏è WICHTIG: Ab hier ist alles im PDF-Container -->
<div id="pdfExportContainer">

 <!-- ===== Stammdaten Kopfbereich (untereinander + Techniker-Dropdowns) ===== -->
<div class="section" style="margin-bottom:16px;">
  <div style="display:grid;grid-template-columns:1fr;gap:12px;">

    <!-- Auftrags-ID -->
    <div>
      <label for="auftrag_id" style="font-weight:bold;">Auftrags-ID</label>
      <input id="auftrag_id" name="auftrag_id" type="text" readonly
             title="Wird automatisch vergeben"
             style="padding:6px;width:100%;background:#f7f7f7;">
    </div>

    <!-- Bearbeitet am -->
    <div>
      <label for="bearbeitet_am" style="font-weight:bold;">Bearbeitet am</label>
      <input id="bearbeitet_am" name="bearbeitet_am" type="date" style="padding:6px;width:100%;">
    </div>

    <!-- Techniker 1 -->
    <div>
      <label for="techniker1" style="font-weight:bold;">Techniker 1</label>
      <select id="techniker1" name="techniker1" style="padding:6px;width:100%;">
        <option value="">Bitte ausw√§hlen</option>
        <option value="Sonstige">Sonstige</option>
      </select>
      <input id="sonstiger_techniker1" type="text" placeholder="Bitte angeben‚Ä¶"
             style="display:none;margin-top:6px;padding:6px;width:100%;">
    </div>

    <!-- Techniker 2 -->
    <div>
      <label for="techniker2" style="font-weight:bold;">Techniker 2 (optional)</label>
      <select id="techniker2" name="techniker2" style="padding:6px;width:100%;">
        <option value="">Bitte ausw√§hlen</option>
        <option value="Sonstige">Sonstige</option>
      </select>
      <input id="sonstiger_techniker2" type="text" placeholder="Bitte angeben‚Ä¶"
             style="display:none;margin-top:6px;padding:6px;width:100%;">
    </div>

  </div>
</div>

<script>
/* üëá Basisliste deiner Techniker ‚Äì einfach erweiterbar */
const TECHNIKER_BASE = [
  "Constantin M√ºller-Seeling",
  "Pascal Merker",
  "Tim Eggers",
  "Udo Mahlmann",
  "Mike Hafermalz",
  "J√∂rg Kowald",
  "Stefan Wulf"
];


/* Dropdown + Sonstige-Funktion aufbauen */
function setupTechnikerSelect(selId, otherId){
  const sel   = document.getElementById(selId);
  const other = document.getElementById(otherId);
  if (!sel) return;

  // Technikerliste bef√ºllen
  TECHNIKER_BASE.forEach(n => {
    const exists = [...sel.options].some(o => (o.value||o.textContent).toLowerCase() === n.toLowerCase());
    if (!exists){
      if (typeof addOptionUnique === "function") addOptionUnique(sel, n);
      else sel.add(new Option(n, n));
    }
  });

  const toggleOther = () => {
    if (other) other.style.display = (sel.value === "Sonstige") ? "block" : "none";
  };

  sel.addEventListener("change", () => {
    if (sel.value !== "Sonstige" && other && other.value.trim()){
      const v = other.value.trim();
      if (typeof addOptionUnique === "function") addOptionUnique(sel, v, { autoselect:true });
      else { sel.add(new Option(v, v)); sel.value = v; }
      other.value = "";
    }
    toggleOther();
  });

  other?.addEventListener("blur", () => {
    const v = (other.value || "").trim();
    if (!v) return;
    if (typeof addOptionUnique === "function") addOptionUnique(sel, v, { autoselect:true });
    else { sel.add(new Option(v, v)); sel.value = v; }
    other.value = "";
    toggleOther();
  });

  toggleOther();
}

window.addEventListener("load", () => {
  setupTechnikerSelect("techniker1", "sonstiger_techniker1");
  setupTechnikerSelect("techniker2", "sonstiger_techniker2");
});

</script>



  <!-- ‚¨ÜÔ∏è Rest deines Formulars folgt hier (Maschine, Anlagenteil, ‚Ä¶) und bleibt unver√§ndert -->


<!-- ‚úÖ Maschinenausfall -->
<div class="section" style="margin-bottom:12px;">
  <label for="maschinenstillstand" style="display:block;font-weight:bold;margin-top:12px;">Maschinenausfall</label>
  <select id="maschinenstillstand" name="maschinenstillstand" style="width:100%;padding:6px;margin-bottom:10px;">
    <option value="" selected>Bitte ausw√§hlen</option>
    <option value="Ja">Ja</option>
    <option value="Nein">Nein</option>
  </select>

  <div id="ausfallzeit_wrap" style="margin-bottom:10px; display:none;">
    <label for="ausfall_stunden">Ausfallzeit:</label>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <div>
        <input id="ausfall_stunden" name="ausfall_stunden"
               type="number" inputmode="numeric" step="1" min="0" max="999"
               placeholder="Stunden" style="width:110px;padding:6px;" disabled>
        <span>Stunden</span>
      </div>
      <div>
        <input id="ausfall_minuten" name="ausfall_minuten"
               type="number" inputmode="numeric" step="1" min="0" max="59"
               placeholder="Minuten" style="width:110px;padding:6px;" disabled>
        <span>Minuten</span>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Maschine -->
<div class="section" style="margin-bottom:12px;">
  <label for="maschine" style="display:block;font-weight:bold;">Maschine</label>
  <select id="maschine" name="maschine" style="width:100%;padding:6px;" autocomplete="off">
    <option value="">Bitte ausw√§hlen</option>
    <option value="Sonstige">Sonstige</option>
    <option value="CIP-Raum">CIP-Raum</option>
    <option value="Crepacco links">Crepacco links</option>
    <option value="Crepacco rechts">Crepacco rechts</option>
    <option value="Dora 680">Dora 680</option>
    <option value="Dora 780">Dora 780</option>
    <option value="Gem√ºseschleuder">Gem√ºseschleuder</option>
    <option value="Hebekipper">Hebekipper</option>
    <option value="Hei√ükutter links (735187)">Hei√ükutter links (735187)</option>
    <option value="Hei√ükutter links 735187">Hei√ükutter links 735187</option>
    <option value="Hei√ükutter rechts (733131)">Hei√ükutter rechts (733131)</option>
    <option value="Herstellung R√ºhrer 1">Herstellung R√ºhrer 1</option>
    <option value="Herstellung R√ºhrer 2">Herstellung R√ºhrer 2</option>
    <option value="Herstellung R√ºhrer 3">Herstellung R√ºhrer 3</option>
    <option value="Herstellung R√ºhrer 4">Herstellung R√ºhrer 4</option>
    <option value="Herstellung R√ºhrer 5">Herstellung R√ºhrer 5</option>
    <option value="Herstellung R√ºhrer 6">Herstellung R√ºhrer 6</option>
    <option value="Herstellung R√ºhrer 7">Herstellung R√ºhrer 7</option>
    <option value="Kaltkutter">Kaltkutter</option>
    <option value="Kilomaschine">Kilomaschine</option>
    <option value="Kistenwaschmaschine">Kistenwaschmaschine</option>
    <option value="Klarsicht">Klarsicht</option>
    <option value="Knoblauchbrecher/-sch√§ler">Knoblauchbrecher/-sch√§ler</option>
    <option value="K√§seschneider">K√§seschneider</option>
    <option value="K√ºbelwaschmaschine">K√ºbelwaschmaschine</option>
    <option value="Minirolle 1">Minirolle 1</option>
    <option value="Minirolle 2">Minirolle 2</option>
    <option value="Minirolle 3">Minirolle 3</option>
    <option value="Minirolle 4">Minirolle 4</option>
    <option value="Minirolle 5">Minirolle 5</option>
    <option value="Minirolle 6">Minirolle 6</option>
    <option value="Mondini 2">Mondini 2</option>
    <option value="Multivac 1">Multivac 1</option>
    <option value="Multivac 2">Multivac 2</option>
    <option value="Multivac 3">Multivac 3</option>
    <option value="MVA">MVA</option>
    <option value="Palettenwaschmaschine">Palettenwaschmaschine</option>
    <option value="Paprikaschneider">Paprikaschneider</option>
    <option value="Paprikateiler">Paprikateiler</option>
    <option value="Petrella SB">Petrella SB</option>
    <option value="Rundl√§ufer 1">Rundl√§ufer 1</option>
    <option value="Rundl√§ufer 2">Rundl√§ufer 2</option>
    <option value="R√ºhle Maschine 1+2">R√ºhle Maschine 1+2</option>
    <option value="R√ºhrer 1">R√ºhrer 1</option>
    <option value="R√ºhrer 2">R√ºhrer 2</option>
    <option value="R√ºhrer 3">R√ºhrer 3</option>
    <option value="R√ºhrer 4">R√ºhrer 4</option>
    <option value="R√ºhrer 5">R√ºhrer 5</option>
    <option value="R√ºhrer 6">R√ºhrer 6</option>
    <option value="R√ºhrer 7">R√ºhrer 7</option>
    <option value="Schnittlauch-Porree-Schneider Krone">Schnittlauch-Porree-Schneider Krone</option>
    <option value="Separator 780">Separator 780</option>
    <option value="Vorsp√ºlmaschine K√ºbel">Vorsp√ºlmaschine K√ºbel</option>
  </select>

  <label for="sonstige_maschine" id="label-sonstige-maschine" style="display:none;margin-top:8px;">
    Sonstiges (Maschine):
  </label>
  <input id="sonstige_maschine" name="sonstige_maschine" type="text"
         placeholder="Bitte angeben..."
         style="display:none;margin-top:5px;width:100%;padding:6px;">
</div>

<!-- ‚úÖ Anlagenteil -->
<div class="section" style="margin-bottom:12px;">
  <label for="anlagenteil" style="display:block;font-weight:bold;">Anlagenteil</label>
  <select id="anlagenteil" name="anlagenteil" style="width:100%;padding:6px;" autocomplete="off">
    <option value="">Bitte ausw√§hlen</option>
    <option value="Sonstige">Sonstige</option>
    <option value="Magnetschalter">Magnetschalter</option>
    <option value="Abdeckhaube">Abdeckhaube</option>
    <option value="Abdeckplatte">Abdeckplatte</option>
    <option value="Antriebsband">Antriebsband</option>
    <option value="Antriebsrolle">Antriebsrolle</option>
    <option value="Band">Band</option>
    <option value="Buchse">Buchse</option>
    <option value="CEE-Steckdose">CEE-Steckdose</option>
    <option value="CPU">CPU</option>
    <option value="Can Bus Modul">Can Bus Modul</option>
    <option value="Deckelformer">Deckelformer</option>
    <option value="Dichtschnur">Dichtschnur</option>
    <option value="Dichtung">Dichtung</option>
    <option value="Dichtungen">Dichtungen</option>
    <option value="Drehschalter">Drehschalter</option>
    <option value="D√§mpfer">D√§mpfer</option>
    <option value="Ein-Taster">Ein-Taster</option>
    <option value="Elektronik">Elektronik</option>
    <option value="Ersatzwerkzeug">Ersatzwerkzeug</option>
    <option value="FU">FU</option>
    <option value="Feder">Feder</option>
    <option value="Filtereinsatz">Filtereinsatz</option>
    <option value="Harting-Stecker">Harting-Stecker</option>
    <option value="Harting-Verbindung">Harting-Verbindung</option>
    <option value="Heizung">Heizung</option>
    <option value="Hubzylinder">Hubzylinder</option>
    <option value="Ini">Ini</option>
    <option value="Kabel">Kabel</option>
    <option value="Kabel und Lichttaster">Kabel und Lichttaster</option>
    <option value="Kabelverschraubung">Kabelverschraubung</option>
    <option value="Ketten">Ketten</option>
    <option value="Kontakte">Kontakte</option>
    <option value="Kunststoffzahnr√§der">Kunststoffzahnr√§der</option>
    <option value="Lager">Lager</option>
    <option value="Lagerachsen">Lagerachsen</option>
    <option value="Lagerzapfen">Lagerzapfen</option>
    <option value="Leimd√ºse">Leimd√ºse</option>
    <option value="Lichtschranke">Lichtschranke</option>
    <option value="Lichtschranke und Kabel">Lichtschranke und Kabel</option>
    <option value="Lichtschranken">Lichtschranken</option>
    <option value="Lichttaster">Lichttaster</option>
    <option value="Lichttaster und Kabel">Lichttaster und Kabel</option>
    <option value="Luftschlauch">Luftschlauch</option>
    <option value="Magnet">Magnet</option>
    <option value="Modul 121">Modul 121</option>
    <option value="Motor">Motor</option>
    <option value="Netzteil">Netzteil</option>
    <option value="Not-Aus-Schalter">Not-Aus-Schalter</option>
    <option value="PT 100">PT 100</option>
    <option value="Panel">Panel</option>
    <option value="Platine">Platine</option>
    <option value="Poti">Poti</option>
    <option value="Profibus">Profibus</option>
    <option value="Relais">Relais</option>
    <option value="Relais mit Sockel">Relais mit Sockel</option>
    <option value="Rolle">Rolle</option>
    <option value="S7-Steuerung">S7-Steuerung</option>
    <option value="SPS">SPS</option>
    <option value="Schalter">Schalter</option>
    <option value="Schaltergeh√§use">Schaltergeh√§use</option>
    <option value="Schiebef√ºhrung">Schiebef√ºhrung</option>
    <option value="Schlauch">Schlauch</option>
    <option value="Schraube">Schraube</option>
    <option value="Schraube und Dichtung">Schraube und Dichtung</option>
    <option value="Schrauben">Schrauben</option>
    <option value="Sensor">Sensor</option>
    <option value="Sicherheitrelais">Sicherheitrelais</option>
    <option value="Sicherheits-Ausgangsmodul">Sicherheits-Ausgangsmodul</option>
    <option value="Sicherheitsbaugruppe">Sicherheitsbaugruppe</option>
    <option value="Sicherheitsrelais">Sicherheitsrelais</option>
    <option value="Sicherheitsschalter">Sicherheitsschalter</option>
    <option value="Sicherheitsventil">Sicherheitsventil</option>
    <option value="Sicherung">Sicherung</option>
    <option value="Siegelheizung">Siegelheizung</option>
    <option value="Spule">Spule</option>
    <option value="Stator">Stator</option>
    <option value="Steckdose">Steckdose</option>
    <option value="Stecker">Stecker</option>
    <option value="Stecker und Spule">Stecker und Spule</option>
    <option value="Steckereinsatz">Steckereinsatz</option>
    <option value="Steckverbindung">Steckverbindung</option>
    <option value="Stopfen">Stopfen</option>
    <option value="Taster">Taster</option>
    <option value="Tasteroberteil">Tasteroberteil</option>
    <option value="Temperaturf√ºhler">Temperaturf√ºhler</option>
    <option value="Touchpanel">Touchpanel</option>
    <option value="Trichterschalter">Trichterschalter</option>
    <option value="Umlenkrolle">Umlenkrolle</option>
    <option value="Vakuumgenerator">Vakuumgenerator</option>
    <option value="Vakuumpumpe">Vakuumpumpe</option>
    <option value="Vakuumsensor">Vakuumsensor</option>
    <option value="Ventil">Ventil</option>
    <option value="Verriegelungsb√ºgel">Verriegelungsb√ºgel</option>
    <option value="Wartungspaket">Wartungspaket</option>
    <option value="Welle">Welle</option>
    <option value="Zylinder">Zylinder</option>
    <option value="Zylinder und Heizungsregler">Zylinder und Heizungsregler</option>
    <option value="Zylinder und Vakuumventil">Zylinder und Vakuumventil</option>
    <option value="Z√§hler">Z√§hler</option>
    <option value="Dichtring">Dichtring</option>
  </select>

  <label id="label-sonstige-anlagenteil" for="sonstige_anlagenteil" style="display:none;margin-top:8px;">
    Sonstiges (Anlagenteil):
  </label>
  <input id="sonstige_anlagenteil" name="sonstige_anlagenteil" type="text"
         placeholder="Bitte angeben..."
         style="display:none;margin-top:5px;width:100%;padding:6px;">
</div>

<!-- ‚Ä¶ Ende Anlagenteil-Section ‚Ä¶ -->
</div>

<!-- ‚¨áÔ∏è HIER EINSETZEN: Wartungsplan-Panel -->
<div class="section" id="wartungsplanSection" style="margin:16px 0;">
  <div id="wpWarning" style="display:none;margin-bottom:10px;padding:10px;border:1px solid #dc3545;color:#842029;background:#f8d7da;border-radius:6px;">
    ‚ö†Ô∏è Diese Anlage hat <strong>√ºberf√§llige Wartungen</strong>. Bitte durchf√ºhren!
  </div>

  <div id="wartungsplanPanel" style="display:none;border:1px solid #ddd;border-radius:8px;padding:12px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label style="font-weight:bold;">Anlage (Maschine)</label>
        <div style="font-size:13px;color:#666;">Verkn√ºpft mit Feld ‚ÄûMaschine‚Äú</div>
      </div>
      <div>
        <label style="font-weight:bold;">Status</label><br>
        <span id="wpStatusPill" style="display:inline-block;padding:4px 8px;border-radius:999px;font-size:13px;background:#e9ecef;">‚Äì</span>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label for="wpTaskSelect" style="font-weight:bold;">Schmierstelle / Aufgabe</label>
      <select id="wpTaskSelect" style="width:100%;padding:6px;">
        <option value="">Bitte ausw√§hlen</option>
      </select>
    </div>

    <div style="display:grid;grid-template-columns:repeat(3,minmax(140px,1fr));gap:12px;margin-top:10px;">
      <div>
        <label style="font-weight:bold;">Intervall (Tage)</label>
        <input id="wpIntervalDays" type="number" min="1" step="1" placeholder="z. B. 30" style="width:100%;padding:6px;">
      </div>
      <div>
        <label style="font-weight:bold;">Zuletzt durchgef√ºhrt</label>
        <input id="wpLastDate" type="date" style="width:100%;padding:6px;">
      </div>
      <div>
        <label style="font-weight:bold;">N√§chstes F√§lligkeitsdatum</label>
        <input id="wpNextDue" type="date" readonly style="width:100%;padding:6px;background:#f7f7f7;">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" id="wpAddTask"    style="padding:8px 12px;border:0;border-radius:6px;background:#6c757d;color:#fff;cursor:pointer;">‚ûï Neue Aufgabe</button>
      <button type="button" id="wpSaveTask"   style="padding:8px 12px;border:0;border-radius:6px;background:#0d6efd;color:#fff;cursor:pointer;">üíæ Speichern</button>
      <button type="button" id="wpDeleteTask" style="padding:8px 12px;border:0;border-radius:6px;background:#dc3545;color:#fff;cursor:pointer;">üóëÔ∏è L√∂schen</button>
      <button type="button" id="wpMarkDoneToday" style="padding:8px 12px;border:0;border-radius:6px;background:#198754;color:#fff;cursor:pointer;">‚úÖ Heute durchgef√ºhrt</button>
    </div>

    <div id="wpHint" style="margin-top:8px;color:#666;font-size:13px;">
      Aufgaben sind pro Maschine hinterlegt. Beim Abschluss kannst du die passende Aufgabe mit ‚ÄûHeute durchgef√ºhrt‚Äú markieren.
    </div>
  </div>
</div>
<!-- ‚¨ÜÔ∏è Ende Wartungsplan-Panel -->







    <div style="margin-top: 20px;">
  <label style="font-weight: bold; display: block;">Dauer der Reparatur (von - bis Uhrzeit):</label>
  <input id="startzeit" name="start_time" style="margin-right: 10px;" type="time"/>
  <input id="endzeit" name="end_time" style="margin-right: 10px;" type="time"/>
  <input id="dauer" name="dauer" placeholder="Dauer in Stunden" readonly="true" type="text"/>
</div>

<div class="section">
<label for="abschlussdatum">Abschlussdatum der Ausf√ºhrung:</label>
<input id="abschlussdatum" name="abschlussdatum" type="date"/>
</div>
<div class="section">
<label for="fehlerbeschreibung">Fehlerbeschreibung:</label>
<textarea cols="50" id="fehlerbeschreibung" name="fehlerbeschreibung" placeholder="Was war defekt? Was wurde unternommen?" rows="4"></textarea>
</div>
<div class="section">
<label for="reinigung_erforderlich">Reinigung Maschine/Umfeld erforderlich:</label>
<select id="reinigung_erforderlich" name="reinigung_erforderlich">
<option value="ja">Ja</option>
<option value="nein">Nein</option>
</select>
<div style="margin-bottom: 10px;">
<label for="reinigungsart_zusatz">Reinigungsausf√ºhrung:</label>
<select id="reinigungsart_zusatz" name="reinigungsart_zusatz" style="width: 100%; padding: 6px; margin-bottom: 10px;">
<option value="">Bitte ausw√§hlen</option>
<option value="Maschinenpersonal">Maschinenpersonal</option>
<option value="Reinigungsschicht">Reinigungsschicht</option>
<option value="Sonstiges">Sonstiges</option>
</select><input id="sonstige_reinigungsart_zusatz" name="sonstige_reinigungsart_zusatz" placeholder="Bitte angeben..." style="display:none; margin-top: 5px; width: 100%;" type="text"/><input id="reinigungsart_sonstiges" name="reinigungsart_sonstiges" style="display:none; width: 100%; padding: 6px;" type="text"/><label for="reinigungsart_sonstiges" style="display:none;">Sonstiges (Reinigungsausf√ºhrung):</label>
</div>
<div style="margin-bottom: 10px;">
</div>
</div>
<div class="section">
  <p>Die Reparatur ist abgeschlossen und alle eingesetzten Werkzeuge wurden komplett entfernt.</p>
</div>

<div class="page-break"></div>

<div class="section">
  <label for="unterschrift_abnahme">Unterschrift MA Abnahme (Produktkreisfreigabe):</label>
  <canvas class="signature-pad" id="unterschrift_abnahme"></canvas>
  <button onclick="clearSignature(0)" style="margin-top: 8px; display: block;" type="button">Unterschrift l√∂schen</button>
</div>

<div class="page-break"></div>

<div class="section">
  <label for="unterschrift_technik">Unterschrift MA Technik:</label>
  <canvas class="signature-pad" id="unterschrift_technik"></canvas>
  <button type="button" style="margin-top: 8px; display: block;" 
          onclick="clearSignature(1)">Unterschrift l√∂schen</button>

  <div style="margin-top: 24px;">
    <label for="foto" style="font-weight: bold;">Fehlerstelle / Schaden (optional):</label>
    <h2>Fotos f√ºr Reparaturauftrag</h2>
    <input accept="image/*" id="fileInput" multiple type="file" />
    <div class="preview-container" id="previewContainer"></div>
  </div>
</div>


<style>
  .page-break {
    page-break-before: always;
  }
  .preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
  }
  .image-wrapper {
    position: relative;
    display: inline-block;
  }
  .delete-button {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: red;
    color: white;
    border: none;
    padding: 5px;
    cursor: pointer;
    border-radius: 5px;
  }
/* korrekt nur f√ºr Thumbnails der Vorschau */
.preview-container img {
  max-width: 200px;
  max-height: 200px;
  border: 1px solid #ccc;
}

</style>

<script>
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    let uploadedFiles = [];
    fileInput.addEventListener('change', function(event) {
        const files = Array.from(event.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('image-wrapper');
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-button');
                deleteBtn.textContent = 'L√∂schen';
                deleteBtn.addEventListener('click', () => {
                    wrapper.remove();
                    uploadedFiles = uploadedFiles.filter(f => f !== file);
                    console.log("Datei gel√∂scht:", file.name);
                });
                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                previewContainer.appendChild(wrapper);
                uploadedFiles.push(file);
            };
            reader.readAsDataURL(file);
        });
        fileInput.value = '';
    });
</script>

<div class="section">
  <label for="ort_datum">Ort / Datum:</label>
  <input id="ort_datum" name="ort_datum" type="text"/>
</div>


<div style="margin-top: 20px; font-size: 14px; line-height: 1.5; white-space: pre;">
Erstellt: M.Thiemann       Datum: 18.06.2025
Gepr√ºft: M. Hafermalz      Datum: 24.06.2025
Freigegeben: F. Pieper     Datum: 24.06.2025
</div>

</div> <!-- <= HIER und NUR HIER den #pdfExportContainer schlie√üen -->


<!-- ====================== -->
<!-- Buttons au√üerhalb Container -->
<!-- ====================== -->
<button type="button" onclick="saveDraftToOneDrive()">üíæ Entwurf in OneDrive speichern</button>
<button type="button" onclick="showDraftList()">üìÇ Entwurf aus OneDrive laden</button>
<button type="button" onclick="generatePDFAndFinish()">‚úÖ Auftrag abschlie√üen & in OneDrive speichern</button>
<button type="button" onclick="forceUpdate()">‚ôªÔ∏è App aktualisieren (Cache l√∂schen)</button>

<style>
canvas.signature-pad {
  border: 1px solid #000;
  width: 100%;
  height: 100px;
  touch-action: none;
}
</style>
<style>
canvas.signature-pad {
  border: 1px solid #000;
  background: #fff;
  touch-action: none;
  width: 100%;
  max-width: 600px;
  height: 200px;
}
.signature-container {
  margin-bottom: 20px;
}
button.clear-signature {
  margin-top: 5px;
}
</style>


<script>
function initSignaturePad(id) {
  const canvas = document.getElementById(id);
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    // HiDPI/Retina scharf rendern
    const ratio = Math.max(window.devicePixelRatio || 1, 1);

    // CSS-Gr√∂√üe aus dem Layout (Fallbacks, falls offset 0 ist)
    const style = getComputedStyle(canvas);
    const cssW = canvas.offsetWidth  || parseInt(style.width)  || 600;
    const cssH = canvas.offsetHeight || parseInt(style.height) || 200;

    // Interne Aufl√∂sung hochskalieren
    canvas.width  = Math.round(cssW * ratio);
    canvas.height = Math.round(cssH * ratio);

    // Koordinaten wieder in CSS-Pixeln
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

    // Strichstil
    ctx.lineWidth   = 2;
    ctx.lineCap     = 'round';
    ctx.lineJoin    = 'round';
    ctx.strokeStyle = '#000';
  }

  resizeCanvas();
  // ‚Ü≥ Diese Zeile ist neu: bei Fenstergr√∂√üe neu skalieren
  window.addEventListener('resize', resizeCanvas);

  let drawing = false;

  canvas.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    drawing = true;
    const r = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
  }, { passive: false });

  canvas.addEventListener("pointermove", (e) => {
    if (!drawing) return;
    const r = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
    ctx.stroke();
  });

  canvas.addEventListener("pointerup",   () => { drawing = false; });
  canvas.addEventListener("pointerleave",() => { drawing = false; });
}

// Dein Load-Listener kann unver√§ndert bleiben:
window.addEventListener("load", () => {
  initSignaturePad("unterschrift_abnahme");
  initSignaturePad("unterschrift_technik");
});
</script>



<script>
function clearSignature(index) {
    const canvases = document.querySelectorAll("canvas");
    if (canvases[index]) {
        const ctx = canvases[index].getContext("2d");
        ctx.clearRect(0, 0, canvases[index].width, canvases[index].height);
    }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // üü¢ Zeitberechnung
  const startTimeInput = document.getElementById("startzeit");
  const endTimeInput   = document.getElementById("endzeit");
  const durationInput  = document.getElementById("dauer");

  function calculateDuration() {
    const start = startTimeInput?.value;
    const end   = endTimeInput?.value;
    if (start && end) {
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let s = new Date(0,0,0,sh,sm), e = new Date(0,0,0,eh,em);
      let diff = e - s; if (diff < 0) diff += 24*60*60*1000;
      const mins = Math.floor(diff/60000), h = Math.floor(mins/60), m = mins%60;
      durationInput.value = (h?`${h} h `:"") + (m?`${m} min`:(h?"" :"0 min"));
    }
  }
  startTimeInput?.addEventListener("input", calculateDuration);
  endTimeInput?.addEventListener("input", calculateDuration);

  // üü¢ "Sonstige"-Felder & Selects
  const maschineSelect             = document.getElementById("maschine");
  const sonstigeMaschineInput      = document.getElementById("sonstige_maschine");
  const labelSonstigeMaschine      = document.getElementById("label-sonstige-maschine");

  const anlagenteilSelect          = document.getElementById("anlagenteil");
  const sonstigeAnlagenteilInput   = document.getElementById("sonstige_anlagenteil");
  const labelSonstigeAnlagenteil   = document.getElementById("label-sonstige-anlagenteil");

  const reinigungsartSelect        = document.getElementById("reinigungsart_zusatz");
  const sonstigeReinigungsartInput = document.getElementById("sonstige_reinigungsart_zusatz");

  function updateMaschineField() {
    const show = maschineSelect?.value === "Sonstige";
    if (sonstigeMaschineInput)  sonstigeMaschineInput.style.display  = show ? "block" : "none";
    if (labelSonstigeMaschine)  labelSonstigeMaschine.style.display  = show ? "block" : "none";
  }
  function updateAnlagenteilField() {
    const show = anlagenteilSelect?.value === "Sonstige";
    if (sonstigeAnlagenteilInput) sonstigeAnlagenteilInput.style.display = show ? "block" : "none";
    if (labelSonstigeAnlagenteil) labelSonstigeAnlagenteil.style.display = show ? "block" : "none";
  }
  function updateReinigungsartField() {
    const show = reinigungsartSelect?.value === "Sonstiges";
    if (sonstigeReinigungsartInput) sonstigeReinigungsartInput.style.display = show ? "block" : "none";
  }

  maschineSelect?.addEventListener("change", updateMaschineField);
  anlagenteilSelect?.addEventListener("change", updateAnlagenteilField);
  reinigungsartSelect?.addEventListener("change", updateReinigungsartField);

  // initialer Zustand
  updateMaschineField();
  updateAnlagenteilField();
  updateReinigungsartField();

  // üîí Basis-Optionen (HTML-Defaults) einmalig puffern
  const baseMaschineValues    = maschineSelect ? Array.from(maschineSelect.options).map(o => o.value) : [];
  const baseAnlagenteilValues = anlagenteilSelect ? Array.from(anlagenteilSelect.options).map(o => o.value) : [];

  function pruneToBase(selectEl, baseValues) {
    if (!selectEl) return;
    Array.from(selectEl.options).forEach(o => {
      if (!baseValues.includes(o.value)) o.remove(); // alle dynamischen raus
    });
    if (!baseValues.includes(selectEl.value)) selectEl.value = ""; // ung√ºltige Auswahl zur√ºcksetzen
  }

function rebuildDropdownsFromMaster() {
  const maschineSelect    = document.getElementById("maschine");
  const anlagenteilSelect = document.getElementById("anlagenteil");

  // aktuelle Auswahl sichern (Value + sichtbarer Text)
  const keep = (sel) => sel ? {
    value: sel.value,
    text:  sel.options[sel.selectedIndex]?.textContent?.trim() || ""
  } : null;

  const keepMaschine    = keep(maschineSelect);
  const keepAnlagenteil = keep(anlagenteilSelect);

  // Helper: Auswahl nach dem Neuaufbau wiederherstellen
  const restore = (sel, kept) => {
    if (!sel || !kept) return;
    if ([...sel.options].some(o => o.value === kept.value)) {
      sel.value = kept.value;
      return;
    }
    const byText = [...sel.options].find(o =>
      (o.textContent || o.innerText).trim() === kept.text
    );
    if (byText) sel.value = byText.value;
  };

  // Maschine
  if (maschineSelect) {
    // Basisoptionen (aus HTML) behalten, dynamische entfernen
    pruneToBase(maschineSelect, baseMaschineValues);

    // Stammdaten anh√§ngen (ohne Autoselect)
    (masterData.maschinen || []).forEach(n =>
      addOptionUnique(maschineSelect, n, { autoselect: false })
    );

    // Sortieren, "" und "Sonstige" oben lassen
    sortSelectOptions(maschineSelect, ["", "Sonstige"]);

    // Auswahl wiederherstellen
    restore(maschineSelect, keepMaschine);
  }

  // Anlagenteil
  if (anlagenteilSelect) {
    pruneToBase(anlagenteilSelect, baseAnlagenteilValues);

    (masterData.anlagenteile || []).forEach(n =>
      addOptionUnique(anlagenteilSelect, n, { autoselect: false })
    );

    sortSelectOptions(anlagenteilSelect, ["", "Sonstige"]);

    restore(anlagenteilSelect, keepAnlagenteil);
  }

  // Abh√§ngige "Sonstige"-Eingabefelder korrekt ein-/ausblenden
  updateMaschineField?.();
  updateAnlagenteilField?.();
}

// global verf√ºgbar lassen
window.rebuildDropdownsFromMaster = rebuildDropdownsFromMaster;

// Initial: Stammdaten laden und erst dann neu aufbauen
loadMasterData().then(rebuildDropdownsFromMaster);


// ‚¨áÔ∏è Einmal VOR den beiden Funktionen einf√ºgen
const norm = (s) => String(s ?? '').trim();

function tryAddCustomMaschine() {
  const val = norm(sonstigeMaschineInput?.value);
  if (!val || !maschineSelect) return;

  addOptionUnique(maschineSelect, val, { autoselect: true });

  const exists = (masterData.maschinen || [])
    .some(x => (x || "").toLowerCase() === val.toLowerCase());
  if (!exists) {
    (masterData.maschinen ||= []).push(val);
    saveMasterData();
  }
}

function tryAddCustomAnlagenteil() {
  const val = norm(sonstigeAnlagenteilInput?.value);
  if (!val || !anlagenteilSelect) return;

  addOptionUnique(anlagenteilSelect, val, { autoselect: true });

  const exists = (masterData.anlagenteile || [])
    .some(x => (x || "").toLowerCase() === val.toLowerCase());
  if (!exists) {
    (masterData.anlagenteile ||= []).push(val);
    saveMasterData();
  }
}



  // Eingabe √ºbernehmen bei Verlassen der Felder ‚Ä¶
  sonstigeMaschineInput?.addEventListener("blur", tryAddCustomMaschine);
  sonstigeAnlagenteilInput?.addEventListener("blur", tryAddCustomAnlagenteil);

  // ‚Ä¶ und wenn von ‚ÄûSonstige‚Äú weg gewechselt wird
  maschineSelect?.addEventListener("change", () => {
    if (maschineSelect.value !== "Sonstige") tryAddCustomMaschine();
  });
  anlagenteilSelect?.addEventListener("change", () => {
    if (anlagenteilSelect.value !== "Sonstige") tryAddCustomAnlagenteil();
  });
});
</script>







<script>
// UUID Generator (v4)
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Lesbare Auftrags-ID
function generateReadableID() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
    return `REP-${year}${month}${day}-${randomPart}`;
}

// Beim Laden die ID setzen
window.addEventListener('load', function() {
    const auftragsID = generateReadableID();
    document.getElementById('auftrag_id').value = auftragsID;
});

</script>







<!-- ‚úÖ MSAL Konfiguration & Login Logik -->

<!-- ‚úÖ MSAL Konfiguration & Login Logik -->
<script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
<script>
  const msalConfig = {
    auth: {
      clientId: "800b6d33-1917-4b4f-abf4-162094f8c862",
      authority: "https://login.microsoftonline.com/f54f53bb-d0ff-4b78-bcf4-4aeeeb924428",
      redirectUri: "https://thiemann423.github.io/Werkstatt-APP/"
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: true },
    system: { allowRedirectInIframe: true }
  };

  const scopes = [
  "User.Read",
  "openid",
  "profile",
  "offline_access",
  "Files.ReadWrite.All",
  "Mail.Send"          // ‚¨ÖÔ∏è neu f√ºr E-Mail-Versand
];

  const msalInstance = new msal.PublicClientApplication(msalConfig);
  let accessToken = "";

  
  function hideLoginHint(){
    const el = document.getElementById("loginHint");
    if (el) el.style.display = "none";
  }
  function showLoginHint(){
    const el = document.getElementById("loginHint");
    if (el) el.style.display = "block";
  }



  // === NEU 1: Redirect-Antwort verarbeiten ‚Äì MUSS direkt nach msalInstance stehen
 
// 1) Redirect-Antwort verarbeiten (muss direkt nach msalInstance stehen)
(async () => {
  try {
    const resp = await msalInstance.handleRedirectPromise();
    if (resp?.account) msalInstance.setActiveAccount(resp.account);
  } catch (e) {
    console.warn("handleRedirectPromise:", e);
  }
})();

// 2) Resolver + Ziel-IDs (GLOBAL!)
const SHARE_URL = "https://petrifeinkost-my.sharepoint.com/:f:/g/personal/merten_thiemann_petri-feinkost_de/EkOa1ufucPNDtlfo6B9rxowB7o8nAY4wHK-gcRha74B2AQ?e=NtbXUx";

const TARGET = { driveId: null, parentItemId: null }; // <- war bei dir nicht definiert
const DRAFTS_FOLDER_NAME = "Reparatur-Entw√ºrfe";
let TARGET_DRAFTS_ITEM_ID = null;




const META_FOLDER_NAME = "Reparatur-Meta";   // <‚Äî NEU
let   TARGET_META_ITEM_ID = null;            // <‚Äî NEU


// richtig: shareId = 'u!' + base64url( UTF8( SHARING_URL ) )
function _b64Url(u) {
  const bytes = new TextEncoder().encode(u);      // nur die URL encodieren
  let bin = '';
  for (const b of bytes) bin += String.fromCharCode(b);
  const b64 = btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
  return 'u!' + b64;                               // 'u!' VOR die Base64, nicht hinein!
}


// WICHTIG: als "function ..." deklarieren (wird gehoistet)
// WICHTIG: als "function ..." deklarieren (wird gehoistet)
async function resolveShareLinkToFolder(){
  if (!accessToken) throw new Error("Kein Access Token");

  // --- Cache lesen ---
  const cache = JSON.parse(localStorage.getItem("TARGET_CACHE") || "null");
  if (cache?.shareUrl === SHARE_URL && cache?.driveId && cache?.parentItemId){
    TARGET.driveId        = cache.driveId;
    TARGET.parentItemId   = cache.parentItemId;
    TARGET_DRAFTS_ITEM_ID = cache.draftsItemId || null;
    TARGET_META_ITEM_ID   = cache.metaItemId   || null;

    // ‚ö†Ô∏è Nur sofort zur√ºck, wenn BEIDE Unterordner-IDs vorhanden sind
    if (TARGET_DRAFTS_ITEM_ID && TARGET_META_ITEM_ID) return;
  } else {
    // --- Share-Link ‚Üí Drive & Ordner aufl√∂sen ---
    const encoded = _b64Url(SHARE_URL);
    const res = await fetch(
      `https://graph.microsoft.com/v1.0/shares/${encoded}/driveItem?$select=id,name,parentReference,folder,file`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    if (!res.ok){
      throw new Error(`shares/driveItem: ${res.status} ${await res.text()}`);
    }
    const item = await res.json();
    const folderItemId = item.folder ? item.id : item.parentReference?.id;
    const driveId      = item.parentReference?.driveId;
    if (!driveId || !folderItemId) throw new Error("Zielordner konnte nicht bestimmt werden.");

    TARGET.driveId      = driveId;
    TARGET.parentItemId = folderItemId;
  }

  // --- Unterordner (Entw√ºrfe + Meta) ermitteln/erstellen ---
  const listUrl =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}` +
    `/children?$select=id,name,folder`;
  const listRes = await fetch(listUrl, { headers: { Authorization: `Bearer ${accessToken}` } });
  if (!listRes.ok) throw new Error(`children list failed: ${listRes.status}`);
  const children = (await listRes.json()).value || [];

  // Entw√ºrfe
  let drafts = children.find(x => x.name === DRAFTS_FOLDER_NAME && x.folder);
  if (!drafts){
    const createDrafts = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}/children`,
      {
        method: "POST",
        headers: { Authorization: `Bearer ${accessToken}`, "Content-Type":"application/json" },
        body: JSON.stringify({ name: DRAFTS_FOLDER_NAME, folder: {}, "@microsoft.graph.conflictBehavior":"ignore" })
      }
    );
    if (createDrafts.ok) drafts = await createDrafts.json();
  }
  TARGET_DRAFTS_ITEM_ID = drafts?.id || null;

  // Meta
  let meta = children.find(x => x.name === META_FOLDER_NAME && x.folder);
  if (!meta){
    const createMeta = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}/children`,
      {
        method: "POST",
        headers: { Authorization: `Bearer ${accessToken}`, "Content-Type":"application/json" },
        body: JSON.stringify({ name: META_FOLDER_NAME, folder: {}, "@microsoft.graph.conflictBehavior":"ignore" })
      }
    );
    if (createMeta.ok) meta = await createMeta.json();
  }
  TARGET_META_ITEM_ID = meta?.id || null;

  // --- Cache schreiben (inkl. IDs der Unterordner) ---
  localStorage.setItem("TARGET_CACHE", JSON.stringify({
    shareUrl:      SHARE_URL,
    driveId:       TARGET.driveId,
    parentItemId:  TARGET.parentItemId,
    draftsItemId:  TARGET_DRAFTS_ITEM_ID,
    metaItemId:    TARGET_META_ITEM_ID
  }));
}



//<!-- ... alles davor: msalConfig, scopes, msalInstance, handleRedirectPromise, resolveShareLinkToFolder, signInAndAcquireToken ... -->

// 3) Login/Token nur per Redirect (Popup auf GitHub Pages meiden)
async function signInAndAcquireToken(interactive = false, { rebuild = true } = {}) {
  try {
    let account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];

    if (!account && interactive) {
      await msalInstance.loginRedirect({ scopes });
      return; // kommt nach Redirect zur√ºck
    }
    if (!account) {
      showLoginHint();
      return;
    }

    try {
      const t = await msalInstance.acquireTokenSilent({ scopes, account });
      accessToken = t.accessToken;
    } catch (e) {
      await msalInstance.acquireTokenRedirect({ scopes });
      return;
    }

    try { await resolveShareLinkToFolder(); } catch (e) { console.warn("resolveShareLinkToFolder:", e); }
    hideLoginHint();

    // ‚¨áÔ∏è WICHTIG: Nur bei Bedarf Stammdaten neu laden + Dropdowns rebuilden
    if (rebuild) {
      try {
        await loadMasterData();
        window.rebuildDropdownsFromMaster?.();
      } catch (e) {
        console.warn("Reload master after sign-in failed:", e);
      }
    }

  } catch (e) {
    console.error("signInAndAcquireToken:", e);
    showLoginHint();
  }
}




/* === HIER einf√ºgen: signOut() === */
async function signOut(){
  try{
    const acc = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
    // üëâ lokalen Cache zu Stammdaten wegr√§umen
    localStorage.removeItem("TE15_MASTER");
    localStorage.removeItem("TARGET_CACHE");
    accessToken = "";

    if (acc) {
      await msalInstance.logoutRedirect({ account: acc });
      return;
    }
  } catch(e){
    console.error("logout:", e);
  }
}

/* DOMContentLoaded: erst lokal laden & bauen, dann (still) anmelden und ggf. neu bauen */
document.addEventListener("DOMContentLoaded", async () => {
  const acc = msalInstance.getAllAccounts()[0];
  if (acc) msalInstance.setActiveAccount(acc);

  // 1) Sofort lokale Stammdaten (Cache) laden und Listen bauen
  await loadMasterData();
  window.rebuildDropdownsFromMaster();

  // 2) Versuch: stille Anmeldung (keine Redirects)
  try {
    await signInAndAcquireToken(false);
    // 3) Nach erfolgreichem Login: OneDrive-Stammdaten laden und Listen neu bauen
    await loadMasterData();
    window.rebuildDropdownsFromMaster();
  } catch (e) {
    console.warn("Silent sign-in skipped:", e);
  }
});

</script>






<script>
  function _byId(id){ return document.getElementById(id); }

  function _showFieldError(el, msg){
    if (!el) return;
    el.classList.add('field-error');
    if (el.nextElementSibling && el.nextElementSibling.classList?.contains('error-text')) {
      el.nextElementSibling.remove();
    }
    const m = document.createElement('div');
    m.className = 'error-text';
    m.textContent = msg;
    el.parentNode.insertBefore(m, el.nextSibling);
  }

  function _clearAllFieldErrors(){
    document.querySelectorAll('.field-error').forEach(e => e.classList.remove('field-error'));
    document.querySelectorAll('.error-text').forEach(e => e.remove());
  }

  // beim Tippen/√Ñndern Fehler am jeweiligen Feld entfernen
  function _autoClearOnChange(id, evt='input'){
    const el = _byId(id);
    if (!el) return;
    el.addEventListener(evt, () => {
      el.classList.remove('field-error');
      if (el.nextElementSibling && el.nextElementSibling.classList?.contains('error-text')) {
        el.nextElementSibling.remove();
      }
    });
  }

  // einmalig aktivieren
  document.addEventListener('DOMContentLoaded', () => {
    _autoClearOnChange('bearbeitet_am', 'change');
    _autoClearOnChange('techniker1',    'change');
    _autoClearOnChange('maschine',      'change');
    _autoClearOnChange('sonstige_maschine');
    _autoClearOnChange('anlagenteil',   'change');
    _autoClearOnChange('sonstige_anlagenteil');
    _autoClearOnChange('fehlerbeschreibung', 'input');
  });

  // Pflichtfelder pr√ºfen
  function validateBeforeFinish(){
    _clearAllFieldErrors();
    let ok = true;

    // 1) Bearbeitet am
    const fDatum = _byId('bearbeitet_am');
    if (!fDatum?.value) { _showFieldError(fDatum, '‚ÄûBearbeitet am‚Äú ist ein Pflichtfeld.'); ok = false; }

    // 2) Techniker 1
    const fTech1 = _byId('techniker1');
    if (!fTech1?.value) { _showFieldError(fTech1, '‚ÄûTechniker 1‚Äú ist ein Pflichtfeld.'); ok = false; }

    // 3) Maschine (+ Sonstige-Text)
    const selM = _byId('maschine');
    if (!selM?.value) {
      _showFieldError(selM, '‚ÄûMaschine‚Äú ist ein Pflichtfeld.'); ok = false;
    } else if (selM.value === 'Sonstige') {
      const txtM = _byId('sonstige_maschine');
      if (!txtM?.value.trim()) { _showFieldError(txtM || selM, 'Bitte ‚ÄûSonstiges (Maschine)‚Äú angeben.'); ok = false; }
    }

    // 4) Anlagenteil (+ Sonstige-Text)
    const selA = _byId('anlagenteil');
    if (!selA?.value) {
      _showFieldError(selA, '‚ÄûAnlagenteil‚Äú ist ein Pflichtfeld.'); ok = false;
    } else if (selA.value === 'Sonstige') {
      const txtA = _byId('sonstige_anlagenteil');
      if (!txtA?.value.trim()) { _showFieldError(txtA || selA, 'Bitte ‚ÄûSonstiges (Anlagenteil)‚Äú angeben.'); ok = false; }
    }

    // 5) Fehlerbeschreibung
    const fDesc = _byId('fehlerbeschreibung');
    if (!fDesc?.value.trim()) { _showFieldError(fDesc, '‚ÄûFehlerbeschreibung‚Äú ist ein Pflichtfeld.'); ok = false; }

    if (!ok) {
      document.querySelector('.field-error')?.scrollIntoView({ behavior:'smooth', block:'center' });
      alert('Bitte f√ºllen Sie alle rot markierten Pflichtfelder aus.');
    }
    return ok;
  }
</script>





<!-- üîΩ Hier unten startet dein gro√ües Script-Block -->
<script>
  // --- Stammdaten (Maschinen & Anlagenteile) --- //
  const MASTER_FILE = "Stammdaten-Reparatur.json";
  let masterData = { version: 1, maschinen: [], anlagenteile: [] };

  // Local-Cache laden
  function loadMasterFromLocal() {
    try {
      const s = localStorage.getItem("TE15_MASTER");
      if (s) masterData = JSON.parse(s);
    } catch {}
  }

  // Local-Cache speichern
  function saveMasterToLocal() {
    try {
      localStorage.setItem("TE15_MASTER", JSON.stringify(masterData));
    } catch {}
  }

  // Stammdaten bewusst leeren + Cache √ºberschreiben
  function setEmptyMaster() {
    masterData = { version: 1, maschinen: [], anlagenteile: [] };
    saveMasterToLocal();
  }

  // Laden (OneDrive -> bei fehlender Datei: leeren -> sonst Local-Fallback)
  async function loadMasterData() {
    try {
      if (!accessToken) {                // nicht angemeldet -> nur local versuchen
        loadMasterFromLocal();
        return;
      }

      await resolveShareLinkToFolder();

      // Pr√ºfen, ob die Master-Datei existiert
      const listUrl =
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}` +
        `/children?$select=id,name`;
      const listRes = await fetch(listUrl, { headers: { Authorization: `Bearer ${accessToken}` } });
      if (!listRes.ok) throw new Error("children list failed");
      const list = await listRes.json();
      const item = (list.value || []).find(x => x.name === MASTER_FILE);

      // ‚ùó Datei existiert nicht -> Stammdaten leeren + Cache √ºberschreiben
      if (!item) {
        setEmptyMaster();
        return;
      }

      // Datei existiert -> Inhalt laden
      const fileRes = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${item.id}/content`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );

      if (!fileRes.ok) {
        // z. B. 404/403 -> lieber nicht alte Daten behalten
        setEmptyMaster();
        return;
      }

      // g√ºltige JSON √ºbernehmen + Cache aktualisieren
      masterData = await fileRes.json();
      if (!masterData || typeof masterData !== "object") {
        setEmptyMaster();
        return;
      }
      // Safety: fehlende Felder initialisieren
      masterData.version ??= 1;
      masterData.maschinen ??= [];
      masterData.anlagenteile ??= [];

      saveMasterToLocal();
    } catch (e) {
      // Netzwerk/Parsing-Fehler -> Local-Fallback (falls vorhanden)
      loadMasterFromLocal();
    }
  }

  // Speichern (OneDrive, plus Local-Cache)
// Speichern (OneDrive, plus Local-Cache)
async function saveMasterData() {
  saveMasterToLocal();
  if (!accessToken || !TARGET.driveId || !TARGET.parentItemId) return;

  const url  = `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}:/${encodeURIComponent(MASTER_FILE)}:/content`;
  const blob = new Blob([JSON.stringify(masterData, null, 2)], { type: "application/json" });

  try {
    await fetch(url, {
      method: "PUT",
      headers: { Authorization: `Bearer ${accessToken}` },
      body: blob
    });
  } catch (e) {
    console.warn("saveMasterData() ‚Äì Upload fehlgeschlagen:", e);
  }
}

/* === Neu: Sortier-Helfer (deutsche Sortierung, numerisch) === */
function sortSelectOptions(selectEl, stickyTopValues = ["", "Sonstige"]) {
  if (!selectEl) return;
  const collator = new Intl.Collator("de", { numeric: true, sensitivity: "base" });

  const opts    = Array.from(selectEl.options);
  const current = selectEl.value;

  // Platzhalter / Sonstige oben lassen
  const sticky = opts.filter(o => stickyTopValues.includes(o.value));
  const rest   = opts.filter(o => !stickyTopValues.includes(o.value));

  rest.sort((a, b) => collator.compare(
    (a.textContent || a.innerText || a.value).trim(),
    (b.textContent || b.innerText || b.value).trim()
  ));

  // Neu aufbauen
  selectEl.options.length = 0;
  sticky.forEach(o => selectEl.add(new Option(o.text, o.value)));
  rest.forEach(o   => selectEl.add(new Option(o.text, o.value)));

  // Auswahl erhalten
  selectEl.value = current;
}

// === Neu: Einf√ºgen + immer sortieren, optional autoselect ===
function addOptionUnique(selectEl, label, { autoselect = false } = {}) {
  const value = (label || "").trim();
  if (!selectEl || !value) return;

  const exists = [...selectEl.options].some(o =>
    ((o.textContent || o.innerText || o.value).trim().toLowerCase() === value.toLowerCase())
  );

  if (!exists) {
    selectEl.add(new Option(value, value)); // Position egal ‚Äì danach sortieren
  }

  // "" = ‚ÄûBitte ausw√§hlen‚Äú, "Sonstige" bleibt oben
  sortSelectOptions(selectEl, ["", "Sonstige"]);

  if (autoselect) selectEl.value = value; // nur auf Wunsch ausw√§hlen
}


/* ‚¨áÔ∏è NEU: Dropdowns aus Stammdaten vollst√§ndig neu aufbauen */
window.rebuildDropdownsFromMaster = function () {
  const maschineSelect    = document.getElementById("maschine");
  const anlagenteilSelect = document.getElementById("anlagenteil");
  if (!maschineSelect || !anlagenteilSelect) return;

  // Basisoptionen (aus dem aktuellen HTML dieses Builds)
  const baseMaschine = Array.from(maschineSelect.options).map(o => o.value);
  const baseTeile    = Array.from(anlagenteilSelect.options).map(o => o.value);

  // Alles zur√ºck auf ‚Äûnur Basisoptionen‚Äú
  Array.from(maschineSelect.options).forEach(o => { if (!baseMaschine.includes(o.value)) o.remove(); });
  Array.from(anlagenteilSelect.options).forEach(o => { if (!baseTeile.includes(o.value))   o.remove(); });

  // Neue Stammdaten anh√§ngen (f√ºgt ein & sortiert direkt)
  (masterData.maschinen     || []).forEach(n => addOptionUnique(maschineSelect, n));
  (masterData.anlagenteile  || []).forEach(n => addOptionUnique(anlagenteilSelect, n));

  // ‚ÄûSonstige‚Äú-Felder korrekt ein-/ausblenden
  maschineSelect.dispatchEvent(new Event('change'));
  anlagenteilSelect.dispatchEvent(new Event('change'));

  // Sicherheit: zum Schluss noch einmal sortieren
  sortSelectOptions(maschineSelect, ["", "Sonstige"]);
  sortSelectOptions(anlagenteilSelect, ["", "Sonstige"]);
};
/* ‚¨ÜÔ∏è ENDE neu */


  // ====================
  // Draft-Funktionen
  // ====================

  const fieldIds = [
    "auftrag_id",
    "bearbeitet_am",
    "techniker1",
    "techniker2",
    "maschinenstillstand",
    "ausfall_stunden",
    "ausfall_minuten",
    "maschine",
    "sonstige_maschine",
    "anlagenteil",
    "sonstige_anlagenteil",
    "startzeit",
    "endzeit",
    "dauer",
    "abschlussdatum",
    "fehlerbeschreibung",
    "reinigung_erforderlich",
    "reinigungsart_zusatz",
    "sonstige_reinigungsart_zusatz",
    "reinigungsart_sonstiges",
    "ort_datum"
  ];

  // ====================
  // OneDrive-Upload (robuster, mit Fehlertext)
  // ====================
  async function uploadToOneDrive(filename, blob, mime = "application/pdf", parentIdOverride = null) {
    if (!accessToken) { alert("‚ö†Ô∏è Kein Zugriffstoken. Bitte anmelden."); return false; }
    if (!TARGET.driveId || !TARGET.parentItemId) { alert("‚ö†Ô∏è Zielordner nicht initialisiert."); return false; }

    const parentId = parentIdOverride || TARGET.parentItemId;  // <‚Äî NEU
    const url =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
      `/items/${parentId}:/${encodeURIComponent(filename)}:/content`;

    try {
      const res = await fetch(url, {
        method: "PUT",
        headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": mime },
        body: blob
      });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        console.error("Upload-Fehler:", res.status, text);
      }
      return res.ok;
    } catch (err) {
      console.error("Fehler beim Upload:", err);
      return false;
    }
  }

  // ====================
  // Formular ‚Üí statischer Inhalt (f√ºr PDF)
  // ====================
function convertFormElementsToStaticText(container){
  const d = container.ownerDocument;

  // 1) Action-Buttons & Dateiuploads ausblenden
  container.querySelectorAll('button, input[type="file"], .delete-button')
           .forEach(el => el.style.display = 'none');

  // 2) Vorschau-Bilder ohne Beschr√§nkung (f√ºr das PDF)
  container.querySelectorAll('.preview-container img').forEach(img => {
    img.style.maxWidth = '100%';
    img.style.maxHeight = 'none';
    img.style.border = '0';
    img.loading = 'eager';
  });

// 3) SELECT/INPUT ‚Üí Daten-Attribut ‚Äûdata-selected-text‚Äú respektieren
container.querySelectorAll('select').forEach(sel => {
  const label = container.querySelector(`label[for="${sel.id}"]`);
  const row   = d.createElement('div'); 
  row.className = 'print-field';
  row.classList.add('avoid-break');                 // ‚Üê hinzugef√ºgt
  const l     = d.createElement('div'); l.className = 'print-label';
  const v     = d.createElement('div'); v.className = 'print-value';
  l.textContent = label?.textContent?.trim() || sel.name || '';
  v.textContent = sel.getAttribute('data-selected-text') || sel.value || '';
  if (label) label.remove();                        // Original-Label entfernen
  sel.replaceWith(row); row.append(l, v);
});

// 4) TEXTAREA ‚Üí IMMER in statischen Text umwandeln (sonst wird abgeschnitten)
container.querySelectorAll('textarea').forEach(ta => {
  const label = container.querySelector(`label[for="${ta.id}"]`);
  const row   = d.createElement('div'); 
  row.className = 'print-field';
  row.classList.add('avoid-break');                 // ‚Üê hinzugef√ºgt
  const l     = d.createElement('div'); l.className = 'print-label';
  const v     = d.createElement('div'); v.className = 'print-value';
  l.textContent = label?.textContent?.trim() || ta.name || '';
  v.textContent = (ta.value || '').trim();          // value als Text (kein HTML)
  if (label) label.remove();
  ta.replaceWith(row); row.append(l, v);
});

// 5) Normale Inputs (date, time, text, number ‚Ä¶) in statischen Text wandeln
container.querySelectorAll('input').forEach(inp => {
  if (/^(button|submit|file|checkbox|radio)$/i.test(inp.type)) return; // ignorieren
  const label = container.querySelector(`label[for="${inp.id}"]`);
  const row   = d.createElement('div'); 
  row.className = 'print-field';
  row.classList.add('avoid-break');                 // ‚Üê hinzugef√ºgt
  const l     = d.createElement('div'); l.className = 'print-label';
  const v     = d.createElement('div'); v.className = 'print-value';
  l.textContent = label?.textContent?.trim() || inp.name || '';
  v.textContent = (inp.value || '').trim();
  if (label) label.remove();
  inp.replaceWith(row); row.append(l, v);
});


  // 6) Doppelte Zeilen (falls entstanden) bereinigen
  const rows = Array.from(container.querySelectorAll('.print-field'));
  for (let i = 1; i < rows.length; i++) {
    const prev = rows[i - 1];
    const curr = rows[i];
    if (prev && curr && prev.textContent.trim() === curr.textContent.trim()) {
      curr.remove();
    }
  }
}













// ====================
// Auftrag abschlie√üen ‚Üí PDF erzeugen & hochladen
// ====================


async function generatePDFAndFinish() {
  // 0) Lib + Login
  await loadHtml2PdfIfNeeded();
  if (!window.html2pdf) { alert("html2pdf konnte nicht geladen werden."); return; }

  await signInAndAcquireToken(true);
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }

  const src = document.getElementById("pdfExportContainer");
  if (!src) { alert("Container nicht gefunden."); return; }

  // ‚úÖ Pflichtfelder NUR beim Abschluss pr√ºfen
  if (!validateBeforeFinish()) return;

  // ‚úÖ Wartung (optional): aktuelle Wartungsaufgabe als "heute durchgef√ºhrt" markieren
  try { await window.wpMarkCurrentTaskDone?.(); }
  catch (e) { console.warn('wpMarkCurrentTaskDone:', e); }

  // A) Canvas aus dem ORIGINAL sichern (id -> DataURL)
  const signatureMap = new Map(
    Array.from(src.querySelectorAll('canvas')).map(c => {
      try { return [c.id, c.toDataURL('image/png')]; }
      catch (e) { console.warn('toDataURL fehlgeschlagen', e); return [c.id, null]; }
    })
  );

  // B) Offscreen-Iframe
  const frame = document.getElementById('pdfSandbox');
  if (!frame) { alert("PDF-Frame fehlt."); return; }
  const doc = frame.contentDocument || frame.contentWindow?.document;
  if (!doc) { alert("PDF-Dokumentkontext nicht verf√ºgbar."); return; }

  doc.open();
  doc.write(`<!doctype html>
<html lang="de"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=794, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
  html,body{margin:0;padding:0;background:#fff;}
  #root{width:794px; box-sizing:border-box; padding:0;}
  html,body,#root{-webkit-text-size-adjust:none;text-size-adjust:none;}
  #root, #root *{ font-family:"Inter", Arial, sans-serif !important; line-height:1.35; box-sizing:border-box; }
  #pdfExportContainerClone{ width:794px; padding:20px; margin:0 auto; background:#fff; }
  .print-field{ display:grid !important; grid-template-columns:38% 62%; column-gap:12px; align-items:start; padding:6px 0; border-bottom:1px solid #e9e9e9; }
  .print-label{ font-weight:700; white-space:normal; overflow-wrap:anywhere; word-break:break-word; min-width:0; }
  .print-value{ white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; hyphens:auto; line-height:1.4; min-width:0; }
  .print-field > * { min-width:0; }
  .avoid-break{ break-inside:avoid; page-break-inside:avoid; }
  img{ max-width:100% !important; height:auto !important; border:0 !important; display:block; }
  canvas{ display:block !important; }
  h1{ font-size:24px; margin:0 0 8px; text-align:center; }
  @page { size: A4; margin: 0; }
</style>
</head><body><div id="root"></div></body></html>`);
  doc.close();

  // C) html2pdf INS IFRAME laden (falls n√∂tig)
  if (!frame.contentWindow.html2pdf) {
    await new Promise((resolve, reject) => {
      const s = doc.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      s.onload = resolve;
      s.onerror = () => reject(new Error('html2pdf im Iframe konnte nicht geladen werden.'));
      doc.head.appendChild(s);
    });
  }

  // üîé Helper: sichtbaren Text f√ºr Select ermitteln (inkl. ‚ÄûSonstige‚Äú-Felder)
  const selectedText = (selId) => {
    const sel = document.getElementById(selId);
    if (!sel) return "";
    let text = (sel.options?.[sel.selectedIndex]?.text || sel.value || "").trim();
    if (selId === "reinigung_erforderlich") {
      const v = (sel.value || "").toLowerCase();
      if (v === "ja") return "Ja";
      if (v === "nein") return "Nein";
    }
    if (selId === "maschine" && sel.value === "Sonstige") {
      const t = document.getElementById("sonstige_maschine")?.value?.trim();
      if (t) text = t;
    }
    if (selId === "anlagenteil" && sel.value === "Sonstige") {
      const t = document.getElementById("sonstige_anlagenteil")?.value?.trim();
      if (t) text = t;
    }
    return text;
  };

  // D) Inhalt klonen
  const clone = src.cloneNode(true);
  clone.id = 'pdfExportContainerClone';
  clone.classList.add('pdf-snapshot');
  clone.style.width = '794px';
  clone.style.maxWidth = '794px';
  clone.style.margin = '0';
  clone.style.padding = '20px';
  clone.style.background = '#ffffff';

  // --- üÜï Wartungsblock nur ins PDF, wenn ausgef√ºllt ---
  function wartungHasUserInput() {
    const selTask  = document.getElementById('wpTaskSelect')?.value?.trim();
    const interval = document.getElementById('wpIntervalDays')?.value?.trim();
    const lastDate = document.getElementById('wpLastDate')?.value?.trim();
    const nextDue  = document.getElementById('wpNextDue')?.value?.trim();
    return !!(selTask || interval || lastDate || nextDue);
  }

  const wartungSectionInClone = clone.querySelector('#wartungsplanSection');
  if (!wartungHasUserInput()) {
    // kompletten Bereich im PDF ausblenden
    wartungSectionInClone?.remove();
  } else {
    // Buttons/Hinweise im PDF entfernen (nur Darstellung)
    clone.querySelector('#wpHint')?.remove();
    clone.querySelectorAll('#wartungsplanPanel button').forEach(b => b.remove());
    clone.querySelector('#wpWarning')?.remove();

    // --- üÜï Werte der Wartungsfelder explizit vom Original √ºbernehmen ---
    (function copyWartungValuesIntoClone(){
      const copyInput = (id) => {
        const o = document.getElementById(id);
        const c = clone.querySelector('#' + id);
        if (o && c) c.value = o.value;
      };
      const copySelect = (id) => {
        const o = document.getElementById(id);
        const c = clone.querySelector('#' + id);
        if (!o || !c) return;
        c.value = o.value;
        Array.from(c.options).forEach(opt => opt.selected = (opt.value === o.value));
        const text = o.options?.[o.selectedIndex]?.text?.trim() || o.value || '';
        c.setAttribute('data-selected-text', text);
      };

      copySelect('wpTaskSelect');
      copyInput('wpIntervalDays');
      copyInput('wpLastDate');
      copyInput('wpNextDue');

      // Status-Pill Text sichern (rein kosmetisch)
      const pillOrig  = document.getElementById('wpStatusPill');
      const pillClone = clone.querySelector('#wpStatusPill');
      if (pillOrig && pillClone) pillClone.textContent = pillOrig.textContent;
    })();
  }
  // --- üÜï Ende Wartungsblock-Logik ---

  // Select-Werte + sichtbare Texte √ºbernehmen (f√ºr die PDF-Umwandlung)
  clone.querySelectorAll('select').forEach(sel => {
    const orig = document.getElementById(sel.id);
    if (!orig) return;
    sel.value = orig.value;
    Array.from(sel.options).forEach(o => o.selected = (o.value === orig.value));
    sel.setAttribute('data-selected-text', selectedText(sel.id));
  });

  // Canvas -> IMG
  clone.querySelectorAll('canvas').forEach(c => {
    const url = signatureMap.get(c.id);
    if (!url) return;
    const img = doc.createElement('img');
    img.src = url;
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.className = 'avoid-break';
    c.parentNode.replaceChild(img, c);
  });

  // In iFrame einf√ºgen & in statischen Inhalt wandeln
  doc.getElementById('root').appendChild(clone);
  convertFormElementsToStaticText(clone);
  clone.querySelectorAll('.preview-container img').forEach(img => {
    img.style.maxWidth = '100%';
    img.style.maxHeight = '';
    img.style.border = '0';
    img.style.display = 'block';
  });

  try {
    // E) Laden abwarten
    if (doc.fonts && doc.fonts.ready) { await doc.fonts.ready; }
    const imgs = doc.images;
    await Promise.all([...imgs].map(img => img.complete ? Promise.resolve()
      : new Promise(res => { img.onload = img.onerror = res; })));

    // F) Dateiname
    const auftragIdField = document.getElementById("auftrag_id");
    let auftragId = auftragIdField?.value?.trim();
    if (!auftragId) {
      const datePart = new Date().toISOString().split("T")[0].replace(/-/g, "");
      auftragId = `REP-${datePart}-${crypto.randomUUID().slice(0,4).toUpperCase()}`;
      if (auftragIdField) auftragIdField.value = auftragId;
    }
    const filename = `${auftragId}.pdf`;

    // G) html2pdf-Optionen
    const height = doc.getElementById('root').scrollHeight;
    const opt = {
      margin: 0,
      filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        scrollX: 0, scrollY: 0,
        windowWidth: 794,
        windowHeight: height,
        logging: false,
        foreignObjectRendering: false
      },
      jsPDF: { unit: 'px', format: [794, 1123], orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    // H) Rendern
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    const h2p = frame.contentWindow.html2pdf;
    const worker  = h2p().set(opt).from(doc.getElementById('root')).toPdf();
    const pdfBlob = await worker.get('pdf').then(pdf => pdf.output('blob'));

    // I) Upload & UI
    const success = await uploadToOneDrive(filename, pdfBlob);
    if (success) {
      // ---- META-Datei f√ºr das Dashboard mitschreiben ----
      const meta = {
        auftrags_id:        auftragId,
        pdfName:            filename,
        bearbeitet_am:      document.getElementById("bearbeitet_am")?.value || "",
        techniker1:         selectedText("techniker1"),
        techniker2:         (selectedText("techniker2") || "").replace(/^‚Äì$/, ""),
        maschine_value:     document.getElementById("maschine")?.value || "",
        maschine_text:      selectedText("maschine"),
        anlagenteil_value:  document.getElementById("anlagenteil")?.value || "",
        anlagenteil_text:   selectedText("anlagenteil"),
      };

      // ‚¨áÔ∏è sicherstellen, dass der Meta-Ordner existiert/aufgel√∂st ist
      if (!TARGET_META_ITEM_ID) {
        try { await resolveShareLinkToFolder(); }
        catch(e){ console.warn("resolveShareLinkToFolder (Meta) fehlgeschlagen:", e); }
      }

      const metaBlob = new Blob([JSON.stringify(meta, null, 2)], { type: "application/json" });

      // bevorzugt in den Meta-Ordner, sonst Fallback Hauptordner
      const metaOk = await uploadToOneDrive(
        `${auftragId}.meta.json`,
        metaBlob,
        "application/json",
        TARGET_META_ITEM_ID || TARGET.parentItemId
      );
      if (!metaOk) console.warn("Meta-Upload fehlgeschlagen");

      alert("‚úÖ PDF erfolgreich in OneDrive gespeichert!");
      await deleteDraftFile?.();
      document.getElementById("abschlussScreen").style.display = "flex";

      try { if (document.getElementById("dashPanel")) await loadDashboard(); } catch {}
    } else {
      alert("‚ö†Ô∏è Fehler beim Hochladen in OneDrive.");
    }
  } catch (err) {
    console.error("‚ùå Fehler bei PDF-Erstellung/Upload:", err);
    alert("‚ùå PDF konnte nicht erstellt oder hochgeladen werden.");
  } finally {
    try { doc.body.innerHTML = '<div id="root"></div>'; } catch {}
  }
}




// ====================
// Sonstiges
// ====================
function forceUpdate() {
  (async () => {
    try {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      if (window.caches?.keys) {
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n)));
      }
      alert("‚úÖ Cache & Service Worker gel√∂scht. Seite wird neu geladen.");
      const url = new URL(location.href);
      url.searchParams.set('_', Date.now());
      location.replace(url.toString());
    } catch (e) {
      console.warn("forceUpdate() Fehler:", e);
      location.reload();
    }
  })();
}


// üíæ ENTWURF SPEICHERN
async function saveDraftToOneDrive() {
  await signInAndAcquireToken(true);
  await resolveShareLinkToFolder();
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const draftData = {};
  fieldIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) draftData[id] = el.value;
  });

  const draftJson = JSON.stringify(draftData, null, 2);
  const blob = new Blob([draftJson], { type: "application/json" });

  const auftragId = document.getElementById('auftrag_id')?.value || "ohne-id";
  const draftFilename = `Entwurf-${auftragId}.json`;

  // Falls der Unterordner existiert, dorthin; sonst in den Hauptordner
  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;

  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${parentId}:/${encodeURIComponent(draftFilename)}:/content`;

  const res = await fetch(url, {
    method: "PUT",
    headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": "application/json" },
    body: blob
  });

  if (res.ok) { alert("‚úÖ Entwurf erfolgreich gespeichert!"); }
  else { alert("‚ö†Ô∏è Fehler beim Speichern des Entwurfs."); }
}


// üì• ENTWURF LADEN
// üì• ENTWURF LADEN
async function loadDraftFromOneDrive(fileName) {
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;
  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${parentId}:/${encodeURIComponent(fileName)}:/content`;

  // Helper: fehlende Option in einem <select> hinzuf√ºgen und ausw√§hlen
  function ensureSelectValue(selId, value, autoselect = true) {
    const sel = document.getElementById(selId);
    if (!sel || value == null || value === "") return;
    const exists = [...sel.options].some(o =>
      (o.value || o.textContent).trim().toLowerCase() === String(value).trim().toLowerCase()
    );
    if (!exists) {
      if (typeof addOptionUnique === "function") addOptionUnique(sel, String(value), { autoselect });
      else {
        sel.add(new Option(String(value), String(value)));
        if (autoselect) sel.value = String(value);
      }
    } else if (autoselect) {
      sel.value = String(value);
    }
  }

  try {
    const res = await fetch(url, { method: "GET", headers: { Authorization: `Bearer ${accessToken}` } });
    if (!res.ok) { alert("‚ö†Ô∏è Fehler beim Laden des Entwurfs."); return; }

    const draftData = await res.json();

    // 1) Standard-Felder direkt setzen
    fieldIds.forEach(id => {
      const el = document.getElementById(id);
      if (el && draftData[id] !== undefined) el.value = draftData[id];
    });

    // 2) Techniker-Dropdowns sicherstellen (Option ggf. nachtragen)
    if (draftData.techniker1) ensureSelectValue("techniker1", draftData.techniker1);
    if (draftData.techniker2) ensureSelectValue("techniker2", draftData.techniker2);

    // 3) Maschine / Anlagenteil + ‚ÄûSonstige‚Äú-Felder korrekt setzen
    // Maschine
    if (draftData.sonstige_maschine && draftData.sonstige_maschine.trim()) {
      const sel = document.getElementById("maschine");
      const txt = document.getElementById("sonstige_maschine");
      if (sel) sel.value = "Sonstige";
      if (txt) txt.value = draftData.sonstige_maschine.trim();
    } else if (draftData.maschine) {
      ensureSelectValue("maschine", draftData.maschine, true);
    }

    // Anlagenteil
    if (draftData.sonstige_anlagenteil && draftData.sonstige_anlagenteil.trim()) {
      const sel = document.getElementById("anlagenteil");
      const txt = document.getElementById("sonstige_anlagenteil");
      if (sel) sel.value = "Sonstige";
      if (txt) txt.value = draftData.sonstige_anlagenteil.trim();
    } else if (draftData.anlagenteil) {
      ensureSelectValue("anlagenteil", draftData.anlagenteil, true);
    }

    // 4) UI-abh√§ngigkeiten aktualisieren (Sonstige-Felder ein-/ausblenden etc.)
    document.getElementById("maschine")?.dispatchEvent(new Event("change"));
    document.getElementById("anlagenteil")?.dispatchEvent(new Event("change"));
    document.getElementById("techniker1")?.dispatchEvent(new Event("change"));
    document.getElementById("techniker2")?.dispatchEvent(new Event("change"));

    alert("‚úÖ Entwurf erfolgreich geladen!");
  } catch (err) {
    console.error("Fehler beim Laden:", err);
    alert("‚ùå Fehler beim Laden des Entwurfs.");
  }
}



// üìÇ ENTWURFSLISTE ANZEIGEN
async function showDraftList() {
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;

  try {
    const res = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${parentId}/children?$select=id,name,file,folder`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    const data = await res.json();
    const files = (data.value || []).filter(item => item.name.endsWith(".json"));
    if (!files.length) { alert("‚ö†Ô∏è Keine Entw√ºrfe gefunden."); return; }

    let list = "Verf√ºgbare Entw√ºrfe:\n\n";
    files.forEach((f, i) => { list += `${i + 1}: ${f.name}\n`; });

    const numberInput = prompt("Bitte die Nummer des Entwurfs eingeben:\n\n" + list);
    const idx = parseInt(numberInput, 10) - 1;

    if (!isNaN(idx) && files[idx]) {
      // F√ºr sp√§teres L√∂schen merken wir uns Name + ID
      window.currentDraftFileName = files[idx].name;
      window.currentDraftFileId   = files[idx].id;

      await loadDraftFromOneDrive(files[idx].name);
    } else {
      alert("‚ö†Ô∏è Ung√ºltige Nummer.");
    }
  } catch (err) {
    console.error("Fehler beim Abrufen der Liste:", err);
    alert("‚ùå Fehler beim Abrufen der Entw√ºrfe.");
  }
}



// üóëÔ∏è ENTWURF L√ñSCHEN
async function deleteDraftFile() {
  if (!accessToken) return;
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { console.warn("Zielordner nicht initialisiert."); return; }

  // Bevorzugt mit der gespeicherten Item-ID l√∂schen
  if (window.currentDraftFileId) {
    try {
      await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${window.currentDraftFileId}`,
        { method: "DELETE", headers: { Authorization: `Bearer ${accessToken}` } }
      );
      console.log("‚úÖ Entwurfsdatei gel√∂scht:", window.currentDraftFileName);
      window.currentDraftFileName = null;
      window.currentDraftFileId = null;
    } catch (err) {
      console.error("‚ùå Fehler beim L√∂schen der Entwurfsdatei:", err);
    }
    return;
  }

  // Fallback: Wenn nur der Name bekannt ist
  if (window.currentDraftFileName) {
    try {
      const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;
      const res = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${parentId}/children?$select=id,name`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      const data = await res.json();
      const match = (data.value || []).find(x => x.name === window.currentDraftFileName);
      if (!match) { console.warn("Datei nicht gefunden:", window.currentDraftFileName); return; }

      await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${match.id}`,
        { method: "DELETE", headers: { Authorization: `Bearer ${accessToken}` } }
      );
      console.log("‚úÖ Entwurfsdatei gel√∂scht:", window.currentDraftFileName);
      window.currentDraftFileName = null;
      window.currentDraftFileId = null;
    } catch (err) {
      console.error("‚ùå Fehler beim L√∂schen der Entwurfsdatei:", err);
    }
  }
}

window.confirmUpdate = function () {
  const modal = document.getElementById('updateModal');
  if (modal) modal.style.display = 'none';

  const msg = document.getElementById('confirmationMessage');
  if (msg) {
    msg.style.display = 'block';
    setTimeout(() => { msg.style.display = 'none'; }, 2500);
  }
};

// ===== Dashboard (mit 30-Tage-Schalter) =====
const META_SUFFIX = '.meta.json';

// false = nur letzte 30 Tage, true = alle
window.showAllOrders = false;

document.addEventListener('DOMContentLoaded', () => {
  const panel    = document.getElementById('dashPanel');
  const toggle   = document.getElementById('toggleDashBtn');
  const reload   = document.getElementById('dashReload');
  const clearBtn = document.getElementById('dashClear');
  const rangeBtn = document.getElementById('dashRangeBtn');

  toggle?.addEventListener('click', () => {
    const show = panel.style.display === 'none' || !panel.style.display;
    panel.style.display = show ? 'block' : 'none';
    if (show) loadDashboard();
  });

  reload?.addEventListener('click', loadDashboard);

  clearBtn?.addEventListener('click', () => {
    ['f_bearbeitet_am','f_techniker','f_maschine','f_anlagenteil'].forEach(id => {
      const el = document.getElementById(id); if (el) el.value = '';
    });
    window.showAllOrders = false;
    if (rangeBtn){ rangeBtn.dataset.mode = '30'; rangeBtn.textContent = 'üóìÔ∏è Letzte 30 Tage'; }
    applyFiltersToDashboard();
  });

  rangeBtn?.addEventListener('click', () => {
    const mode = rangeBtn.dataset.mode || '30';
    if (mode === '30') {
      window.showAllOrders = true;
      rangeBtn.dataset.mode = 'all';
      rangeBtn.textContent  = 'üóìÔ∏è Alle Auftr√§ge';
      const d = document.getElementById('f_bearbeitet_am'); if (d) d.value = '';
    } else {
      window.showAllOrders = false;
      rangeBtn.dataset.mode = '30';
      rangeBtn.textContent  = 'üóìÔ∏è Letzte 30 Tage';
    }
    applyFiltersToDashboard();
  });

  ['f_bearbeitet_am','f_techniker','f_maschine','f_anlagenteil'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', applyFiltersToDashboard);
  });

  // üõ†Ô∏è Wartung-Button im Kopf (√∂ffnet/schlie√üt den Wartungsbereich)
  const wartungHeadBtn = document.getElementById('wartungToggleHead');
  if (wartungHeadBtn) {
    wartungHeadBtn.addEventListener('click', () => {
      const panel   = document.getElementById('wartungsplanPanel');    // Panel aus dem Wartungsplan-HTML
      const section = document.getElementById('wartungsplanSection');  // Umrahmende Section

      if (!panel || !section) {
        alert('Wartungsbereich ist noch nicht eingebaut.');
        return;
      }
      const willShow = panel.style.display === 'none' || !panel.style.display;
      panel.style.display = willShow ? 'block' : 'none';
      wartungHeadBtn.textContent = willShow ? 'üõ†Ô∏è Wartung (zu)' : 'üõ†Ô∏è Wartung';

      if (willShow) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  }
});



async function loadDashboard(){
  await signInAndAcquireToken(true);
  await resolveShareLinkToFolder();

  const tbody = document.querySelector('#dashTable tbody');
  const empty = document.getElementById('dashEmpty');
  if (!tbody) return;

  tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;">Lade‚Ä¶</td></tr>';
  if (empty) empty.style.display = 'none';

  try{
    const headers = { Authorization: `Bearer ${accessToken}` };

    // PDFs im Hauptordner (bleiben dort)
    const listPdfUrl =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}` +
      `/children?$top=2000&$select=id,name,webUrl,file,folder`;
    const pdfRes = await fetch(listPdfUrl, { headers });
    const mainItems = (await pdfRes.json()).value || [];

    const pdfMap = new Map(
      mainItems.filter(i => i.file && /\.pdf$/i.test(i.name))
               .map(i => [i.name, i.webUrl])
    );

    // META-Dateien: zuerst Meta-Ordner, sonst Fallback Hauptordner
    let metaItems = [];
    if (TARGET_META_ITEM_ID) {
      const listMetaUrl =
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET_META_ITEM_ID}` +
        `/children?$top=2000&$select=id,name,file`;
      const metaRes = await fetch(listMetaUrl, { headers });
      if (metaRes.ok){
        const data = await metaRes.json();
        metaItems = (data.value || []).filter(i => i.file && i.name.endsWith(META_SUFFIX));
      }
    }
    if (!metaItems.length){
      metaItems = mainItems.filter(i => i.file && i.name.endsWith(META_SUFFIX));
    }

    const rows = [];
    for (const m of metaItems){
      const mres = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${m.id}/content`,
        { headers }
      );
      if (!mres.ok) continue;
      const meta = await mres.json();

      const auftragsId = (meta.auftrags_id || m.name.replace(META_SUFFIX,'')).trim();
      const pdfName    = meta.pdfName || `${auftragsId}.pdf`;

      rows.push({
        dateIso:  meta.bearbeitet_am || '',
        dateDisp: meta.bearbeitet_am ? new Date(meta.bearbeitet_am).toLocaleDateString('de-DE') : '',
        tech:     [meta.techniker1, meta.techniker2].filter(Boolean).join(', '),
        maschine: meta.maschine_text || meta.maschine_value || '',
        teil:     meta.anlagenteil_text || meta.anlagenteil_value || '',
        id:       auftragsId,
        url:      pdfMap.get(pdfName) || null
      });
    }

    rows.sort((a,b) => (b.dateIso||'').localeCompare(a.dateIso||''));

    if (!rows.length){
      tbody.innerHTML = '';
      if (empty) empty.style.display = 'block';
      // Analytics ausblenden, wenn keine Zeilen
      const dashBox = document.getElementById('dashAnalytics');
      if (dashBox) dashBox.style.display = 'none';
      return;
    }

    tbody.innerHTML = rows.map(r => {
      const idCell = r.url ? `<a href="${r.url}" target="_blank" rel="noopener">${r.id}</a>` : r.id;
      return `<tr>
        <td data-k="bearbeitet_am" data-iso="${r.dateIso}">${r.dateDisp}</td>
        <td data-k="techniker">${r.tech}</td>
        <td data-k="maschine">${r.maschine}</td>
        <td data-k="anlagenteil">${r.teil}</td>
        <td data-k="auftrag_id">${idCell}</td>
      </tr>`;
    }).join('');

    applyFiltersToDashboard(); // -> triggert auch updateAnalytics()
  }catch(e){
    console.error('Dashboard:', e);
    tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;">Fehler beim Laden.</td></tr>';
    const dashBox = document.getElementById('dashAnalytics');
    if (dashBox) dashBox.style.display = 'none';
  }
}

/* üîé NEU: Balkenliste rendern */
function renderTop(map, targetId){
  const target = document.getElementById(targetId);
  if(!target) return;
  const entries = [...map.entries()];
  const total   = entries.reduce((a,[,n]) => a+n, 0) || 1;

  const top = entries
    .sort((a,b) => b[1]-a[1] || a[0].localeCompare(b[0],'de'))
    .slice(0,5);

  target.innerHTML = top.length ? top.map(([label,count])=>{
    const pct = Math.round((count/total)*100);
    return `<div class="bar-row" data-label="${label}">
      <div class="bar-label" title="${label}">${label}</div>
      <div class="bar"><div class="bar-fill" style="width:${pct}%"></div></div>
      <div class="bar-count">${count}</div>
    </div>`;
  }).join('') : `<div style="color:#666">Keine Daten</div>`;

  // Klick = Filter setzen
  target.querySelectorAll('.bar-row').forEach(row=>{
    row.addEventListener('click', ()=>{
      const label = row.dataset.label || '';
      const inputId = (targetId === 'topMachines') ? 'f_maschine' : 'f_anlagenteil';
      const inp = document.getElementById(inputId);
      if (inp){ inp.value = label; applyFiltersToDashboard(); }
    });
  });
}

/* üîé NEU: Auswertung der aktuell sichtbaren Zeilen */
function updateAnalytics(){
  const rows = [...document.querySelectorAll('#dashTable tbody tr')]
    .filter(tr => tr.style.display !== 'none');

  const dashBox = document.getElementById('dashAnalytics');
  if (!dashBox) return;

  if (!rows.length){
    dashBox.style.display = 'none';
    return;
  }

  const machines = new Map();
  const parts    = new Map();

  rows.forEach(tr=>{
    const m = tr.querySelector('[data-k="maschine"]')?.textContent.trim() || '';
    const a = tr.querySelector('[data-k="anlagenteil"]')?.textContent.trim() || '';
    if (m) machines.set(m, (machines.get(m)||0) + 1);
    if (a) parts.set(a,    (parts.get(a)||0)    + 1);
  });

  renderTop(machines, 'topMachines');
  renderTop(parts,    'topParts');
  dashBox.style.display = 'block';
}

function applyFiltersToDashboard(){
  const valDate   = (document.getElementById('f_bearbeitet_am')?.value || '').trim(); // ISO yyyy-mm-dd
  const valTech   = (document.getElementById('f_techniker')?.value     || '').trim().toLowerCase();
  const valMach   = (document.getElementById('f_maschine')?.value      || '').trim().toLowerCase();
  const valTeil   = (document.getElementById('f_anlagenteil')?.value   || '').trim().toLowerCase();

  const rows = document.querySelectorAll('#dashTable tbody tr');
  let shown = 0;

  // Grenze f√ºr ‚Äûletzte 30 Tage‚Äú
  const now   = new Date();
  const last30 = new Date(now.getTime() - 30*24*60*60*1000);

  rows.forEach(tr => {
    const cDate = tr.querySelector('[data-k="bearbeitet_am"]');
    const cTech = tr.querySelector('[data-k="techniker"]');
    const cMac  = tr.querySelector('[data-k="maschine"]');
    const cTeil = tr.querySelector('[data-k="anlagenteil"]');

    let ok = true;

    // Textfilter
    if (valTech && !(cTech?.textContent || '').toLowerCase().includes(valTech)) ok = false;
    if (valMach && !(cMac ?.textContent || '').toLowerCase().includes(valMach)) ok = false;
    if (valTeil && !(cTeil?.textContent || '').toLowerCase().includes(valTeil)) ok = false;

    // Datumsfilter per Eingabefeld (zeigt nur >= ausgew√§hltem Datum)
    if (ok && valDate) {
      const rowIso = cDate?.dataset.iso || '';
      if (!rowIso || rowIso < valDate) ok = false;
    }

    // 30-Tage-Einschr√§nkung (wenn nicht ‚Äûalle‚Äú aktiv)
    if (ok && !window.showAllOrders) {
      const rowIso = cDate?.dataset.iso || '';
      if (rowIso) {
        const d = new Date(rowIso);
        if (!(d >= last30)) ok = false;
      }
    }

    tr.style.display = ok ? '' : 'none';
    if (ok) shown++;
  });

  const empty = document.getElementById('dashEmpty');
  if (empty) empty.style.display = shown ? 'none' : 'block';

  // üîé NEU: nach jedem Filter neu berechnen
  updateAnalytics();
}
// ===== /Dashboard =====

</script>
<script>
/* ===== Wartungsplan ‚Äì Daten & OneDrive-Speicher ===== */
const WP_FILE = "Wartungsplaene.json";
/** Struktur: { [maschinenName]: [ { id, name, intervalDays, lastDateISO } ] } */
let wartungsplaene = {};

function wpTodayISO(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function wpAddDays(iso, days){
  if (!iso) return "";
  const d = new Date(iso); d.setDate(d.getDate()+Number(days||0));
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function wpComputeNext(lastDate, intervalDays){
  if (!lastDate || !intervalDays) return "";
  return wpAddDays(lastDate, intervalDays);
}
function wpStatus(nextIso){
  if (!nextIso) return {label:"‚Äì",level:"none",bg:"#e9ecef",fg:"#000"};
  const t = wpTodayISO();
  if (nextIso < t) return {label:"√úberf√§llig",level:"overdue",bg:"#f8d7da",fg:"#842029"};
  const daysLeft = Math.floor((new Date(nextIso) - new Date(t))/86400000);
  if (daysLeft <= 3) return {label:"Bald f√§llig",level:"soon",bg:"#fff3cd",fg:"#664d03"};
  return {label:"OK",level:"ok",bg:"#d1e7dd",fg:"#0f5132"};
}

async function wpLoad(){
  try{
    // offline/local fallback
    const raw = localStorage.getItem("TE15_WARTUNGSPLAENE");
    wartungsplaene = raw ? JSON.parse(raw) : {};
  }catch{ wartungsplaene = {}; }

  // Wenn eingeloggt + Meta-Ordner aufgel√∂st -> aus OneDrive laden
  if (!window.accessToken || !window.TARGET_META_ITEM_ID) return;
  try{
    const listUrl = `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET_META_ITEM_ID}/children?$select=id,name`;
    const lr = await fetch(listUrl, { headers:{Authorization:`Bearer ${accessToken}`}});
    if (!lr.ok) return;
    const ls = await lr.json();
    const item = (ls.value||[]).find(x => x.name === WP_FILE);
    if (!item) return;
    const fr = await fetch(`https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${item.id}/content`,
                           { headers:{Authorization:`Bearer ${accessToken}`}});
    if (!fr.ok) return;
    wartungsplaene = await fr.json();
    localStorage.setItem("TE15_WARTUNGSPLAENE", JSON.stringify(wartungsplaene));
  }catch(e){ console.warn("wpLoad()", e); }
}

async function wpSave(){
  try{ localStorage.setItem("TE15_WARTUNGSPLAENE", JSON.stringify(wartungsplaene)); }catch{}
  if (!window.accessToken || !window.TARGET_META_ITEM_ID) return;
  const url = `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET_META_ITEM_ID}:/${encodeURIComponent(WP_FILE)}:/content`;
  const blob = new Blob([JSON.stringify(wartungsplaene, null, 2)], { type:"application/json" });
  try{
    await fetch(url, { method:"PUT", headers:{Authorization:`Bearer ${accessToken}`}, body:blob });
  }catch(e){ console.warn("wpSave()", e); }
}

/* ===== Wartungsplan ‚Äì UI ===== */
function wpEls(){
  return {
    panel: document.getElementById("wartungsplanPanel"),
    section: document.getElementById("wartungsplanSection"),
    warn: document.getElementById("wpWarning"),
    pill: document.getElementById("wpStatusPill"),
    selTask: document.getElementById("wpTaskSelect"),
    interval: document.getElementById("wpIntervalDays"),
    last: document.getElementById("wpLastDate"),
    next: document.getElementById("wpNextDue"),
    btnAdd: document.getElementById("wpAddTask"),
    btnSave: document.getElementById("wpSaveTask"),
    btnDel: document.getElementById("wpDeleteTask"),
    btnDone: document.getElementById("wpMarkDoneToday"),
    selMaschine: document.getElementById("maschine")
  };
}
function wpEnsureMachineKey(name){ if (!name) return null; wartungsplaene[name] ||= []; return name; }

function wpRefreshTaskList(){
  const { selTask, selMaschine } = wpEls();
  const m = selMaschine?.value; selTask.innerHTML = `<option value="">Bitte ausw√§hlen</option>`;
  if (!m) return;
  (wartungsplaene[m]||[]).forEach(t=>{
    const o = document.createElement("option"); o.value = t.id; o.textContent = t.name; selTask.appendChild(o);
  });
}
<script>
// ==== kleine Helfer ====
const isIsoDate = (s) => /^\d{4}-\d{2}-\d{2}$/.test(String(s||""));
const toInt = (v, def=0) => {
  const n = parseInt(v, 10);
  return Number.isFinite(n) ? n : def;
};

// ==== Status / Warnung / Auswahl ====
function wpStatusUpdateForTask(task){
  const { interval, last, next, pill } = wpEls();

  if (!task){
    if (interval) interval.value = "";
    if (last)     last.value     = "";
    if (next)     next.value     = "";
    if (pill){
      pill.textContent = "‚Äì";
      pill.style.background = "#e9ecef";
      pill.style.color      = "#000";
    }
    return;
  }

  // Werte vorsichtig aus dem Task √ºbernehmen
  const inter = toInt(task.intervalDays || "", "");
  const lastIso = isIsoDate(task.lastDateISO) ? task.lastDateISO : "";

  if (interval) interval.value = inter === "" ? "" : String(inter);
  if (last)     last.value     = lastIso;
  if (next){
    next.value = wpComputeNext(lastIso, inter) || "";
  }

  const st = wpStatus(next?.value || "");
  if (pill){
    pill.textContent      = st.label;
    pill.style.background = st.bg;
    pill.style.color      = st.fg;
  }
}


// ===== Helpers =====
function toInt(v, fallback = 0){
  const n = parseInt(String(v ?? '').replace(/[^\d-]/g, ''), 10);
  return Number.isFinite(n) ? n : fallback;
}
function isIsoDate(s){
  return /^\d{4}-\d{2}-\d{2}$/.test(String(s || ''));
}

// √úberf√§llige Aufgaben f√ºr eine Maschine ermitteln (Array zur√ºck)
function wpOverdueTasks(machineName){
  if (!machineName) return [];
  const tasks = wartungsplaene[machineName] || [];
  return tasks.filter(t => {
    const inter = toInt(t.intervalDays || 0, 0);
    const last  = isIsoDate(t.lastDateISO) ? t.lastDateISO : "";
    const next  = wpComputeNext(last, inter);
    return wpStatus(next).level === "overdue";
  });
}

// üî¥ Globalen Banner aktualisieren (sichtbar auch bei zuem Panel)
function wpUpdateGlobalBanner(){
  const banner = document.getElementById('wpGlobalOverdueBanner');
  if (!banner) return;

  const selMaschine = wpEls().selMaschine;
  const m = selMaschine?.value || "";

  // Nur f√ºr die aktuell gew√§hlte Maschine anzeigen
  const overdue = wpOverdueTasks(m);
  if (!m || overdue.length === 0){
    banner.style.display = "none";
    return;
  }

  // Nachricht setzen
  const msgEl = banner.querySelector('[data-msg]');
  if (msgEl){
    const names = overdue.map(t => t.name).slice(0,3).join(', ');
    const more  = overdue.length > 3 ? ` (+${overdue.length - 3} weitere)` : '';
    msgEl.textContent = `Maschine ‚Äû${m}‚Äú: ${overdue.length} Wartung(en) √ºberf√§llig ‚Äì ${names}${more}`;
  }

  banner.style.display = "flex";
}

// ==== Status / Warnung / Auswahl ====
function wpStatusUpdateForTask(task){
  const { interval, last, next, pill } = wpEls();

  if (!task){
    interval.value = "";
    last.value     = "";
    next.value     = "";
    pill.textContent = "‚Äì";
    pill.style.background = "#e9ecef";
    pill.style.color = "#000";
    return;
  }

  interval.value = task.intervalDays || "";
  last.value     = task.lastDateISO  || "";
  next.value     = wpComputeNext(task.lastDateISO, task.intervalDays) || "";

  const st = wpStatus(next.value);
  pill.textContent      = st.label;
  pill.style.background = st.bg;
  pill.style.color      = st.fg;
}

function wpEvalWarning(){
  const { selMaschine, warn } = wpEls();
  const m = selMaschine?.value;
  let anyOverdue = false;

  if (m){
    anyOverdue = wpOverdueTasks(m).length > 0;
  }
  if (warn) warn.style.display = anyOverdue ? "block" : "none";

  // üîÅ Banner + (offline) Info aktualisieren
  wpUpdateGlobalBanner();

  // ‚úâÔ∏è Zus√§tzlich (falls konfiguriert): E-Mail-Check, aber hier ohne Versand
  try { wpCheckOverdueAndNotify?.({ sendMail:false }); } catch {}
}

function wpCurrentTask(){
  const { selMaschine, selTask } = wpEls();
  const m = selMaschine?.value, id = selTask?.value;
  if (!m || !id) return null;
  return (wartungsplaene[m]||[]).find(t => t.id === id) || null;
}

function wpRecalcNext(){
  const { interval, last, next, pill } = wpEls();
  const inter   = toInt(interval?.value || 0, 0);
  const lastIso = isIsoDate(last?.value) ? last.value : "";
  if (next) next.value = inter > 0 && lastIso ? wpComputeNext(lastIso, inter) : "";

  const st = wpStatus(next?.value || "");
  if (pill){
    pill.textContent      = st.label;
    pill.style.background = st.bg;
    pill.style.color      = st.fg;
  }
}

// ==== UI verdrahten ====
function setupWartungsplanUI(){
  const E = wpEls();
  if (!E.section) return;

  // Banner-Button: Wartungspanel √∂ffnen & scrollen
  document.getElementById('wpOpenFromBanner')?.addEventListener('click', () => {
    const panel   = document.getElementById('wartungsplanPanel');
    const section = document.getElementById('wartungsplanSection');
    if (panel){ panel.style.display = 'block'; }
    // Button-Label im Kopf (falls vorhanden) umschalten
    const headBtn = document.getElementById('wartungToggleHead');
    if (headBtn) headBtn.textContent = 'üõ†Ô∏è Wartung (zu)';
    section?.scrollIntoView({ behavior:'smooth', block:'start' });
  });

E.selMaschine?.addEventListener("change", () => {
  wpRefreshTaskList();
  wpStatusUpdateForTask(null);
  wpEvalWarning();
  wpUpdateGlobalBanner(); // ‚¨ÖÔ∏è hier
});


  // Auswahl Aufgabe -> Felder & Status f√ºllen
  E.selTask?.addEventListener("change", () => wpStatusUpdateForTask(wpCurrentTask()));

  // Eingaben -> NextDue live rechnen
  E.interval?.addEventListener("input", wpRecalcNext);
  E.last?.addEventListener("change", wpRecalcNext);

  // Neue Aufgabe
  E.btnAdd?.addEventListener("click", async () => {
    const m = wpEnsureMachineKey(E.selMaschine?.value);
    if (!m){ alert("Bitte zuerst eine Maschine w√§hlen."); return; }
    const name = prompt("Bezeichnung der Wartungsaufgabe (z. B. 'Kette schmieren'):");
    if (!name) return;

    const t = { id: crypto.randomUUID(), name, intervalDays: 30, lastDateISO: "" };
    wartungsplaene[m].push(t);
    await wpSave();

    wpRefreshTaskList();
    if (E.selTask) E.selTask.value = t.id;
    wpStatusUpdateForTask(t);
    wpEvalWarning();
  });

  // Speichern
  E.btnSave?.addEventListener("click", async () => {
    const t = wpCurrentTask(); if (!t){ alert("Bitte eine Aufgabe w√§hlen."); return; }

    // Intervall absichern (>=1) oder leer
    let inter = toInt(E.interval?.value || "", NaN);
    if (!Number.isFinite(inter) || inter < 1) inter = "";
    t.intervalDays = inter;

    // Datum validieren
    t.lastDateISO  = isIsoDate(E.last?.value) ? E.last.value : "";

await wpSave();
wpRecalcNext?.();
wpEvalWarning?.();
wpUpdateGlobalBanner(); // ‚¨ÖÔ∏è hier


  });

  // L√∂schen
  E.btnDel?.addEventListener("click", async () => {
    const m  = E.selMaschine?.value, id = E.selTask?.value;
    if (!m || !id) return;
    if (!confirm("Diese Wartungsaufgabe wirklich l√∂schen?")) return;

    wartungsplaene[m] = (wartungsplaene[m]||[]).filter(x => x.id !== id);
    await wpSave();

    wpRefreshTaskList();
    wpStatusUpdateForTask(null);
    wpEvalWarning();
  });

  // Heute durchgef√ºhrt
  E.btnDone?.addEventListener("click", async () => {
    const t = wpCurrentTask(); if (!t){ alert("Bitte eine Aufgabe w√§hlen."); return; }
    t.lastDateISO = wpTodayISO();
    await wpSave();

    wpRecalcNext();
    wpEvalWarning();
  });
}

/* Init: beim Laden + nach Login nachziehen */
document.addEventListener("DOMContentLoaded", async () => {
  await wpLoad();
  setupWartungsplanUI();

  // Maschine k√∂nnte schon gesetzt sein
  wpRefreshTaskList();
  wpStatusUpdateForTask(wpCurrentTask());
  wpEvalWarning();

  // Offline-Banner beim Start
  try { wpCheckOverdueAndNotify?.({ sendMail:false }); } catch {}
});

// Beim Login: nachladen + Banner + ggf. Mail (1√ó/Tag)
(function hookLogin(){
  const orig = window.signInAndAcquireToken;
  if (typeof orig === "function"){
    window.signInAndAcquireToken = async function(...args){
      const r = await orig.apply(this, args);
      try {
        await wpLoad();
        wpRefreshTaskList();
        wpStatusUpdateForTask(wpCurrentTask());
        wpEvalWarning();
        // beim Login zus√§tzlich Mail erlauben
        wpCheckOverdueAndNotify?.({ sendMail:true });
      } catch(e){}
      return r;
    };
  }
})();

// Optional: beim Auftragsabschluss automatisch die aktuell gew√§hlte Aufgabe auf ‚Äûheute‚Äú setzen
window.wpMarkCurrentTaskDone = async function(){
  const t = wpCurrentTask(); if (!t) return;
  t.lastDateISO = wpTodayISO();
  await wpSave();
  // nach Abschluss neu bewerten
  try { wpCheckOverdueAndNotify?.({ sendMail:false }); } catch {}
};
</script>




</body>
</html>
