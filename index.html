


<!DOCTYPE html>

<html lang="de">
<head>
  <!-- Build-Version: 1.0.1 - Cache-Bypass -->
  <link href="icon-192.png" rel="apple-touch-icon"/>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>TE 15 Reparaturauftrag 03</title>
<style>
  body {
      font-family: Arial, sans-serif;
      margin: 20px;
  }
  .header, .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .header div, .footer div {
      margin: 5px;
  }
  .section {
      margin-bottom: 20px;
  }
  .section label {
      display: block;
      margin-bottom: 5px;
  }
  .section input, .section select, .section textarea {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
  }
  .signature {
      border: 1px solid #000;
      height: 100px;
      margin-bottom: 20px;
  }

  /* Style f√ºr die Buttons */
  button#saveDraftJsonButton,
  button#loadDraftJsonButton,
  button#closeOrderButton {
      margin: 5px;
      padding: 8px 15px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #0078d4;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s;
  }
  button#saveDraftJsonButton:hover,
  button#loadDraftJsonButton:hover,
  button#closeOrderButton:hover {
      background-color: #005ea0;
  }

  /* ‚úÖ Hier einf√ºgen: Container f√ºr PDF */

</style>
<style>
  /* Druckfarben & Seitenumbr√ºche */
  @media print {
    body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .page-break { page-break-before: always; }
    .no-print { display: none !important; }
  }

  /* Sauberes A4-Layout */
  #pdfExportContainer{
    width:210mm; max-width:210mm;
    padding:10mm 10mm 12mm;
    margin:0 auto;
    background:#fff; color:#000; box-sizing:border-box;
  }

  /* 2-Spalten-Layout f√ºr ‚ÄûLabel : Wert‚Äú */
  .print-field{
    display:grid; grid-template-columns:38% 62%;
    column-gap:12px; align-items:start; padding:6px 0;
    border-bottom:1px solid #e9e9e9;
  }
  .print-label{
    font-weight:700;
    white-space:nowrap;
    min-width:0;
  }
  .print-value{
    white-space:pre-wrap;
    word-break:break-word;
    overflow-wrap:anywhere;
    line-height:1.35;
    min-width:0;
  }

  /* Silbentrennung au√üerhalb des Iframes */
  html[lang="de"] .print-value { hyphens:auto; }

  .print-field > * { min-width:0; }

  .avoid-break{ break-inside:avoid; page-break-inside:avoid; }
  @media (max-width: 820px) { #pdfExportContainer { width:100%; max-width:100%; } }
  canvas { display:block !important; }
  img { max-width:100% !important; height:auto !important; }
</style>



 <style>
  #updateModal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #updateModalContent {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
  }
  #confirmationMessage {
    display: none;
    margin-top: 20px;
    padding: 10px;
    background-color: #e0ffe0;
    border: 1px solid #00aa00;
    border-radius: 5px;
  }
</style>


<style>
/* Snapshot: zweispaltig halten */
.pdf-snapshot .print-field {
  display: grid !important;
  grid-template-columns: 38% 62%;
  column-gap: 12px;
  align-items: start;
  padding: 6px 0;
  border-bottom: 1px solid #e9e9e9;
}

/* WICHTIG: Label darf umbrechen, sonst √ºberdeckt es den Wert */
.pdf-snapshot .print-label {
  white-space: normal !important;
  overflow-wrap: anywhere;
  word-break: break-word;
  min-width: 0;
}

/* bleibt wie gehabt */
.pdf-snapshot .print-value {
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  line-height: 1.35;
  margin-bottom: 6px;
  min-width: 0;
}




</style>



<!-- html2pdf einmalig laden (ohne defer!) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Fallback, falls das CDN mal nicht l√§dt -->
<script>
async function loadHtml2PdfIfNeeded(){
  if (window.html2pdf) return;
  await new Promise(r=>setTimeout(r,0));
  if (window.html2pdf) return;
  await new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
    s.onload = resolve;
    s.onerror = () => reject(new Error('html2pdf konnte nicht geladen werden'));
    document.head.appendChild(s);
  });
}
</script>
  


</head>

<body>
  <!-- Offscreen-Renderframe nur f√ºr den PDF-Export -->
  <iframe id="pdfSandbox"
          style="position:fixed;left:-99999px;top:-99999px;width:820px;height:1200px;visibility:hidden;border:0;"></iframe>

  <div id="updateModal">
<div id="updateModalContent">
<p><strong>Die App wurde aktualisiert.</strong><br/>Bitte best√§tigen Sie die neue Version.</p>
<button onclick="confirmUpdate()">OK</button>
</div>
</div>
<div id="confirmationMessage" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 25px 30px; background-color: #d4edda; color: #155724; border: 3px solid #28a745; border-radius: 12px; font-size: 22px; text-align: center; font-weight: bold; z-index: 9999; box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);"></div>

<div id="abschlussScreen" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;align-items:center;justify-content:center;flex-direction:column;font-size:20px;font-family:sans-serif;z-index:999;">
  <p>‚úÖ Auftrag wurde abgeschlossen.</p>
  <button onclick="window.location.href = 'index.html';" style="margin-top:20px;padding:10px 20px;font-size:16px;background:#007BFF;color:white;border:none;border-radius:6px;">
    Neuen Auftrag starten
  </button>
</div>
<!-- üîê Login/Logout Bereich -->
<div style="margin-bottom: 20px;">
  <button onclick="signInAndAcquireToken(true)" class="no-print"
          style="padding:8px 15px; background:#0078d4; color:white; border:none; border-radius:5px; cursor:pointer;">
    Microsoft anmelden
  </button>
  <button onclick="signOut()" class="no-print"
          style="padding:8px 15px; margin-left:10px; background:#d9534f; color:white; border:none; border-radius:5px; cursor:pointer;">
    Abmelden / Konto wechseln
  </button>
</div>
<div id="loginHint" class="no-print" 
     style="margin-bottom: 20px; padding: 10px; background: #fffbe6; border: 1px solid #e6c200; 
            border-radius: 6px; color: #7a6600; font-size: 14px;">
  ‚ö†Ô∏è Bitte zuerst mit Microsoft anmelden ‚Äì sonst k√∂nnen keine Daten in OneDrive gespeichert oder geladen werden.
</div>

<!-- === üìä Dashboard (auf/zu klappbar) === -->
<div id="ordersDashboard" class="no-print" style="margin:16px 0;">
  <button type="button" id="toggleDashBtn"
          style="padding:8px 12px;border:0;border-radius:6px;background:#0f6cbd;color:#fff;cursor:pointer;">
    üìä Dashboard anzeigen
  </button>

  <div id="dashPanel" style="display:none;margin-top:10px;border:1px solid #ddd;border-radius:8px;padding:12px;">
    <div style="display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;align-items:end;">
      <div>
        <label for="f_bearbeitet_am">Bearbeitet am</label>
        <input type="date" id="f_bearbeitet_am" style="width:100%;padding:6px;">
      </div>
      <div>
        <label for="f_techniker">Techniker</label>
        <input type="text" id="f_techniker" placeholder="z. B. Merker" style="width:100%;padding:6px;">
      </div>
      <div>
        <label for="f_maschine">Maschine</label>
        <input type="text" id="f_maschine" placeholder="z. B. Multivac" style="width:100%;padding:6px;">
      </div>
      <div>
        <label for="f_anlagenteil">Anlagenteil</label>
        <input type="text" id="f_anlagenteil" placeholder="z. B. Sensor" style="width:100%;padding:6px;">
      </div>
    </div>

    <div style="margin:10px 0;">
      <button type="button" id="dashReload"
              style="padding:6px 10px;border:0;border-radius:6px;background:#e5e5e5;cursor:pointer;">
        üîÑ Neu laden
      </button>
      <button type="button" id="dashClear"
              style="padding:6px 10px;border:0;border-radius:6px;background:#f3f3f3;cursor:pointer;margin-left:6px;">
        ‚ùå Filter l√∂schen
      </button>
    </div>

    <div style="overflow:auto;max-height:50vh;border:1px solid #eee;border-radius:6px;">
      <table id="dashTable" style="width:100%;border-collapse:collapse;font-size:14px;">
        <thead style="position:sticky;top:0;background:#fafafa;">
          <tr>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Bearbeitet am</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Techniker</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Maschine</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Anlagenteil</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Auftrags-ID</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="dashEmpty" style="display:none;padding:8px;color:#666;">Keine Auftr√§ge gefunden.</div>
  </div>
</div>


<div id="pdfExportContainer">
<div style="margin-bottom: 12px;">
<label for="auftrag_id" style="display: block; font-weight: bold;">Auftrags-ID:</label>
<input id="auftrag_id" name="auftrag_id" readonly="" style="padding: 6px; width: 100%;" type="text"/>
</div><div style="text-align: center; margin-top: 20px;"><h1 style="font-size: 24px; margin-bottom: 5px;">Reparaturauftrag</h1></div><div style="text-align: left; font-size: 14px; margin-left: 20px; margin-top: 5px;">Formblatt-Nr.: TE15 | Version: 04 | G√ºltig ab: 26.06.2025</div>
<div style="margin-bottom: 12px;"><label for="bearbeitet_am" style="display: block; font-weight: bold;">Bearbeitet am:</label><input id="bearbeitet_am" name="bearbeitet_am" style="padding: 6px; width: 100%;" type="date"/></div><div style="margin-bottom: 12px;"><label for="techniker1" style="display: block; font-weight: bold;">Techniker 1</label><select id="techniker1" name="techniker1" style="width: 100%; padding: 6px;"><option value="Constantin M√ºller-Seeling">Constantin M√ºller-Seeling</option><option value="Pascal Merker">Pascal Merker</option><option value="Tim Eggers">Tim Eggers</option><option value="Udo Mahlmann">Udo Mahlmann</option><option value="Mike Hafermalz">Mike Hafermalz</option><option value="J√∂rg Kowald">J√∂rg Kowald</option><option value="Stafan Wulf">Stafan Wulf</option></select></div><div style="margin-bottom: 12px;"><label for="techniker2" style="display: block; font-weight: bold;">Techniker 2 (optional)</label><select id="techniker2" name="techniker2" style="width: 100%; padding: 6px;"><option value="">‚Äì</option><option value="Constantin M√ºller-Seeling">Constantin M√ºller-Seeling</option><option value="Pascal Merker">Pascal Merker</option><option value="Tim Eggers">Tim Eggers</option><option value="Udo Mahlmann">Udo Mahlmann</option><option value="Mike Hafermalz">Mike Hafermalz</option><option value="J√∂rg Kowald">J√∂rg Kowald</option><option value="Stafan Wulf">Stafan Wulf</option></select></div>
<div class="section">
<label style="display: block; font-weight: bold; margin-top: 12px;">Maschinenausfall</label><select id="maschinenstillstand" name="maschinenstillstand">
<option value="Ja">Ja</option>
<option value="Nein">Nein</option>
</select>
<div style="margin-bottom: 10px;">
<div style="margin-bottom: 10px;">
<label for="maschinenausfall_dauer">Ausfallzeit:</label>
<div style="display: flex; gap: 10px;">
<div>
<input id="ausfall_stunden" max="999" min="0" name="ausfall_stunden" placeholder="Stunden" style="width: 100px; padding: 6px;" type="number"/>
<span>Stunden</span>
</div>
<div>
<input id="ausfall_minuten" max="59" min="0" name="ausfall_minuten" placeholder="Minuten" style="width: 100px; padding: 6px;" type="number"/>
<span>Minuten</span>
</div>  <!-- schlie√üt inneres margin-bottom:10px -->
<!-- ‚ûï fehlend: -->
</div>  <!-- schlie√üt √§u√üeres margin-bottom:10px -->
</div>  <!-- schlie√üt .section (Maschinenausfall) -->
<!-- und erst dann: -->
<div class="section" style="margin-bottom: 12px;">
  <!-- Maschine ... -->

  <label for="maschine" style="display: block; font-weight: bold;">Maschine</label>
  <select id="maschine" name="maschine" style="width: 100%; padding: 6px;">
    <option value="">Bitte ausw√§hlen</option>
    <option value="Sonstige">Sonstige</option>
    <option value="CIP-Raum">CIP-Raum</option>
    <option value="Crepacco links">Crepacco links</option>
    <option value="Crepacco rechts">Crepacco rechts</option>
    <option value="Dora 680">Dora 680</option>
    <option value="Dora 780">Dora 780</option>
    <option value="Gem√ºseschleuder">Gem√ºseschleuder</option>
    <option value="Hebekipper">Hebekipper</option>
    <option value="Hei√ükutter links (735187)">Hei√ükutter links (735187)</option>
    <option value="Hei√ükutter links 735187">Hei√ükutter links 735187</option>
    <option value="Hei√ükutter rechts (733131)">Hei√ükutter rechts (733131)</option>
    <option value="Herstellung R√ºhrer 1">Herstellung R√ºhrer 1</option>
    <option value="Herstellung R√ºhrer 2">Herstellung R√ºhrer 2</option>
    <option value="Herstellung R√ºhrer 3">Herstellung R√ºhrer 3</option>
    <option value="Herstellung R√ºhrer 4">Herstellung R√ºhrer 4</option>
    <option value="Herstellung R√ºhrer 5">Herstellung R√ºhrer 5</option>
    <option value="Herstellung R√ºhrer 6">Herstellung R√ºhrer 6</option>
    <option value="Herstellung R√ºhrer 7">Herstellung R√ºhrer 7</option>
    <option value="Kaltkutter">Kaltkutter</option>
    <option value="Kilomaschine">Kilomaschine</option>
    <option value="Kistenwaschmaschine">Kistenwaschmaschine</option>
    <option value="Klarsicht">Klarsicht</option>
    <option value="Knoblauchbrecher/-sch√§ler">Knoblauchbrecher/-sch√§ler</option>
    <option value="K√§seschneider">K√§seschneider</option>
    <option value="K√ºbelwaschmaschine">K√ºbelwaschmaschine</option>
    <option value="Minirolle 1">Minirolle 1</option>
    <option value="Minirolle 2">Minirolle 2</option>
    <option value="Minirolle 3">Minirolle 3</option>
    <option value="Minirolle 4">Minirolle 4</option>
    <option value="Minirolle 5">Minirolle 5</option>
    <option value="Minirolle 6">Minirolle 6</option>
    <option value="Mondini 2">Mondini 2</option>
    <option value="Multivac 1">Multivac 1</option>
    <option value="Multivac 2">Multivac 2</option>
    <option value="Multivac 3">Multivac 3</option>
    <option value="MVA">MVA</option>
    <option value="Palettenwaschmaschine">Palettenwaschmaschine</option>
    <option value="Paprikaschneider">Paprikaschneider</option>
    <option value="Paprikateiler">Paprikateiler</option>
    <option value="Petrella SB">Petrella SB</option>
    <option value="Rundl√§ufer 1">Rundl√§ufer 1</option>
    <option value="Rundl√§ufer 2">Rundl√§ufer 2</option>
    <option value="R√ºhle Maschine 1+2">R√ºhle Maschine 1+2</option>
    <option value="R√ºhrer 1">R√ºhrer 1</option>
    <option value="R√ºhrer 2">R√ºhrer 2</option>
    <option value="R√ºhrer 3">R√ºhrer 3</option>
    <option value="R√ºhrer 4">R√ºhrer 4</option>
    <option value="R√ºhrer 5">R√ºhrer 5</option>
    <option value="R√ºhrer 6">R√ºhrer 6</option>
    <option value="R√ºhrer 7">R√ºhrer 7</option>
    <option value="Schnittlauch-Porree-Schneider Krone">Schnittlauch-Porree-Schneider Krone</option>
    <option value="Separator 780">Separator 780</option>
    <option value="Vorsp√ºlmaschine K√ºbel">Vorsp√ºlmaschine K√ºbel</option>
  </select>

  <!-- Eingabefeld erscheint nur bei Auswahl "Sonstige" -->
  <label for="sonstige_maschine" id="label-sonstige-maschine" style="display:none; margin-top: 8px;">
    Sonstiges (Maschine):
  </label>
  <input
    id="sonstige_maschine"
    name="sonstige_maschine"
    placeholder="Bitte angeben..."
    type="text"
    style="display:none; margin-top: 5px; width: 100%; padding: 6px;"
  />
</div>
<div class="section" style="margin-bottom: 12px;">
  <label for="anlagenteil" style="display:block; font-weight:bold;">Anlagenteil</label>
  <select id="anlagenteil" name="anlagenteil" style="width:100%; padding:6px;">
    <option value="">Bitte ausw√§hlen</option>
    <option value="Sonstige">Sonstige</option>
    <option value="Magnetschalter">Magnetschalter</option>
    <option value="Abdeckhaube">Abdeckhaube</option>
    <option value="Abdeckplatte">Abdeckplatte</option>
    <option value="Antriebsband">Antriebsband</option>
    <option value="Antriebsrolle">Antriebsrolle</option>
    <option value="Band">Band</option>
    <option value="Buchse">Buchse</option>
    <option value="CEE-Steckdose">CEE-Steckdose</option>
    <option value="CPU">CPU</option>
    <option value="Can Bus Modul">Can Bus Modul</option>
    <option value="Deckelformer">Deckelformer</option>
    <option value="Dichtschnur">Dichtschnur</option>
    <option value="Dichtung">Dichtung</option>
    <option value="Dichtungen">Dichtungen</option>
    <option value="Drehschalter">Drehschalter</option>
    <option value="D√§mpfer">D√§mpfer</option>
    <option value="Ein-Taster">Ein-Taster</option>
    <option value="Elektronik">Elektronik</option>
    <option value="Ersatzwerkzeug">Ersatzwerkzeug</option>
    <option value="FU">FU</option>
    <option value="Feder">Feder</option>
    <option value="Filtereinsatz">Filtereinsatz</option>
    <option value="Harting-Stecker">Harting-Stecker</option>
    <option value="Harting-Verbindung">Harting-Verbindung</option>
    <option value="Heizung">Heizung</option>
    <option value="Hubzylinder">Hubzylinder</option>
    <option value="Ini">Ini</option>
    <option value="Kabel">Kabel</option>
    <option value="Kabel und Lichttaster">Kabel und Lichttaster</option>
    <option value="Kabelverschraubung">Kabelverschraubung</option>
    <option value="Ketten">Ketten</option>
    <option value="Kontakte">Kontakte</option>
    <option value="Kunststoffzahnr√§der">Kunststoffzahnr√§der</option>
    <option value="Lager">Lager</option>
    <option value="Lagerachsen">Lagerachsen</option>
    <option value="Lagerzapfen">Lagerzapfen</option>
    <option value="Leimd√ºse">Leimd√ºse</option>
    <option value="Lichtschranke">Lichtschranke</option>
    <option value="Lichtschranke und Kabel">Lichtschranke und Kabel</option>
    <option value="Lichtschranken">Lichtschranken</option>
    <option value="Lichttaster">Lichttaster</option>
    <option value="Lichttaster und Kabel">Lichttaster und Kabel</option>
    <option value="Luftschlauch">Luftschlauch</option>
    <option value="Magnet">Magnet</option>
    <option value="Modul 121">Modul 121</option>
    <option value="Motor">Motor</option>
    <option value="Netzteil">Netzteil</option>
    <option value="Not-Aus-Schalter">Not-Aus-Schalter</option>
    <option value="PT 100">PT 100</option>
    <option value="Panel">Panel</option>
    <option value="Platine">Platine</option>
    <option value="Poti">Poti</option>
    <option value="Profibus">Profibus</option>
    <option value="Relais">Relais</option>
    <option value="Relais mit Sockel">Relais mit Sockel</option>
    <option value="Rolle">Rolle</option>
    <option value="S7-Steuerung">S7-Steuerung</option>
    <option value="SPS">SPS</option>
    <option value="Schalter">Schalter</option>
    <option value="Schaltergeh√§use">Schaltergeh√§use</option>
    <option value="Schiebef√ºhrung">Schiebef√ºhrung</option>
    <option value="Schlauch">Schlauch</option>
    <option value="Schraube">Schraube</option>
    <option value="Schraube und Dichtung">Schraube und Dichtung</option>
    <option value="Schrauben">Schrauben</option>
    <option value="Sensor">Sensor</option>
    <option value="Sicherheitrelais">Sicherheitrelais</option>
    <option value="Sicherheits-Ausgangsmodul">Sicherheits-Ausgangsmodul</option>
    <option value="Sicherheitsbaugruppe">Sicherheitsbaugruppe</option>
    <option value="Sicherheitsrelais">Sicherheitsrelais</option>
    <option value="Sicherheitsschalter">Sicherheitsschalter</option>
    <option value="Sicherheitsventil">Sicherheitsventil</option>
    <option value="Sicherung">Sicherung</option>
    <option value="Siegelheizung">Siegelheizung</option>
    <option value="Spule">Spule</option>
    <option value="Stator">Stator</option>
    <option value="Steckdose">Steckdose</option>
    <option value="Stecker">Stecker</option>
    <option value="Stecker und Spule">Stecker und Spule</option>
    <option value="Steckereinsatz">Steckereinsatz</option>
    <option value="Steckverbindung">Steckverbindung</option>
    <option value="Stopfen">Stopfen</option>
    <option value="Taster">Taster</option>
    <option value="Tasteroberteil">Tasteroberteil</option>
    <option value="Temperaturf√ºhler">Temperaturf√ºhler</option>
    <option value="Touchpanel">Touchpanel</option>
    <option value="Trichterschalter">Trichterschalter</option>
    <option value="Umlenkrolle">Umlenkrolle</option>
    <option value="Vakuumgenerator">Vakuumgenerator</option>
    <option value="Vakuumpumpe">Vakuumpumpe</option>
    <option value="Vakuumsensor">Vakuumsensor</option>
    <option value="Ventil">Ventil</option>
    <option value="Verriegelungsb√ºgel">Verriegelungsb√ºgel</option>
    <option value="Wartungspaket">Wartungspaket</option>
    <option value="Welle">Welle</option>
    <option value="Zylinder">Zylinder</option>
    <option value="Zylinder und Heizungsregler">Zylinder und Heizungsregler</option>
    <option value="Zylinder und Vakuumventil">Zylinder und Vakuumventil</option>
    <option value="Z√§hler">Z√§hler</option>
    <option value="Dichtring">Dichtring</option>
  </select>

  <label id="label-sonstige-anlagenteil"
         for="sonstige_anlagenteil"
         style="display:none; margin-top:8px;">
    Sonstiges (Anlagenteil):
  </label>
  <input id="sonstige_anlagenteil"
         name="sonstige_anlagenteil"
         type="text"
         placeholder="Bitte angeben..."
         style="display:none; margin-top:5px; width:100%; padding:6px;">
</div>





    <div style="margin-top: 20px;">
  <label style="font-weight: bold; display: block;">Dauer der Reparatur (von - bis Uhrzeit):</label>
  <input id="startzeit" name="start_time" style="margin-right: 10px;" type="time"/>
  <input id="endzeit" name="end_time" style="margin-right: 10px;" type="time"/>
  <input id="dauer" name="dauer" placeholder="Dauer in Stunden" readonly="true" type="text"/>
</div>

<div class="section">
<label for="abschlussdatum">Abschlussdatum der Ausf√ºhrung:</label>
<input id="abschlussdatum" name="abschlussdatum" type="date"/>
</div>
<div class="section">
<label for="fehlerbeschreibung">Fehlerbeschreibung:</label>
<textarea cols="50" id="fehlerbeschreibung" name="fehlerbeschreibung" placeholder="Was war defekt? Was wurde unternommen?" rows="4"></textarea>
</div>
<div class="section">
<label for="reinigung_erforderlich">Reinigung Maschine/Umfeld erforderlich:</label>
<select id="reinigung_erforderlich" name="reinigung_erforderlich">
<option value="ja">Ja</option>
<option value="nein">Nein</option>
</select>
<div style="margin-bottom: 10px;">
<label for="reinigungsart_zusatz">Reinigungsausf√ºhrung:</label>
<select id="reinigungsart_zusatz" name="reinigungsart_zusatz" style="width: 100%; padding: 6px; margin-bottom: 10px;">
<option value="">Bitte ausw√§hlen</option>
<option value="Maschinenpersonal">Maschinenpersonal</option>
<option value="Reinigungsschicht">Reinigungsschicht</option>
<option value="Sonstiges">Sonstiges</option>
</select><input id="sonstige_reinigungsart_zusatz" name="sonstige_reinigungsart_zusatz" placeholder="Bitte angeben..." style="display:none; margin-top: 5px; width: 100%;" type="text"/><input id="reinigungsart_sonstiges" name="reinigungsart_sonstiges" style="display:none; width: 100%; padding: 6px;" type="text"/><label for="reinigungsart_sonstiges" style="display:none;">Sonstiges (Reinigungsausf√ºhrung):</label>
</div>
<div style="margin-bottom: 10px;">
</div>
</div>
<div class="section">
  <p>Die Reparatur ist abgeschlossen und alle eingesetzten Werkzeuge wurden komplett entfernt.</p>
</div>

<div class="page-break"></div>

<div class="section">
  <label for="unterschrift_abnahme">Unterschrift MA Abnahme (Produktkreisfreigabe):</label>
  <canvas class="signature-pad" id="unterschrift_abnahme"></canvas>
  <button onclick="clearSignature(0)" style="margin-top: 8px; display: block;" type="button">Unterschrift l√∂schen</button>
</div>

<div class="page-break"></div>

<div class="section">
  <label for="unterschrift_technik">Unterschrift MA Technik:</label>
  <canvas class="signature-pad" id="unterschrift_technik"></canvas>
  <button type="button" style="margin-top: 8px; display: block;" 
          onclick="clearSignature(1)">Unterschrift l√∂schen</button>

  <div style="margin-top: 24px;">
    <label for="foto" style="font-weight: bold;">Fehlerstelle / Schaden (optional):</label>
    <h2>Fotos f√ºr Reparaturauftrag</h2>
    <input accept="image/*" id="fileInput" multiple type="file" />
    <div class="preview-container" id="previewContainer"></div>
  </div>
</div>


<style>
  .page-break {
    page-break-before: always;
  }
  .preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
  }
  .image-wrapper {
    position: relative;
    display: inline-block;
  }
  .delete-button {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: red;
    color: white;
    border: none;
    padding: 5px;
    cursor: pointer;
    border-radius: 5px;
  }
/* korrekt nur f√ºr Thumbnails der Vorschau */
.preview-container img {
  max-width: 200px;
  max-height: 200px;
  border: 1px solid #ccc;
}

</style>

<script>
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    let uploadedFiles = [];
    fileInput.addEventListener('change', function(event) {
        const files = Array.from(event.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('image-wrapper');
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-button');
                deleteBtn.textContent = 'L√∂schen';
                deleteBtn.addEventListener('click', () => {
                    wrapper.remove();
                    uploadedFiles = uploadedFiles.filter(f => f !== file);
                    console.log("Datei gel√∂scht:", file.name);
                });
                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                previewContainer.appendChild(wrapper);
                uploadedFiles.push(file);
            };
            reader.readAsDataURL(file);
        });
        fileInput.value = '';
    });
</script>

<div class="section">
  <label for="ort_datum">Ort / Datum:</label>
  <input id="ort_datum" name="ort_datum" type="text"/>
</div>


<div style="margin-top: 20px; font-size: 14px; line-height: 1.5; white-space: pre;">
Erstellt: M.Thiemann       Datum: 18.06.2025
Gepr√ºft: M. Hafermalz      Datum: 24.06.2025
Freigegeben: F. Pieper     Datum: 24.06.2025
</div>

</div> <!-- <= HIER und NUR HIER den #pdfExportContainer schlie√üen -->


<!-- ====================== -->
<!-- Buttons au√üerhalb Container -->
<!-- ====================== -->
<button type="button" onclick="saveDraftToOneDrive()">üíæ Entwurf in OneDrive speichern</button>
<button type="button" onclick="showDraftList()">üìÇ Entwurf aus OneDrive laden</button>
<button type="button" onclick="generatePDFAndFinish()">‚úÖ Auftrag abschlie√üen & in OneDrive speichern</button>
<button type="button" onclick="forceUpdate()">‚ôªÔ∏è App aktualisieren (Cache l√∂schen)</button>

<style>
canvas.signature-pad {
  border: 1px solid #000;
  width: 100%;
  height: 100px;
  touch-action: none;
}
</style>
<style>
canvas.signature-pad {
  border: 1px solid #000;
  background: #fff;
  touch-action: none;
  width: 100%;
  max-width: 600px;
  height: 200px;
}
.signature-container {
  margin-bottom: 20px;
}
button.clear-signature {
  margin-top: 5px;
}
</style>


<script>
function initSignaturePad(id) {
  const canvas = document.getElementById(id);
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    // HiDPI/Retina scharf rendern
    const ratio = Math.max(window.devicePixelRatio || 1, 1);

    // CSS-Gr√∂√üe aus dem Layout (Fallbacks, falls offset 0 ist)
    const style = getComputedStyle(canvas);
    const cssW = canvas.offsetWidth  || parseInt(style.width)  || 600;
    const cssH = canvas.offsetHeight || parseInt(style.height) || 200;

    // Interne Aufl√∂sung hochskalieren
    canvas.width  = Math.round(cssW * ratio);
    canvas.height = Math.round(cssH * ratio);

    // Koordinaten wieder in CSS-Pixeln
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

    // Strichstil
    ctx.lineWidth   = 2;
    ctx.lineCap     = 'round';
    ctx.lineJoin    = 'round';
    ctx.strokeStyle = '#000';
  }

  resizeCanvas();
  // ‚Ü≥ Diese Zeile ist neu: bei Fenstergr√∂√üe neu skalieren
  window.addEventListener('resize', resizeCanvas);

  let drawing = false;

  canvas.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    drawing = true;
    const r = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
  }, { passive: false });

  canvas.addEventListener("pointermove", (e) => {
    if (!drawing) return;
    const r = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
    ctx.stroke();
  });

  canvas.addEventListener("pointerup",   () => { drawing = false; });
  canvas.addEventListener("pointerleave",() => { drawing = false; });
}

// Dein Load-Listener kann unver√§ndert bleiben:
window.addEventListener("load", () => {
  initSignaturePad("unterschrift_abnahme");
  initSignaturePad("unterschrift_technik");
});
</script>



<script>
function clearSignature(index) {
    const canvases = document.querySelectorAll("canvas");
    if (canvases[index]) {
        const ctx = canvases[index].getContext("2d");
        ctx.clearRect(0, 0, canvases[index].width, canvases[index].height);
    }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // üü¢ Zeitberechnung
  const startTimeInput = document.getElementById("startzeit");
  const endTimeInput   = document.getElementById("endzeit");
  const durationInput  = document.getElementById("dauer");

  function calculateDuration() {
    const start = startTimeInput?.value;
    const end   = endTimeInput?.value;
    if (start && end) {
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let s = new Date(0,0,0,sh,sm), e = new Date(0,0,0,eh,em);
      let diff = e - s; if (diff < 0) diff += 24*60*60*1000;
      const mins = Math.floor(diff/60000), h = Math.floor(mins/60), m = mins%60;
      durationInput.value = (h?`${h} h `:"") + (m?`${m} min`:(h?"" :"0 min"));
    }
  }
  startTimeInput?.addEventListener("input", calculateDuration);
  endTimeInput?.addEventListener("input", calculateDuration);

  // üü¢ "Sonstige"-Felder anzeigen
  const maschineSelect               = document.getElementById("maschine");
  const sonstigeMaschineInput        = document.getElementById("sonstige_maschine");
  const labelSonstigeMaschine        = document.getElementById("label-sonstige-maschine");

  const anlagenteilSelect            = document.getElementById("anlagenteil");
  const sonstigeAnlagenteilInput     = document.getElementById("sonstige_anlagenteil");
  const labelSonstigeAnlagenteil     = document.getElementById("label-sonstige-anlagenteil");

  const reinigungsartSelect          = document.getElementById("reinigungsart_zusatz");
  const sonstigeReinigungsartInput   = document.getElementById("sonstige_reinigungsart_zusatz");

  function updateMaschineField() {
    const show = maschineSelect?.value === "Sonstige";
    if (sonstigeMaschineInput)  sonstigeMaschineInput.style.display  = show ? "block" : "none";
    if (labelSonstigeMaschine)  labelSonstigeMaschine.style.display  = show ? "block" : "none";
  }

  function updateAnlagenteilField() {
    const show = anlagenteilSelect?.value === "Sonstige";
    if (sonstigeAnlagenteilInput) sonstigeAnlagenteilInput.style.display = show ? "block" : "none";
    if (labelSonstigeAnlagenteil) labelSonstigeAnlagenteil.style.display = show ? "block" : "none";
  }

  function updateReinigungsartField() {
    const show = reinigungsartSelect?.value === "Sonstiges";
    if (sonstigeReinigungsartInput) sonstigeReinigungsartInput.style.display = show ? "block" : "none";
  }

  maschineSelect?.addEventListener("change", updateMaschineField);
  anlagenteilSelect?.addEventListener("change", updateAnlagenteilField);
  reinigungsartSelect?.addEventListener("change", updateReinigungsartField);

  // initialer Zustand
  updateMaschineField();
  updateAnlagenteilField();
  updateReinigungsartField();
});
</script>





<script>
// UUID Generator (v4)
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Lesbare Auftrags-ID
function generateReadableID() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
    return `REP-${year}${month}${day}-${randomPart}`;
}

// Beim Laden die ID setzen
window.addEventListener('load', function() {
    const auftragsID = generateReadableID();
    document.getElementById('auftrag_id').value = auftragsID;
});

</script>







<!-- ‚úÖ MSAL Konfiguration & Login Logik -->

<!-- ‚úÖ MSAL Konfiguration & Login Logik -->
<script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
<script>
  const msalConfig = {
    auth: {
      clientId: "800b6d33-1917-4b4f-abf4-162094f8c862",
      authority: "https://login.microsoftonline.com/f54f53bb-d0ff-4b78-bcf4-4aeeeb924428",
      redirectUri: "https://thiemann423.github.io/Werkstatt-APP/"
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: true },
    system: { allowRedirectInIframe: true }
  };

  const scopes = ["User.Read","openid","profile","offline_access","Files.ReadWrite.All"];
  const msalInstance = new msal.PublicClientApplication(msalConfig);
  let accessToken = "";

  
  function hideLoginHint(){
    const el = document.getElementById("loginHint");
    if (el) el.style.display = "none";
  }
  function showLoginHint(){
    const el = document.getElementById("loginHint");
    if (el) el.style.display = "block";
  }



  // === NEU 1: Redirect-Antwort verarbeiten ‚Äì MUSS direkt nach msalInstance stehen
 
// 1) Redirect-Antwort verarbeiten (muss direkt nach msalInstance stehen)
(async () => {
  try {
    const resp = await msalInstance.handleRedirectPromise();
    if (resp?.account) msalInstance.setActiveAccount(resp.account);
  } catch (e) {
    console.warn("handleRedirectPromise:", e);
  }
})();

// 2) Resolver + Ziel-IDs (GLOBAL!)
const SHARE_URL = "https://petrifeinkost-my.sharepoint.com/:f:/g/personal/merten_thiemann_petri-feinkost_de/EkOa1ufucPNDtlfo6B9rxowB7o8nAY4wHK-gcRha74B2AQ?e=NtbXUx";

const TARGET = { driveId: null, parentItemId: null }; // <- war bei dir nicht definiert
const DRAFTS_FOLDER_NAME = "Reparatur-Entw√ºrfe";
let TARGET_DRAFTS_ITEM_ID = null;

// richtig: shareId = 'u!' + base64url( UTF8( SHARING_URL ) )
function _b64Url(u) {
  const bytes = new TextEncoder().encode(u);      // nur die URL encodieren
  let bin = '';
  for (const b of bytes) bin += String.fromCharCode(b);
  const b64 = btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
  return 'u!' + b64;                               // 'u!' VOR die Base64, nicht hinein!
}


// WICHTIG: als "function ..." deklarieren (wird gehoistet)
async function resolveShareLinkToFolder(){
  if (!accessToken) throw new Error("Kein Access Token");

  // Cache
  const cache = JSON.parse(localStorage.getItem("TARGET_CACHE") || "null");
  if (cache?.shareUrl === SHARE_URL && cache?.driveId && cache?.parentItemId){
    TARGET.driveId = cache.driveId;
    TARGET.parentItemId = cache.parentItemId;
    TARGET_DRAFTS_ITEM_ID = cache.draftsItemId || null;
    return;
  }

  // Share-Link ‚Üí Drive & Ordner
  const encoded = _b64Url(SHARE_URL);
  const res = await fetch(
    `https://graph.microsoft.com/v1.0/shares/${encoded}/driveItem?$select=id,name,parentReference,folder,file`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  if (!res.ok){
    throw new Error(`shares/driveItem: ${res.status} ${await res.text()}`);
  }
  const item = await res.json();
  const folderItemId = item.folder ? item.id : item.parentReference?.id;
  const driveId = item.parentReference?.driveId;
  if (!driveId || !folderItemId) throw new Error("Zielordner konnte nicht bestimmt werden.");

  TARGET.driveId = driveId;
  TARGET.parentItemId = folderItemId;

  // Optional: Unterordner f√ºr Entw√ºrfe anlegen
  const r2 = await fetch(
    `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${folderItemId}/children?$select=id,name,folder`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  if (r2.ok){
    const data = await r2.json();
    const drafts = (data.value||[]).find(x => x.name === DRAFTS_FOLDER_NAME && x.folder);
    if (drafts) TARGET_DRAFTS_ITEM_ID = drafts.id;
    else {
      const create = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${folderItemId}/children`,
        {
          method: "POST",
          headers: { Authorization: `Bearer ${accessToken}`, "Content-Type":"application/json" },
          body: JSON.stringify({ name: DRAFTS_FOLDER_NAME, folder: {}, "@microsoft.graph.conflictBehavior": "ignore" })
        }
      );
      if (create.ok) TARGET_DRAFTS_ITEM_ID = (await create.json()).id;
    }
  }

  localStorage.setItem("TARGET_CACHE", JSON.stringify({
    shareUrl: SHARE_URL,
    driveId: TARGET.driveId,
    parentItemId: TARGET.parentItemId,
    draftsItemId: TARGET_DRAFTS_ITEM_ID
  }));
}

//<!-- ... alles davor: msalConfig, scopes, msalInstance, handleRedirectPromise, resolveShareLinkToFolder, signInAndAcquireToken ... -->

// 3) Login/Token nur per Redirect (Popup auf GitHub Pages meiden)
async function signInAndAcquireToken(interactive = false) {
  try {
    let account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];

    if (!account && interactive) {
      await msalInstance.loginRedirect({ scopes });
      return; // kommt nach Redirect zur√ºck
    }
    if (!account) { showLoginHint(); return; }

    try {
      const t = await msalInstance.acquireTokenSilent({ scopes, account });
      accessToken = t.accessToken;
    } catch (e) {
      await msalInstance.acquireTokenRedirect({ scopes });
      return; // kommt nach Redirect zur√ºck
    }

    await resolveShareLinkToFolder();
    hideLoginHint();
  } catch (e) {
    console.error("signInAndAcquireToken:", e);
    showLoginHint();
  }
}

/* === HIER einf√ºgen: signOut() === */
async function signOut(){
  try{
    const acc = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
    if (acc) {
      localStorage.removeItem("TARGET_CACHE");     // Zielordner-Cache leeren
      await msalInstance.logoutRedirect({ account: acc });
      return;                                      // kommt nach Redirect zur√ºck
    }
  } catch(e){
    console.error("logout:", e);
  }
}

/* und dann dein DOMContentLoaded wie gehabt */
document.addEventListener("DOMContentLoaded", () => {
  const acc = msalInstance.getAllAccounts()[0];
  if (acc) msalInstance.setActiveAccount(acc);
  signInAndAcquireToken(false);
});
</script>











<!-- üîΩ Hier unten startet dein gro√ües Script-Block -->
<script>
// ====================
// Draft-Funktionen
// ====================

// ====================
// Draft-Funktionen
// ====================
const fieldIds = [
  "auftrag_id",
  "bearbeitet_am",
  "techniker1",
  "techniker2",
  "maschinenstillstand",
  "ausfall_stunden",
  "ausfall_minuten",
  "maschine",
  "sonstige_maschine",
  "anlagenteil",
  "sonstige_anlagenteil",
  "startzeit",
  "endzeit",
  "dauer",
  "abschlussdatum",
  "fehlerbeschreibung",
  "reinigung_erforderlich",
  "reinigungsart_zusatz",
  "sonstige_reinigungsart_zusatz",
  "reinigungsart_sonstiges",
  "ort_datum"
];






// ====================
// OneDrive-Upload (robuster, mit Fehlertext)
// ====================
// ====================
// OneDrive-Upload (robuster, mit Fehlertext)
// ====================
async function uploadToOneDrive(filename, blob, mime = "application/pdf") {
  if (!accessToken) { alert("‚ö†Ô∏è Kein Zugriffstoken. Bitte anmelden."); return false; }
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("‚ö†Ô∏è Zielordner nicht initialisiert."); return false; }

  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${TARGET.parentItemId}:/${encodeURIComponent(filename)}:/content`;

  try {
    const res = await fetch(url, {
      method: "PUT",
      headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": mime },
      body: blob
    });

    if (!res.ok) {
      const text = await res.text().catch(() => "");
      console.error("Upload-Fehler:", res.status, text);
    }
    return res.ok;
  } catch (err) {
    console.error("Fehler beim Upload:", err);
    return false;
  }
}


// ====================
// Formular ‚Üí statischer Inhalt (f√ºr PDF)
// ====================
function convertFormElementsToStaticText(container){
  // Immer im Kontext des IFRAME-Dokuments arbeiten
  const d   = container.ownerDocument;
  const win = d.defaultView || window;

  // 0) UI-Elemente ausblenden
  container.querySelectorAll('button, input[type="file"], .delete-button')
           .forEach(el => el.style.display = 'none');

  // Vorschau-Thumbnails im PDF gro√ü & ohne Rahmen
  container.querySelectorAll('.preview-container img').forEach(img => {
    img.style.maxWidth = '100%';
    img.style.maxHeight = 'none';
    img.style.border = '0';
    img.loading = 'eager';
  });

  // Helper
  const processedIds = new Set();
  const addRow = (labelText, valueText, beforeNode) => {
    if (!valueText || !valueText.toString().trim()) return;
    const row = d.createElement('div'); row.className = 'print-field';
    const l   = d.createElement('div'); l.className   = 'print-label'; l.textContent = labelText;
    const v   = d.createElement('div'); v.className   = 'print-value'; v.textContent = valueText;
    row.append(l, v);
    const parent = (beforeNode && beforeNode.parentNode) || container;
    parent.insertBefore(row, beforeNode || null);
  };

  // ===== 1) Spezialf√§lle vorab =====

  // 1a) Ausfallzeit (2 Inputs ‚Üí 1 Zeile)
  {
    const ausLabel = container.querySelector('label[for="maschinenausfall_dauer"]');
    const ausSt  = container.querySelector('#ausfall_stunden');
    const ausMin = container.querySelector('#ausfall_minuten');
    if (ausSt || ausMin){
      const value =
        (ausSt?.value ? `${ausSt.value} h` : '') +
        (ausMin?.value ? `${ausSt?.value ? ' ' : ''}${ausMin.value} min` : '');
      addRow('Ausfallzeit', value.trim(), ausLabel || ausSt);
      ausSt?.remove(); ausMin?.remove();
      const flex = ausLabel?.nextElementSibling; if (flex && flex.matches('div')) flex.remove();
      ausLabel?.remove();
      processedIds.add('ausfall_stunden'); processedIds.add('ausfall_minuten');
    }
  }

  // 1b) Reparaturdauer (Start/Ende/Dauer ‚Üí 1 Zeile)
  {
    const start = container.querySelector('#startzeit');
    const end   = container.querySelector('#endzeit');
    const dur   = container.querySelector('#dauer');
    const dauerLabel = (start?.previousElementSibling?.tagName === 'LABEL') ? start.previousElementSibling : null;
    if (start || end || dur){
      const value = `${start?.value || ''} ‚Äì ${end?.value || ''}${dur?.value ? ` (${dur.value})` : ''}`.trim();
      addRow('Reparaturdauer (von ‚Äì bis)', value, dauerLabel || start);
      start?.remove(); end?.remove(); dur?.remove(); dauerLabel?.remove();
      processedIds.add('startzeit'); processedIds.add('endzeit'); processedIds.add('dauer');
    }
  }

  // 1c) Techniker 1/2 ‚Äì Spezial
  {
    const cleanLabel = (el, fb) => ((el?.textContent || fb || '')
      .replace(/:\s*$/, '')
      .replace(/\s*\(optional\)\s*$/i, ''));

    function addTechniker(id, fb) {
      const sel = container.querySelector('#' + id);
      if (!sel) return;
      const labelEl = (sel.previousElementSibling?.tagName === 'LABEL') ? sel.previousElementSibling : null;

      // sichtbarer Text und value
      const val = (sel.value || '').trim();
      const txt = (sel.options[sel.selectedIndex]?.text || val).trim();

      // TK2: Platzhalter (leer/‚Äû‚Äì‚Äú) √ºberspringen
      if (id === 'techniker2' && (!val || val === '‚Äì')) {
        sel.remove(); labelEl?.remove(); processedIds.add(id); return;
      }

      if (txt) addRow(cleanLabel(labelEl, fb), txt, labelEl || sel);
      sel.remove(); labelEl?.remove();
      processedIds.add(id);
    }

    addTechniker('techniker1', 'Techniker 1');
    addTechniker('techniker2', 'Techniker 2');
  }

 // 1d) Reinigung (Ja/Nein + Ausf√ºhrung + Sonstiges) ‚Äì extra robust
{
  const reqSel   = container.querySelector('#reinigung_erforderlich');
  const artSel   = container.querySelector('#reinigungsart_zusatz');
  const artOther = container.querySelector('#sonstige_reinigungsart_zusatz');
  const section  = reqSel ? reqSel.closest('.section') : null;

  const getSelectText = (sel) => {
    if (!sel) return '';
    // 1) bevorzugt: im Klon abgelegter sichtbarer Text
    let t = (sel.getAttribute('data-selected-text') || '').trim();

    // 2) normaler Weg (kann bei selectedIndex = -1 ausfallen)
    if (!t && sel.selectedIndex >= 0) {
      const o = sel.options[sel.selectedIndex];
      t = ((o && (o.textContent || o.innerText)) || '').trim();
    }

    // 3) Fallback: Value ‚Üí Ja/Nein (besonders wichtig f√ºr reqSel)
    if (!t) {
      const v = String(sel.value || '').toLowerCase();
      if      (v === 'ja')   t = 'Ja';
      else if (v === 'nein') t = 'Nein';
    }

    // 4) letzter Versuch: Option per Value suchen und Text nehmen
    if (!t && sel.value) {
      const byVal = sel.querySelector(`option[value="${sel.value.replace(/"/g,'\\"')}"]`);
      t = ((byVal && (byVal.textContent || byVal.innerText)) || '').trim();
    }
    return t;
  };

  // Ja/Nein (Reinigung erforderlich)
  if (reqSel) {
    const txt = getSelectText(reqSel);

    // Label ermitteln (nicht hart codieren)
    const labelEl =
      (reqSel.previousElementSibling && reqSel.previousElementSibling.tagName === 'LABEL')
        ? reqSel.previousElementSibling
        : container.querySelector('label[for="reinigung_erforderlich"]');

    const labelTxt = (labelEl?.textContent || 'Reinigung Maschine/Umfeld erforderlich')
      .replace(/:\s*$/, '')
      .trim();

    if (txt) addRow(labelTxt, txt, section || reqSel);

    labelEl?.remove();
    reqSel.remove();
    processedIds.add('reinigung_erforderlich');
  }

  // Reinigungsausf√ºhrung
  if (artSel) {
    const artTxt  = getSelectText(artSel);
    const labelEl = (artSel.previousElementSibling?.tagName === 'LABEL') ? artSel.previousElementSibling : null;
    const labelTxt = (labelEl?.textContent || 'Reinigungsausf√ºhrung')
      .replace(/:\s*$/, '')
      .trim();

    if (artTxt && artTxt !== 'Bitte ausw√§hlen') {
      addRow(labelTxt, artTxt, section || artSel);
    }

    labelEl?.remove();
    artSel.remove();
    processedIds.add('reinigungsart_zusatz');
  }

  // Sonstiges-Text zur Reinigungsausf√ºhrung
  if (artOther) {
    const otherVal = (artOther.value || '').trim();
    const labelEl  = (artOther.previousElementSibling?.tagName === 'LABEL') ? artOther.previousElementSibling : null;
    const labelTxt = (labelEl?.textContent || 'Reinigungsausf√ºhrung (Sonstiges)')
      .replace(/:\s*$/, '')
      .trim();

    if (otherVal) addRow(labelTxt, otherVal, section || artOther);

    labelEl?.remove();
    artOther.remove();
    processedIds.add('sonstige_reinigungsart_zusatz');
  }
}


  // ===== 2) Generisch f√ºr alle restlichen Felder =====
  const placeholders = new Set(['', '-', '‚Äì', '‚Äî', 'Bitte ausw√§hlen']);
  const isPlaceholder = (t) => placeholders.has((t||'').trim());
  const formatDate = (v) => { try { if (!v) return ''; const d2 = new Date(v); return isNaN(d2) ? v : d2.toLocaleDateString('de-DE'); } catch { return v || ''; } };

  const fields = Array.from(container.querySelectorAll('input, select, textarea'));
  fields.forEach(el => {
    if (processedIds.has(el.id)) { el.remove(); return; } // Spezialf√§lle √ºberspringen

    const cs = win.getComputedStyle(el);
    if (el.type === 'hidden' || el.type === 'file' ||
        cs.display === 'none' || cs.visibility === 'hidden' ||
        (el.offsetWidth === 0 && el.offsetHeight === 0)) {
      el.remove(); return;
    }

    const label = (el.previousElementSibling?.tagName === 'LABEL') ? el.previousElementSibling : null;

    let val = '';
    if (el.tagName === 'SELECT') {
      // 1) bevorzugt im Klon gespeicherten Text nehmen
      val = (el.getAttribute('data-selected-text') || '').trim();
      // 2) sonst den sichtbaren Option-Text
      if (!val) {
        const opt = el.options[el.selectedIndex];
        val = ((opt && (opt.textContent || opt.innerText)) || '').trim();
      }
      // 3) Placeholder filtern
      if (isPlaceholder(val)) val = '';
    } else if (el.type === 'date') {
      val = formatDate(el.value);
    } else if (el.tagName === 'TEXTAREA') {
      val = (el.value || '').trim();
    } else {
      val = (el.value || '').trim();
    }

    if (!val) { el.remove(); label?.remove(); return; }

    const row = d.createElement('div'); row.className = 'print-field';
    const l   = d.createElement('div'); l.className   = 'print-label';
    l.textContent = (label ? label.textContent : (el.name || el.id || '')).replace(/:\s*$/, '');
    const vDiv = d.createElement('div'); vDiv.className = 'print-value'; vDiv.textContent = val;
    row.append(l, vDiv);

    const parent = label ? label.parentNode : el.parentNode;
    parent.insertBefore(row, label || el);
    label?.remove();
    el.remove();
  });

  // ===== 3) Canvas ‚Üí IMG (falls noch vorhanden)
  container.querySelectorAll('canvas').forEach(c => {
    const img = d.createElement('img');
    try { img.src = c.toDataURL('image/png'); } catch(e) { console.warn('Canvas toDataURL fehlgeschlagen', e); }
    img.style.width = '100%';
    img.className = 'avoid-break';
    c.parentNode.replaceChild(img, c);
  });

  // ===== 4) Bilderbl√∂cke zusammenhalten
  container.querySelectorAll('.preview-container').forEach(pc => pc.classList.add('avoid-break'));

  // ===== 5) Sicherheit: versehentliche Duplikate entfernen
  const rows = Array.from(container.querySelectorAll('.print-field'));
  for (let i = 1; i < rows.length; i++) {
    const prev = rows[i - 1];
    const curr = rows[i];
    if (prev && curr && prev.textContent.trim() === curr.textContent.trim()) {
      curr.remove();
    }
  }
}











// ====================
// Auftrag abschlie√üen ‚Üí PDF erzeugen & hochladen
// ====================


async function generatePDFAndFinish() {
  // 0) Lib + Login
  await loadHtml2PdfIfNeeded();
  if (!window.html2pdf) { alert("html2pdf konnte nicht geladen werden."); return; }

  await signInAndAcquireToken(true);
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }

  const src = document.getElementById("pdfExportContainer");
  if (!src) { alert("Container nicht gefunden."); return; }

  // A) Canvas aus dem ORIGINAL sichern (id -> DataURL)
  const signatureMap = new Map(
    Array.from(src.querySelectorAll('canvas')).map(c => {
      try { return [c.id, c.toDataURL('image/png')]; }
      catch (e) { console.warn('toDataURL fehlgeschlagen', e); return [c.id, null]; }
    })
  );

// B) Isoliertes OFFSCREEN-IFRAME benutzen (ignoriert Seiten-/Text-Zoom)
const frame = document.getElementById('pdfSandbox');
if (!frame) { alert("PDF-Frame fehlt."); return; }

const doc = frame.contentDocument || frame.contentWindow?.document;
if (!doc) { alert("PDF-Dokumentkontext nicht verf√ºgbar."); return; }

doc.open();
doc.write(`<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=794, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html,body{margin:0;padding:0;background:#fff;}
    #root{width:794px; box-sizing:border-box; padding:0;}
    html,body,#root{-webkit-text-size-adjust:none;text-size-adjust:none;}
    #root, #root *{ font-family:"Inter", Arial, sans-serif !important; line-height:1.35; box-sizing:border-box; }

    /* Container im Iframe */
    #pdfExportContainerClone{ width:794px; padding:20px; margin:0 auto; background:#fff; }

    /* 2-Spalten-Layout erzwingen */
    .print-field{
      display:grid !important;
      grid-template-columns:38% 62%;
      column-gap:12px;
      align-items:start;
      padding:6px 0;
      border-bottom:1px solid #e9e9e9;
    }
  .print-label{
  font-weight:700;
  white-space: normal;        /* umbrechen erlauben */
  overflow-wrap: anywhere;    /* lange W√∂rter trennen */
  word-break: break-word;
  min-width: 0;
}

    .print-value{
      white-space:pre-wrap;
      word-break:break-word;     /* bricht sehr lange W√∂rter */
      overflow-wrap:anywhere;    /* zus√§tzliche Sicherheit */
      hyphens:auto;              /* DE-Silbentrennung aktiv */
      line-height:1.4;
      min-width:0;
    }
    .print-field > * { min-width:0; } /* f√ºr beide Spalten */

    .avoid-break{ break-inside:avoid; page-break-inside:avoid; }
    img{ max-width:100% !important; height:auto !important; border:0 !important; display:block; }
    canvas{ display:block !important; }

    h1{ font-size:24px; margin:0 0 8px; text-align:center; }
    @page { size: A4; margin: 0; }
  </style>
</head>
<body><div id="root"></div></body>
</html>`);
doc.close();


  // C) html2pdf INS IFRAME laden (falls noch nicht vorhanden)
  if (!frame.contentWindow.html2pdf) {
    await new Promise((resolve, reject) => {
      const s = doc.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      s.onload = resolve;
      s.onerror = () => reject(new Error('html2pdf im Iframe konnte nicht geladen werden.'));
      doc.head.appendChild(s);
    });
  }

// D) Inhalt klonen (nur im KLON √§ndern)
const clone = src.cloneNode(true);
clone.id = 'pdfExportContainerClone';
clone.classList.add('pdf-snapshot');
clone.style.width = '794px';
clone.style.maxWidth = '794px';
clone.style.margin = '0';
clone.style.padding = '20px';
clone.style.background = '#ffffff';

/* Select-Werte √ºbernehmen + sichtbaren Text zwischenspeichern */
clone.querySelectorAll('select').forEach(sel => {
  const orig = src.querySelector('#' + sel.id);
  if (!orig) return;
  sel.value = orig.value;
  Array.from(sel.options).forEach(o => o.selected = (o.value === orig.value));
  const checked = sel.querySelector('option:checked');
  let displayText = (checked?.textContent || checked?.innerText || sel.value || '').trim();
  if (sel.id === 'reinigung_erforderlich') {
    const v = (sel.value || displayText || '').trim().toLowerCase();
    displayText = v === 'ja' ? 'Ja' : v === 'nein' ? 'Nein' : displayText;
  }
  sel.setAttribute('data-selected-text', displayText);
});
;

/* Canvas -> IMG mit gesicherter DataURL */
clone.querySelectorAll('canvas').forEach(c => {
  const url = signatureMap.get(c.id);
  if (!url) return;
  const img = doc.createElement('img');
  img.src = url;
  img.style.maxWidth = '100%';
  img.style.height = 'auto';
  img.className = 'avoid-break';
  c.parentNode.replaceChild(img, c);
});

/* Klon ins iFrame h√§ngen ‚Ä¶ */
doc.getElementById('root').appendChild(clone);

/* ‚Ä¶ und JETZT Formular ‚Üí statischen Inhalt wandeln */
convertFormElementsToStaticText(clone);

/* Thumbnails im PDF gro√ü darstellen */
clone.querySelectorAll('.preview-container img').forEach(img => {
  img.style.maxWidth = '100%';
  img.style.maxHeight = '';
  img.style.border = '0';
  img.style.display = 'block';
});


  try {
    // E) Warten bis Fonts & Bilder im Iframe geladen sind
    if (doc.fonts && doc.fonts.ready) { await doc.fonts.ready; }
    const imgs = doc.images;
    await Promise.all([...imgs].map(img => img.complete ? Promise.resolve()
      : new Promise(res => { img.onload = img.onerror = res; })));

    // F) Dateiname
    const auftragIdField = document.getElementById("auftrag_id");
    let auftragId = auftragIdField?.value?.trim();
    if (!auftragId) {
      const datePart = new Date().toISOString().split("T")[0].replace(/-/g, "");
      auftragId = `REP-${datePart}-${crypto.randomUUID().slice(0,4).toUpperCase()}`;
      if (auftragIdField) auftragIdField.value = auftragId;
    }
    const filename = `${auftragId}.pdf`;

    // G) html2pdf-Optionen (fester Layout-Kontext!)
    const height = doc.getElementById('root').scrollHeight;
    const opt = {
      margin: 0,
      filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        scrollX: 0, scrollY: 0,
        windowWidth: 794,
        windowHeight: height,
        logging: false,
        foreignObjectRendering: false
      },
      jsPDF: {
        unit: 'px',
        format: [794, 1123], // A4 @96DPI
        orientation: 'portrait'
      },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    // H) Rendern (IM IFRAME!)
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    const h2p = frame.contentWindow.html2pdf;
    const worker  = h2p().set(opt).from(doc.getElementById('root')).toPdf();
    const pdfBlob = await worker.get('pdf').then(pdf => pdf.output('blob'));

    // I) Upload & UI
    const success = await uploadToOneDrive(filename, pdfBlob);
    if (success) {
      alert("‚úÖ PDF erfolgreich in OneDrive gespeichert!");
      await deleteDraftFile?.();
      document.getElementById("abschlussScreen").style.display = "flex";
    } else {
      alert("‚ö†Ô∏è Fehler beim Hochladen in OneDrive.");
    }
  } catch (err) {
    console.error("‚ùå Fehler bei PDF-Erstellung/Upload:", err);
    alert("‚ùå PDF konnte nicht erstellt oder hochgeladen werden.");
  } finally {
    // optional: Iframe leeren (nicht entfernen)
    try { doc.body.innerHTML = '<div id="root"></div>'; } catch {}
  }
}








// ====================
// Sonstiges
// ====================
function forceUpdate() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
      for (let registration of registrations) registration.unregister();
    }).then(function() {
      caches.keys().then(function(names) { for (let name of names) caches.delete(name); });
    }).then(function() {
      alert("‚úÖ Cache & Service Worker gel√∂scht. Seite wird neu geladen.");
      location.reload(true);
    });
  }
}

// üíæ ENTWURF SPEICHERN
async function saveDraftToOneDrive() {
  await signInAndAcquireToken(true);
  await resolveShareLinkToFolder();
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const draftData = {};
  fieldIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) draftData[id] = el.value;
  });

  const draftJson = JSON.stringify(draftData, null, 2);
  const blob = new Blob([draftJson], { type: "application/json" });

  const auftragId = document.getElementById('auftrag_id')?.value || "ohne-id";
  const draftFilename = `Entwurf-${auftragId}.json`;

  // Falls der Unterordner existiert, dorthin; sonst in den Hauptordner
  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;

  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${parentId}:/${encodeURIComponent(draftFilename)}:/content`;

  const res = await fetch(url, {
    method: "PUT",
    headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": "application/json" },
    body: blob
  });

  if (res.ok) { alert("‚úÖ Entwurf erfolgreich gespeichert!"); }
  else { alert("‚ö†Ô∏è Fehler beim Speichern des Entwurfs."); }
}


// üì• ENTWURF LADEN
async function loadDraftFromOneDrive(fileName) {
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;
  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${parentId}:/${encodeURIComponent(fileName)}:/content`;

  try {
    const res = await fetch(url, { method: "GET", headers: { Authorization: `Bearer ${accessToken}` } });
    if (!res.ok) { alert("‚ö†Ô∏è Fehler beim Laden des Entwurfs."); return; }

    const draftData = await res.json();
    fieldIds.forEach(id => {
      const el = document.getElementById(id);
      if (el && draftData[id] !== undefined) el.value = draftData[id];
    });

    alert("‚úÖ Entwurf erfolgreich geladen!");
  } catch (err) {
    console.error("Fehler beim Laden:", err);
    alert("‚ùå Fehler beim Laden des Entwurfs.");
  }
}


// üìÇ ENTWURFSLISTE ANZEIGEN
async function showDraftList() {
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;

  try {
    const res = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${parentId}/children?$select=id,name,file,folder`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    const data = await res.json();
    const files = (data.value || []).filter(item => item.name.endsWith(".json"));
    if (!files.length) { alert("‚ö†Ô∏è Keine Entw√ºrfe gefunden."); return; }

    let list = "Verf√ºgbare Entw√ºrfe:\n\n";
    files.forEach((f, i) => { list += `${i + 1}: ${f.name}\n`; });

    const numberInput = prompt("Bitte die Nummer des Entwurfs eingeben:\n\n" + list);
    const idx = parseInt(numberInput, 10) - 1;

    if (!isNaN(idx) && files[idx]) {
      // F√ºr sp√§teres L√∂schen merken wir uns Name + ID
      window.currentDraftFileName = files[idx].name;
      window.currentDraftFileId   = files[idx].id;

      await loadDraftFromOneDrive(files[idx].name);
    } else {
      alert("‚ö†Ô∏è Ung√ºltige Nummer.");
    }
  } catch (err) {
    console.error("Fehler beim Abrufen der Liste:", err);
    alert("‚ùå Fehler beim Abrufen der Entw√ºrfe.");
  }
}


// üóëÔ∏è ENTWURF L√ñSCHEN
async function deleteDraftFile() {
  if (!accessToken) return;
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { console.warn("Zielordner nicht initialisiert."); return; }

  // Bevorzugt mit der gespeicherten Item-ID l√∂schen
  if (window.currentDraftFileId) {
    try {
      await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${window.currentDraftFileId}`,
        { method: "DELETE", headers: { Authorization: `Bearer ${accessToken}` } }
      );
      console.log("‚úÖ Entwurfsdatei gel√∂scht:", window.currentDraftFileName);
      window.currentDraftFileName = null;
      window.currentDraftFileId = null;
    } catch (err) {
      console.error("‚ùå Fehler beim L√∂schen der Entwurfsdatei:", err);
    }
    return;
  }

  // Fallback: Wenn wir nur den Namen haben, versuche die ID aus dem Ordner zu ermitteln
  if (window.currentDraftFileName) {
    try {
      const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;
      const res = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${parentId}/children?$select=id,name`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      const data = await res.json();
      const match = (data.value || []).find(x => x.name === window.currentDraftFileName);
      if (!match) { console.warn("Datei nicht gefunden:", window.currentDraftFileName); return; }

      await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${match.id}`,
        { method: "DELETE", headers: { Authorization: `Bearer ${accessToken}` } }
      );
      console.log("‚úÖ Entwurfsdatei gel√∂scht:", window.currentDraftFileName);
      window.currentDraftFileName = null;
      window.currentDraftFileId = null;
    } catch (err) {
      console.error("‚ùå Fehler beim L√∂schen der Entwurfsdatei:", err);
    }
  }
}

window.confirmUpdate = function () {
  const modal = document.getElementById('updateModal');
  if (modal) modal.style.display = 'none';

  const msg = document.getElementById('confirmationMessage');
  if (msg) {
    msg.style.display = 'block';
    setTimeout(() => { msg.style.display = 'none'; }, 2500);
  }
};
</script>



</body>
</html>
