

<!DOCTYPE html>
<html lang="de">
<head>
  <!-- Build-Version: 1.0.1 - Cache-Bypass -->
  <link href="icon-192.png" rel="apple-touch-icon"/>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>TE 15 Reparaturauftrag 03</title>
<style>
  body {
  
      font-family: Arial, sans-serif;
      margin: 20px;
  }
  .header, .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .header div, .footer div {
      margin: 5px;
  }
  .section {
      margin-bottom: 20px;
  }
  .section label {
      display: block;
      margin-bottom: 5px;
  }
  .section input, .section select, .section textarea {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
  }
  .signature {
      border: 1px solid #000;
      height: 100px;
      margin-bottom: 20px;
  }
  /* Style f√ºr die Buttons */
  button#saveDraftJsonButton,
  button#loadDraftJsonButton,
  button#closeOrderButton {
      margin: 5px;
      padding: 8px 15px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #0078d4;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s;
  }
  button#saveDraftJsonButton:hover,
  button#loadDraftJsonButton:hover,
  button#closeOrderButton:hover {
      background-color: #005ea0;
  }

  /* ‚úÖ Hier einf√ºgen: Container f√ºr PDF */

</style>
<style>
  /* Druckfarben & Seitenumbr√ºche */
  @media print {
    body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .page-break { page-break-before: always; }
    .no-print { display: none !important; }
  }

  /* Sauberes A4-Layout */
  #pdfExportContainer{
    width:210mm; max-width:210mm;
    padding:10mm 10mm 12mm;
    margin:0 auto;
    background:#fff; color:#000; box-sizing:border-box;
  }

  /* 2-Spalten-Layout f√ºr ‚ÄûLabel : Wert‚Äú */
  .print-field{
    display:grid; grid-template-columns:38% 62%;
    column-gap:12px; align-items:start; padding:6px 0;
    border-bottom:1px solid #e9e9e9;
  }
  .print-label{
    font-weight:700;
    white-space:nowrap;
    min-width:0;
  }
  .print-value{
    white-space:pre-wrap;
    word-break:break-word;
    overflow-wrap:anywhere;
    line-height:1.35;
    min-width:0;
  }

  /* Silbentrennung au√üerhalb des Iframes */
  html[lang="de"] .print-value { hyphens:auto; }

  .print-field > * { min-width:0; }

  .avoid-break{ break-inside:avoid; page-break-inside:avoid; }
  @media (max-width: 820px) { #pdfExportContainer { width:100%; max-width:100%; } }
  canvas { display:block !important; }
  img { max-width:100% !important; height:auto !important; }
</style>



 <style>
  #updateModal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #updateModalContent {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
  }
  #confirmationMessage {
    display: none;
    margin-top: 20px;
    padding: 10px;
    background-color: #e0ffe0;
    border: 1px solid #00aa00;
    border-radius: 5px;
  }
</style>


<style>
/* Snapshot: zweispaltig halten */
/* Snapshot: zweispaltig (Flex statt Grid -> kein √úberlapp-Bug in html2canvas) */
.pdf-snapshot .print-field{
  display: flex !important;
  flex-wrap: nowrap !important;
  align-items: flex-start !important;
  padding: 8px 0 !important;
  border-bottom: 1px solid #e9e9e9 !important;
  gap: 12px !important;               /* moderne Browser; falls kein gap, regelt padding rechts am Label */
}

.pdf-snapshot .print-label{
  white-space: normal !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  min-width: 0 !important;

  flex: 0 0 38% !important;           /* feste Spaltenbreite links */
  max-width: 38% !important;
  padding-right: 12px !important;     /* fallback, wenn gap fehlt */
}

.pdf-snapshot .print-value{
  white-space: pre-wrap !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  hyphens: auto !important;
  line-height: 1.4 !important;
  margin-bottom: 6px !important;
  min-width: 0 !important;

  flex: 1 1 62% !important;           /* rechte Spalte f√ºllt */
  max-width: 62% !important;
}



/* Label darf umbrechen */
.pdf-snapshot .print-label{
  white-space: normal !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  min-width: 0 !important;
}

/* Wert: vollst√§ndiger Umbruch + Silbentrennung */
.pdf-snapshot .print-value{
  white-space: pre-wrap !important;     /* Zeilenumbr√ºche erhalten + umbrechen */
  overflow-wrap: anywhere !important;   /* lange ‚ÄûW√∂rter‚Äú umbrechen */
  word-break: break-word !important;
  hyphens: auto !important;             /* Silbentrennung (de) */
  line-height: 1.4 !important;          /* etwas mehr Luft */
  margin-bottom: 6px !important;
  min-width: 0 !important;
}
</style>


<style>
  .field-error { border: 2px solid #d9534f !important; background:#fff6f6; }
  .error-text  { color:#d9534f; font-size:12px; margin:-6px 0 10px 0; }
</style>

<!-- üîé Analytics-Styles (NEU) -->
<style>
  .analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .bar-row{display:grid;grid-template-columns:1fr auto 40px;gap:8px;align-items:center;padding:4px 0;cursor:pointer}
  .bar{height:10px;background:#eee;border-radius:6px;overflow:hidden}
  .bar-fill{height:100%;background:#0f6cbd}
  .bar-label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bar-count{font-variant-numeric:tabular-nums;text-align:right}
  @media (max-width:720px){.analytics-grid{grid-template-columns:1fr}}
</style>

<!-- html2pdf einmalig laden (ohne defer!) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Fallback, falls das CDN mal nicht l√§dt -->
<script>
async function loadHtml2PdfIfNeeded(){
  if (window.html2pdf) return;
  await new Promise(r => setTimeout(r, 0));
  if (window.html2pdf) return;

  await new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
    s.onload = resolve;
    s.onerror = () => reject(new Error('html2pdf konnte nicht geladen werden'));
    document.head.appendChild(s);
  });
}
</script>

  


</head>

<body>
  <!-- Offscreen-Renderframe nur f√ºr den PDF-Export -->
  <iframe id="pdfSandbox"
          style="position:fixed;left:-99999px;top:-99999px;width:820px;height:1200px;visibility:hidden;border:0;"></iframe>

  <div id="updateModal">
<div id="updateModalContent">
<p><strong>Die App wurde aktualisiert.</strong><br/>Bitte best√§tigen Sie die neue Version.</p>
<button onclick="confirmUpdate()">OK</button>
</div>
</div>
<div id="confirmationMessage" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 25px 30px; background-color: #d4edda; color: #155724; border: 3px solid #28a745; border-radius: 12px; font-size: 22px; text-align: center; font-weight: bold; z-index: 9999; box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);"></div>

<div id="abschlussScreen" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;align-items:center;justify-content:center;flex-direction:column;font-size:20px;font-family:sans-serif;z-index:999;">
  <p>‚úÖ Auftrag wurde abgeschlossen.</p>
  <button onclick="window.location.href = 'index.html';" style="margin-top:20px;padding:10px 20px;font-size:16px;background:#007BFF;color:white;border:none;border-radius:6px;">
    Neuen Auftrag starten
  </button>
</div>

<!-- üîê Login/Logout Bereich -->
<div style="margin-bottom: 20px;">
  <button onclick="signInAndAcquireToken(true)" class="no-print"
          style="padding:8px 15px; background:#0078d4; color:white; border:none; border-radius:5px; cursor:pointer;">
    Microsoft anmelden
  </button>
  <button onclick="signOut()" class="no-print"
          style="padding:8px 15px; margin-left:10px; background:#d9534f; color:white; border:none; border-radius:5px; cursor:pointer;">
    Abmelden / Konto wechseln
  </button>
  <!-- Wartung: Toggle-Button im Kopf -->
  <button id="wartungToggleHead" class="no-print"
          style="padding:8px 12px; margin-left:10px; background:#198754; color:white; border:none; border-radius:6px; cursor:pointer;">
    üõ†Ô∏è Wartung
  </button>
</div>

<!-- üî¥ Globale Wartungswarnung (sichtbar auch bei zuem Panel; nur App, nicht im PDF) -->
<div id="wpGlobalOverdueBanner" class="no-print"
     style="display:none;margin:10px 0;padding:10px 12px;border-left:6px solid #dc3545;
            background:#f8d7da;color:#842029;border-radius:6px;align-items:center;
            gap:10px;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:10px;">
    <span style="font-size:20px;line-height:1;">‚ö†Ô∏è</span>
    <span data-msg>Es gibt √ºberf√§llige Wartungen.</span>
  </div>
  <button id="wpOpenFromBanner"
          style="border:0;border-radius:6px;background:#dc3545;color:#fff;
                 padding:6px 10px;cursor:pointer;">
    Wartung √∂ffnen
  </button>
</div>

<!-- üîî Globaler Hinweis (generisch; nur App, nicht im PDF) -->
<div id="wpGlobalAlert" class="no-print"
     style="display:none; margin:10px 0 20px 0; padding:10px 12px;
            border:1px solid #dc3545; background:#f8d7da; color:#842029;
            border-radius:6px; font-size:14px;">
  <!-- Inhalt wird per JS gesetzt -->
</div>

<!-- üîê Login-Hinweis (einmalig; keine doppelte id) -->
<div id="loginHint" class="no-print"
     style="margin-bottom: 20px; padding: 10px; background: #fffbe6; border: 1px solid #e6c200;
            border-radius: 6px; color: #7a6600; font-size: 14px;">
  ‚ö†Ô∏è Bitte zuerst mit Microsoft anmelden ‚Äì sonst k√∂nnen keine Daten in OneDrive gespeichert oder geladen werden.
</div>




<!-- === üìä Dashboard (auf/zu klappbar) === -->
<div id="ordersDashboard" class="no-print" style="margin:16px 0;">
  <button type="button" id="toggleDashBtn"
          style="padding:8px 12px;border:0;border-radius:6px;background:#0f6cbd;color:#fff;cursor:pointer;">
    üìä Dashboard anzeigen
  </button>
  
<button
  type="button"
  id="toggleWpLogBtn"
  onclick="(function(){
    var p=document.getElementById('wpLogPanel');
    if(!p){alert('Hinweis: #wpLogPanel nicht gefunden.');return;}
    var open=(p.style.display===''||p.style.display==='none');
    p.style.display=open?'block':'none';
    // beim √ñffnen Daten laden (falls Funktionen existieren)
    try{ if(open && typeof wpLogLoad==='function') wpLogLoad(); }catch(e){}
    try{ if(open && typeof renderWpLogTable==='function') renderWpLogTable(); }catch(e){}
  })()"
  aria-controls="wpLogPanel"
  aria-expanded="false"
  title="Wartungs-Dashboard (Alt+W)"
  style="padding:8px 12px;border:0;border-radius:6px;background:#0f6cbd;color:#fff;cursor:pointer;margin-left:6px;">
  üß∞ Wartungs-Dashboard
</button>


<script>
/* Failsafe: Toggle bereitstellen + Button sicher aktivieren */
(function () {
  // Toggle nur definieren, falls noch nicht vorhanden
  if (!window.__toggleWpLogPanel) {
    window.__toggleWpLogPanel = function () {
      var p = document.getElementById('wpLogPanel');
      if (!p) { alert('Hinweis: #wpLogPanel nicht gefunden.'); return; }
      var willOpen = (p.style.display === '' || p.style.display === 'none');
      p.style.display = willOpen ? 'block' : 'none';

      // ARIA aktualisieren
      var btn = document.getElementById('toggleWpLogBtn');
      if (btn) btn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');

      // Beim √ñffnen Daten laden
      if (willOpen) {
        if (typeof wpLogLoad === 'function') { try { wpLogLoad(); } catch(e) {} }
        if (typeof renderWpLogTable === 'function') { try { renderWpLogTable(); } catch(e) {} }
      }
    };
  }

// Button sicher aktivieren + Zusatzlistener
window.addEventListener('load', function () {
  var btn = document.getElementById('toggleWpLogBtn');
  var panel = document.getElementById('wpLogPanel');
  if (btn) {
    btn.removeAttribute('disabled');
    btn.setAttribute('aria-controls', 'wpLogPanel');
    btn.setAttribute('aria-expanded', (panel && panel.style.display === 'block') ? 'true' : 'false');
    // ‚ùå diese Zeile bitte raus:
    // btn.addEventListener('click', window.__toggleWpLogPanel);
  }
});


  // Tastaturk√ºrzel: Alt+W
  window.addEventListener('keydown', function (e) {
    if (e.altKey && (e.key === 'w' || e.key === 'W')) {
      e.preventDefault();
      window.__toggleWpLogPanel();
    }
  });
})();
</script>

<script>
/* ===== Globaler Wartungs-Hinweis ohne ge√∂ffnetes Dashboard ===== */
(function(){
  // kleine Helfer (nutzt vorhandene, wenn sie da sind)
  const wpEls = window.wpEls || function(){
    return {
      selMaschine: document.getElementById('selMaschine') || document.querySelector('#selMaschine, [name="maschine"], select[data-maschine]')
    };
  };
  const wpNorm = window.wpNorm || (s => String(s||"").toLowerCase().trim());

  function toISO(d){
    if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    const dt = d instanceof Date ? d : new Date();
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
  }
  function addDays(iso, n){
    if (!iso) return "";
    const d = new Date(iso); if (isNaN(d)) return "";
    d.setDate(d.getDate() + Number(n||0));
    return toISO(d);
  }
  function cmpISO(a,b){ return a===b ? 0 : (a<b ? -1 : 1); }

  // Sichere Quelle f√ºr f√§llige/√ºberf√§llige Eintr√§ge
  function getDueList(){
    // Wenn deine neue computeDueMap() existiert, nutze sie
    if (typeof window.computeDueMap === 'function'){
      const map = window.computeDueMap();
      const out = [];
      for (const [,v] of map){
        if (v.status === 'today' || v.status === 'overdue'){
          out.push({
            machine: v.machine || "",
            task: v.taskName || "",
            nextDue: v.nextDue || "",
            status: v.status
          });
        }
      }
      return out;
    }
    // Fallback (falls computeDueMap nicht vorhanden ist)
    const list = Array.isArray(window.wartungslog) ? window.wartungslog : [];
    const latest = new Map();
    for (const e of list){
      const key = `${(e.machine||"").trim()}||${(e.taskName||"").trim()}`;
      const last = (e.dateISO||"").trim();
      if (!latest.has(key) || (last && last > (latest.get(key).dateISO||""))){
        latest.set(key, e);
      }
    }
    const today = toISO(new Date());
    const out = [];
    latest.forEach(e=>{
      const intv = (e.intervalDays==="" || e.intervalDays==null) ? 0 : Number(e.intervalDays);
      const next = (e.dateISO && intv) ? addDays(e.dateISO, intv) : "";
      if (!next) return;
      const status = cmpISO(next, today) < 0 ? 'overdue' : (cmpISO(next, today)===0 ? 'today' : 'ok');
      if (status !== 'ok'){
        out.push({ machine: e.machine||"", task: e.taskName||"", nextDue: next, status });
      }
    });
    return out;
  }

  // √ñffnet Dashboard + w√§hlt Maschine
  function wpOpenMachineFromName(name){
    try{
      const { selMaschine } = wpEls();
      if (selMaschine){
        const norm = wpNorm(name);
        const opt = [...selMaschine.options].find(
          o => wpNorm(o.value) === norm || wpNorm(o.textContent||"") === norm
        );
        if (opt){
          selMaschine.value = opt.value;
          selMaschine.dispatchEvent(new Event('change', { bubbles:true }));
        }
      }
      // Wartungs-Panel √∂ffnen (falls vorhanden)
      document.querySelector('[data-wp-panel="wartung"]')?.click();
      // Alternativ: dein vorhandener Toggle-Button
      if (!document.querySelector('[data-wp-panel="wartung"]')) {
        document.getElementById('toggleWpLogBtn')?.click();
      }
    }catch(e){ console.warn('wpOpenMachineFromName:', e); }
  }

  // Rote Badge am Kopf-Button
  function setWartungBadge(on){
    const btn = document.getElementById('wartungToggleHead');
    if (!btn) return;
    let dot = btn.querySelector('.wp-badge-dot');
    if (on && !dot){
      dot = document.createElement('span');
      dot.className = 'wp-badge-dot';
      Object.assign(dot.style, {
        display:'inline-block', width:'10px', height:'10px',
        background:'#dc3545', borderRadius:'999px', marginLeft:'8px',
        verticalAlign:'middle'
      });
      btn.appendChild(dot);
    }
    if (!on && dot){ dot.remove(); }
  }

  // Banner + Alert bef√ºllen
  function renderGlobalOverdueUI(due){
    const banner = document.getElementById('wpGlobalOverdueBanner');
    const openBtn = document.getElementById('wpOpenFromBanner');
    const alertBox = document.getElementById('wpGlobalAlert');

    // Banner
    if (banner){
      if (due.length){
        const msgEl = banner.querySelector('[data-msg]');
        if (msgEl){
          const over = due.filter(d => d.status==='overdue').length;
          const tod  = due.filter(d => d.status==='today').length;
          msgEl.textContent =
            over ? `Es gibt ${over} √ºberf√§llige und ${tod} heute f√§llige Wartungen.` :
                   `Es gibt ${tod} heute f√§llige Wartungen.`;
        }
        banner.style.display = 'flex';
      } else {
        banner.style.display = 'none';
      }
    }

    // Button im Banner f√ºhrt ‚Äì falls nur 1 Eintrag ‚Äì direkt dorthin
    if (openBtn){
      openBtn.onclick = () => {
        if (due.length === 1 && due[0].machine){
          wpOpenMachineFromName(due[0].machine);
        } else {
          // Mehrere: √∂ffne Dashboard, der Nutzer w√§hlt dort
          document.getElementById('toggleWpLogBtn')?.click();
        }
      };
    }

    // Alert-Liste mit Klick
    if (alertBox){
      if (due.length){
        const items = due.slice(0, 8).map(d => {
          const label = [d.machine, d.task].filter(Boolean).join(' ‚Äì ');
          const when  = d.nextDue ? ` (${d.nextDue}${d.status==='overdue' ? ' √ºberf√§llig' : ' heute'})` : '';
          return `<li><button data-goto="${encodeURIComponent(d.machine||'')}"
                     style="all:unset;cursor:pointer;text-decoration:underline;color:#842029;">
                     ${label}${when}</button></li>`;
        }).join('');
        alertBox.innerHTML = `
          <strong>‚ö†Ô∏è Wartung f√§llig:</strong>
          <ul style="margin:6px 0 0 18px;list-style:disc;">${items}</ul>
        `;
        alertBox.style.display = 'block';

        alertBox.querySelectorAll('button[data-goto]').forEach(btn=>{
          btn.addEventListener('click', (ev)=>{
            const name = decodeURIComponent(ev.currentTarget.getAttribute('data-goto')||'');
            if (name) wpOpenMachineFromName(name);
          });
        });
      } else {
        alertBox.style.display = 'none';
        alertBox.innerHTML = '';
      }
    }

    // Badge am Kopf-Button
    setWartungBadge(due.length > 0);
  }

  // Start-Check (ohne Dashboard)
  document.addEventListener('DOMContentLoaded', function(){
    try{
      // Logs laden, falls Funktion vorhanden
      if (typeof window.wpLogLoad === 'function'){ try{ window.wpLogLoad(); }catch(e){} }
      const due = getDueList();
      renderGlobalOverdueUI(due);
    }catch(e){
      console.warn('Globaler Wartungs-Check:', e);
    }
  });
})();
</script>

  

<!-- z-index-Kapselung f√ºrs Sticky-Header -->
<div id="dashPanel" style="display:none;margin-top:10px;border:1px solid #ddd;border-radius:8px;padding:12px;position:relative;">
  <div style="display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;align-items:end;">
    <div>
      <label for="f_bearbeitet_am">Bearbeitet am</label>
      <input type="date" id="f_bearbeitet_am" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="f_techniker">Techniker</label>
      <input type="text" id="f_techniker" placeholder="z. B. Merker" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="f_maschine">Maschine</label>
      <input type="text" id="f_maschine" placeholder="z. B. Multivac" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="f_anlagenteil">Anlagenteil</label>
      <input type="text" id="f_anlagenteil" placeholder="z. B. Sensor" style="width:100%;padding:6px;">
    </div>
  </div>

  <div style="margin:10px 0;">
    <button type="button" id="dashReload"
            style="padding:6px 10px;border:0;border-radius:6px;background:#e5e5e5;cursor:pointer;">
      üîÑ Neu laden
    </button>
    <button type="button" id="dashClear"
            style="padding:6px 10px;border:0;border-radius:6px;background:#f3f3f3;cursor:pointer;margin-left:6px;">
      ‚ùå Filter l√∂schen
    </button>
    <button type="button" id="dashRangeBtn" data-mode="30"
            style="padding:6px 10px;border:0;border-radius:6px;background:#d9edf7;margin-left:6px;cursor:pointer;">
     üóìÔ∏è Letzte 30 Tage
    </button>
  </div>

  <div style="overflow:auto;max-height:50vh;border:1px solid #eee;border-radius:6px;">
    <table id="dashTable" style="width:100%;border-collapse:collapse;font-size:14px;">
      <!-- Sticky-Header bleibt innerhalb des Panels -->
      <thead style="position:sticky;top:0;background:#fafafa;z-index:1;">
        <tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Bearbeitet am</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Techniker</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Maschine</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Anlagenteil</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Auftrags-ID</th>
        </tr>
      </thead>
      <tbody id="dashboardBody"></tbody>
    </table>
  </div>

  <div id="dashEmpty" style="display:none;padding:8px;color:#666;">Keine Auftr√§ge gefunden.</div>

  <!-- üîé Analytics-Bl√∂cke -->
  <div id="dashAnalytics" style="display:none; margin-top:12px; padding-top:10px; border-top:1px solid #eee;">
    <div style="font-weight:600; margin-bottom:6px;">üîé H√§ufigste Eintr√§ge (aktuelle Filter)</div>
    <div class="analytics-grid">
      <div>
        <div style="font-weight:600; margin-bottom:6px;">Maschinen ‚Äì Top 5</div>
        <div id="topMachines"></div>
      </div>
      <div>
        <div style="font-weight:600; margin-bottom:6px;">Anlagenteile ‚Äì Top 5</div>
        <div id="topParts"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ BEGIN: Wartungs-Dashboard (Log) + Logik -->
<!-- ===== Wartungs-Dashboard (Log) ===== -->
<div id="wpLogPanel" style="display:none;margin-top:10px;border:1px solid #ddd;border-radius:8px;padding:12px;position:relative;">

  <div style="display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;align-items:end;">
    <div>
      <label for="wpLog_from">Von</label>
      <input type="date" id="wpLog_from" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="wpLog_to">Bis</label>
      <input type="date" id="wpLog_to" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="wpLog_machine">Maschine</label>
      <input type="text" id="wpLog_machine" placeholder="z. B. Minirolle" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="wpLog_task">Aufgabe</label>
      <input type="text" id="wpLog_task" placeholder="z. B. Vakuumf√ºller" style="width:100%;padding:6px;">
    </div>
  </div>

  <div style="display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;align-items:end;margin-top:10px;">
    <div>
      <label for="wpLog_tech">Techniker</label>
      <input type="text" id="wpLog_tech" placeholder="Name oder Teil" style="width:100%;padding:6px;">
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button type="button" id="wpLogReload"
              style="padding:6px 10px;border:0;border-radius:6px;background:#e5e5e5;cursor:pointer;">
        üîÑ Neu laden
      </button>
      <button type="button" id="wpLogClear"
              style="padding:6px 10px;border:0;border-radius:6px;background:#f3f3f3;cursor:pointer;">
        ‚ùå Filter l√∂schen
      </button>
      <button type="button" id="wpLogRangeBtn" data-mode="30"
              style="padding:6px 10px;border:0;border-radius:6px;background:#d9edf7;cursor:pointer;">
        üóìÔ∏è Letzte 30 Tage
      </button>
    </div>
    <div></div><div></div>
  </div>

  <div style="overflow:auto;max-height:50vh;border:1px solid #eee;border-radius:6px;margin-top:10px;">
    <table id="wpLogTable" style="width:100%;border-collapse:collapse;font-size:14px;">
      <thead style="position:sticky;top:0;background:#fafafa;z-index:1;">
        <tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Datum</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Maschine</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Aufgabe</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Intervall</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Schmiernippel</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Techniker</th>
        </tr>
      </thead>
      <tbody id="wpLogBody"></tbody>
    </table>
  </div>

  <div id="wpLogEmpty" style="display:none;padding:8px;color:#666;">Keine Eintr√§ge gefunden.</div>
</div>

<script>
/* ========= Wartungs-Log: Speicherung + Anzeige (localStorage) ========= */
const WP_STORAGE_KEY = "wpLog";

/* üßæ Eintrag speichern ‚Äì wird √ºber #wpSaveTask ausgel√∂st */
function saveWpTask() {
  const today = new Date().toISOString().split("T")[0];

  const task = {
    // wenn du lieber das Feld "Zuletzt durchgef√ºhrt" nehmen willst:
    // date: document.getElementById("wpLastDate")?.value || today,
    date: today,
    machine: document.getElementById("maschine")?.value || "",
    task: document.getElementById("wpTaskSelect")?.value || "",
    interval: document.getElementById("wpIntervalDays")?.value || "",
    nipCount: document.getElementById("wpNipCount")?.value || "",
    tech: document.getElementById("techniker1")?.value || ""
  };

  const list = JSON.parse(localStorage.getItem(WP_STORAGE_KEY) || "[]");
  list.push(task);
  localStorage.setItem(WP_STORAGE_KEY, JSON.stringify(list));
  alert("Wartung gespeichert!");

  // Wenn das Wartungs-Dashboard sichtbar ist, sofort aktualisieren
  const panel = document.getElementById("wpLogPanel");
  if (panel && panel.style.display !== "none") {
    loadWpLog();
  }
}

/* üîé Filter einsammeln */
function getWpFilters() {
  const from  = document.getElementById("wpLog_from")?.value || "";
  const to    = document.getElementById("wpLog_to")?.value || "";
  const mach  = (document.getElementById("wpLog_machine")?.value || "").trim().toLowerCase();
  const task  = (document.getElementById("wpLog_task")?.value || "").trim().toLowerCase();
  const tech  = (document.getElementById("wpLog_tech")?.value || "").trim().toLowerCase();
  return { from, to, mach, task, tech };
}

/* üßÆ Datums-Check */
function inDateRange(dateStr, from, to) {
  if (!dateStr) return false;
  if (from && dateStr < from) return false;
  if (to && dateStr > to) return false;
  return true;
}

/* üìã Tabelle aus localStorage bauen (mit Filtern) */
function loadWpLog() {
  const tbody = document.getElementById("wpLogBody");
  const empty = document.getElementById("wpLogEmpty");
  if (!tbody) return;

  const { from, to, mach, task, tech } = getWpFilters();
  const raw = JSON.parse(localStorage.getItem(WP_STORAGE_KEY) || "[]");

  const data = raw.filter(e => {
    const dateOk = inDateRange(e.date || "", from, to);
    const machOk = !mach || (e.machine || "").toLowerCase().includes(mach);
    const taskOk = !task || (e.task || "").toLowerCase().includes(task);
    const techOk = !tech || (e.tech || "").toLowerCase().includes(tech);
    return dateOk && machOk && taskOk && techOk;
  });

  tbody.innerHTML = "";
  if (!data.length) {
    if (empty) empty.style.display = "block";
    return;
  }
  if (empty) empty.style.display = "none";

  // optional: nach Datum absteigend sortieren
  data.sort((a,b) => (b.date||"").localeCompare(a.date||""));

  data.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.date || ""}</td>
      <td>${e.machine || ""}</td>
      <td>${e.task || ""}</td>
      <td>${e.interval || ""}</td>
      <td>${e.nipCount || ""}</td>
      <td>${e.tech || ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* üßº Filter l√∂schen */
function clearWpFilters() {
  ["wpLog_from","wpLog_to","wpLog_machine","wpLog_task","wpLog_tech"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
  loadWpLog();
}

/* üóìÔ∏è ‚ÄûLetzte 30 Tage‚Äú (Button toggelt 30/90/365) */
function setWpRange(btn) {
  const modes = ["30","90","365"];
  const nowMode = btn.getAttribute("data-mode") || "30";
  const nextMode = modes[(modes.indexOf(nowMode)+1) % modes.length];
  btn.setAttribute("data-mode", nextMode);

  // Button-Label
  btn.textContent = nextMode === "30" ? "üóìÔ∏è Letzte 30 Tage"
                  : nextMode === "90" ? "üóìÔ∏è Letzte 90 Tage"
                  : "üóìÔ∏è Letzte 365 Tage";

  // Von/Bis setzen
  const today = new Date();
  const days = parseInt(nextMode, 10);
  const from = new Date(today);
  from.setDate(today.getDate() - days + 1);

  const toStr   = today.toISOString().split("T")[0];
  const fromStr = from.toISOString().split("T")[0];

  const fromEl = document.getElementById("wpLog_from");
  const toEl   = document.getElementById("wpLog_to");
  if (fromEl) fromEl.value = fromStr;
  if (toEl)   toEl.value   = toStr;

  loadWpLog();
}

/* üîå Verdrahten (wenn DOM geladen ist) */
window.addEventListener("load", () => {
  // Speichern aus dem Wartungs-Panel (Button existiert bereits in deinem Wartungsplan-Panel)
  document.getElementById("wpSaveTask")?.addEventListener("click", saveWpTask);

  // Wartungs-Log Panel: Buttons
  document.getElementById("wpLogReload")?.addEventListener("click", loadWpLog);
  document.getElementById("wpLogClear")?.addEventListener("click", clearWpFilters);
  document.getElementById("wpLogRangeBtn")?.addEventListener("click", (e) => setWpRange(e.currentTarget));

  // Filterfelder reagieren live
  ["wpLog_from","wpLog_to","wpLog_machine","wpLog_task","wpLog_tech"].forEach(id => {
    const el = document.getElementById(id);
    el?.addEventListener("input", loadWpLog);
  });



  // Falls Panel beim Start schon sichtbar ist
  const panel = document.getElementById("wpLogPanel");
  if (panel && panel.style.display !== "none") loadWpLog();
});
</script>
<!-- ‚úÖ END: Wartungs-Dashboard (Log) + Logik -->




<!-- ‚¨áÔ∏è WICHTIG: Ab hier ist alles im PDF-Container -->
<div id="pdfExportContainer">

 <!-- ===== Stammdaten Kopfbereich (untereinander + Techniker-Dropdowns) ===== -->
<div class="section" style="margin-bottom:16px;">
  <div style="display:grid;grid-template-columns:1fr;gap:12px;">

    <!-- Auftrags-ID -->
    <div>
      <label for="auftrag_id" style="font-weight:bold;">Auftrags-ID</label>
      <input id="auftrag_id" name="auftrag_id" type="text" readonly
             title="Wird automatisch vergeben"
             style="padding:6px;width:100%;background:#f7f7f7;">
    </div>

    <!-- Bearbeitet am -->
    <div>
      <label for="bearbeitet_am" style="font-weight:bold;">Bearbeitet am</label>
      <input id="bearbeitet_am" name="bearbeitet_am" type="date" style="padding:6px;width:100%;">
    </div>

    <!-- Techniker 1 -->
    <div>
      <label for="techniker1" style="font-weight:bold;">Techniker 1</label>
      <select id="techniker1" name="techniker1" style="padding:6px;width:100%;">
        <option value="">Bitte ausw√§hlen</option>
        <option value="Sonstige">Sonstige</option>
      </select>
      <input id="sonstiger_techniker1" type="text" placeholder="Bitte angeben‚Ä¶"
             style="display:none;margin-top:6px;padding:6px;width:100%;">
    </div>

    <!-- Techniker 2 -->
    <div>
      <label for="techniker2" style="font-weight:bold;">Techniker 2 (optional)</label>
      <select id="techniker2" name="techniker2" style="padding:6px;width:100%;">
        <option value="">Bitte ausw√§hlen</option>
        <option value="Sonstige">Sonstige</option>
      </select>
      <input id="sonstiger_techniker2" type="text" placeholder="Bitte angeben‚Ä¶"
             style="display:none;margin-top:6px;padding:6px;width:100%;">
    </div>

  </div>
</div>

<script>
/* üëá Basisliste deiner Techniker ‚Äì einfach erweiterbar */
const TECHNIKER_BASE = [
  "Constantin M√ºller-Seeling",
  "Pascal Merker",
  "Tim Eggers",
  "Udo Mahlmann",
  "Mike Hafermalz",
  "J√∂rg Kowald",
  "Stefan Wulf"
];


/* Dropdown + Sonstige-Funktion aufbauen */
function setupTechnikerSelect(selId, otherId){
  const sel   = document.getElementById(selId);
  const other = document.getElementById(otherId);
  if (!sel) return;

  // Technikerliste bef√ºllen
  TECHNIKER_BASE.forEach(n => {
    const exists = [...sel.options].some(o => (o.value||o.textContent).toLowerCase() === n.toLowerCase());
    if (!exists){
      if (typeof addOptionUnique === "function") addOptionUnique(sel, n);
      else sel.add(new Option(n, n));
    }
  });

  const toggleOther = () => {
    if (other) other.style.display = (sel.value === "Sonstige") ? "block" : "none";
  };

  sel.addEventListener("change", () => {
    if (sel.value !== "Sonstige" && other && other.value.trim()){
      const v = other.value.trim();
      if (typeof addOptionUnique === "function") addOptionUnique(sel, v, { autoselect:true });
      else { sel.add(new Option(v, v)); sel.value = v; }
      other.value = "";
    }
    toggleOther();
  });

  other?.addEventListener("blur", () => {
    const v = (other.value || "").trim();
    if (!v) return;
    if (typeof addOptionUnique === "function") addOptionUnique(sel, v, { autoselect:true });
    else { sel.add(new Option(v, v)); sel.value = v; }
    other.value = "";
    toggleOther();
  });

  toggleOther();
}

window.addEventListener("load", () => {
  setupTechnikerSelect("techniker1", "sonstiger_techniker1");
  setupTechnikerSelect("techniker2", "sonstiger_techniker2");
});

</script>



  <!-- ‚¨ÜÔ∏è Rest deines Formulars folgt hier (Maschine, Anlagenteil, ‚Ä¶) und bleibt unver√§ndert -->


<!-- ‚úÖ Maschinenausfall -->
<div class="section" style="margin-bottom:12px;">
  <label for="maschinenstillstand" style="display:block;font-weight:bold;margin-top:12px;">Maschinenausfall</label>
  <select id="maschinenstillstand" name="maschinenstillstand" style="width:100%;padding:6px;margin-bottom:10px;">
    <option value="" selected>Bitte ausw√§hlen</option>
    <option value="Ja">Ja</option>
    <option value="Nein">Nein</option>
  </select>

  <div id="ausfallzeit_wrap" style="margin-bottom:10px; display:none;">
    <label for="ausfall_stunden">Ausfallzeit:</label>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <div>
        <input id="ausfall_stunden" name="ausfall_stunden"
               type="number" inputmode="numeric" step="1" min="0" max="999"
               placeholder="Stunden" style="width:110px;padding:6px;" disabled>
        <span>Stunden</span>
      </div>
      <div>
        <input id="ausfall_minuten" name="ausfall_minuten"
               type="number" inputmode="numeric" step="1" min="0" max="59"
               placeholder="Minuten" style="width:110px;padding:6px;" disabled>
        <span>Minuten</span>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Maschine -->
<div class="section" style="margin-bottom:12px;">
  <label for="maschine" style="display:block;font-weight:bold;">Maschine</label>
  <select id="maschine" name="maschine" style="width:100%;padding:6px;" autocomplete="off">
    <option value="">Bitte ausw√§hlen</option>
    <option value="Sonstige">Sonstige</option>
    <option value="CIP-Raum">CIP-Raum</option>
    <option value="Crepacco links">Crepacco links</option>
    <option value="Crepacco rechts">Crepacco rechts</option>
    <option value="Dora 680">Dora 680</option>
    <option value="Dora 780">Dora 780</option>
    <option value="Gem√ºseschleuder">Gem√ºseschleuder</option>
    <option value="Hebekipper">Hebekipper</option>
    <option value="Hei√ükutter links (735187)">Hei√ükutter links (735187)</option>
    <option value="Hei√ükutter links 735187">Hei√ükutter links 735187</option>
    <option value="Hei√ükutter rechts (733131)">Hei√ükutter rechts (733131)</option>
    <option value="Herstellung R√ºhrer 1">Herstellung R√ºhrer 1</option>
    <option value="Herstellung R√ºhrer 2">Herstellung R√ºhrer 2</option>
    <option value="Herstellung R√ºhrer 3">Herstellung R√ºhrer 3</option>
    <option value="Herstellung R√ºhrer 4">Herstellung R√ºhrer 4</option>
    <option value="Herstellung R√ºhrer 5">Herstellung R√ºhrer 5</option>
    <option value="Herstellung R√ºhrer 6">Herstellung R√ºhrer 6</option>
    <option value="Herstellung R√ºhrer 7">Herstellung R√ºhrer 7</option>
    <option value="Kaltkutter">Kaltkutter</option>
    <option value="Kilomaschine">Kilomaschine</option>
    <option value="Kistenwaschmaschine">Kistenwaschmaschine</option>
    <option value="Klarsicht">Klarsicht</option>
    <option value="Knoblauchbrecher/-sch√§ler">Knoblauchbrecher/-sch√§ler</option>
    <option value="K√§seschneider">K√§seschneider</option>
    <option value="K√ºbelwaschmaschine">K√ºbelwaschmaschine</option>
    <option value="Minirolle 1">Minirolle 1</option>
    <option value="Minirolle 2">Minirolle 2</option>
    <option value="Minirolle 3">Minirolle 3</option>
    <option value="Minirolle 4">Minirolle 4</option>
    <option value="Minirolle 5">Minirolle 5</option>
    <option value="Minirolle 6">Minirolle 6</option>
    <option value="Mondini 2">Mondini 2</option>
    <option value="Multivac 1">Multivac 1</option>
    <option value="Multivac 2">Multivac 2</option>
    <option value="Multivac 3">Multivac 3</option>
    <option value="MVA">MVA</option>
    <option value="Palettenwaschmaschine">Palettenwaschmaschine</option>
    <option value="Paprikaschneider">Paprikaschneider</option>
    <option value="Paprikateiler">Paprikateiler</option>
    <option value="Petrella SB">Petrella SB</option>
    <option value="Rundl√§ufer 1">Rundl√§ufer 1</option>
    <option value="Rundl√§ufer 2">Rundl√§ufer 2</option>
    <option value="R√ºhle Maschine 1+2">R√ºhle Maschine 1+2</option>
    <option value="R√ºhrer 1">R√ºhrer 1</option>
    <option value="R√ºhrer 2">R√ºhrer 2</option>
    <option value="R√ºhrer 3">R√ºhrer 3</option>
    <option value="R√ºhrer 4">R√ºhrer 4</option>
    <option value="R√ºhrer 5">R√ºhrer 5</option>
    <option value="R√ºhrer 6">R√ºhrer 6</option>
    <option value="R√ºhrer 7">R√ºhrer 7</option>
    <option value="Schnittlauch-Porree-Schneider Krone">Schnittlauch-Porree-Schneider Krone</option>
    <option value="Separator 780">Separator 780</option>
    <option value="Vorsp√ºlmaschine K√ºbel">Vorsp√ºlmaschine K√ºbel</option>
  </select>

  <label for="sonstige_maschine" id="label-sonstige-maschine" style="display:none;margin-top:8px;">
    Sonstiges (Maschine):
  </label>
  <input id="sonstige_maschine" name="sonstige_maschine" type="text"
         placeholder="Bitte angeben..."
         style="display:none;margin-top:5px;width:100%;padding:6px;">
</div>

<!-- ‚úÖ Anlagenteil -->
<div class="section" style="margin-bottom:12px;">
  <label for="anlagenteil" style="display:block;font-weight:bold;">Anlagenteil</label>
  <select id="anlagenteil" name="anlagenteil" style="width:100%;padding:6px;" autocomplete="off">
    <option value="">Bitte ausw√§hlen</option>
    <option value="Sonstige">Sonstige</option>
    <option value="Magnetschalter">Magnetschalter</option>
    <option value="Abdeckhaube">Abdeckhaube</option>
    <option value="Abdeckplatte">Abdeckplatte</option>
    <option value="Antriebsband">Antriebsband</option>
    <option value="Antriebsrolle">Antriebsrolle</option>
    <option value="Band">Band</option>
    <option value="Buchse">Buchse</option>
    <option value="CEE-Steckdose">CEE-Steckdose</option>
    <option value="CPU">CPU</option>
    <option value="Can Bus Modul">Can Bus Modul</option>
    <option value="Deckelformer">Deckelformer</option>
    <option value="Dichtschnur">Dichtschnur</option>
    <option value="Dichtung">Dichtung</option>
    <option value="Dichtungen">Dichtungen</option>
    <option value="Drehschalter">Drehschalter</option>
    <option value="D√§mpfer">D√§mpfer</option>
    <option value="Ein-Taster">Ein-Taster</option>
    <option value="Elektronik">Elektronik</option>
    <option value="Ersatzwerkzeug">Ersatzwerkzeug</option>
    <option value="FU">FU</option>
    <option value="Feder">Feder</option>
    <option value="Filtereinsatz">Filtereinsatz</option>
    <option value="Harting-Stecker">Harting-Stecker</option>
    <option value="Harting-Verbindung">Harting-Verbindung</option>
    <option value="Heizung">Heizung</option>
    <option value="Hubzylinder">Hubzylinder</option>
    <option value="Ini">Ini</option>
    <option value="Kabel">Kabel</option>
    <option value="Kabel und Lichttaster">Kabel und Lichttaster</option>
    <option value="Kabelverschraubung">Kabelverschraubung</option>
    <option value="Ketten">Ketten</option>
    <option value="Kontakte">Kontakte</option>
    <option value="Kunststoffzahnr√§der">Kunststoffzahnr√§der</option>
    <option value="Lager">Lager</option>
    <option value="Lagerachsen">Lagerachsen</option>
    <option value="Lagerzapfen">Lagerzapfen</option>
    <option value="Leimd√ºse">Leimd√ºse</option>
    <option value="Lichtschranke">Lichtschranke</option>
    <option value="Lichtschranke und Kabel">Lichtschranke und Kabel</option>
    <option value="Lichtschranken">Lichtschranken</option>
    <option value="Lichttaster">Lichttaster</option>
    <option value="Lichttaster und Kabel">Lichttaster und Kabel</option>
    <option value="Luftschlauch">Luftschlauch</option>
    <option value="Magnet">Magnet</option>
    <option value="Modul 121">Modul 121</option>
    <option value="Motor">Motor</option>
    <option value="Netzteil">Netzteil</option>
    <option value="Not-Aus-Schalter">Not-Aus-Schalter</option>
    <option value="PT 100">PT 100</option>
    <option value="Panel">Panel</option>
    <option value="Platine">Platine</option>
    <option value="Poti">Poti</option>
    <option value="Profibus">Profibus</option>
    <option value="Relais">Relais</option>
    <option value="Relais mit Sockel">Relais mit Sockel</option>
    <option value="Rolle">Rolle</option>
    <option value="S7-Steuerung">S7-Steuerung</option>
    <option value="SPS">SPS</option>
    <option value="Schalter">Schalter</option>
    <option value="Schaltergeh√§use">Schaltergeh√§use</option>
    <option value="Schiebef√ºhrung">Schiebef√ºhrung</option>
    <option value="Schlauch">Schlauch</option>
    <option value="Schraube">Schraube</option>
    <option value="Schraube und Dichtung">Schraube und Dichtung</option>
    <option value="Schrauben">Schrauben</option>
    <option value="Sensor">Sensor</option>
    <option value="Sicherheitrelais">Sicherheitrelais</option>
    <option value="Sicherheits-Ausgangsmodul">Sicherheits-Ausgangsmodul</option>
    <option value="Sicherheitsbaugruppe">Sicherheitsbaugruppe</option>
    <option value="Sicherheitsrelais">Sicherheitsrelais</option>
    <option value="Sicherheitsschalter">Sicherheitsschalter</option>
    <option value="Sicherheitsventil">Sicherheitsventil</option>
    <option value="Sicherung">Sicherung</option>
    <option value="Siegelheizung">Siegelheizung</option>
    <option value="Spule">Spule</option>
    <option value="Stator">Stator</option>
    <option value="Steckdose">Steckdose</option>
    <option value="Stecker">Stecker</option>
    <option value="Stecker und Spule">Stecker und Spule</option>
    <option value="Steckereinsatz">Steckereinsatz</option>
    <option value="Steckverbindung">Steckverbindung</option>
    <option value="Stopfen">Stopfen</option>
    <option value="Taster">Taster</option>
    <option value="Tasteroberteil">Tasteroberteil</option>
    <option value="Temperaturf√ºhler">Temperaturf√ºhler</option>
    <option value="Touchpanel">Touchpanel</option>
    <option value="Trichterschalter">Trichterschalter</option>
    <option value="Umlenkrolle">Umlenkrolle</option>
    <option value="Vakuumgenerator">Vakuumgenerator</option>
    <option value="Vakuumpumpe">Vakuumpumpe</option>
    <option value="Vakuumsensor">Vakuumsensor</option>
    <option value="Ventil">Ventil</option>
    <option value="Verriegelungsb√ºgel">Verriegelungsb√ºgel</option>
    <option value="Wartungspaket">Wartungspaket</option>
    <option value="Welle">Welle</option>
    <option value="Zylinder">Zylinder</option>
    <option value="Zylinder und Heizungsregler">Zylinder und Heizungsregler</option>
    <option value="Zylinder und Vakuumventil">Zylinder und Vakuumventil</option>
    <option value="Z√§hler">Z√§hler</option>
    <option value="Dichtring">Dichtring</option>
  </select>

  <label id="label-sonstige-anlagenteil" for="sonstige_anlagenteil" style="display:none;margin-top:8px;">
    Sonstiges (Anlagenteil):
  </label>
  <input id="sonstige_anlagenteil" name="sonstige_anlagenteil" type="text"
         placeholder="Bitte angeben..."
         style="display:none;margin-top:5px;width:100%;padding:6px;">
</div>

<!-- ‚¨áÔ∏è HIER EINSETZEN: Wartungsplan-Panel -->
<div class="section" id="wartungsplanSection" style="margin:16px 0;">
  <div id="wpWarning" style="display:none;margin-bottom:10px;padding:10px;border:1px solid #dc3545;color:#842029;background:#f8d7da;border-radius:6px;">
    ‚ö†Ô∏è Diese Anlage hat <strong>√ºberf√§llige Wartungen</strong>. Bitte durchf√ºhren!
  </div>

  <div id="wartungsplanPanel" style="display:none;border:1px solid #ddd;border-radius:8px;padding:12px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label style="font-weight:bold;">Anlage (Maschine)</label>
        <div style="font-size:13px;color:#666;">Verkn√ºpft mit Feld ‚ÄûMaschine‚Äú</div>
      </div>
      <div>
        <label style="font-weight:bold;">Status</label><br>
        <span id="wpStatusPill" style="display:inline-block;padding:4px 8px;border-radius:999px;font-size:13px;background:#e9ecef;">‚Äì</span>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label for="wpTaskSelect" style="font-weight:bold;">Schmierstelle / Aufgabe</label>
      <select id="wpTaskSelect" style="width:100%;padding:6px;">
        <option value="">Bitte ausw√§hlen</option>
      </select>
    </div>

    <!-- ‚ûï NEU: Anzahl Schmiernippel -->
    <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label for="wpNipCount" style="font-weight:bold;">Anzahl Schmiernippel</label>
        <input id="wpNipCount" type="number" min="0" step="1" placeholder="z. B. 6" style="width:100%;padding:6px;">
      </div>
      <div></div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(3,minmax(140px,1fr));gap:12px;margin-top:10px;">
      <div>
        <label style="font-weight:bold;">Intervall (Tage)</label>
        <input id="wpIntervalDays" type="number" min="1" step="1" placeholder="z. B. 30" style="width:100%;padding:6px;">
      </div>
      <div>
        <label style="font-weight:bold;">Zuletzt durchgef√ºhrt</label>
        <input id="wpLastDate" type="date" style="width:100%;padding:6px;">
      </div>
      <div>
        <label style="font-weight:bold;">N√§chstes F√§lligkeitsdatum</label>
        <input id="wpNextDue" type="date" readonly style="width:100%;padding:6px;background:#f7f7f7;">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" id="wpAddTask"    style="padding:8px 12px;border:0;border-radius:6px;background:#6c757d;color:#fff;cursor:pointer;">‚ûï Neue Aufgabe</button>
      <button type="button" id="wpSaveTask"   style="padding:8px 12px;border:0;border-radius:6px;background:#0d6efd;color:#fff;cursor:pointer;">üíæ Speichern</button>
      <button type="button" id="wpDeleteTask" style="padding:8px 12px;border:0;border-radius:6px;background:#dc3545;color:#fff;cursor:pointer;">üóëÔ∏è L√∂schen</button>
      <button type="button" id="wpMarkDoneToday" style="padding:8px 12px;border:0;border-radius:6px;background:#198754;color:#fff;cursor:pointer;">‚úÖ Heute durchgef√ºhrt</button>
    </div>

    <div id="wpHint" style="margin-top:8px;color:#666;font-size:13px;">
      Aufgaben sind pro Maschine hinterlegt. Beim Abschluss kannst du die passende Aufgabe mit ‚ÄûHeute durchgef√ºhrt‚Äú markieren.
    </div>
    <!-- üîΩ NEU: Wartungs-Zusammenfassung -->
<div id="wpPrintSummary" style="display:none;margin-top:10px;border:1px dashed #ccc;padding:8px;border-radius:8px;">
  <div style="font-weight:600;margin-bottom:6px;">Wartungs-Zusammenfassung</div>
  <div><strong>Aufgabe:</strong> <span id="wpPrintTask">‚Äì</span></div>
  <div><strong>Intervall (Tage):</strong> <span id="wpPrintInterval">‚Äì</span></div>
  <div><strong>Zuletzt durchgef√ºhrt:</strong> <span id="wpPrintLast">‚Äì</span></div>
  <div><strong>N√§chstes F√§lligkeitsdatum:</strong> <span id="wpPrintNext">‚Äì</span></div>
  <div><strong>Schmiernippel:</strong> <span id="wpPrintNip">‚Äì</span></div>
</div>
  </div>
</div>
<!-- ‚¨ÜÔ∏è Ende Wartungsplan-Panel -->







    <div style="margin-top: 20px;">
  <label style="font-weight: bold; display: block;">Dauer der Reparatur (von - bis Uhrzeit):</label>
  <input id="startzeit" name="start_time" style="margin-right: 10px;" type="time"/>
  <input id="endzeit" name="end_time" style="margin-right: 10px;" type="time"/>
  <input id="dauer" name="dauer" placeholder="Dauer in Stunden" readonly="true" type="text"/>
</div>

<div class="section">
<label for="abschlussdatum">Abschlussdatum der Ausf√ºhrung:</label>
<input id="abschlussdatum" name="abschlussdatum" type="date"/>
</div>
<div class="section">
<label for="fehlerbeschreibung">Fehlerbeschreibung:</label>
<textarea cols="50" id="fehlerbeschreibung" name="fehlerbeschreibung" placeholder="Was war defekt? Was wurde unternommen?" rows="4"></textarea>
</div>
<div class="section">
<label for="reinigung_erforderlich">Reinigung Maschine/Umfeld erforderlich:</label>
<select id="reinigung_erforderlich" name="reinigung_erforderlich">
<option value="ja">Ja</option>
<option value="nein">Nein</option>
</select>
<div style="margin-bottom: 10px;">
<label for="reinigungsart_zusatz">Reinigungsausf√ºhrung:</label>
<select id="reinigungsart_zusatz" name="reinigungsart_zusatz" style="width: 100%; padding: 6px; margin-bottom: 10px;">
<option value="">Bitte ausw√§hlen</option>
<option value="Maschinenpersonal">Maschinenpersonal</option>
<option value="Reinigungsschicht">Reinigungsschicht</option>
<option value="Sonstiges">Sonstiges</option>
</select><input id="sonstige_reinigungsart_zusatz" name="sonstige_reinigungsart_zusatz" placeholder="Bitte angeben..." style="display:none; margin-top: 5px; width: 100%;" type="text"/><input id="reinigungsart_sonstiges" name="reinigungsart_sonstiges" style="display:none; width: 100%; padding: 6px;" type="text"/><label for="reinigungsart_sonstiges" style="display:none;">Sonstiges (Reinigungsausf√ºhrung):</label>
</div>
<div style="margin-bottom: 10px;">
</div>
</div>
<div class="section">
  <p>Die Reparatur ist abgeschlossen und alle eingesetzten Werkzeuge wurden komplett entfernt.</p>
</div>

<div class="page-break"></div>

<div class="section">
  <label for="unterschrift_abnahme">Unterschrift MA Abnahme (Produktkreisfreigabe):</label>
  <canvas class="signature-pad" id="unterschrift_abnahme"></canvas>
  <button onclick="clearSignature(0)" style="margin-top: 8px; display: block;" type="button">Unterschrift l√∂schen</button>
</div>

<div class="page-break"></div>

<div class="section">
  <label for="unterschrift_technik">Unterschrift MA Technik:</label>
  <canvas class="signature-pad" id="unterschrift_technik"></canvas>
  <button type="button" style="margin-top: 8px; display: block;" 
          onclick="clearSignature(1)">Unterschrift l√∂schen</button>

  <div style="margin-top: 24px;">
    <label for="foto" style="font-weight: bold;">Fehlerstelle / Schaden (optional):</label>
    <h2>Fotos f√ºr Reparaturauftrag</h2>
    <input accept="image/*" id="fileInput" multiple type="file" />
    <div class="preview-container" id="previewContainer"></div>
  </div>
</div>


<style>
  .page-break {
    page-break-before: always;
  }
  .preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
  }
  .image-wrapper {
    position: relative;
    display: inline-block;
  }
  .delete-button {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: red;
    color: white;
    border: none;
    padding: 5px;
    cursor: pointer;
    border-radius: 5px;
  }
/* korrekt nur f√ºr Thumbnails der Vorschau */
.preview-container img {
  max-width: 200px;
  max-height: 200px;
  border: 1px solid #ccc;
}

</style>

<script>
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    let uploadedFiles = [];
    fileInput.addEventListener('change', function(event) {
        const files = Array.from(event.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('image-wrapper');
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-button');
                deleteBtn.textContent = 'L√∂schen';
                deleteBtn.addEventListener('click', () => {
                    wrapper.remove();
                    uploadedFiles = uploadedFiles.filter(f => f !== file);
                    console.log("Datei gel√∂scht:", file.name);
                });
                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                previewContainer.appendChild(wrapper);
                uploadedFiles.push(file);
            };
            reader.readAsDataURL(file);
        });
        fileInput.value = '';
    });
</script>

<div class="section">
  <label for="ort_datum">Ort / Datum:</label>
  <input id="ort_datum" name="ort_datum" type="text"/>
</div>


<div style="margin-top: 20px; font-size: 14px; line-height: 1.5; white-space: pre;">
Erstellt: M.Thiemann       Datum: 18.06.2025
Gepr√ºft: M. Hafermalz      Datum: 24.06.2025
Freigegeben: F. Pieper     Datum: 24.06.2025
</div>

</div> <!-- <= HIER und NUR HIER den #pdfExportContainer schlie√üen -->


<!-- ====================== -->
<!-- Buttons au√üerhalb Container -->
<!-- ====================== -->
<div class="no-print" style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px;">
  <button type="button" onclick="saveDraftToOneDrive()">üíæ Entwurf in OneDrive speichern</button>
  <button type="button" onclick="showDraftList()">üìÇ Entwurf aus OneDrive laden</button>
  <button type="button" onclick="generatePDFAndFinish()">‚úÖ Auftrag abschlie√üen & in OneDrive speichern</button>
  <button type="button" onclick="forceUpdate()">‚ôªÔ∏è App aktualisieren (Cache l√∂schen)</button>
</div>

<!-- üì• Schmierplan (Excel) importieren) -->
<div class="no-print" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:4px 0 16px;">
  <input id="xlsxInput" type="file" accept=".xlsx,.xls">
  <button type="button" onclick="importSchmierplanFromExcel()">üì• Excel (Schmierplan) einlesen</button>
</div>

<!-- SheetJS (XLSX) f√ºr den Excel-Import -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


<style>
canvas.signature-pad {
  border: 1px solid #000;
  width: 100%;
  height: 100px;
  touch-action: none;
}
</style>
<style>
canvas.signature-pad {
  border: 1px solid #000;
  background: #fff;
  touch-action: none;
  width: 100%;
  max-width: 600px;
  height: 200px;
}
.signature-container {
  margin-bottom: 20px;
}
button.clear-signature {
  margin-top: 5px;
}
</style>


<script>
function initSignaturePad(id) {
  const canvas = document.getElementById(id);
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    // HiDPI/Retina scharf rendern
    const ratio = Math.max(window.devicePixelRatio || 1, 1);

    // CSS-Gr√∂√üe aus dem Layout (Fallbacks, falls offset 0 ist)
    const style = getComputedStyle(canvas);
    const cssW = canvas.offsetWidth  || parseInt(style.width)  || 600;
    const cssH = canvas.offsetHeight || parseInt(style.height) || 200;

    // Interne Aufl√∂sung hochskalieren
    canvas.width  = Math.round(cssW * ratio);
    canvas.height = Math.round(cssH * ratio);

    // Koordinaten wieder in CSS-Pixeln
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

    // Strichstil
    ctx.lineWidth   = 2;
    ctx.lineCap     = 'round';
    ctx.lineJoin    = 'round';
    ctx.strokeStyle = '#000';
  }

  resizeCanvas();
  // ‚Ü≥ Diese Zeile ist neu: bei Fenstergr√∂√üe neu skalieren
  window.addEventListener('resize', resizeCanvas);

  let drawing = false;

  canvas.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    drawing = true;
    const r = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
  }, { passive: false });

  canvas.addEventListener("pointermove", (e) => {
    if (!drawing) return;
    const r = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
    ctx.stroke();
  });

  canvas.addEventListener("pointerup",   () => { drawing = false; });
  canvas.addEventListener("pointerleave",() => { drawing = false; });
}

// Dein Load-Listener kann unver√§ndert bleiben:
window.addEventListener("load", () => {
  initSignaturePad("unterschrift_abnahme");
  initSignaturePad("unterschrift_technik");
});
</script>



<script>
function clearSignature(index) {
    const canvases = document.querySelectorAll("canvas");
    if (canvases[index]) {
        const ctx = canvases[index].getContext("2d");
        ctx.clearRect(0, 0, canvases[index].width, canvases[index].height);
    }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // üü¢ Zeitberechnung
  const startTimeInput = document.getElementById("startzeit");
  const endTimeInput   = document.getElementById("endzeit");
  const durationInput  = document.getElementById("dauer");

  function calculateDuration() {
    const start = startTimeInput?.value;
    const end   = endTimeInput?.value;
    if (start && end) {
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let s = new Date(0,0,0,sh,sm), e = new Date(0,0,0,eh,em);
      let diff = e - s; if (diff < 0) diff += 24*60*60*1000;
      const mins = Math.floor(diff/60000), h = Math.floor(mins/60), m = mins%60;
      durationInput.value = (h?`${h} h `:"") + (m?`${m} min`:(h?"" :"0 min"));
    }
  }
  startTimeInput?.addEventListener("input", calculateDuration);
  endTimeInput?.addEventListener("input", calculateDuration);

  // üü¢ "Sonstige"-Felder & Selects
  const maschineSelect             = document.getElementById("maschine");
  const sonstigeMaschineInput      = document.getElementById("sonstige_maschine");
  const labelSonstigeMaschine      = document.getElementById("label-sonstige-maschine");

  const anlagenteilSelect          = document.getElementById("anlagenteil");
  const sonstigeAnlagenteilInput   = document.getElementById("sonstige_anlagenteil");
  const labelSonstigeAnlagenteil   = document.getElementById("label-sonstige-anlagenteil");

  const reinigungsartSelect        = document.getElementById("reinigungsart_zusatz");
  const sonstigeReinigungsartInput = document.getElementById("sonstige_reinigungsart_zusatz");

  function updateMaschineField() {
    const show = maschineSelect?.value === "Sonstige";
    if (sonstigeMaschineInput)  sonstigeMaschineInput.style.display  = show ? "block" : "none";
    if (labelSonstigeMaschine)  labelSonstigeMaschine.style.display  = show ? "block" : "none";
  }
  function updateAnlagenteilField() {
    const show = anlagenteilSelect?.value === "Sonstige";
    if (sonstigeAnlagenteilInput) sonstigeAnlagenteilInput.style.display = show ? "block" : "none";
    if (labelSonstigeAnlagenteil) labelSonstigeAnlagenteil.style.display = show ? "block" : "none";
  }
  function updateReinigungsartField() {
    const show = reinigungsartSelect?.value === "Sonstiges";
    if (sonstigeReinigungsartInput) sonstigeReinigungsartInput.style.display = show ? "block" : "none";
  }

  maschineSelect?.addEventListener("change", updateMaschineField);
  anlagenteilSelect?.addEventListener("change", updateAnlagenteilField);
  reinigungsartSelect?.addEventListener("change", updateReinigungsartField);

  // initialer Zustand
  updateMaschineField();
  updateAnlagenteilField();
  updateReinigungsartField();

  // üîí Basis-Optionen (HTML-Defaults) einmalig puffern
  const baseMaschineValues    = maschineSelect ? Array.from(maschineSelect.options).map(o => o.value) : [];
  const baseAnlagenteilValues = anlagenteilSelect ? Array.from(anlagenteilSelect.options).map(o => o.value) : [];

  function pruneToBase(selectEl, baseValues) {
    if (!selectEl) return;
    Array.from(selectEl.options).forEach(o => {
      if (!baseValues.includes(o.value)) o.remove(); // alle dynamischen raus
    });
    if (!baseValues.includes(selectEl.value)) selectEl.value = ""; // ung√ºltige Auswahl zur√ºcksetzen
  }

function rebuildDropdownsFromMaster() {
  const maschineSelect    = document.getElementById("maschine");
  const anlagenteilSelect = document.getElementById("anlagenteil");

  // aktuelle Auswahl sichern (Value + sichtbarer Text)
  const keep = (sel) => sel ? {
    value: sel.value,
    text:  sel.options[sel.selectedIndex]?.textContent?.trim() || ""
  } : null;

  const keepMaschine    = keep(maschineSelect);
  const keepAnlagenteil = keep(anlagenteilSelect);

  // Helper: Auswahl nach dem Neuaufbau wiederherstellen
  const restore = (sel, kept) => {
    if (!sel || !kept) return;
    if ([...sel.options].some(o => o.value === kept.value)) {
      sel.value = kept.value;
      return;
    }
    const byText = [...sel.options].find(o =>
      (o.textContent || o.innerText).trim() === kept.text
    );
    if (byText) sel.value = byText.value;
  };

  // Maschine
  if (maschineSelect) {
    // Basisoptionen (aus HTML) behalten, dynamische entfernen
    pruneToBase(maschineSelect, baseMaschineValues);

    // Stammdaten anh√§ngen (ohne Autoselect)
    (masterData.maschinen || []).forEach(n =>
      addOptionUnique(maschineSelect, n, { autoselect: false })
    );

    // Sortieren, "" und "Sonstige" oben lassen
    sortSelectOptions(maschineSelect, ["", "Sonstige"]);

    // Auswahl wiederherstellen
    restore(maschineSelect, keepMaschine);
  }

  // Anlagenteil
  if (anlagenteilSelect) {
    pruneToBase(anlagenteilSelect, baseAnlagenteilValues);

    (masterData.anlagenteile || []).forEach(n =>
      addOptionUnique(anlagenteilSelect, n, { autoselect: false })
    );

    sortSelectOptions(anlagenteilSelect, ["", "Sonstige"]);

    restore(anlagenteilSelect, keepAnlagenteil);
  }

  // Abh√§ngige "Sonstige"-Eingabefelder korrekt ein-/ausblenden
  updateMaschineField?.();
  updateAnlagenteilField?.();
}

// global verf√ºgbar lassen
window.rebuildDropdownsFromMaster = rebuildDropdownsFromMaster;

// Initial: Stammdaten laden und erst dann neu aufbauen
loadMasterData().then(rebuildDropdownsFromMaster);


// ‚¨áÔ∏è Einmal VOR den beiden Funktionen einf√ºgen
const norm = (s) => String(s ?? '').trim();

function tryAddCustomMaschine() {
  const val = norm(sonstigeMaschineInput?.value);
  if (!val || !maschineSelect) return;

  addOptionUnique(maschineSelect, val, { autoselect: true });

  const exists = (masterData.maschinen || [])
    .some(x => (x || "").toLowerCase() === val.toLowerCase());
  if (!exists) {
    (masterData.maschinen ||= []).push(val);
    saveMasterData();
  }
}

function tryAddCustomAnlagenteil() {
  const val = norm(sonstigeAnlagenteilInput?.value);
  if (!val || !anlagenteilSelect) return;

  addOptionUnique(anlagenteilSelect, val, { autoselect: true });

  const exists = (masterData.anlagenteile || [])
    .some(x => (x || "").toLowerCase() === val.toLowerCase());
  if (!exists) {
    (masterData.anlagenteile ||= []).push(val);
    saveMasterData();
  }
}



  // Eingabe √ºbernehmen bei Verlassen der Felder ‚Ä¶
  sonstigeMaschineInput?.addEventListener("blur", tryAddCustomMaschine);
  sonstigeAnlagenteilInput?.addEventListener("blur", tryAddCustomAnlagenteil);

  // ‚Ä¶ und wenn von ‚ÄûSonstige‚Äú weg gewechselt wird
  maschineSelect?.addEventListener("change", () => {
    if (maschineSelect.value !== "Sonstige") tryAddCustomMaschine();
  });
  anlagenteilSelect?.addEventListener("change", () => {
    if (anlagenteilSelect.value !== "Sonstige") tryAddCustomAnlagenteil();
  });
});
</script>







<script>
// UUID Generator (v4)
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Lesbare Auftrags-ID
function generateReadableID() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
    return `REP-${year}${month}${day}-${randomPart}`;
}

// Beim Laden die ID setzen
window.addEventListener('load', function() {
    const auftragsID = generateReadableID();
    document.getElementById('auftrag_id').value = auftragsID;
});

</script>







<!-- ‚úÖ MSAL Konfiguration & Login Logik -->

<!-- ‚úÖ MSAL Konfiguration & Login Logik -->
<script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
<script>
  const msalConfig = {
    auth: {
      clientId: "800b6d33-1917-4b4f-abf4-162094f8c862",
      authority: "https://login.microsoftonline.com/f54f53bb-d0ff-4b78-bcf4-4aeeeb924428",
      redirectUri: "https://thiemann423.github.io/Werkstatt-APP/"
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: true },
    system: { allowRedirectInIframe: true }
  };

  const scopes = [
  "User.Read",
  "openid",
  "profile",
  "offline_access",
  "Files.ReadWrite.All",
  "Mail.Send"          // ‚¨ÖÔ∏è neu f√ºr E-Mail-Versand
];

  const msalInstance = new msal.PublicClientApplication(msalConfig);
  let accessToken = "";

  
  function hideLoginHint(){
    const el = document.getElementById("loginHint");
    if (el) el.style.display = "none";
  }
  function showLoginHint(){
    const el = document.getElementById("loginHint");
    if (el) el.style.display = "block";
  }



  // === NEU 1: Redirect-Antwort verarbeiten ‚Äì MUSS direkt nach msalInstance stehen
 
// 1) Redirect-Antwort verarbeiten (muss direkt nach msalInstance stehen)
(async () => {
  try {
  const resp = await msalInstance.handleRedirectPromise();
if (resp?.accessToken) {
  accessToken = resp.accessToken;
  window.accessToken = accessToken;        // ‚Üê NEU
}
if (resp?.account) msalInstance.setActiveAccount(resp.account);
  } catch (e) {
    console.warn("handleRedirectPromise:", e);
  }
})();

// 2) Resolver + Ziel-IDs (GLOBAL!)
const SHARE_URL = "https://petrifeinkost-my.sharepoint.com/:f:/g/personal/merten_thiemann_petri-feinkost_de/EkOa1ufucPNDtlfo6B9rxowB7o8nAY4wHK-gcRha74B2AQ?e=NtbXUx";

const TARGET = { driveId: null, parentItemId: null }; // <- war bei dir nicht definiert
const DRAFTS_FOLDER_NAME = "Reparatur-Entw√ºrfe";
let TARGET_DRAFTS_ITEM_ID = null;




const META_FOLDER_NAME = "Reparatur-Meta";   // <‚Äî NEU
let   TARGET_META_ITEM_ID = null;            // <‚Äî NEU


// richtig: shareId = 'u!' + base64url( UTF8( SHARING_URL ) )
function _b64Url(u) {
  const bytes = new TextEncoder().encode(u);      // nur die URL encodieren
  let bin = '';
  for (const b of bytes) bin += String.fromCharCode(b);
  const b64 = btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
  return 'u!' + b64;                               // 'u!' VOR die Base64, nicht hinein!
}


// WICHTIG: als "function ..." deklarieren (wird gehoistet)
// WICHTIG: als "function ..." deklarieren (wird gehoistet)
async function resolveShareLinkToFolder(){
  if (!accessToken) throw new Error("Kein Access Token");

  // --- Cache lesen ---
  const cache = JSON.parse(localStorage.getItem("TARGET_CACHE") || "null");
  if (cache?.shareUrl === SHARE_URL && cache?.driveId && cache?.parentItemId){
    TARGET.driveId        = cache.driveId;
    TARGET.parentItemId   = cache.parentItemId;
    TARGET_DRAFTS_ITEM_ID = cache.draftsItemId || null;
    TARGET_META_ITEM_ID   = cache.metaItemId   || null;

    // ‚ö†Ô∏è Nur sofort zur√ºck, wenn BEIDE Unterordner-IDs vorhanden sind
    if (TARGET_DRAFTS_ITEM_ID && TARGET_META_ITEM_ID) return;
  } else {
    // --- Share-Link ‚Üí Drive & Ordner aufl√∂sen ---
    const encoded = _b64Url(SHARE_URL);
    const res = await fetch(
      `https://graph.microsoft.com/v1.0/shares/${encoded}/driveItem?$select=id,name,parentReference,folder,file`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    if (!res.ok){
      throw new Error(`shares/driveItem: ${res.status} ${await res.text()}`);
    }
    const item = await res.json();
    const folderItemId = item.folder ? item.id : item.parentReference?.id;
    const driveId      = item.parentReference?.driveId;
    if (!driveId || !folderItemId) throw new Error("Zielordner konnte nicht bestimmt werden.");

    TARGET.driveId      = driveId;
    TARGET.parentItemId = folderItemId;
  }

  // --- Unterordner (Entw√ºrfe + Meta) ermitteln/erstellen ---
  const listUrl =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}` +
    `/children?$select=id,name,folder`;
  const listRes = await fetch(listUrl, { headers: { Authorization: `Bearer ${accessToken}` } });
  if (!listRes.ok) throw new Error(`children list failed: ${listRes.status}`);
  const children = (await listRes.json()).value || [];

  // Entw√ºrfe
  let drafts = children.find(x => x.name === DRAFTS_FOLDER_NAME && x.folder);
  if (!drafts){
    const createDrafts = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}/children`,
      {
        method: "POST",
        headers: { Authorization: `Bearer ${accessToken}`, "Content-Type":"application/json" },
        body: JSON.stringify({ name: DRAFTS_FOLDER_NAME, folder: {}, "@microsoft.graph.conflictBehavior":"ignore" })
      }
    );
    if (createDrafts.ok) drafts = await createDrafts.json();
  }
  TARGET_DRAFTS_ITEM_ID = drafts?.id || null;

  // Meta
  let meta = children.find(x => x.name === META_FOLDER_NAME && x.folder);
  if (!meta){
    const createMeta = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}/children`,
      {
        method: "POST",
        headers: { Authorization: `Bearer ${accessToken}`, "Content-Type":"application/json" },
        body: JSON.stringify({ name: META_FOLDER_NAME, folder: {}, "@microsoft.graph.conflictBehavior":"ignore" })
      }
    );
    if (createMeta.ok) meta = await createMeta.json();
  }
  TARGET_META_ITEM_ID = meta?.id || null;

  // --- Cache schreiben (inkl. IDs der Unterordner) ---
  localStorage.setItem("TARGET_CACHE", JSON.stringify({
    shareUrl:      SHARE_URL,
    driveId:       TARGET.driveId,
    parentItemId:  TARGET.parentItemId,
    draftsItemId:  TARGET_DRAFTS_ITEM_ID,
    metaItemId:    TARGET_META_ITEM_ID
  }));
}



//<!-- ... alles davor: msalConfig, scopes, msalInstance, handleRedirectPromise, resolveShareLinkToFolder, signInAndAcquireToken ... -->

// 3) Login/Token nur per Redirect (Popup auf GitHub Pages meiden)
async function signInAndAcquireToken(interactive = false, { rebuild = true } = {}) {
  try {
    let account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];

    if (!account && interactive) {
      await msalInstance.loginRedirect({ scopes });
      return; // kommt nach Redirect zur√ºck
    }
    if (!account) {
      showLoginHint();
      return;
    }

    try {
      const t = await msalInstance.acquireTokenSilent({ scopes, account });
      accessToken = t.accessToken;
      window.accessToken = accessToken;     
    } catch (e) {
      await msalInstance.acquireTokenRedirect({ scopes });
      return;
    }

    try { await resolveShareLinkToFolder(); } catch (e) { console.warn("resolveShareLinkToFolder:", e); }
    hideLoginHint();

    // ‚¨áÔ∏è WICHTIG: Nur bei Bedarf Stammdaten neu laden + Dropdowns rebuilden
    if (rebuild) {
      try {
        await loadMasterData();
        window.rebuildDropdownsFromMaster?.();
      } catch (e) {
        console.warn("Reload master after sign-in failed:", e);
      }
    }

  } catch (e) {
    console.error("signInAndAcquireToken:", e);
    showLoginHint();
  }
}




/* === HIER einf√ºgen: signOut() === */
async function signOut(){
  try{
    const acc = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
    // üëâ lokalen Cache zu Stammdaten wegr√§umen
    localStorage.removeItem("TE15_MASTER");
    localStorage.removeItem("TARGET_CACHE");
    accessToken = "";

    if (acc) {
      await msalInstance.logoutRedirect({ account: acc });
      return;
    }
  } catch(e){
    console.error("logout:", e);
  }
}

/* DOMContentLoaded: erst lokal laden & bauen, dann (still) anmelden und ggf. neu bauen */
document.addEventListener("DOMContentLoaded", async () => {
  const acc = msalInstance.getAllAccounts()[0];
  if (acc) msalInstance.setActiveAccount(acc);

  // 1) Sofort lokale Stammdaten (Cache) laden und Listen bauen
  await loadMasterData();
  window.rebuildDropdownsFromMaster();

  // 2) Versuch: stille Anmeldung (keine Redirects)
  try {
    await signInAndAcquireToken(false);
    // 3) Nach erfolgreichem Login: OneDrive-Stammdaten laden und Listen neu bauen
    await loadMasterData();
    window.rebuildDropdownsFromMaster();
  } catch (e) {
    console.warn("Silent sign-in skipped:", e);
  }
});

</script>






<script>
  function _byId(id){ return document.getElementById(id); }

  function _showFieldError(el, msg){
    if (!el) return;
    el.classList.add('field-error');
    if (el.nextElementSibling && el.nextElementSibling.classList?.contains('error-text')) {
      el.nextElementSibling.remove();
    }
    const m = document.createElement('div');
    m.className = 'error-text';
    m.textContent = msg;
    el.parentNode.insertBefore(m, el.nextSibling);
  }

  function _clearAllFieldErrors(){
    document.querySelectorAll('.field-error').forEach(e => e.classList.remove('field-error'));
    document.querySelectorAll('.error-text').forEach(e => e.remove());
  }

  // beim Tippen/√Ñndern Fehler am jeweiligen Feld entfernen
  function _autoClearOnChange(id, evt='input'){
    const el = _byId(id);
    if (!el) return;
    el.addEventListener(evt, () => {
      el.classList.remove('field-error');
      if (el.nextElementSibling && el.nextElementSibling.classList?.contains('error-text')) {
        el.nextElementSibling.remove();
      }
    });
  }

  // einmalig aktivieren
  document.addEventListener('DOMContentLoaded', () => {
    _autoClearOnChange('bearbeitet_am', 'change');
    _autoClearOnChange('techniker1',    'change');
    _autoClearOnChange('maschine',      'change');
    _autoClearOnChange('sonstige_maschine');
    _autoClearOnChange('anlagenteil',   'change');
    _autoClearOnChange('sonstige_anlagenteil');
    _autoClearOnChange('fehlerbeschreibung', 'input');
  });

  // Pflichtfelder pr√ºfen
  function validateBeforeFinish(){
    _clearAllFieldErrors();
    let ok = true;

    // 1) Bearbeitet am
    const fDatum = _byId('bearbeitet_am');
    if (!fDatum?.value) { _showFieldError(fDatum, '‚ÄûBearbeitet am‚Äú ist ein Pflichtfeld.'); ok = false; }

    // 2) Techniker 1
    const fTech1 = _byId('techniker1');
    if (!fTech1?.value) { _showFieldError(fTech1, '‚ÄûTechniker 1‚Äú ist ein Pflichtfeld.'); ok = false; }

    // 3) Maschine (+ Sonstige-Text)
    const selM = _byId('maschine');
    if (!selM?.value) {
      _showFieldError(selM, '‚ÄûMaschine‚Äú ist ein Pflichtfeld.'); ok = false;
    } else if (selM.value === 'Sonstige') {
      const txtM = _byId('sonstige_maschine');
      if (!txtM?.value.trim()) { _showFieldError(txtM || selM, 'Bitte ‚ÄûSonstiges (Maschine)‚Äú angeben.'); ok = false; }
    }

    // 4) Anlagenteil (+ Sonstige-Text)
    const selA = _byId('anlagenteil');
    if (!selA?.value) {
      _showFieldError(selA, '‚ÄûAnlagenteil‚Äú ist ein Pflichtfeld.'); ok = false;
    } else if (selA.value === 'Sonstige') {
      const txtA = _byId('sonstige_anlagenteil');
      if (!txtA?.value.trim()) { _showFieldError(txtA || selA, 'Bitte ‚ÄûSonstiges (Anlagenteil)‚Äú angeben.'); ok = false; }
    }

    // 5) Fehlerbeschreibung
    const fDesc = _byId('fehlerbeschreibung');
    if (!fDesc?.value.trim()) { _showFieldError(fDesc, '‚ÄûFehlerbeschreibung‚Äú ist ein Pflichtfeld.'); ok = false; }

    if (!ok) {
      document.querySelector('.field-error')?.scrollIntoView({ behavior:'smooth', block:'center' });
      alert('Bitte f√ºllen Sie alle rot markierten Pflichtfelder aus.');
    }
    return ok;
  }
</script>





<!-- üîΩ Hier unten startet dein gro√ües Script-Block -->
<script>
  // --- Stammdaten (Maschinen & Anlagenteile) --- //
  const MASTER_FILE = "Stammdaten-Reparatur.json";
  let masterData = { version: 1, maschinen: [], anlagenteile: [] };

  // Local-Cache laden
  function loadMasterFromLocal() {
    try {
      const s = localStorage.getItem("TE15_MASTER");
      if (s) masterData = JSON.parse(s);
    } catch {}
  }

  // Local-Cache speichern
  function saveMasterToLocal() {
    try {
      localStorage.setItem("TE15_MASTER", JSON.stringify(masterData));
    } catch {}
  }

  // Stammdaten bewusst leeren + Cache √ºberschreiben
  function setEmptyMaster() {
    masterData = { version: 1, maschinen: [], anlagenteile: [] };
    saveMasterToLocal();
  }

  // Laden (OneDrive -> bei fehlender Datei: leeren -> sonst Local-Fallback)
  async function loadMasterData() {
    try {
      if (!accessToken) {                // nicht angemeldet -> nur local versuchen
        loadMasterFromLocal();
        return;
      }

      await resolveShareLinkToFolder();

      // Pr√ºfen, ob die Master-Datei existiert
      const listUrl =
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}` +
        `/children?$select=id,name`;
      const listRes = await fetch(listUrl, { headers: { Authorization: `Bearer ${accessToken}` } });
      if (!listRes.ok) throw new Error("children list failed");
      const list = await listRes.json();
      const item = (list.value || []).find(x => x.name === MASTER_FILE);

      // ‚ùó Datei existiert nicht -> Stammdaten leeren + Cache √ºberschreiben
      if (!item) {
        setEmptyMaster();
        return;
      }

      // Datei existiert -> Inhalt laden
      const fileRes = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${item.id}/content`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );

      if (!fileRes.ok) {
        // z. B. 404/403 -> lieber nicht alte Daten behalten
        setEmptyMaster();
        return;
      }

      // g√ºltige JSON √ºbernehmen + Cache aktualisieren
      masterData = await fileRes.json();
      if (!masterData || typeof masterData !== "object") {
        setEmptyMaster();
        return;
      }
      // Safety: fehlende Felder initialisieren
      masterData.version ??= 1;
      masterData.maschinen ??= [];
      masterData.anlagenteile ??= [];

      saveMasterToLocal();
    } catch (e) {
      // Netzwerk/Parsing-Fehler -> Local-Fallback (falls vorhanden)
      loadMasterFromLocal();
    }
  }

  // Speichern (OneDrive, plus Local-Cache)
// Speichern (OneDrive, plus Local-Cache)
async function saveMasterData() {
  saveMasterToLocal();
  if (!accessToken || !TARGET.driveId || !TARGET.parentItemId) return;

  const url  = `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}:/${encodeURIComponent(MASTER_FILE)}:/content`;
  const blob = new Blob([JSON.stringify(masterData, null, 2)], { type: "application/json" });

  try {
    await fetch(url, {
      method: "PUT",
      headers: { Authorization: `Bearer ${accessToken}` },
      body: blob
    });
  } catch (e) {
    console.warn("saveMasterData() ‚Äì Upload fehlgeschlagen:", e);
  }
}

/* === Neu: Sortier-Helfer (deutsche Sortierung, numerisch) === */
function sortSelectOptions(selectEl, stickyTopValues = ["", "Sonstige"]) {
  if (!selectEl) return;
  const collator = new Intl.Collator("de", { numeric: true, sensitivity: "base" });

  const opts    = Array.from(selectEl.options);
  const current = selectEl.value;

  // Platzhalter / Sonstige oben lassen
  const sticky = opts.filter(o => stickyTopValues.includes(o.value));
  const rest   = opts.filter(o => !stickyTopValues.includes(o.value));

  rest.sort((a, b) => collator.compare(
    (a.textContent || a.innerText || a.value).trim(),
    (b.textContent || b.innerText || b.value).trim()
  ));

  // Neu aufbauen
  selectEl.options.length = 0;
  sticky.forEach(o => selectEl.add(new Option(o.text, o.value)));
  rest.forEach(o   => selectEl.add(new Option(o.text, o.value)));

  // Auswahl erhalten
  selectEl.value = current;
}

// === Neu: Einf√ºgen + immer sortieren, optional autoselect ===
function addOptionUnique(selectEl, label, { autoselect = false } = {}) {
  const value = (label || "").trim();
  if (!selectEl || !value) return;

  const exists = [...selectEl.options].some(o =>
    ((o.textContent || o.innerText || o.value).trim().toLowerCase() === value.toLowerCase())
  );

  if (!exists) {
    selectEl.add(new Option(value, value)); // Position egal ‚Äì danach sortieren
  }

  // "" = ‚ÄûBitte ausw√§hlen‚Äú, "Sonstige" bleibt oben
  sortSelectOptions(selectEl, ["", "Sonstige"]);

  if (autoselect) selectEl.value = value; // nur auf Wunsch ausw√§hlen
}


/* ‚¨áÔ∏è NEU: Dropdowns aus Stammdaten vollst√§ndig neu aufbauen */
window.rebuildDropdownsFromMaster = function () {
  const maschineSelect    = document.getElementById("maschine");
  const anlagenteilSelect = document.getElementById("anlagenteil");
  if (!maschineSelect || !anlagenteilSelect) return;

  // Basisoptionen (aus dem aktuellen HTML dieses Builds)
  const baseMaschine = Array.from(maschineSelect.options).map(o => o.value);
  const baseTeile    = Array.from(anlagenteilSelect.options).map(o => o.value);

  // Alles zur√ºck auf ‚Äûnur Basisoptionen‚Äú
  Array.from(maschineSelect.options).forEach(o => { if (!baseMaschine.includes(o.value)) o.remove(); });
  Array.from(anlagenteilSelect.options).forEach(o => { if (!baseTeile.includes(o.value))   o.remove(); });

  // Neue Stammdaten anh√§ngen (f√ºgt ein & sortiert direkt)
  (masterData.maschinen     || []).forEach(n => addOptionUnique(maschineSelect, n));
  (masterData.anlagenteile  || []).forEach(n => addOptionUnique(anlagenteilSelect, n));

  // ‚ÄûSonstige‚Äú-Felder korrekt ein-/ausblenden
  maschineSelect.dispatchEvent(new Event('change'));
  anlagenteilSelect.dispatchEvent(new Event('change'));

  // Sicherheit: zum Schluss noch einmal sortieren
  sortSelectOptions(maschineSelect, ["", "Sonstige"]);
  sortSelectOptions(anlagenteilSelect, ["", "Sonstige"]);
};
/* ‚¨ÜÔ∏è ENDE neu */


  // ====================
  // Draft-Funktionen
  // ====================

  const fieldIds = [
    "auftrag_id",
    "bearbeitet_am",
    "techniker1",
    "techniker2",
    "maschinenstillstand",
    "ausfall_stunden",
    "ausfall_minuten",
    "maschine",
    "sonstige_maschine",
    "anlagenteil",
    "sonstige_anlagenteil",
    "startzeit",
    "endzeit",
    "dauer",
    "abschlussdatum",
    "fehlerbeschreibung",
    "reinigung_erforderlich",
    "reinigungsart_zusatz",
    "sonstige_reinigungsart_zusatz",
    "reinigungsart_sonstiges",
    "ort_datum"
  ];

  // ====================
  // OneDrive-Upload (robuster, mit Fehlertext)
  // ====================
  async function uploadToOneDrive(filename, blob, mime = "application/pdf", parentIdOverride = null) {
    if (!accessToken) { alert("‚ö†Ô∏è Kein Zugriffstoken. Bitte anmelden."); return false; }
    if (!TARGET.driveId || !TARGET.parentItemId) { alert("‚ö†Ô∏è Zielordner nicht initialisiert."); return false; }

    const parentId = parentIdOverride || TARGET.parentItemId;  // <‚Äî NEU
    const url =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
      `/items/${parentId}:/${encodeURIComponent(filename)}:/content`;

    try {
      const res = await fetch(url, {
        method: "PUT",
        headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": mime },
        body: blob
      });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        console.error("Upload-Fehler:", res.status, text);
      }
      return res.ok;
    } catch (err) {
      console.error("Fehler beim Upload:", err);
      return false;
    }
  }

  // ====================
  // Formular ‚Üí statischer Inhalt (f√ºr PDF)
  // ====================
function convertFormElementsToStaticText(container){
  const d = container.ownerDocument;

  // 1) Action-Buttons & Dateiuploads ausblenden
  container.querySelectorAll('button, input[type="file"], .delete-button')
           .forEach(el => el.style.display = 'none');

  // 2) Vorschau-Bilder ohne Beschr√§nkung (f√ºr das PDF)
  container.querySelectorAll('.preview-container img').forEach(img => {
    img.style.maxWidth = '100%';
    img.style.maxHeight = 'none';
    img.style.border = '0';
    img.loading = 'eager';
  });

// 3) SELECT/INPUT ‚Üí Daten-Attribut ‚Äûdata-selected-text‚Äú respektieren
container.querySelectorAll('select').forEach(sel => {
  const label = container.querySelector(`label[for="${sel.id}"]`);
  const row   = d.createElement('div'); 
  row.className = 'print-field';
  row.classList.add('avoid-break');                 // ‚Üê hinzugef√ºgt
  const l     = d.createElement('div'); l.className = 'print-label';
  const v     = d.createElement('div'); v.className = 'print-value';
  l.textContent = label?.textContent?.trim() || sel.name || '';
  v.textContent = sel.getAttribute('data-selected-text') || sel.value || '';
  if (label) label.remove();                        // Original-Label entfernen
  sel.replaceWith(row); row.append(l, v);
});

// 4) TEXTAREA ‚Üí IMMER in statischen Text umwandeln (sonst wird abgeschnitten)
container.querySelectorAll('textarea').forEach(ta => {
  const label = container.querySelector(`label[for="${ta.id}"]`);
  const row   = d.createElement('div'); 
  row.className = 'print-field';
  row.classList.add('avoid-break');                 // ‚Üê hinzugef√ºgt
  const l     = d.createElement('div'); l.className = 'print-label';
  const v     = d.createElement('div'); v.className = 'print-value';
  l.textContent = label?.textContent?.trim() || ta.name || '';
  v.textContent = (ta.value || '').trim();          // value als Text (kein HTML)
  if (label) label.remove();
  ta.replaceWith(row); row.append(l, v);
});

// 5) Normale Inputs (date, time, text, number ‚Ä¶) in statischen Text wandeln
container.querySelectorAll('input').forEach(inp => {
  if (/^(button|submit|file|checkbox|radio)$/i.test(inp.type)) return; // ignorieren
  const label = container.querySelector(`label[for="${inp.id}"]`);
  const row   = d.createElement('div'); 
  row.className = 'print-field';
  row.classList.add('avoid-break');                 // ‚Üê hinzugef√ºgt
  const l     = d.createElement('div'); l.className = 'print-label';
  const v     = d.createElement('div'); v.className = 'print-value';
  l.textContent = label?.textContent?.trim() || inp.name || '';
  v.textContent = (inp.value || '').trim();
  if (label) label.remove();
  inp.replaceWith(row); row.append(l, v);
});


  // 6) Doppelte Zeilen (falls entstanden) bereinigen
  const rows = Array.from(container.querySelectorAll('.print-field'));
  for (let i = 1; i < rows.length; i++) {
    const prev = rows[i - 1];
    const curr = rows[i];
    if (prev && curr && prev.textContent.trim() === curr.textContent.trim()) {
      curr.remove();
    }
  }
}













// ====================
// Auftrag abschlie√üen ‚Üí PDF erzeugen & hochladen
// ====================


async function generatePDFAndFinish() {
  // 0) Lib + Login
  await loadHtml2PdfIfNeeded();
  if (!window.html2pdf) { alert("html2pdf konnte nicht geladen werden."); return; }

  await signInAndAcquireToken(true);
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }

  const src = document.getElementById("pdfExportContainer");
  if (!src) { alert("Container nicht gefunden."); return; }

  // ‚úÖ Pflichtfelder NUR beim Abschluss pr√ºfen
  if (!validateBeforeFinish()) return;

  // ‚úÖ Wartung (optional): aktuelle Wartungsaufgabe als "heute durchgef√ºhrt" markieren
  try { await window.wpMarkCurrentTaskDone?.(); }
  catch (e) { console.warn('wpMarkCurrentTaskDone:', e); }

  // A) Canvas aus dem ORIGINAL sichern (id -> DataURL)
  const signatureMap = new Map(
    Array.from(src.querySelectorAll('canvas')).map(c => {
      try { return [c.id, c.toDataURL('image/png')]; }
      catch (e) { console.warn('toDataURL fehlgeschlagen', e); return [c.id, null]; }
    })
  );

  // B) Offscreen-Iframe
  const frame = document.getElementById('pdfSandbox');
  if (!frame) { alert("PDF-Frame fehlt."); return; }
  const doc = frame.contentDocument || frame.contentWindow?.document;
  if (!doc) { alert("PDF-Dokumentkontext nicht verf√ºgbar."); return; }

doc.write(`<!doctype html>
<html lang="de"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=794, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
  html,body{margin:0;padding:0;background:#fff;}
  #root{width:794px; box-sizing:border-box; padding:0;}
  html,body,#root{-webkit-text-size-adjust:none;text-size-adjust:none;}
  #root, #root *{ font-family:"Inter", Arial, sans-serif !important; line-height:1.35; box-sizing:border-box; }
  #pdfExportContainerClone{ width:794px; padding:20px; margin:0 auto; background:#fff; }

  /* ‚úÖ Flex statt Grid, verhindert √úberlappungen bei langen Texten */
  .print-field{
    display:flex !important;
    flex-wrap:nowrap !important;
    align-items:flex-start !important;
    gap:12px !important;
    padding:6px 0 !important;
    border-bottom:1px solid #e9e9e9 !important;
  }
  .print-label{
    font-weight:700;
    white-space:normal !important;
    overflow-wrap:anywhere !important;
    word-break:break-word !important;
    min-width:0 !important;
    flex:0 0 38% !important;
    max-width:38% !important;
    padding-right:12px !important;
  }
  .print-value{
    white-space:pre-wrap !important;
    overflow-wrap:anywhere !important;
    word-break:break-word !important;
    hyphens:auto !important;
    line-height:1.4 !important;
    margin-bottom:6px !important;
    min-width:0 !important;
    flex:1 1 62% !important;
    max-width:62% !important;
  }

  .print-field > * { min-width:0; }
  .avoid-break{ break-inside:avoid; page-break-inside:avoid; }
  img{ max-width:100% !important; height:auto !important; border:0 !important; display:block; }
  canvas{ display:block !important; }
  h1{ font-size:24px; margin:0 0 8px; text-align:center; }
  @page { size: A4; margin: 0; }
</style>
</head><body><div id="root"></div></body></html>`);
doc.close();


  // C) html2pdf INS IFRAME laden (falls n√∂tig)
  if (!frame.contentWindow.html2pdf) {
    await new Promise((resolve, reject) => {
      const s = doc.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      s.onload = resolve;
      s.onerror = () => reject(new Error('html2pdf im Iframe konnte nicht geladen werden.'));
      doc.head.appendChild(s);
    });
  }

  // üîé Helper: sichtbaren Text f√ºr Select ermitteln (inkl. ‚ÄûSonstige‚Äú-Felder)
  const selectedText = (selId) => {
    const sel = document.getElementById(selId);
    if (!sel) return "";
    let text = (sel.options?.[sel.selectedIndex]?.text || sel.value || "").trim();
    if (selId === "reinigung_erforderlich") {
      const v = (sel.value || "").toLowerCase();
      if (v === "ja") return "Ja";
      if (v === "nein") return "Nein";
    }
    if (selId === "maschine" && sel.value === "Sonstige") {
      const t = document.getElementById("sonstige_maschine")?.value?.trim();
      if (t) text = t;
    }
    if (selId === "anlagenteil" && sel.value === "Sonstige") {
      const t = document.getElementById("sonstige_anlagenteil")?.value?.trim();
      if (t) text = t;
    }
    return text;
  };

  // D) Inhalt klonen
  const clone = src.cloneNode(true);
  clone.id = 'pdfExportContainerClone';
  clone.classList.add('pdf-snapshot');
  clone.style.width = '794px';
  clone.style.maxWidth = '794px';
  clone.style.margin = '0';
  clone.style.padding = '20px';
  clone.style.background = '#ffffff';

  // --- üÜï Wartungsblock nur ins PDF, wenn ausgef√ºllt ---
  function wartungHasUserInput() {
    const selTask  = document.getElementById('wpTaskSelect')?.value?.trim();
    const interval = document.getElementById('wpIntervalDays')?.value?.trim();
    const lastDate = document.getElementById('wpLastDate')?.value?.trim();
    const nextDue  = document.getElementById('wpNextDue')?.value?.trim();
    return !!(selTask || interval || lastDate || nextDue);
  }

  const wartungSectionInClone = clone.querySelector('#wartungsplanSection');
  if (!wartungHasUserInput()) {
    // kompletten Bereich im PDF ausblenden
    wartungSectionInClone?.remove();
  } else {
    // Buttons/Hinweise im PDF entfernen (nur Darstellung)
    clone.querySelector('#wpHint')?.remove();
    clone.querySelectorAll('#wartungsplanPanel button').forEach(b => b.remove());
    clone.querySelector('#wpWarning')?.remove();

    // --- üÜï Werte der Wartungsfelder explizit vom Original √ºbernehmen ---
    (function copyWartungValuesIntoClone(){
      const copyInput = (id) => {
        const o = document.getElementById(id);
        const c = clone.querySelector('#' + id);
        if (o && c) c.value = o.value;
      };
      const copySelect = (id) => {
        const o = document.getElementById(id);
        const c = clone.querySelector('#' + id);
        if (!o || !c) return;
        c.value = o.value;
        Array.from(c.options).forEach(opt => opt.selected = (opt.value === o.value));
        const text = o.options?.[o.selectedIndex]?.text?.trim() || o.value || '';
        c.setAttribute('data-selected-text', text);
      };

      copySelect('wpTaskSelect');
      copyInput('wpIntervalDays');
      copyInput('wpLastDate');
      copyInput('wpNextDue');

      // Status-Pill Text sichern (rein kosmetisch)
      const pillOrig  = document.getElementById('wpStatusPill');
      const pillClone = clone.querySelector('#wpStatusPill');
      if (pillOrig && pillClone) pillClone.textContent = pillOrig.textContent;
    })();
  }
  // --- üÜï Ende Wartungsblock-Logik ---

  // Select-Werte + sichtbare Texte √ºbernehmen (f√ºr die PDF-Umwandlung)
  clone.querySelectorAll('select').forEach(sel => {
    const orig = document.getElementById(sel.id);
    if (!orig) return;
    sel.value = orig.value;
    Array.from(sel.options).forEach(o => o.selected = (o.value === orig.value));
    sel.setAttribute('data-selected-text', selectedText(sel.id));
  });

  // Canvas -> IMG
  clone.querySelectorAll('canvas').forEach(c => {
    const url = signatureMap.get(c.id);
    if (!url) return;
    const img = doc.createElement('img');
    img.src = url;
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.className = 'avoid-break';
    c.parentNode.replaceChild(img, c);
  });

  // In iFrame einf√ºgen & in statischen Inhalt wandeln
  doc.getElementById('root').appendChild(clone);
  convertFormElementsToStaticText(clone);
  clone.querySelectorAll('.preview-container img').forEach(img => {
    img.style.maxWidth = '100%';
    img.style.maxHeight = '';
    img.style.border = '0';
    img.style.display = 'block';
  });

  try {
    // E) Laden abwarten
    if (doc.fonts && doc.fonts.ready) { await doc.fonts.ready; }
    const imgs = doc.images;
    await Promise.all([...imgs].map(img => img.complete ? Promise.resolve()
      : new Promise(res => { img.onload = img.onerror = res; })));

    // F) Dateiname
    const auftragIdField = document.getElementById("auftrag_id");
    let auftragId = auftragIdField?.value?.trim();
    if (!auftragId) {
      const datePart = new Date().toISOString().split("T")[0].replace(/-/g, "");
      auftragId = `REP-${datePart}-${crypto.randomUUID().slice(0,4).toUpperCase()}`;
      if (auftragIdField) auftragIdField.value = auftragId;
    }
    const filename = `${auftragId}.pdf`;

    // G) html2pdf-Optionen
    const height = doc.getElementById('root').scrollHeight;
    const opt = {
      margin: 0,
      filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        scrollX: 0, scrollY: 0,
        windowWidth: 794,
        windowHeight: height,
        logging: false,
        foreignObjectRendering: false
      },
      jsPDF: { unit: 'px', format: [794, 1123], orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    // H) Rendern
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    const h2p = frame.contentWindow.html2pdf;
    const worker  = h2p().set(opt).from(doc.getElementById('root')).toPdf();
    const pdfBlob = await worker.get('pdf').then(pdf => pdf.output('blob'));

    // I) Upload & UI
    const success = await uploadToOneDrive(filename, pdfBlob);
    if (success) {
      // ---- META-Datei f√ºr das Dashboard mitschreiben ----
      const meta = {
        auftrags_id:        auftragId,
        pdfName:            filename,
        bearbeitet_am:      document.getElementById("bearbeitet_am")?.value || "",
        techniker1:         selectedText("techniker1"),
        techniker2:         (selectedText("techniker2") || "").replace(/^‚Äì$/, ""),
        maschine_value:     document.getElementById("maschine")?.value || "",
        maschine_text:      selectedText("maschine"),
        anlagenteil_value:  document.getElementById("anlagenteil")?.value || "",
        anlagenteil_text:   selectedText("anlagenteil"),
      };

      // ‚¨áÔ∏è sicherstellen, dass der Meta-Ordner existiert/aufgel√∂st ist
      if (!TARGET_META_ITEM_ID) {
        try { await resolveShareLinkToFolder(); }
        catch(e){ console.warn("resolveShareLinkToFolder (Meta) fehlgeschlagen:", e); }
      }

      const metaBlob = new Blob([JSON.stringify(meta, null, 2)], { type: "application/json" });

      // bevorzugt in den Meta-Ordner, sonst Fallback Hauptordner
      const metaOk = await uploadToOneDrive(
        `${auftragId}.meta.json`,
        metaBlob,
        "application/json",
        TARGET_META_ITEM_ID || TARGET.parentItemId
      );
      if (!metaOk) console.warn("Meta-Upload fehlgeschlagen");

      alert("‚úÖ PDF erfolgreich in OneDrive gespeichert!");
      await deleteDraftFile?.();
      document.getElementById("abschlussScreen").style.display = "flex";

      try { if (document.getElementById("dashPanel")) await loadDashboard(); } catch {}
    } else {
      alert("‚ö†Ô∏è Fehler beim Hochladen in OneDrive.");
    }
  } catch (err) {
    console.error("‚ùå Fehler bei PDF-Erstellung/Upload:", err);
    alert("‚ùå PDF konnte nicht erstellt oder hochgeladen werden.");
  } finally {
    try { doc.body.innerHTML = '<div id="root"></div>'; } catch {}
  }
}




// ====================
// Sonstiges
// ====================
function forceUpdate() {
  (async () => {
    try {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      if (window.caches?.keys) {
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n)));
      }
      alert("‚úÖ Cache & Service Worker gel√∂scht. Seite wird neu geladen.");
      const url = new URL(location.href);
      url.searchParams.set('_', Date.now());
      location.replace(url.toString());
    } catch (e) {
      console.warn("forceUpdate() Fehler:", e);
      location.reload();
    }
  })();
}


// üíæ ENTWURF SPEICHERN
async function saveDraftToOneDrive() {
  await signInAndAcquireToken(true);
  await resolveShareLinkToFolder();
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const draftData = {};
  fieldIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) draftData[id] = el.value;
  });

  const draftJson = JSON.stringify(draftData, null, 2);
  const blob = new Blob([draftJson], { type: "application/json" });

  const auftragId = document.getElementById('auftrag_id')?.value || "ohne-id";
  const draftFilename = `Entwurf-${auftragId}.json`;

  // Falls der Unterordner existiert, dorthin; sonst in den Hauptordner
  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;

  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${parentId}:/${encodeURIComponent(draftFilename)}:/content`;

  const res = await fetch(url, {
    method: "PUT",
    headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": "application/json" },
    body: blob
  });

  if (res.ok) { alert("‚úÖ Entwurf erfolgreich gespeichert!"); }
  else { alert("‚ö†Ô∏è Fehler beim Speichern des Entwurfs."); }
}


// üì• ENTWURF LADEN
// üì• ENTWURF LADEN
async function loadDraftFromOneDrive(fileName) {
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;
  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${parentId}:/${encodeURIComponent(fileName)}:/content`;

  // Helper: fehlende Option in einem <select> hinzuf√ºgen und ausw√§hlen
  function ensureSelectValue(selId, value, autoselect = true) {
    const sel = document.getElementById(selId);
    if (!sel || value == null || value === "") return;
    const exists = [...sel.options].some(o =>
      (o.value || o.textContent).trim().toLowerCase() === String(value).trim().toLowerCase()
    );
    if (!exists) {
      if (typeof addOptionUnique === "function") addOptionUnique(sel, String(value), { autoselect });
      else {
        sel.add(new Option(String(value), String(value)));
        if (autoselect) sel.value = String(value);
      }
    } else if (autoselect) {
      sel.value = String(value);
    }
  }

  try {
    const res = await fetch(url, { method: "GET", headers: { Authorization: `Bearer ${accessToken}` } });
    if (!res.ok) { alert("‚ö†Ô∏è Fehler beim Laden des Entwurfs."); return; }

    const draftData = await res.json();

    // 1) Standard-Felder direkt setzen
    fieldIds.forEach(id => {
      const el = document.getElementById(id);
      if (el && draftData[id] !== undefined) el.value = draftData[id];
    });

    // 2) Techniker-Dropdowns sicherstellen (Option ggf. nachtragen)
    if (draftData.techniker1) ensureSelectValue("techniker1", draftData.techniker1);
    if (draftData.techniker2) ensureSelectValue("techniker2", draftData.techniker2);

    // 3) Maschine / Anlagenteil + ‚ÄûSonstige‚Äú-Felder korrekt setzen
    // Maschine
    if (draftData.sonstige_maschine && draftData.sonstige_maschine.trim()) {
      const sel = document.getElementById("maschine");
      const txt = document.getElementById("sonstige_maschine");
      if (sel) sel.value = "Sonstige";
      if (txt) txt.value = draftData.sonstige_maschine.trim();
    } else if (draftData.maschine) {
      ensureSelectValue("maschine", draftData.maschine, true);
    }

    // Anlagenteil
    if (draftData.sonstige_anlagenteil && draftData.sonstige_anlagenteil.trim()) {
      const sel = document.getElementById("anlagenteil");
      const txt = document.getElementById("sonstige_anlagenteil");
      if (sel) sel.value = "Sonstige";
      if (txt) txt.value = draftData.sonstige_anlagenteil.trim();
    } else if (draftData.anlagenteil) {
      ensureSelectValue("anlagenteil", draftData.anlagenteil, true);
    }

    // 4) UI-abh√§ngigkeiten aktualisieren (Sonstige-Felder ein-/ausblenden etc.)
    document.getElementById("maschine")?.dispatchEvent(new Event("change"));
    document.getElementById("anlagenteil")?.dispatchEvent(new Event("change"));
    document.getElementById("techniker1")?.dispatchEvent(new Event("change"));
    document.getElementById("techniker2")?.dispatchEvent(new Event("change"));

    alert("‚úÖ Entwurf erfolgreich geladen!");
  } catch (err) {
    console.error("Fehler beim Laden:", err);
    alert("‚ùå Fehler beim Laden des Entwurfs.");
  }
}



// üìÇ ENTWURFSLISTE ANZEIGEN
async function showDraftList() {
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;

  try {
    const res = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${parentId}/children?$select=id,name,file,folder`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    const data = await res.json();
    const files = (data.value || []).filter(item => item.name.endsWith(".json"));
    if (!files.length) { alert("‚ö†Ô∏è Keine Entw√ºrfe gefunden."); return; }

    let list = "Verf√ºgbare Entw√ºrfe:\n\n";
    files.forEach((f, i) => { list += `${i + 1}: ${f.name}\n`; });

    const numberInput = prompt("Bitte die Nummer des Entwurfs eingeben:\n\n" + list);
    const idx = parseInt(numberInput, 10) - 1;

    if (!isNaN(idx) && files[idx]) {
      // F√ºr sp√§teres L√∂schen merken wir uns Name + ID
      window.currentDraftFileName = files[idx].name;
      window.currentDraftFileId   = files[idx].id;

      await loadDraftFromOneDrive(files[idx].name);
    } else {
      alert("‚ö†Ô∏è Ung√ºltige Nummer.");
    }
  } catch (err) {
    console.error("Fehler beim Abrufen der Liste:", err);
    alert("‚ùå Fehler beim Abrufen der Entw√ºrfe.");
  }
}



// üóëÔ∏è ENTWURF L√ñSCHEN
async function deleteDraftFile() {
  if (!accessToken) return;
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { console.warn("Zielordner nicht initialisiert."); return; }

  // Bevorzugt mit der gespeicherten Item-ID l√∂schen
  if (window.currentDraftFileId) {
    try {
      await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${window.currentDraftFileId}`,
        { method: "DELETE", headers: { Authorization: `Bearer ${accessToken}` } }
      );
      console.log("‚úÖ Entwurfsdatei gel√∂scht:", window.currentDraftFileName);
      window.currentDraftFileName = null;
      window.currentDraftFileId = null;
    } catch (err) {
      console.error("‚ùå Fehler beim L√∂schen der Entwurfsdatei:", err);
    }
    return;
  }

  // Fallback: Wenn nur der Name bekannt ist
  if (window.currentDraftFileName) {
    try {
      const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;
      const res = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${parentId}/children?$select=id,name`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      const data = await res.json();
      const match = (data.value || []).find(x => x.name === window.currentDraftFileName);
      if (!match) { console.warn("Datei nicht gefunden:", window.currentDraftFileName); return; }

      await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${match.id}`,
        { method: "DELETE", headers: { Authorization: `Bearer ${accessToken}` } }
      );
      console.log("‚úÖ Entwurfsdatei gel√∂scht:", window.currentDraftFileName);
      window.currentDraftFileName = null;
      window.currentDraftFileId = null;
    } catch (err) {
      console.error("‚ùå Fehler beim L√∂schen der Entwurfsdatei:", err);
    }
  }
}

window.confirmUpdate = function () {
  const modal = document.getElementById('updateModal');
  if (modal) modal.style.display = 'none';

  const msg = document.getElementById('confirmationMessage');
  if (msg) {
    msg.style.display = 'block';
    setTimeout(() => { msg.style.display = 'none'; }, 2500);
  }
};

// ===== Dashboard (mit 30-Tage-Schalter) =====
const META_SUFFIX = '.meta.json';

// false = nur letzte 30 Tage, true = alle
window.showAllOrders = false;

document.addEventListener('DOMContentLoaded', () => {
  const panel    = document.getElementById('dashPanel');
  const toggle   = document.getElementById('toggleDashBtn');
  const reload   = document.getElementById('dashReload');
  const clearBtn = document.getElementById('dashClear');
  const rangeBtn = document.getElementById('dashRangeBtn');

  toggle?.addEventListener('click', () => {
    const show = panel.style.display === 'none' || !panel.style.display;
    panel.style.display = show ? 'block' : 'none';
    if (show) loadDashboard();
  });

  reload?.addEventListener('click', loadDashboard);

  clearBtn?.addEventListener('click', () => {
    ['f_bearbeitet_am','f_techniker','f_maschine','f_anlagenteil'].forEach(id => {
      const el = document.getElementById(id); if (el) el.value = '';
    });
    window.showAllOrders = false;
    if (rangeBtn){ rangeBtn.dataset.mode = '30'; rangeBtn.textContent = 'üóìÔ∏è Letzte 30 Tage'; }
    applyFiltersToDashboard();
  });

  rangeBtn?.addEventListener('click', () => {
    const mode = rangeBtn.dataset.mode || '30';
    if (mode === '30') {
      window.showAllOrders = true;
      rangeBtn.dataset.mode = 'all';
      rangeBtn.textContent  = 'üóìÔ∏è Alle Auftr√§ge';
      const d = document.getElementById('f_bearbeitet_am'); if (d) d.value = '';
    } else {
      window.showAllOrders = false;
      rangeBtn.dataset.mode = '30';
      rangeBtn.textContent  = 'üóìÔ∏è Letzte 30 Tage';
    }
    applyFiltersToDashboard();
  });

  ['f_bearbeitet_am','f_techniker','f_maschine','f_anlagenteil'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', applyFiltersToDashboard);
  });

  // üõ†Ô∏è Wartung-Button im Kopf (√∂ffnet/schlie√üt den Wartungsbereich)
  const wartungHeadBtn = document.getElementById('wartungToggleHead');
  if (wartungHeadBtn) {
    wartungHeadBtn.addEventListener('click', () => {
      const panel   = document.getElementById('wartungsplanPanel');    // Panel aus dem Wartungsplan-HTML
      const section = document.getElementById('wartungsplanSection');  // Umrahmende Section

      if (!panel || !section) {
        alert('Wartungsbereich ist noch nicht eingebaut.');
        return;
      }
      const willShow = panel.style.display === 'none' || !panel.style.display;
      panel.style.display = willShow ? 'block' : 'none';
      wartungHeadBtn.textContent = willShow ? 'üõ†Ô∏è Wartung (zu)' : 'üõ†Ô∏è Wartung';

      if (willShow) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  }
});



async function loadDashboard(){
  await signInAndAcquireToken(true);
  await resolveShareLinkToFolder();

  const tbody = document.querySelector('#dashTable tbody');
  const empty = document.getElementById('dashEmpty');
  if (!tbody) return;

  tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;">Lade‚Ä¶</td></tr>';
  if (empty) empty.style.display = 'none';

  try{
    const headers = { Authorization: `Bearer ${accessToken}` };

    // PDFs im Hauptordner (bleiben dort)
    const listPdfUrl =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}` +
      `/children?$top=2000&$select=id,name,webUrl,file,folder`;
    const pdfRes = await fetch(listPdfUrl, { headers });
    const mainItems = (await pdfRes.json()).value || [];

    const pdfMap = new Map(
      mainItems.filter(i => i.file && /\.pdf$/i.test(i.name))
               .map(i => [i.name, i.webUrl])
    );

    // META-Dateien: zuerst Meta-Ordner, sonst Fallback Hauptordner
    let metaItems = [];
    if (TARGET_META_ITEM_ID) {
      const listMetaUrl =
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET_META_ITEM_ID}` +
        `/children?$top=2000&$select=id,name,file`;
      const metaRes = await fetch(listMetaUrl, { headers });
      if (metaRes.ok){
        const data = await metaRes.json();
        metaItems = (data.value || []).filter(i => i.file && i.name.endsWith(META_SUFFIX));
      }
    }
    if (!metaItems.length){
      metaItems = mainItems.filter(i => i.file && i.name.endsWith(META_SUFFIX));
    }

    const rows = [];
    for (const m of metaItems){
      const mres = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${m.id}/content`,
        { headers }
      );
      if (!mres.ok) continue;
      const meta = await mres.json();

      const auftragsId = (meta.auftrags_id || m.name.replace(META_SUFFIX,'')).trim();
      const pdfName    = meta.pdfName || `${auftragsId}.pdf`;

      rows.push({
        dateIso:  meta.bearbeitet_am || '',
        dateDisp: meta.bearbeitet_am ? new Date(meta.bearbeitet_am).toLocaleDateString('de-DE') : '',
        tech:     [meta.techniker1, meta.techniker2].filter(Boolean).join(', '),
        maschine: meta.maschine_text || meta.maschine_value || '',
        teil:     meta.anlagenteil_text || meta.anlagenteil_value || '',
        id:       auftragsId,
        url:      pdfMap.get(pdfName) || null
      });
    }

    rows.sort((a,b) => (b.dateIso||'').localeCompare(a.dateIso||''));

    if (!rows.length){
      tbody.innerHTML = '';
      if (empty) empty.style.display = 'block';
      // Analytics ausblenden, wenn keine Zeilen
      const dashBox = document.getElementById('dashAnalytics');
      if (dashBox) dashBox.style.display = 'none';
      return;
    }

    tbody.innerHTML = rows.map(r => {
      const idCell = r.url ? `<a href="${r.url}" target="_blank" rel="noopener">${r.id}</a>` : r.id;
      return `<tr>
        <td data-k="bearbeitet_am" data-iso="${r.dateIso}">${r.dateDisp}</td>
        <td data-k="techniker">${r.tech}</td>
        <td data-k="maschine">${r.maschine}</td>
        <td data-k="anlagenteil">${r.teil}</td>
        <td data-k="auftrag_id">${idCell}</td>
      </tr>`;
    }).join('');

    applyFiltersToDashboard(); // -> triggert auch updateAnalytics()
  }catch(e){
    console.error('Dashboard:', e);
    tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;">Fehler beim Laden.</td></tr>';
    const dashBox = document.getElementById('dashAnalytics');
    if (dashBox) dashBox.style.display = 'none';
  }
}

/* üîé NEU: Balkenliste rendern */
function renderTop(map, targetId){
  const target = document.getElementById(targetId);
  if(!target) return;
  const entries = [...map.entries()];
  const total   = entries.reduce((a,[,n]) => a+n, 0) || 1;

  const top = entries
    .sort((a,b) => b[1]-a[1] || a[0].localeCompare(b[0],'de'))
    .slice(0,5);

  target.innerHTML = top.length ? top.map(([label,count])=>{
    const pct = Math.round((count/total)*100);
    return `<div class="bar-row" data-label="${label}">
      <div class="bar-label" title="${label}">${label}</div>
      <div class="bar"><div class="bar-fill" style="width:${pct}%"></div></div>
      <div class="bar-count">${count}</div>
    </div>`;
  }).join('') : `<div style="color:#666">Keine Daten</div>`;

  // Klick = Filter setzen
  target.querySelectorAll('.bar-row').forEach(row=>{
    row.addEventListener('click', ()=>{
      const label = row.dataset.label || '';
      const inputId = (targetId === 'topMachines') ? 'f_maschine' : 'f_anlagenteil';
      const inp = document.getElementById(inputId);
      if (inp){ inp.value = label; applyFiltersToDashboard(); }
    });
  });
}

/* üîé NEU: Auswertung der aktuell sichtbaren Zeilen */
function updateAnalytics(){
  const rows = [...document.querySelectorAll('#dashTable tbody tr')]
    .filter(tr => tr.style.display !== 'none');

  const dashBox = document.getElementById('dashAnalytics');
  if (!dashBox) return;

  if (!rows.length){
    dashBox.style.display = 'none';
    return;
  }

  const machines = new Map();
  const parts    = new Map();

  rows.forEach(tr=>{
    const m = tr.querySelector('[data-k="maschine"]')?.textContent.trim() || '';
    const a = tr.querySelector('[data-k="anlagenteil"]')?.textContent.trim() || '';
    if (m) machines.set(m, (machines.get(m)||0) + 1);
    if (a) parts.set(a,    (parts.get(a)||0)    + 1);
  });

  renderTop(machines, 'topMachines');
  renderTop(parts,    'topParts');
  dashBox.style.display = 'block';
}

function applyFiltersToDashboard(){
  const valDate   = (document.getElementById('f_bearbeitet_am')?.value || '').trim(); // ISO yyyy-mm-dd
  const valTech   = (document.getElementById('f_techniker')?.value     || '').trim().toLowerCase();
  const valMach   = (document.getElementById('f_maschine')?.value      || '').trim().toLowerCase();
  const valTeil   = (document.getElementById('f_anlagenteil')?.value   || '').trim().toLowerCase();

  const rows = document.querySelectorAll('#dashTable tbody tr');
  let shown = 0;

  // Grenze f√ºr ‚Äûletzte 30 Tage‚Äú
  const now   = new Date();
  const last30 = new Date(now.getTime() - 30*24*60*60*1000);

  rows.forEach(tr => {
    const cDate = tr.querySelector('[data-k="bearbeitet_am"]');
    const cTech = tr.querySelector('[data-k="techniker"]');
    const cMac  = tr.querySelector('[data-k="maschine"]');
    const cTeil = tr.querySelector('[data-k="anlagenteil"]');

    let ok = true;

    // Textfilter
    if (valTech && !(cTech?.textContent || '').toLowerCase().includes(valTech)) ok = false;
    if (valMach && !(cMac ?.textContent || '').toLowerCase().includes(valMach)) ok = false;
    if (valTeil && !(cTeil?.textContent || '').toLowerCase().includes(valTeil)) ok = false;

    // Datumsfilter per Eingabefeld (zeigt nur >= ausgew√§hltem Datum)
    if (ok && valDate) {
      const rowIso = cDate?.dataset.iso || '';
      if (!rowIso || rowIso < valDate) ok = false;
    }

    // 30-Tage-Einschr√§nkung (wenn nicht ‚Äûalle‚Äú aktiv)
    if (ok && !window.showAllOrders) {
      const rowIso = cDate?.dataset.iso || '';
      if (rowIso) {
        const d = new Date(rowIso);
        if (!(d >= last30)) ok = false;
      }
    }

    tr.style.display = ok ? '' : 'none';
    if (ok) shown++;
  });

  const empty = document.getElementById('dashEmpty');
  if (empty) empty.style.display = shown ? 'none' : 'block';

  // üîé NEU: nach jedem Filter neu berechnen
  updateAnalytics();
}
// ===== /Dashboard =====

</script>
<script>
/* ===== Wartungsplan ‚Äì Daten & OneDrive-Speicher ===== */
const WP_FILE = "Wartungsplaene.json";
/** Struktur: { [maschinenName]: [ { id, name, intervalDays, lastDateISO, nipples } ] } */

// ===============================
// Wartungspl√§ne ‚Äì Kern-Helfer
// ===============================
let wartungsplaene = {};
let _wpIdx = {}; // { normMaschinenName: tasks[] }

// Namen robust vergleichen (Umlaute/√ü/Mehrfach-Spaces egal)
function wpNorm(s){
  return String(s || "")
    .toLowerCase()
    .replace(/√ü/g, "ss")
    .normalize("NFD").replace(/\p{Diacritic}/gu, "") // √§‚Üía, √∂‚Üío, √º‚Üíu, √©‚Üíe ‚Ä¶
    .replace(/\s+/g, " ")
    .trim();
}

// Index EINMAL bauen (nutzt wpNorm)
function wpBuildIndex(){
  _wpIdx = {};
  for (const [m, tasks] of Object.entries(wartungsplaene || {})){
    _wpIdx[wpNorm(m)] = Array.isArray(tasks) ? tasks : [];
  }
}
function wpRebuildIndex(){ wpBuildIndex(); } // <- KEIN wpIndex!

// ===============================
// Datums-/Status-Helfer
// ===============================
function wpTodayISO(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function wpAddDays(iso, days){
  if (!iso) return "";
  const d = new Date(iso); d.setDate(d.getDate()+Number(days||0));
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function wpComputeNext(lastDate, intervalDays){
  if (!lastDate || !intervalDays) return "";
  return wpAddDays(lastDate, intervalDays);
}
function wpStatus(nextIso){
  if (!nextIso) return {label:"‚Äì",level:"none",bg:"#e9ecef",fg:"#000"};
  const t = wpTodayISO();
  if (nextIso < t) return {label:"√úberf√§llig",level:"overdue",bg:"#f8d7da",fg:"#842029"};
  const daysLeft = Math.floor((new Date(nextIso) - new Date(t))/86400000);
  if (daysLeft <= 3) return {label:"Bald f√§llig",level:"soon",bg:"#fff3cd",fg:"#664d03"};
  return {label:"OK",level:"ok",bg:"#d1e7dd",fg:"#0f5132"};
}

// ===============================
// MAIL-REGELN (Default-Intervalle)
// ===============================
// - Alle Vakuumf√ºller: t√§glich
// - Antriebseinheit Multivac 4 / Petrella SB: w√∂chentlich
// - Alles andere: alle 4 Wochen
const WP_RULES = {
  daily:  [/vakuumf√ºller/i],
  weekly: [/\bmultivac\s*4\b/i, /\bpetrella\s*sb\b/i]
};
// Maschine + (optional) Aufgabenname => Default-Intervall in Tagen
function wpMailRuleInterval(machineName = "", taskName = "") {
  const m = String(machineName || "").trim();
  const t = String(taskName   || "").trim();
  if (WP_RULES.daily .some(rx => rx.test(m))) return 1;   // t√§glich
  if (WP_RULES.weekly.some(rx => rx.test(m))) return 7;   // w√∂chentlich
  if (/antrieb/i.test(t))                    return 7;    // Aufgabe deutet Antrieb ‚Üí weekly
  return 28;                                              // sonst 4 Wochen
}
// Intervallfeld (und NextDue/Status) gem√§√ü Regel vorschlagen
function wpApplyMailRules({ force = false } = {}) {
  const { selMaschine, selTask, interval, last, next, pill } = wpEls?.() || {};
  if (!interval) return;
  const machineName =
    selMaschine?.value || selMaschine?.options?.[selMaschine.selectedIndex]?.text || "";
  const taskText =
    selTask?.options?.[selTask.selectedIndex]?.text?.trim() || selTask?.value || "";
  if (!force && interval.value) return;
  const days = wpMailRuleInterval(machineName, taskText);
  interval.value = String(days);
  if (last && /^\d{4}-\d{2}-\d{2}$/.test(last.value)) {
    if (next) next.value = wpComputeNext(last.value, days);
  }
  const st = wpStatus(next?.value || "");
  if (pill) { pill.textContent = st.label; pill.style.background = st.bg; pill.style.color = st.fg; }
}

// ===============================
// Laden aus OneDrive
// ===============================
const WP_FILE_PATH = "/me/drive/root:/Reparatur-Auftr√§ge/Wartungsplaene.json:/content";
const WP_CACHE_KEY = "TE15_WARTUNGSPLAENE";

async function wpLoad(){
  // 1) Cache
  try {
    const raw = localStorage.getItem(WP_CACHE_KEY);
    wartungsplaene = raw ? JSON.parse(raw) : {};
  } catch { wartungsplaene = {}; }

  // 2) OneDrive (nur wenn eingeloggt)
  if (window.accessToken){
    try{
      const r = await fetch("https://graph.microsoft.com/v1.0" + WP_FILE_PATH, {
        headers:{ Authorization:`Bearer ${accessToken}` }
      });
      if (r.ok){
        wartungsplaene = JSON.parse(await r.text());
        localStorage.setItem(WP_CACHE_KEY, JSON.stringify(wartungsplaene));
      }
    }catch(e){ console.warn("[WP] OneDrive load failed:", e); }
  }

  // 3) Index bauen & UI ansto√üen
  wpBuildIndex();
  console.info("[WP] geladen:", Object.keys(wartungsplaene || {}).length, "Maschinen");
  try { wpRefreshTaskList?.(); wpStatusUpdateForTask?.(); } catch {}
}

// Speichern (Cache + OneDrive)
async function wpSave(){
  try { localStorage.setItem("TE15_WARTUNGSPLAENE", JSON.stringify(wartungsplaene)); } catch {}
  wpRebuildIndex();

  if (!window.accessToken || !window.TARGET_META_ITEM_ID) return;
  const url = `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET_META_ITEM_ID}:/${encodeURIComponent(WP_FILE)}:/content`;
  const blob = new Blob([JSON.stringify(wartungsplaene, null, 2)], { type:"application/json" });
  try{
    await fetch(url, { method:"PUT", headers:{Authorization:`Bearer ${accessToken}`}, body:blob });
  }catch(e){ console.warn("wpSave()", e); }
}
// ===== Wartungs-LOG (Historie) ===================================
const WP_LOG_FILE   = "Wartungslog.json";
const WP_LOG_CACHE  = "TE15_WARTUNGSLOG";
// Wird in den gleichen Meta-Ordner geschrieben wie die Wartungspl√§ne
let wartungslog = [];

async function wpLogLoad(){
  // 1) Cache
  try { wartungslog = JSON.parse(localStorage.getItem(WP_LOG_CACHE) || "[]"); }
  catch { wartungslog = []; }

  // 2) OneDrive (nur wenn eingeloggt + Meta-Ordner vorhanden)
  if (window.accessToken && window.TARGET_META_ITEM_ID){
    try{
      const url = `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET_META_ITEM_ID}:/${encodeURIComponent(WP_LOG_FILE)}:/content`;
      const r = await fetch(url, { headers:{ Authorization:`Bearer ${accessToken}` } });
      if (r.ok) wartungslog = JSON.parse(await r.text());
    } catch(e){ console.warn("[WP-LOG] Load failed:", e); }
  }
  try { localStorage.setItem(WP_LOG_CACHE, JSON.stringify(wartungslog)); } catch {}
}

async function wpLogSave(){
  try { localStorage.setItem(WP_LOG_CACHE, JSON.stringify(wartungslog)); } catch {}
  if (!window.accessToken || !window.TARGET_META_ITEM_ID) return;
  try{
    const url = `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET_META_ITEM_ID}:/${encodeURIComponent(WP_LOG_FILE)}:/content`;
    const blob = new Blob([JSON.stringify(wartungslog, null, 2)], { type:"application/json" });
    await fetch(url, { method:"PUT", headers:{ Authorization:`Bearer ${accessToken}` }, body: blob });
  } catch(e){ console.warn("[WP-LOG] Save failed:", e); }
}

// Eintrag hinzuf√ºgen
async function wpLogExecution({dateISO, task, machine, technician=""}){
  if (!dateISO || !task) return;
  // Duplikate vermeiden (gleiches Task+Datum)
  const exists = wartungslog.some(e => e.taskId === task.id && e.dateISO === dateISO);
  if (exists) return;

  wartungslog.push({
    id: crypto.randomUUID(),
    dateISO,
    machine,
    taskId: task.id || "",
    taskName: task.name || "",
    intervalDays: task.intervalDays ?? "",
    nipples: task.nipples ?? "",
    technician
  });
  await wpLogSave();
}

/* ===== Wartungsplan ‚Äì UI (final, stabil, inkl. Nippel & Banner) ===== */
function wpEls(){
  return {
    panel: document.getElementById("wartungsplanPanel"),
    section: document.getElementById("wartungsplanSection"),
    warn: document.getElementById("wpWarning"),
    pill: document.getElementById("wpStatusPill"),
    selTask: document.getElementById("wpTaskSelect"),
    interval: document.getElementById("wpIntervalDays"),
    last: document.getElementById("wpLastDate"),
    next: document.getElementById("wpNextDue"),
    nip: document.getElementById("wpNipCount"),
    btnAdd: document.getElementById("wpAddTask"),
    btnSave: document.getElementById("wpSaveTask"),
    btnDel: document.getElementById("wpDeleteTask"),
    btnDone: document.getElementById("wpMarkDoneToday"),
    selMaschine: document.getElementById("maschine")
  };
}

/* ---------- Maschine-Key sicherstellen ---------- */
function wpEnsureMachineKey(name){
  if (!name) return null;
  const key = Object.keys(wartungsplaene).find(k => wpNorm(k) === wpNorm(name)) || name;
  wartungsplaene[key] ||= [];
  return key;
}

/* ---------- Aufgabenliste f√ºr gew√§hlte Maschine ---------- */
function wpRefreshTaskList(){
  const { selTask, selMaschine } = wpEls();
  if (!selTask) return;

  const mRaw  = (selMaschine?.value || '').trim();
  const mNorm = wpNorm(mRaw);

  const direct = wartungsplaene[mRaw] || [];
  const idx    = _wpIdx[mNorm] || [];
  const tasks  = direct.length ? direct : idx;

  selTask.innerHTML = '<option value="">Bitte ausw√§hlen</option>' +
    tasks.map(t => 
      `<option value="${t.id||''}" data-interval="${t.intervalDays||''}" data-nipples="${t.nipples||''}">
         ${t.name||''}
       </option>`
    ).join('');

  wpStatusUpdateForTask(null);
}

/* ---------- Aktuell gew√§hlten Task bestimmen ---------- */
function wpCurrentTask(){
  const { selMaschine, selTask } = wpEls();
  const m  = selMaschine?.value || "";
  const id = selTask?.value || "";
  const list = wartungsplaene[m] || _wpIdx[wpNorm(m)] || [];
  return list.find(t => String(t.id) === String(id)) || null;
}

/* ---------- Statusfelder aktualisieren ---------- */
function wpStatusUpdateForTask(task){
  const { interval, last, next, pill, nip, selMaschine } = wpEls();

  const clear = () => {
    if (interval) interval.value = "";
    if (last)     last.value = "";
    if (next)     next.value = "";
    if (nip)      nip.value = "";
    if (pill) {
      pill.textContent = "‚Äì";
      pill.style.background = "#e9ecef";
      pill.style.color = "#000";
    }
  };
  if (!task) return clear();

  let inter = toInt(task.intervalDays, "");
  const lastIso = isIsoDate(task.lastDateISO) ? task.lastDateISO : "";

  if (!inter || inter === 0){
    try {
      inter = wpMailRuleInterval(selMaschine?.value || "", task.name || "") || 28;
    } catch { inter = 28; }
  }

  if (interval) interval.value = inter;
  if (last) last.value = lastIso;

  const nextVal = (lastIso && inter) ? wpComputeNext(lastIso, inter) : "";
  if (next) next.value = nextVal;

  // ‚úÖ Schmiernippel √ºbernehmen
  if (nip) nip.value = task.nipples ?? "";

  const st = wpStatus(nextVal || "");
  if (pill) {
    pill.textContent = st.label;
    pill.style.background = st.bg;
    pill.style.color = st.fg;
  }
}

/* ---------- F√§lligkeiten & Banner ---------- */
function wpOverdueTasks(machineName){
  const tasks = wartungsplaene[machineName] || _wpIdx[wpNorm(machineName)] || [];
  return tasks.filter(t => {
    const inter = toInt(t.intervalDays || 0, 0);
    const last  = isIsoDate(t.lastDateISO) ? t.lastDateISO : "";
    const next  = wpComputeNext(last, inter);
    return wpStatus(next).level === "overdue";
  });
}
  // Alle Maschinen pr√ºfen und √ºberf√§llige Aufgaben einsammeln
function wpOverdueAll(){
  const res = [];
  const wp = window.wartungsplaene || {};
  for (const [machine, tasks] of Object.entries(wp)){
    if (!Array.isArray(tasks)) continue;
    const overdue = tasks.filter(t => {
      const inter = toInt(t.intervalDays || 0, 0);
      const last  = isIsoDate(t.lastDateISO) ? t.lastDateISO : "";
      const next  = wpComputeNext(last, inter);
      return wpStatus(next).level === "overdue";
    });
    if (overdue.length) res.push({ machine, overdue });
  }
  return res;
}


// üî¥ Globaler Banner: zeigt entweder f√ºr die gew√§hlte Maschine ODER global
function wpUpdateGlobalBanner(){
  const banner = document.getElementById('wpGlobalOverdueBanner');
  if (!banner) return;

  const { selMaschine } = wpEls();
  const selected = (selMaschine?.value || "").trim();

  // Wenn eine Maschine gew√§hlt ist: bisheriges Verhalten
  if (selected){
    const list = wpOverdueTasks(selected);
    if (!list.length){
      banner.style.display = "none";
      return;
    }
    const msgEl = banner.querySelector('[data-msg]');
    if (msgEl){
      const names = list.map(t => t.name).slice(0,3).join(', ');
      const more  = list.length > 3 ? ` (+${list.length - 3} weitere)` : '';
      msgEl.textContent = `Maschine ‚Äû${selected}‚Äú: ${list.length} Wartung(en) √ºberf√§llig ‚Äì ${names}${more}`;
    }
    banner.style.display = "flex";
    return;
  }

  // Keine Maschine gew√§hlt ‚Üí global pr√ºfen
  const all = wpOverdueAll();
  const total = all.reduce((a, x) => a + x.overdue.length, 0);

  if (!total){
    banner.style.display = "none";
    return;
  }

  const first = all[0];
  const firstNames = first.overdue.map(t => t.name).slice(0,3).join(', ');
  const rest = total - first.overdue.length;

  const msgEl = banner.querySelector('[data-msg]');
  if (msgEl){
    // Kleiner, aber informativer Globaltext
    msgEl.textContent =
      `${total} √ºberf√§llige Wartung(en) in ${all.length} Maschine(n) ‚Äì ` +
      `z. B. ‚Äû${first.machine}‚Äú: ${firstNames}${rest>0 ? ` (+${rest} weitere)` : ''}`;
  }
  banner.style.display = "flex";

  // Optional: Wenn der Banner-Button ‚ÄûWartung √∂ffnen‚Äú existiert,
  // und noch keine Maschine gew√§hlt ist, w√§hle beim Klick die erste betroffene.
  const openBtn = document.getElementById('wpOpenFromBanner') || banner.querySelector('[data-open]');
  if (openBtn){
    openBtn.onclick = () => {
      try{
        const { selMaschine } = wpEls();
        if (selMaschine && !selMaschine.value && first?.machine){
          // versuche die Maschine vorzuw√§hlen
          // 1) exakter Name
          selMaschine.value = first.machine;
          // 2) falls nicht exakt vorhanden: suche per Normalisierung
          if (selMaschine.value !== first.machine){
            const norm = wpNorm(first.machine);
            const opt = [...selMaschine.options].find(o => wpNorm(o.value) === norm || wpNorm(o.textContent||"") === norm);
            if (opt) selMaschine.value = opt.value;
          }
          selMaschine.dispatchEvent(new Event('change', { bubbles:true }));
        }
      }catch{}
      // Panel √∂ffnen, falls du das so handhabst:
      document.getElementById('wartungsplanPanel')?.style && (document.getElementById('wartungsplanPanel').style.display = 'block');
      document.getElementById('wartungToggleHead') && (document.getElementById('wartungToggleHead').textContent = 'üõ†Ô∏è Wartung (zu)');
      document.getElementById('wartungsplanSection')?.scrollIntoView({ behavior:'smooth', block:'start' });
    };
  }
}


function wpEvalWarning(){
  const { selMaschine, warn } = wpEls();
  const m = (selMaschine?.value || "").trim();
  let overdue = [], soon = [];

  if (m){
    const tasks = wartungsplaene[m] || [];
    for (const t of tasks){
      const inter = toInt(t.intervalDays || 0, 0);
      const last  = isIsoDate(t.lastDateISO) ? t.lastDateISO : "";
      const next  = wpComputeNext(last, inter);
      const st    = wpStatus(next);
      if (st.level === "overdue") overdue.push(t);
      else if (st.level === "soon") soon.push(t);
    }
  }

  if (warn){
    if (overdue.length || soon.length){
      const parts = [];
      if (overdue.length) parts.push(`‚ö†Ô∏è <strong>${overdue.length}</strong> √ºberf√§llige Wartung${overdue.length>1?"en":""}`);
      if (soon.length)    parts.push(`‚è≥ <strong>${soon.length}</strong> bald f√§llige Wartung${soon.length>1?"en":""}`);
      warn.style.display = "block";
      warn.innerHTML = parts.join(" ‚Ä¢ ");
    } else {
      warn.style.display = "none";
      warn.textContent = "";
    }
  }
  try { wpUpdateGlobalBanner?.(); } catch {}
}

/* ---------- Recalc ---------- */
function wpRecalcNext(){
  const { interval, last, next, pill } = wpEls();
  const inter   = toInt(interval?.value || 0, 0);
  const lastIso = isIsoDate(last?.value) ? last.value : "";
  if (next) next.value = inter > 0 && lastIso ? wpComputeNext(lastIso, inter) : "";

  const st = wpStatus(next?.value || "");
  if (pill){
    pill.textContent      = st.label;
    pill.style.background = st.bg;
    pill.style.color      = st.fg;
  }
}

  /* ---------- Helpers & Warning (einmal global) ---------- */
function isIsoDate(s){ return /^\d{4}-\d{2}-\d{2}$/.test(String(s||'')); }
function toInt(v, fallback=""){ const n=parseInt(String(v??'').replace(/[^\d-]/g,''),10); return Number.isFinite(n)?n:fallback; }

function wpStatusUpdateForTask(task){
  const { interval, last, next, pill, nip, selMaschine } = wpEls();
  const clear=()=>{ if(interval)interval.value=""; if(last)last.value=""; if(next)next.value=""; if(nip)nip.value=""; if(pill){ pill.textContent="‚Äì"; pill.style.background="#e9ecef"; pill.style.color="#000"; } };
  if(!task){ clear(); return; }

  let inter = toInt(task?.intervalDays, null);
  if(inter===null || inter===0){
    try{ inter = wpMailRuleInterval(selMaschine?.value||"", task?.name||"") || 28; }catch{ inter=28; }
  }
  if(interval) interval.value = inter==null ? "" : String(inter);

  const lastIso = isIsoDate(task?.lastDateISO) ? task.lastDateISO : "";
  if(last) last.value = lastIso;

  const nextVal = (lastIso && inter) ? wpComputeNext(lastIso, inter) : "";
  if(next) next.value = nextVal;

  let n = task?.nipples;
  n = (n===null || n===undefined || n==="") ? "" : toInt(n,"");
  if(nip) nip.value = n;

  const st = wpStatus(nextVal||"");
  if(pill){ pill.textContent=st.label; pill.style.background=st.bg; pill.style.color=st.fg; }
}

function wpEvalWarning(){
  const { selMaschine, warn } = wpEls();
  const m = (selMaschine?.value||"").trim();
  const tasks = m ? (window.wartungsplaene?.[m]||[]) : [];
  let overdue=0, soon=0;
  for(const t of tasks){
    const inter = toInt(t.intervalDays||0,0);
    const last  = isIsoDate(t.lastDateISO) ? t.lastDateISO : "";
    const next  = wpComputeNext(last, inter);
    const st    = wpStatus(next);
    if(st.level==="overdue") overdue++; else if(st.level==="soon") soon++;
  }
  if(warn){
    if(overdue||soon){
      const parts=[];
      if(overdue) parts.push(`‚ö†Ô∏è <strong>${overdue}</strong> √ºberf√§llige Wartung${overdue>1?"en":""}`);
      if(soon)    parts.push(`‚è≥ <strong>${soon}</strong> bald f√§llige Wartung${soon>1?"en":""}`);
      warn.style.display="block"; warn.innerHTML=parts.join(" ‚Ä¢ ");
    }else{ warn.style.display="none"; warn.textContent=""; }
  }
  try{ wpUpdateGlobalBanner?.(); }catch{}
  try{ wpCheckOverdueAndNotify?.({ sendMail:false, machine:m }); }catch{}
}
/* ---------- Ende Fix-Block ---------- */
function wpSyncPrintSummary(task){
  const box = document.getElementById('wpPrintSummary');
  if (!box) return;

  if (!task){
    box.style.display = 'none';
    return;
  }

  const { intervalDays, lastDateISO, name, nipples } = task;
  const inter = toInt(intervalDays || 0, 0);
  const last  = isIsoDate(lastDateISO) ? lastDateISO : "";
  const next  = (last && inter>0) ? wpComputeNext(last, inter) : "";

  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || "‚Äì"; };

  set('wpPrintTask', name || "");
  set('wpPrintInterval', inter ? String(inter) : "");
  set('wpPrintLast', last || "");
  set('wpPrintNext', next || "");
  set('wpPrintNip', (nipples ?? "") === "" ? "" : String(nipples));

  box.style.display = 'block';
}

  
/* ---------- Setup UI ---------- */
function setupWartungsplanUI(){
  const E = wpEls();
  if (!E.section) return;

  // Banner-Button: Panel √∂ffnen & scrollen
  document.getElementById('wpOpenFromBanner')?.addEventListener('click', () => {
    if (E.panel) E.panel.style.display = 'block';
    const headBtn = document.getElementById('wartungToggleHead');
    if (headBtn) headBtn.textContent = 'üõ†Ô∏è Wartung (zu)';
    E.section.scrollIntoView({ behavior:'smooth', block:'start' });
  });

  // ‚îÄ‚îÄ Maschine ge√§ndert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (E.selMaschine){
    E.selMaschine.onchange = () => {
      wpRefreshTaskList();
      wpStatusUpdateForTask(null);
      wpEvalWarning?.();
      wpUpdateGlobalBanner?.();
      wpSyncPrintSummary?.(null);        // Zusammenfassung leeren
    };
  }

  // ‚îÄ‚îÄ Aufgabe ge√§ndert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (E.selTask){
    E.selTask.onchange = () => {
      const t = wpCurrentTask();
      wpStatusUpdateForTask(t);

      // Intervall nur vorschlagen, wenn im Datensatz noch keins steht
      if (!t || !toInt(t?.intervalDays, "")) {
        try { wpApplyMailRules({ force:false }); } catch {}
      }

      wpUpdateGlobalBanner?.();
      wpSyncPrintSummary?.(t);           // Zusammenfassung f√ºllen
    };
  }

// ‚îÄ‚îÄ Eingaben ‚Üí F√§lligkeit neu berechnen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
E.interval?.addEventListener('input',  wpRecalcNext);

// NEU: "Zuletzt durchgef√ºhrt" akzeptiert dd.mm.jjjj ODER ISO und speichert sofort
E.last?.addEventListener('change', async () => {
  const t = wpCurrentTask(); if (!t) return;
  let v = (E.last.value || "").trim();

  // dd.mm.jjjj -> yyyy-mm-dd
  const m = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (m) { v = `${m[3]}-${m[2]}-${m[1]}`; E.last.value = v; }

  // nur g√ºltiges ISO √ºbernehmen
  t.lastDateISO = /^\d{4}-\d{2}-\d{2}$/.test(v) ? v : "";

  await wpSave();            // persistieren
  wpRecalcNext?.();          // Next-Datum in das Feld schreiben
  wpEvalWarning?.();         // Warnungen/Banner aktualisieren
  wpUpdateGlobalBanner?.();
  wpSyncPrintSummary?.(t);   // Zusammenfassung unter dem Panel
});


// (5) ‚îÄ‚îÄ Neue Aufgabe anlegen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
E.btnAdd?.addEventListener('click', async () => {
  const m = wpEnsureMachineKey(E.selMaschine?.value);
  if (!m){ alert("Bitte zuerst eine Maschine w√§hlen."); return; }

  const name = prompt("Bezeichnung der Wartungsaufgabe (z. B. 'Kette schmieren'):");
  if (!name) return;

  const t = { id: crypto.randomUUID(), name, intervalDays: 30, lastDateISO: "" };

  // Nippel aus Eingabefeld √ºbernehmen, falls vorhanden
  const nipVal = toInt(E.nip?.value || "", NaN);
  if (Number.isFinite(nipVal) && nipVal >= 0) t.nipples = nipVal;

  (wartungsplaene[m] ||= []).push(t);
  await wpSave();

  wpRefreshTaskList();
  if (E.selTask) E.selTask.value = t.id;

  try { wpApplyMailRules({ force:true }); } catch {}

  wpStatusUpdateForTask(t);
  wpEvalWarning?.();
  wpUpdateGlobalBanner?.();
  wpSyncPrintSummary?.(t);             // ‚á¢ neue Aufgabe in die Summary
});

E.btnSave?.addEventListener('click', async () => {
  const t = wpCurrentTask();
  if (!t){ alert("Bitte eine Aufgabe w√§hlen."); return; }

  // Intervall √ºbernehmen/validieren
  let inter = toInt(E.interval?.value || "", NaN);
  if (!Number.isFinite(inter) || inter < 1) inter = "";
  t.intervalDays = inter;

  // >>> NEU: Datum aus dem Feld normalisieren (dd.mm.jjjj -> ISO) und √ºbernehmen
  let v = (E.last?.value || "").trim();
  const m = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (m) { v = `${m[3]}-${m[2]}-${m[1]}`; if (E.last) E.last.value = v; }
  t.lastDateISO = /^\d{4}-\d{2}-\d{2}$/.test(v) ? v : "";

  // Nippelzahl √ºbernehmen (optional)
  const nipVal = toInt(E.nip?.value || "", NaN);
  if (Number.isFinite(nipVal) && nipVal >= 0) t.nipples = nipVal; else delete t.nipples;

  await wpSave();

  wpRecalcNext?.();
  wpEvalWarning?.();
  wpUpdateGlobalBanner?.();
  wpSyncPrintSummary?.(t);
});



  // ‚îÄ‚îÄ L√∂schen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  E.btnDel?.addEventListener('click', async () => {
    const m  = E.selMaschine?.value, id = E.selTask?.value;
    if (!m || !id) return;
    if (!confirm("Diese Wartungsaufgabe wirklich l√∂schen?")) return;

    wartungsplaene[m] = (wartungsplaene[m]||[]).filter(x => String(x.id) !== String(id));
    await wpSave();

    wpRefreshTaskList();
    wpStatusUpdateForTask(null);
    wpEvalWarning?.();
    wpUpdateGlobalBanner?.();
    wpSyncPrintSummary?.(null);
  });

  // (4) ‚îÄ‚îÄ Heute durchgef√ºhrt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  E.btnDone?.addEventListener('click', async () => {
    const t = wpCurrentTask();
    if (!t){ alert("Bitte eine Aufgabe w√§hlen."); return; }

    t.lastDateISO = wpTodayISO();
    await wpSave();
await wpLogExecutionAndRefresh({
  dateISO: t.lastDateISO,
  task: t,
  machine: E.selMaschine?.value || "",
  technician: E.selTechniker1?.value || ""
});


    wpRecalcNext();
    wpEvalWarning?.();
    wpUpdateGlobalBanner?.();
    wpSyncPrintSummary?.(t);             // ‚á¢ Summary nach ‚Äûheute‚Äú aktualisieren
  });

  // (6) >>> Initial nach dem ersten F√ºllen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  wpRefreshTaskList();
  const initTask = wpCurrentTask();
  wpStatusUpdateForTask(initTask);
  wpEvalWarning?.();
  wpUpdateGlobalBanner?.();
  wpSyncPrintSummary?.(initTask);
}

/* ---------- Init ---------- */
document.addEventListener("DOMContentLoaded", async () => {
  await wpLoad();
  await wpLogLoad();   // Wartungs-Log aus OneDrive + Cache laden

  setupWartungsplanUI();

  // Nachtr√§glich sicherstellen, dass alles initial gesetzt ist
  wpRefreshTaskList();
  const cur = wpCurrentTask?.() || null;
  wpStatusUpdateForTask(cur);
  wpEvalWarning?.();
  wpUpdateGlobalBanner?.();
  wpSyncPrintSummary?.(cur);

  try { wpCheckOverdueAndNotify?.({ sendMail:false }); } catch {}
});




// üîê Nach Login automatisch Banner + Warnungen aktualisieren
(function hookLogin(){
  const orig = window.signInAndAcquireToken;
  if (typeof orig === "function"){
    window.signInAndAcquireToken = async function(...args){
      const r = await orig.apply(this, args);
      try {
        await wpLoad();
        wpBuildIndex?.();
        wpRefreshTaskList?.();
        wpStatusUpdateForTask?.(wpCurrentTask?.());
        wpEvalWarning?.();

        // Banner nach Login sofort aktualisieren
        wpUpdateGlobalBanner?.();

        // Optional: beim Login Mail-Benachrichtigung erlauben
        wpCheckOverdueAndNotify?.({ sendMail:true });
      } catch(e){}
      return r;
    };
  }
})();
</script>

<script>

// ===== Wartungs-Dashboard (Log) =====
// *** Selbstversorgender Block: nutzt localStorage und deine bestehenden Felder ***

// Ein global geteilter Key ‚Äì keine Mehrfach-consts mehr
window.__WP_LOG_KEY__ = window.__WP_LOG_KEY__ || "wpLog";

function _wpNorm(s){ return String(s||"").toLowerCase().trim(); }
function _wpFmtISO(s){ return s || ""; }
function _byId(id){ return document.getElementById(id); }
function _toISO(d){
  if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
  const dt = d instanceof Date ? d : new Date();
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
}
function _getSelectText(sel){
  const el = _byId(sel);
  if (!el) return "";
  const opt = el.options?.[el.selectedIndex];
  return (opt?.textContent || opt?.innerText || el.value || "").trim();
}
function _collectEntryFromForm({useTodayIfEmpty=true}={}){
  const todayISO = _toISO(new Date());
  const dateISO = _byId("wpLastDate")?.value || (useTodayIfEmpty ? todayISO : "");
  return {
    dateISO: _toISO(dateISO),
    machine: _byId("maschine")?.value || "",
    taskName: _getSelectText("wpTaskSelect") || _byId("wpTaskSelect")?.value || "",
    intervalDays: parseInt(_byId("wpIntervalDays")?.value || "", 10) || "",
    nipples: parseInt(_byId("wpNipCount")?.value || "", 10) || "",
    technician: _byId("techniker1")?.value || ""
  };
}

// *** HIER die beiden Stellen auf window.__WP_LOG_KEY__ umgestellt ***
function wpLogLoad(){
  try{
    const raw = JSON.parse(localStorage.getItem(window.__WP_LOG_KEY__) || "[]");
    window.wartungslog = (raw||[]).map(e => ({
      dateISO: _toISO(e.dateISO || e.date || ""),
      machine: e.machine || e.maschine || "",
      taskName: e.taskName || e.task || "",
      intervalDays: (e.intervalDays ?? e.interval ?? ""),
      nipples: (e.nipples ?? e.nipCount ?? ""),
      technician: e.technician || e.tech || ""
    }));
  }catch(e){
    console.warn("wpLogLoad parse:", e);
    window.wartungslog = [];
  }
}
function _saveAll(list){
  localStorage.setItem(window.__WP_LOG_KEY__, JSON.stringify(list || []));
}

function wpLogExecution(entry){
  const e = {
    dateISO: _toISO(entry?.dateISO),
    machine: entry?.machine || "",
    taskName: entry?.taskName || "",
    intervalDays: (entry?.intervalDays ?? ""),
    nipples: (entry?.nipples ?? ""),
    technician: entry?.technician || ""
  };
  const list = Array.isArray(window.wartungslog) ? [...window.wartungslog] : [];
  list.push(e);
  window.wartungslog = list;
  _saveAll(list);
}

function wpLogApplyFilters(list){
  const from = _byId("wpLog_from")?.value || "";
  const to   = _byId("wpLog_to")?.value   || "";
  const m    = _wpNorm(_byId("wpLog_machine")?.value);
  const t    = _wpNorm(_byId("wpLog_task")?.value);
  const tech = _wpNorm(_byId("wpLog_tech")?.value);
  return (list||[]).filter(e=>{
    if (from && e.dateISO < from) return false;
    if (to   && e.dateISO > to)   return false;
    if (m && !_wpNorm(e.machine).includes(m)) return false;
    if (t && !_wpNorm(e.taskName).includes(t)) return false;
    if (tech && !_wpNorm(e.technician).includes(tech)) return false;
    return true;
  }).sort((a,b)=>(b.dateISO||"").localeCompare(a.dateISO||""));
}
function renderWpLogTable(){
  const body = _byId("wpLogBody");
  const empty= _byId("wpLogEmpty");
  if (!body) return;
  const rows = wpLogApplyFilters(window.wartungslog || []);
  body.innerHTML = "";
  if (!rows.length){ if (empty) empty.style.display = "block"; return; }
  if (empty) empty.style.display = "none";
  const td = (txt)=>`<td style="padding:8px;border-bottom:1px solid #eee;">${txt}</td>`;
  body.innerHTML = rows.map(e => `
    <tr>
      ${td(_wpFmtISO(e.dateISO))}
      ${td(e.machine || "‚Äì")}
      ${td(e.taskName || "‚Äì")}
      ${td((e.intervalDays ?? "") === "" ? "‚Äì" : e.intervalDays)}
      ${td((e.nipples ?? "") === "" ? "‚Äì" : e.nipples)}
      ${td(e.technician || "‚Äì")}
    </tr>
  `).join("");
}

function toggleWpLogPanel(){
  const p = _byId("wpLogPanel");
  if (!p) return;
  const orders = _byId("dashPanel");
  if (orders && orders.style.display === "block") orders.style.display = "none";
  const willOpen = (p.style.display==="none" || !p.style.display);
  p.style.display = willOpen ? "block" : "none";
  if (willOpen){ wpLogLoad(); renderWpLogTable(); }
}

function bindWpLogUi(){

  ["wpLog_from","wpLog_to","wpLog_machine","wpLog_task","wpLog_tech"]
    .forEach(id => _byId(id)?.addEventListener("input", renderWpLogTable));
  _byId("wpLogReload")?.addEventListener("click", ()=>{ wpLogLoad(); renderWpLogTable(); });
  _byId("wpLogClear")?.addEventListener("click", ()=>{
    ["wpLog_from","wpLog_to","wpLog_machine","wpLog_task","wpLog_tech"]
      .forEach(id => { const el = _byId(id); if (el) el.value = ""; });
    renderWpLogTable();
  });
  _byId("wpLogRangeBtn")?.addEventListener("click",(ev)=>{
    const btn = ev.currentTarget;
    const mode = String(btn?.dataset?.mode || "30");
    const today = new Date();
    const toISO = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const from = new Date(today);
    if (mode === "30"){ from.setDate(from.getDate()-30); btn.dataset.mode="90"; btn.textContent="üóìÔ∏è Letzte 90 Tage"; }
    else if (mode === "90"){ from.setDate(from.getDate()-90); btn.dataset.mode="7";  btn.textContent="üóìÔ∏è Letzte 7 Tage"; }
    else { from.setDate(from.getDate()-7);  btn.dataset.mode="30"; btn.textContent="üóìÔ∏è Letzte 30 Tage"; }
    if (_byId("wpLog_from")) _byId("wpLog_from").value = toISO(from);
    if (_byId("wpLog_to"))   _byId("wpLog_to").value   = toISO(today);
    renderWpLogTable();
  });
  _byId("wpSaveTask")?.addEventListener("click", ()=>{
    const entry = _collectEntryFromForm({useTodayIfEmpty:true});
    wpLogExecution(entry);
    if (_byId("wpLogPanel")?.style.display === "block") renderWpLogTable();
    alert("Wartung gespeichert!");
  });
  _byId("wpMarkDoneToday")?.addEventListener("click", ()=>{
    const todayISO = _toISO(new Date());
    const lastEl = _byId("wpLastDate");
    if (lastEl) lastEl.value = todayISO;
    const intervalDays = parseInt(_byId("wpIntervalDays")?.value || "0", 10) || 0;
    if (intervalDays > 0) {
      const next = new Date(); next.setDate(next.getDate() + intervalDays);
      if (_byId("wpNextDue")) _byId("wpNextDue").value = _toISO(next);
    }
    const entry = _collectEntryFromForm({useTodayIfEmpty:true});
    wpLogExecution(entry);
    if (_byId("wpLogPanel")?.style.display === "block") renderWpLogTable();
  });
}

document.addEventListener("DOMContentLoaded", ()=>{
  try { wpLogLoad(); } catch(e){ console.warn("wpLogLoad:", e); }
  try { bindWpLogUi(); } catch(e){ console.warn("bindWpLogUi:", e); }
  if (_byId("wpLogPanel") && _byId("wpLogPanel").style.display === "block"){ renderWpLogTable(); }
});
</script>
<script>
// === 1) F√§lligkeit immer sauber nachziehen ===
(function(){
  const byId = (id)=>document.getElementById(id);

function toISO(d){
  // wenn schon im Format YYYY-MM-DD, lass so
  if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;

  const dd  = (d instanceof Date) ? d : new Date(d || Date.now());
  const m   = String(dd.getMonth() + 1).padStart(2, "0"); // <- String
  const day = String(dd.getDate()).padStart(2, "0");      // <- String
  return `${dd.getFullYear()}-${m}-${day}`;
}

// Kompatibilit√§t f√ºr alten Code
window.todayISO = window.todayISO || function () {
  return toISO(new Date());
};



  function recomputeNextDue(){
    const last = byId("wpLastDate")?.value || "";         // Zuletzt durchgef√ºhrt
    const intv = parseInt(byId("wpIntervalDays")?.value || "0", 10) || 0;
    const out  = byId("wpNextDue");
    if (!out) return;
    if (!last || !intv) { out.value = ""; return; }
    const d = new Date(last);
    d.setDate(d.getDate() + intv);                        // funktioniert auch bei Intervall = 1
    out.value = toISO(d);
  }

  // bei manuellen √Ñnderungen neu berechnen
  window.addEventListener("load", ()=>{
    byId("wpIntervalDays")?.addEventListener("input",  recomputeNextDue);
    byId("wpLastDate")?.addEventListener("change",     recomputeNextDue);

    // Falls ‚ÄûHeute durchgef√ºhrt‚Äú existiert, danach sicher neu rechnen
    byId("wpMarkDoneToday")?.addEventListener("click", ()=>{
      // unser anderer Code setzt lastDate + Intervall; hier nur neu berechnen
      setTimeout(recomputeNextDue, 0);
    });

    // initial (falls Felder schon Werte haben)
    recomputeNextDue();
  });
})();

// === 2) Schutz f√ºr leeren Schmierstellen-Select (wpTaskSelect) ‚Äì robust & pro Maschine ===
(function(){
  const byId = (id)=>document.getElementById(id);
  const PLACEHOLDER_TEXT = "Bitte ausw√§hlen";

  // Snapshots je Maschine (Key = Maschinenwert)
  const SNAPSHOT_BY_MACHINE = new Map();
  let childObserver = null, docObserver = null;
  let currentSelect = null;
  let restoring = false;

  function norm(s){ return String(s||"").trim().toLowerCase(); }

  function getMachineKey(){
    return byId("maschine")?.value || "__default__";
  }

  function takeSnapshotForMachine(sel){
    if (!sel || !sel.options.length) return;
    const key = getMachineKey();
    const snap = Array.from(sel.options).map(o => ({ v:o.value, t:o.textContent }));
    SNAPSHOT_BY_MACHINE.set(key, snap);
  }

  function ensurePlaceholder(sel){
    if (!sel) return;
    if (!sel.options.length){
      sel.add(new Option(PLACEHOLDER_TEXT, ""));
      sel.value = "";
      return;
    }
    const first = sel.options[0];
    if (!first || norm(first.textContent) !== norm(PLACEHOLDER_TEXT)){
      // nur hinzuf√ºgen, wenn nicht schon vorhanden
      const hasPH = Array.from(sel.options).some(o => norm(o.textContent) === norm(PLACEHOLDER_TEXT) && o.value === "");
      if (!hasPH) sel.insertBefore(new Option(PLACEHOLDER_TEXT, ""), sel.firstChild);
      sel.value = "";
    }
  }

  function restoreOptionsIfEmpty(sel){
    if (!sel || restoring) return;
    if (sel.options.length > 0) return;

    restoring = true;
    try{
      const key = getMachineKey();
      const snap = SNAPSHOT_BY_MACHINE.get(key) || SNAPSHOT_BY_MACHINE.get("__default__");

      if (snap && snap.length){
        sel.innerHTML = "";
        snap.forEach(o => sel.add(new Option(o.t, o.v)));
        ensurePlaceholder(sel);
      } else {
        // Minimal-Variante
        sel.innerHTML = "";
        ensurePlaceholder(sel);
      }
    } finally { restoring = false; }
  }

  function attachChildObserver(sel){
    if (!sel) return;
    if (childObserver) childObserver.disconnect();
    childObserver = new MutationObserver(() => {
      // Wenn geleert wurde ‚Üí wiederherstellen
      if (!sel.options.length) restoreOptionsIfEmpty(sel);
    });
    childObserver.observe(sel, { childList: true });
  }

  function attachToSelect(){
    const sel = byId("wpTaskSelect");
    if (!sel) return false;
    currentSelect = sel;

    // Nach kleinem Delay snappen (falls ein anderes Skript gerade bef√ºllt)
    setTimeout(()=>{
      // Default-Snapshot einmalig merken
      if (!SNAPSHOT_BY_MACHINE.has("__default__") && sel.options.length){
        SNAPSHOT_BY_MACHINE.set("__default__", Array.from(sel.options).map(o => ({v:o.value, t:o.textContent})));
      }

      takeSnapshotForMachine(sel);
      restoreOptionsIfEmpty(sel);  // falls leer ‚Üí wieder bef√ºllen
      ensurePlaceholder(sel);
      attachChildObserver(sel);
    }, 150);

    return true;
  }

  function watchForReplacement(){
    if (docObserver) docObserver.disconnect();
    docObserver = new MutationObserver(()=>{
      const sel = byId("wpTaskSelect");
      if (sel && sel !== currentSelect){
        currentSelect = sel;
        // Bei Ersatz: erneut Snapshot/Fallback setzen
        takeSnapshotForMachine(sel);
        restoreOptionsIfEmpty(sel);
        ensurePlaceholder(sel);
        attachChildObserver(sel);
      }
    });
    docObserver.observe(document.body, { childList: true, subtree: true });
  }

  function onMachineChange(){
    // Nach Maschinenwechsel bauen andere Skripte evtl. um ‚Üí kurze Pause, dann sichern/auff√ºllen
    setTimeout(()=>{
      const sel = byId("wpTaskSelect");
      if (!sel) return;
      takeSnapshotForMachine(sel);  // pro Maschine speichern
      restoreOptionsIfEmpty(sel);
      ensurePlaceholder(sel);
    }, 150);
  }

  window.addEventListener("load", ()=>{
    attachToSelect();
    watchForReplacement();

    byId("maschine")?.addEventListener("change", onMachineChange);

byId("toggleWpLogBtn")?.addEventListener("click", ()=>{
    setTimeout(()=>{
      const sel = byId("wpTaskSelect");
      if (!sel) return;
      takeSnapshotForMachine(sel);
      restoreOptionsIfEmpty(sel);
      ensurePlaceholder(sel);
    }, 150);
  });
});                 // Ende: window.addEventListener("load", ...)
</script>

<script>
/* ===== Overdue-Alarm f√ºr Wartung: Badge + Hinweis + optionaler Beep =====
   - Nimmt letzte Ausf√ºhrung pro (Maschine + Aufgabe) aus window.wartungslog
   - nextDue = lastDate + intervalDays
   - "√úberf√§llig" wenn nextDue < heute
   - Roter Punkt am Button + Hinweisleiste im Panel
   - Optional: kurzer Beep beim √ñffnen
*/
(function(){
  // ===== Allgemeine Helfer =====
  function _wpNorm(s){ return String(s||"").toLowerCase().trim(); }
  function _wpFmtISO(s){ return s || ""; }
  function _byId(id){ return document.getElementById(id); }
  function _toISO(d){
    if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    const dt = d instanceof Date ? d : new Date();
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
  }

  // ===== Wartungs-Helfer (Datum, Vergleiche etc.) =====
  function toISO(d){
    if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    const dt = d instanceof Date ? d : new Date();
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
  }
  function addDays(iso, n){
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d)) return "";
    d.setDate(d.getDate() + Number(n || 0));
    return toISO(d);
  }
  function cmpISO(a, b){
    return a === b ? 0 : (a < b ? -1 : 1); // nur YYYY-MM-DD
  }

  // ===== Wartungsberechnung =====
  // Map je (Maschine||Aufgabe) mit lastDate, intervalDays, nextDue, status
  function computeDueMap(){
    try { if (typeof wpLogLoad === "function") wpLogLoad(); } catch(e){}
    const list = Array.isArray(window.wartungslog) ? window.wartungslog : [];
    const map = new Map();

    list.forEach(e=>{
      const key  = `${(e.machine||"").trim()}||${(e.taskName||"").trim()}`;
      const last = (e.dateISO||"").trim();
      const intv = (e.intervalDays==="" || e.intervalDays==null) ? 0 : Number(e.intervalDays);
      const prev = map.get(key);

      if (!prev || (last && last > (prev.lastDate||""))) {
        const next = (last && intv) ? addDays(last, intv) : "";
        const today = toISO(new Date());
        let status = "ok";
        if (next) {
          if (cmpISO(next, today) < 0) status = "overdue";
          else if (cmpISO(next, today) === 0) status = "today";
        }
        map.set(key, {
          machine: e.machine || "",
          taskName: e.taskName || "",
          lastDate: last || "",
          intervalDays: intv || 0,
          nextDue: next,
          status
        });
      }
    });
    return map;
  }


function anyDueOrOverdue(dueMap){
  const t = todayISO();
  for (const [,v] of dueMap) {
    if (v.nextDue && v.nextDue <= t) return true; // heute ODER √ºberf√§llig
  }
  return false;
}

function listDueOrOverdue(dueMap){
  // robust: nutze window.todayISO() wenn vorhanden, sonst toISO(new Date())
  const t = (typeof window.todayISO === 'function')
              ? window.todayISO()
              : toISO(new Date());

  const out = [];
  // akzeptiert Map oder Plain-Object
  const it = (dueMap instanceof Map)
    ? dueMap
    : new Map(Object.entries(dueMap || {}));

  for (const [, v] of it) {
    const next = v && v.nextDue ? String(v.nextDue) : "";
    // ISO-Strings lassen sich lexikographisch vergleichen
    if (next && next <= t) out.push(v);
  }
  return out.sort((a,b)=> (a.nextDue||"").localeCompare(b.nextDue||""));
}


  // Roter Punkt am Button + Title/ARIA
  function updateButtonBadge(isOverdue){
    const btn = byId("toggleWpLogBtn");
    if (!btn) return;
    // kleinen roten Punkt rechts neben dem Text einf√ºgen/entfernen
    let dot = btn.querySelector(".wpBadge");
    if (isOverdue) {
      if (!dot) {
        dot = document.createElement("span");
        dot.className = "wpBadge";
        dot.setAttribute("aria-hidden","true");
        dot.style.cssText = "display:inline-block;margin-left:8px;width:8px;height:8px;border-radius:50%;background:#e53935;vertical-align:middle;";
        btn.appendChild(dot);
      }
      btn.setAttribute("title","√úberf√§llige Wartung vorhanden (Alt+W)");
      btn.setAttribute("aria-label","Wartungs-Dashboard ‚Äì √úberf√§llig");
    } else {
      if (dot) dot.remove();
      btn.removeAttribute("title");
      btn.removeAttribute("aria-label");
    }
  }

  // Hinweisbalken im Panel
  function ensurePanelBanner(){
    const panel = byId("wpLogPanel");
    if (!panel) return null;
    let bar = byId("wpOverdueBar");
    if (!bar) {
      bar = document.createElement("div");
      bar.id = "wpOverdueBar";
      bar.style.cssText = "display:none;margin:-12px -12px 12px -12px;padding:10px 12px;background:#fdecea;color:#b71c1c;border-bottom:1px solid #f5c6c6;border-radius:8px 8px 0 0;font-size:14px;";
      bar.textContent = "Achtung: Es gibt √ºberf√§llige Wartungen. Bitte pr√ºfen.";
      panel.insertBefore(bar, panel.firstChild);
    }
    return bar;
  }

  // kurzer Beep (nur nach User-Interaktion zuverl√§ssig)
  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = 880; // A5
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime + 0.02);
      o.start(); o.stop(ctx.currentTime + 0.15);
    } catch(e) {}
  }

function refreshOverdueUI({ beepOnOverdue = false } = {}) {
  // Sicherstellen, dass computeDueMap existiert
  const map = (typeof computeDueMap === "function") ? computeDueMap() : new Map();

  // todayISO robust holen (alte oder neue Variante)
  const getToday = () => (typeof window.todayISO === "function"
    ? window.todayISO()
    : toISO(new Date()));

  const dueList = listDueOrOverdue(map); // heute/√ºberf√§llige sammeln

  // Badge aktualisieren, falls Funktion existiert
  if (typeof updateButtonBadge === "function") {
    updateButtonBadge(dueList.length > 0);
  }

  // Panel-Hinweisleiste (Dashboard)
  const bar = (typeof ensurePanelBanner === "function") ? ensurePanelBanner() : null;
  if (bar) {
    if (dueList.length) {
      bar.style.display = "block";
      bar.textContent = `Hinweis: ${dueList.length} Wartung(en) heute/√ºberf√§llig.`;
    } else {
      bar.style.display = "none";
    }
  }

  // Optionaler akustischer Hinweis
  if (dueList.length && beepOnOverdue && typeof beep === "function") {
    beep();
  }

  // üîî Auch globalen Hinweis / Banner au√üerhalb des Dashboards aktualisieren
  if (typeof renderGlobalOverdueUI === "function") {
    // Wir erzeugen ein vereinheitlichtes Array f√ºr das globale UI
    const today = getToday();
    const globalDue = dueList.map(v => ({
      machine: v.machine || "",
      task: v.taskName || "",
      nextDue: v.nextDue || "",
      status: v.nextDue < today
        ? "overdue"
        : (v.nextDue === today ? "today" : "ok")
    }));
    renderGlobalOverdueUI(globalDue);
  }
}



  // Wiring
  window.addEventListener("load", ()=>{
    // Initial
    refreshOverdueUI();

    // Beim Panel-√ñffnen -> Hinweis aktualisieren + optional Beep
    const btn = byId("toggleWpLogBtn");
    if (btn) {
      btn.addEventListener("click", ()=> {
        setTimeout(()=> refreshOverdueUI({beepOnOverdue:true}), 60);
      });
    }

    // Nach ‚ÄûSpeichern‚Äú / ‚ÄûHeute durchgef√ºhrt‚Äú aktualisieren
    const safe = (id) => byId(id)?.addEventListener("click", ()=> setTimeout(()=>{ try{ refreshOverdueUI(); }catch(e){} }, 60));
    safe("wpSaveTask");
    safe("wpMarkDoneToday");

    // Falls Log-Funktion direkt genutzt wird, nach jedem Schreiben refreshen
    if (typeof window.wpLogExecution === "function") {
      const orig = window.wpLogExecution;
      window.wpLogExecution = function(entry){
        const r = orig.apply(this, arguments);
        try { refreshOverdueUI(); } catch(e){}
        return r;
      };
    }
  });

  // Tastenk√ºrzel: Alt+W toggelt Panel und refresht UI
  window.addEventListener('keydown', function(e){
    if(e.altKey && (e.key==='w' || e.key==='W')){
      e.preventDefault();
      var p = byId('wpLogPanel');
      if(!p){ alert('Hinweis: #wpLogPanel nicht gefunden.'); return; }
      var open = (p.style.display==='' || p.style.display==='none');
      p.style.display = open ? 'block' : 'none';
      try{ if(open && typeof wpLogLoad==='function') wpLogLoad(); }catch(e){}
      try{ if(open && typeof renderWpLogTable==='function') renderWpLogTable(); }catch(e){}
      // nach dem √ñffnen UI pr√ºfen + ggf. Beep
      setTimeout(()=> refreshOverdueUI({beepOnOverdue:true}), 60);
    }
  });

  // Optional: regelm√§√üige Pr√ºfung, falls Seite lange offen bleibt
  setInterval(()=>{ try{ refreshOverdueUI(); }catch(e){} }, 6*60*60*1000);
})();
</script>
<script>
// === Auto-Bef√ºllung f√ºr "Schmierstelle/Aufgabe" aus Wartungspl√§nen ===
// Sucht die globale Datenquelle (wartungsplaene/wp/wpData/‚Ä¶)
// Erwartete Struktur je Maschine: Array von Aufgaben-Namen ODER Array von Objekten mit {name: "..."} / {aufgabe: "..."}.
(function(){
  const byId = (id)=>document.getElementById(id);
  const PLACEHOLDER = "Bitte ausw√§hlen";

  function getPlans(){
    // probiere mehrere m√∂gliche Variablen
    const wp = window.wartungsplaene
           || window.wp
           || window._wp
           || window._wpData
           || window.WARTUNGSPLAENE
           || null;
    return (wp && typeof wp === "object") ? wp : null;
  }

  function extractTaskNames(list){
    if (!Array.isArray(list)) return [];
    // akzeptiere z. B. ["Schmieren A","Reinigen B"] ODER [{name:"..."},{aufgabe:"..."}]
    return list.map(x=>{
      if (typeof x === "string") return x;
      if (x && typeof x === "object") return (x.name || x.aufgabe || x.title || x.task || "").trim();
      return "";
    }).filter(Boolean);
  }

  function rebuildWpTaskSelectFromPlans(){
    const sel = byId("wpTaskSelect");
    const machine = byId("maschine")?.value || "";
    if (!sel || !machine) return false;

    const plans = getPlans();
    if (!plans) return false;

    // Suche maschinenseitig tolerant (exakt oder case-insensitiv)
    const keys = Object.keys(plans);
    const key = keys.find(k => k === machine)
            || keys.find(k => k.toLowerCase().trim() === machine.toLowerCase().trim());
    if (!key) return false;

    const tasks = extractTaskNames(plans[key]?.tasks || plans[key]?.aufgaben || plans[key]);
    if (!tasks.length) return false;

    // Select neu aufbauen
    sel.innerHTML = "";
    sel.add(new Option(PLACEHOLDER, ""));
    tasks.forEach(t => sel.add(new Option(t, t)));
    sel.value = "";
    return true;
  }

  // Fallback: wenn nichts in Pl√§nen gefunden -> Platzhalter sicherstellen (damit Select nie leer ist)
  function ensureNotEmpty(){
    const sel = byId("wpTaskSelect");
    if (!sel) return;
    if (!sel.options || sel.options.length === 0){
      sel.add(new Option(PLACEHOLDER, ""));
      sel.value = "";
    }
  }

  window.addEventListener("load", ()=>{
    // Beim Laden versuchen zu f√ºllen
    if (!rebuildWpTaskSelectFromPlans()) ensureNotEmpty();

    // Beim Maschinenwechsel neu f√ºllen
    byId("maschine")?.addEventListener("change", ()=>{
      setTimeout(()=>{
        if (!rebuildWpTaskSelectFromPlans()) ensureNotEmpty();
      }, 120);
    });

    // Wenn Wartungs-Dashboard ge√∂ffnet wird, auch nochmal versuchen (falls Pl√§ne dann erst da sind)
    byId("toggleWpLogBtn")?.addEventListener("click", ()=>{
      setTimeout(()=>{
        if (!rebuildWpTaskSelectFromPlans()) ensureNotEmpty();
      }, 120);
    });
  });
})();
</script>



</body>
</html>
