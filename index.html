<!DOCTYPE html>
<html lang="de">
<head>
  <!-- MSAL laden (muss vor deinem Cloud-Code stehen) -->
  <script src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js"></script>

  <!-- Build-Version: 1.0.1 - Cache-Bypass -->
  <link href="icon-192.png" rel="apple-touch-icon"/>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>TE 15 Reparaturauftrag 03</title>
<style>
  body {
      font-family: Arial, sans-serif;
      margin: 20px;
  }
  .header, .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .header div, .footer div {
      margin: 5px;
  }
  .section {
      margin-bottom: 20px;
  }
  .section label {
      display: block;
      margin-bottom: 5px;
  }
  .section input, .section select, .section textarea {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
  }
  .signature {
      border: 1px solid #000;
      height: 100px;
      margin-bottom: 20px;
  }
  /* Style f√ºr die Buttons */
  button#saveDraftJsonButton,
  button#loadDraftJsonButton,
  button#closeOrderButton {
      margin: 5px;
      padding: 8px 15px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #0078d4;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s;
  }
  button#saveDraftJsonButton:hover,
  button#loadDraftJsonButton:hover,
  button#closeOrderButton:hover {
      background-color: #005ea0;
  }

  /* ‚úÖ Hier einf√ºgen: Container f√ºr PDF */

</style>
<style>
  /* Druckfarben & Seitenumbr√ºche */
  @media print {
    body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .page-break { page-break-before: always; }
    .no-print { display: none !important; }
  }

  /* Sauberes A4-Layout */
  #pdfExportContainer{
    width:210mm; max-width:210mm;
    padding:10mm 10mm 12mm;
    margin:0 auto;
    background:#fff; color:#000; box-sizing:border-box;
  }

  /* 2-Spalten-Layout f√ºr ‚ÄûLabel : Wert‚Äú */
  .print-field{
    display:grid; grid-template-columns:38% 62%;
    column-gap:12px; align-items:start; padding:6px 0;
    border-bottom:1px solid #e9e9e9;
  }
  .print-label{
    font-weight:700;
    white-space:nowrap;
    min-width:0;
  }
.print-value{
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  line-height: 1.6;      /* mehr Zeilenh√∂he */
  min-width: 0;
}


  /* Silbentrennung au√üerhalb des Iframes */
  html[lang="de"] .print-value { hyphens:auto; }

  .print-field > * { min-width:0; }

  .avoid-break{ break-inside:avoid; page-break-inside:avoid; }
  @media (max-width: 820px) { #pdfExportContainer { width:100%; max-width:100%; } }
  canvas { display:block !important; }
  img { max-width:100% !important; height:auto !important; }
</style>

<style>
  #updateModal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #updateModalContent {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
  }
  #confirmationMessage {
    display: none;
    margin-top: 20px;
    padding: 10px;
    background-color: #e0ffe0;
    border: 1px solid #00aa00;
    border-radius: 5px;
  }
</style>

<style>
/* Snapshot: zweispaltig halten */
/* Snapshot: zweispaltig (Flex statt Grid -> kein √úberlapp-Bug in html2canvas) */
.pdf-snapshot .print-field{
  display: flex !important;
  flex-wrap: nowrap !important;
  align-items: flex-start !important;
  padding: 8px 0 !important;
  border-bottom: 1px solid #e9e9e9 !important;
  gap: 12px !important;
}
.pdf-snapshot .print-label{
  white-space: normal !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  min-width: 0 !important;
  flex: 0 0 38% !important;
  max-width: 38% !important;
  padding-right: 12px !important;
}
.pdf-snapshot .print-value{
  white-space: pre-wrap !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  hyphens: auto !important;
  line-height: 1.6 !important;   /* h√∂her */
  margin-bottom: 6px !important;
  min-width: 0 !important;
  flex: 1 1 62% !important;
  max-width: 62% !important;
}

/* (zweite Definitionen bleiben wie bei dir) */
</style>



<style>
  .field-error { border: 2px solid #d9534f !important; background:#fff6f6; }
  .error-text  { color:#d9534f; font-size:12px; margin:-6px 0 10px 0; }
</style>

<!-- üîé Analytics-Styles (NEU) -->
<style>
  .analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .bar-row{display:grid;grid-template-columns:1fr auto 40px;gap:8px;align-items:center;padding:4px 0;cursor:pointer}
  .bar{height:10px;background:#eee;border-radius:6px;overflow:hidden}
  .bar-fill{height:100%;background:#0f6cbd}
  .bar-label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bar-count{font-variant-numeric:tabular-nums;text-align:right}
  @media (max-width:720px){.analytics-grid{grid-template-columns:1fr}}
</style>

<!-- html2pdf einmalig laden (ohne defer!) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Fallback, falls das CDN mal nicht l√§dt -->
<script>
async function loadHtml2PdfIfNeeded(){
  if (window.html2pdf) return;
  await new Promise(r => setTimeout(r, 0));
  if (window.html2pdf) return;

  await new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
    s.onload = resolve;
    s.onerror = () => reject(new Error('html2pdf konnte nicht geladen werden'));
    document.head.appendChild(s);
  });
}
</script>

<!-- OneDrive/Graph ‚Äì Config -->
<script>
  // Freigegebener OneDrive-Ordner (Reparatur + Wartung)
  const ONEDRIVE_SHARED_LINK =
    "https://petrifeinkost-my.sharepoint.com/:f:/g/personal/merten_thiemann_petri-feinkost_de/EkOa1ufucPNDtlfo6B9rxowB7o8nAY4wHK-gcRha74B2AQ?e=gnn1A2";

  // Wartungspl√§ne-Datei im gleichen Ordner
  const WP_FILE = "Wartungsplaene.json";

  // Log-Datei (Wartungs-Dashboard)
  const CLOUD_FILENAME = "wartungslog.json";
</script>
<script>
// OneDrive-Ordner f√ºr Wartungslog ermitteln
// Nutzt die gleichen Infos wie deine Reparatur-Meta-Daten
// OneDrive-Ordner f√ºr Wartungslog ermitteln
// Nutzt den gleichen Ordner wie die Reparatur-Stammdaten
// OneDrive-Ordner f√ºr Wartungslog ermitteln
// Nutzt den gleichen Ordner wie die Reparatur-Meta-/Stammdaten
async function getShareRootEndpoint() {
  // 1) Ohne Token keine Cloud-Zugriffe
  if (!window.accessToken) {
    throw new Error("Kein Access Token ‚Äì bitte in der App auf 'Microsoft anmelden' klicken.");
  }

  // 2) Falls TARGET noch leer ist, versuche aus dem Cache zu lesen
  if (!window.TARGET || !TARGET.driveId || !TARGET.parentItemId) {
    try {
      const cache = JSON.parse(localStorage.getItem("TARGET_CACHE") || "null");
      if (cache && cache.driveId && cache.parentItemId) {
        TARGET.driveId      = cache.driveId;
        TARGET.parentItemId = cache.parentItemId;
        window.TARGET       = TARGET;
      }
    } catch (e) {
      console.warn("TARGET_CACHE lesen fehlgeschlagen:", e);
    }
  }

  // 3) Wenn immer noch nichts da ist: Cloud-Ordner nicht initialisiert
  if (!window.TARGET || !TARGET.driveId || !TARGET.parentItemId) {
    throw new Error("TARGET nicht initialisiert ‚Äì Share-Ordner konnte nicht ermittelt werden.");
  }

  // 4) Wartungslog im gleichen Ordner wie die Reparatur-Dateien speichern/laden
  return {
    driveId: TARGET.driveId,
    itemId:  TARGET.parentItemId
  };
}







  // JSON-Datei aus dem Ordner laden
  async function graphDownloadJsonFromFolder(root, filename) {
    if (!window.accessToken) {
      throw new Error("Kein Access Token ‚Äì bitte erst mit Microsoft anmelden.");
    }

    const listUrl =
      `https://graph.microsoft.com/v1.0/drives/${root.driveId}/items/${root.itemId}` +
      `/children?$select=id,name`;

    const listRes = await fetch(listUrl, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if (!listRes.ok) {
      throw new Error("children list failed: " + listRes.status);
    }

    const list = await listRes.json();
    const item = (list.value || []).find(x => x.name === filename);

    // Datei existiert noch nicht ‚Üí leere Liste
    if (!item) {
      return { data: [], etag: null };
    }

    const fileRes = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${root.driveId}/items/${item.id}/content`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    if (!fileRes.ok) {
      throw new Error("download failed: " + fileRes.status);
    }

    let data = [];
    try {
      data = await fileRes.json();
    } catch (_) {
      data = [];
    }

    const etag =
      fileRes.headers.get("ETag") ||
      fileRes.headers.get("Etag") ||
      null;

    return { data, etag };
  }

  // JSON-Datei im Ordner speichern (mit ETag f√ºr Konflikte)
  async function graphUploadJsonToFolder(root, filename, data, etag) {
    if (!window.accessToken) {
      throw new Error("Kein Access Token ‚Äì bitte erst mit Microsoft anmelden.");
    }

    const listUrl =
      `https://graph.microsoft.com/v1.0/drives/${root.driveId}/items/${root.itemId}` +
      `/children?$select=id,name`;

    const listRes = await fetch(listUrl, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if (!listRes.ok) {
      throw new Error("children list failed: " + listRes.status);
    }

    const list = await listRes.json();
    const item = (list.value || []).find(x => x.name === filename);
    const itemId = item ? item.id : null;

    const uploadUrl = itemId
      // bestehende Datei √ºberschreiben
      ? `https://graph.microsoft.com/v1.0/drives/${root.driveId}/items/${itemId}/content`
      // neue Datei im Ordner anlegen
      : `https://graph.microsoft.com/v1.0/drives/${root.driveId}/items/${root.itemId}:/${filename}:/content`;

    const headers = {
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    };
    if (etag) {
      headers["If-Match"] = etag;
    }

    const body = JSON.stringify(data || [], null, 2);

    const res = await fetch(uploadUrl, {
      method: "PUT",
      headers,
      body
    });

    // 412 = ETag-Konflikt (gleichzeitiges Speichern)
    if (res.status === 412) {
      const err = new Error("etag_conflict");
      err.code = "etag_conflict";
      err.status = 412;
      throw err;
    }

    if (!res.ok) {
      throw new Error("upload failed: " + res.status);
    }

    let saved = {};
    try {
      saved = await res.json();
    } catch (_) {}

    return {
      etag: saved.eTag || saved.etag || null
    };
  }
</script>

<!-- ‚úÖ Anzeigenamen-Hilfsfunktion (im <head>, vor </head>) -->
<script>
  function displayNameFromUser(u){
    if (!u) return "";
    if (u.name && u.name.trim()) return u.name.trim();
    const mailId = (u.email || u.upn || "").split("@")[0] || "";
    if (!mailId) return "";
    return mailId.replace(/[._-]+/g, " ").replace(/\b\w/g, c => c.toUpperCase());
  }
</script>

<!-- üîß Einmaliger Helper-Block -->
<!-- ‚Ä¶ dein Config-Block + displayNameFromUser ‚Ä¶ -->

<!-- üîß Einmaliger Helper-Block (IM HEAD!) -->
<script>
  // Globaler DOM-Helfer (f√ºr alle Bl√∂cke verf√ºgbar)
  window.byId = window.byId || function(id){ return document.getElementById(id); };

  // Alte/Neue Funktionsnamen kompatibel halten
  window.wpRefreshOverdueUI = window.wpRefreshOverdueUI || function(){
    try { if (typeof refreshOverdueUI === "function") refreshOverdueUI(); } catch(e){}
  };
</script>
</head>
<body>


  
  <!-- Offscreen-Renderframe nur f√ºr den PDF-Export -->
  <iframe id="pdfSandbox"
          style="position:fixed;left:-99999px;top:-99999px;width:820px;height:1200px;visibility:hidden;border:0;"></iframe>

  <div id="updateModal">
<div id="updateModalContent">
<p><strong>Die App wurde aktualisiert.</strong><br/>Bitte best√§tigen Sie die neue Version.</p>
<button onclick="confirmUpdate()">OK</button>
</div>
</div>
<div id="confirmationMessage" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 25px 30px; background-color: #d4edda; color: #155724; border: 3px solid #28a745; border-radius: 12px; font-size: 22px; text-align: center; font-weight: bold; z-index: 9999; box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);"></div>

<div id="abschlussScreen" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;align-items:center;justify-content:center;flex-direction:column;font-size:20px;font-family:sans-serif;z-index:999;">
  <p>‚úÖ Auftrag wurde abgeschlossen.</p>
  <button onclick="window.location.href = 'index.html';" style="margin-top:20px;padding:10px 20px;font-size:16px;background:#007BFF;color:white;border:none;border-radius:6px;">
    Neuen Auftrag starten
  </button>
</div>

<!-- üîê Login/Logout Bereich -->
<div style="margin-bottom: 20px;">
<button
  onclick="signInAndAcquireToken(true, { rebuild: true })"
  class="no-print"
  style="padding:8px 15px; background:#0078d4; color:white; border:none; border-radius:5px; cursor:pointer;"
>
  Microsoft anmelden
</button>


  <button onclick="signOut()" class="no-print"
          style="padding:8px 15px; margin-left:10px; background:#d9534f; color:white; border:none; border-radius:5px; cursor:pointer;">
    Abmelden / Konto wechseln
  </button>
  <!-- Wartung: Toggle-Button im Kopf -->
  <button id="wartungToggleHead" class="no-print"
          style="padding:8px 12px; margin-left:10px; background:#198754; color:white; border:none; border-radius:6px; cursor:pointer;">
    üõ†Ô∏è Wartung
  </button>
</div>

<!-- üî¥ Globale Wartungswarnung (sichtbar auch bei zuem Panel; nur App, nicht im PDF) -->
<div id="wpGlobalOverdueBanner" class="no-print"
     style="display:none;margin:10px 0;padding:10px 12px;border-left:6px solid #dc3545;
            background:#f8d7da;color:#842029;border-radius:6px;align-items:center;
            gap:10px;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:10px;">
    <span style="font-size:20px;line-height:1;">‚ö†Ô∏è</span>
    <span data-msg>Es gibt √ºberf√§llige Wartungen.</span>
  </div>
  <button id="wpOpenFromBanner"
          style="border:0;border-radius:6px;background:#dc3545;color:#fff;
                 padding:6px 10px;cursor:pointer;">
    Wartung √∂ffnen
  </button>
</div>

<!-- üîî Globaler Hinweis (generisch; nur App, nicht im PDF) -->
<div id="wpGlobalAlert" class="no-print"
     style="display:none; margin:10px 0 20px 0; padding:10px 12px;
            border:1px solid #dc3545; background:#f8d7da; color:#842029;
            border-radius:6px; font-size:14px;">
  <!-- Inhalt wird per JS gesetzt -->
</div>

<!-- üîê Login-Hinweis (einmalig; keine doppelte id) -->
<div id="loginHint" class="no-print"
     style="margin-bottom: 20px; padding: 10px; background: #fffbe6; border: 1px solid #e6c200;
            border-radius: 6px; color: #7a6600; font-size: 14px;">
  ‚ö†Ô∏è Bitte zuerst mit Microsoft anmelden ‚Äì sonst k√∂nnen keine Daten in OneDrive gespeichert oder geladen werden.
</div>




<!-- === üìä Dashboard (auf/zu klappbar) === -->
<div id="ordersDashboard" class="no-print" style="margin:16px 0;">
  <button type="button" id="toggleDashBtn"
          style="padding:8px 12px;border:0;border-radius:6px;background:#0f6cbd;color:#fff;cursor:pointer;">
    üìä Dashboard anzeigen
  </button>
  
<button
  type="button"
  id="toggleWpLogBtn"
  onclick="(function(){
    var p=document.getElementById('wpLogPanel');
    if(!p){alert('Hinweis: #wpLogPanel nicht gefunden.');return;}
    var open=(p.style.display===''||p.style.display==='none');
    p.style.display=open?'block':'none';
    // beim √ñffnen Daten laden (falls Funktionen existieren)
    try{ if(open && typeof wpLogLoad==='function') wpLogLoad(); }catch(e){}
    try{ if(open && typeof renderWpLogTable==='function') renderWpLogTable(); }catch(e){}
  })()"
  aria-controls="wpLogPanel"
  aria-expanded="false"
  title="Wartungs-Dashboard (Alt+W)"
  style="padding:8px 12px;border:0;border-radius:6px;background:#0f6cbd;color:#fff;cursor:pointer;margin-left:6px;">
  üß∞ Wartungs-Dashboard
</button>
  <!-- üìù NEU: Entw√ºrfe-Dashboard -->
  <button
    type="button"
    id="toggleDraftDashBtn"
    title="Reparatur-Entw√ºrfe anzeigen"
    style="padding:8px 12px;border:0;border-radius:6px;background:#0f6cbd;color:#fff;cursor:pointer;margin-left:6px;">
    üìù Entw√ºrfe-Dashboard
  </button>
</div>


<script>
/* Failsafe: Toggle bereitstellen + Button sicher aktivieren */
(function () {

  // Toggle nur definieren, falls noch nicht vorhanden
  if (!window.__toggleWpLogPanel) {
    window.__toggleWpLogPanel = function () {
      var p = document.getElementById('wpLogPanel');
      if (!p) {
        alert('Hinweis: #wpLogPanel nicht gefunden.');
        return;
      }

      var willOpen = (p.style.display === '' || p.style.display === 'none');
      p.style.display = willOpen ? 'block' : 'none';

      // ARIA aktualisieren
      var btn = document.getElementById('toggleWpLogBtn');
      if (btn) {
        btn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
      }

      // ‚úÖ Beim √ñffnen: Filter binden + Daten laden + Tabelle bauen
      if (willOpen) {
        (async function () {
          try {
            if (typeof bindWpLogUi === "function") bindWpLogUi();
          } catch (e) {
            console.warn("bindWpLogUi:", e);
          }

          try {
            if (typeof wpLogLoad === "function") await wpLogLoad();
          } catch (e) {
            console.warn("wpLogLoad:", e);
          }

          try {
            if (typeof loadWpLog === "function") {
              await loadWpLog();
            } else if (typeof renderWpLogTable === "function") {
              renderWpLogTable();
            }
          } catch (e) {
            console.warn("load/render:", e);
          }
        })();
      }
    };
  }

  // Button sicher aktivieren
  window.addEventListener('load', function () {
    var btn   = document.getElementById('toggleWpLogBtn');
    var panel = document.getElementById('wpLogPanel');
    if (btn) {
      btn.removeAttribute('disabled');
      btn.setAttribute('aria-controls', 'wpLogPanel');
      btn.setAttribute(
        'aria-expanded',
        (panel && panel.style.display === 'block') ? 'true' : 'false'
      );
    }
  });

  // Tastaturk√ºrzel: Alt+W
  window.addEventListener('keydown', function (e) {
    if (e.altKey && (e.key === 'w' || e.key === 'W')) {
      e.preventDefault();
      if (window.__toggleWpLogPanel) window.__toggleWpLogPanel();
    }
  });

})();
</script>



<script>
/* ===== Globaler Wartungs-Hinweis ohne ge√∂ffnetes Dashboard ===== */
(function () {
  // kleine Helfer
  const wpEls = window.wpEls || function () {
    return {
      selMaschine:
        document.getElementById("selMaschine") ||
        document.querySelector('#selMaschine, [name="maschine"], select[data-maschine]')
    };
  };
  const wpNorm =
    window.wpNorm || (s => String(s || "").toLowerCase().trim());

  function toISO(d) {
    if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    var dd = d instanceof Date ? d : new Date(d || Date.now());
    var m = String(dd.getMonth() + 1).padStart(2, "0");
    var day = String(dd.getDate()).padStart(2, "0");
    return dd.getFullYear() + "-" + m + "-" + day;
  }

  function addDays(iso, n) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d)) return "";
    d.setDate(d.getDate() + Number(n || 0));
    return toISO(d);
  }

  function cmpISO(a, b) {
    return a === b ? 0 : a < b ? -1 : 1;
  }

  // Liste der heute f√§lligen / √ºberf√§lligen Wartungen ermitteln
  async function getDueList() {
    // 1. Neue Logik: computeDueMap benutzen, wenn vorhanden
    if (typeof window.computeDueMap === "function") {
      try {
        const map = await window.computeDueMap();   // <-- WICHTIG: await!
        const out = [];
        for (const [, v] of map) {
          if (v.status === "today" || v.status === "overdue") {
            out.push({
              machine: v.machine || "",
              task:    v.taskName || v.task || "",
              nextDue: v.nextDue || "",
              status:  v.status
            });
          }
        }
        return out;
      } catch (e) {
        console.warn("getDueList/computeDueMap:", e);
      }
    }

    // 2. Fallback: nur mit window.wartungslog arbeiten
    const list   = Array.isArray(window.wartungslog) ? window.wartungslog : [];
    const latest = new Map();
    for (const e of list) {
      const key  = `${(e.machine || "").trim()}||${(e.taskName || "").trim()}`;
      const last = (e.dateISO || "").trim();
      if (!latest.has(key) || (last && last > (latest.get(key).dateISO || ""))) {
        latest.set(key, e);
      }
    }
    const today = toISO(new Date());
    const out   = [];
    latest.forEach(e => {
      const intv = (e.intervalDays === "" || e.intervalDays == null) ? 0 : Number(e.intervalDays);
      const next = (e.dateISO && intv) ? addDays(e.dateISO, intv) : "";
      if (!next) return;
      const status = cmpISO(next, today) < 0 ? "overdue"
                   : cmpISO(next, today) === 0 ? "today"
                   : "ok";
      if (status !== "ok") {
        out.push({
          machine: e.machine || "",
          task:    e.taskName || "",
          nextDue: next,
          status
        });
      }
    });
    return out;
  }

  // --- Mail-Versand f√ºr √ºberf√§llige Wartungen -----------------
  window.wpSendOverdueMail = async function (dueList) {
    try {
      if (!window.accessToken) {
        console.warn("[WP] Kein Access Token, Mail kann nicht gesendet werden.");
        return;
      }
      if (!Array.isArray(dueList) || !dueList.length) return;

      // einfache HTML-Tabelle bauen
      let rows = dueList.map(v => {
        const machine = v.machine || v.maschine || "";
        const task    = v.taskName || v.task || "";
        const nextDue = v.nextDue || "";
        const status  = v.status || "";
        return `<tr>
          <td>${machine}</td>
          <td>${task}</td>
          <td>${nextDue}</td>
          <td>${status}</td>
        </tr>`;
      }).join("");

      const bodyHtml = `
        <p>Hinweis aus der Werkstatt-App:</p>
        <p>Es liegen Wartungen an, die heute f√§llig oder bereits √ºberf√§llig sind.</p>
        <table border="1" cellspacing="0" cellpadding="4">
          <thead>
            <tr>
              <th>Maschine</th>
              <th>Aufgabe</th>
              <th>F√§llig am</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <p>Bitte im Wartungs-Dashboard pr√ºfen.</p>
      `;

      const mail = {
        message: {
          subject: `Wartungs-Hinweis: ${dueList.length} Aufgabe(n) f√§llig/√ºberf√§llig`,
          body: {
            contentType: "HTML",
            content: bodyHtml
          },
          toRecipients: [
            { emailAddress: { address: "mike.hafermalz@petri-feinkost.de" } },
            { emailAddress: { address: "merten.thiemann@petri-feinkost.de" } }
          ]
        },
        saveToSentItems: true
      };

      const res = await fetch("https://graph.microsoft.com/v1.0/me/sendMail", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + window.accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(mail)
      });

      if (!res.ok) {
        console.error("[WP] sendMail fehlgeschlagen:", res.status, await res.text());
      } else {
        console.log("[WP] Warn-Mail erfolgreich gesendet.");
      }
    } catch (e) {
      console.error("[WP] Fehler beim Mailversand:", e);
    }
  };

  // --- √ñffentliche Funktion: pr√ºfen + optional Mail senden ----
  window.wpCheckOverdueAndNotify = async function (opts) {
    opts = opts || {};
    const sendMail = !!opts.sendMail;

    let dueList = [];
    try {
      dueList = await getDueList();
    } catch (e) {
      console.warn("[WP] getDueList Fehler:", e);
      dueList = [];
    }

    if (!Array.isArray(dueList) || !dueList.length) {
      console.log("[WP] Keine f√§lligen Wartungen, keine Mail n√∂tig.");
      return;
    }

    // Nur einmal pro Tag pro Browser mailen
    const today = (new Date()).toISOString().slice(0, 10);
    const LS_KEY = "WP_LAST_OVERDUE_MAIL_DATE";
    let lastDate = null;
    try { lastDate = localStorage.getItem(LS_KEY); } catch (_) {}

    if (sendMail && lastDate === today) {
      console.log("[WP] Warn-Mail heute bereits gesendet.");
      return;
    }

    if (sendMail) {
      await window.wpSendOverdueMail(dueList);
      try { localStorage.setItem(LS_KEY, today); } catch (_) {}
    }
  };

  // √ñffnet Dashboard + w√§hlt Maschine
  function wpOpenMachineFromName(name) {
    try {
      const { selMaschine } = wpEls();
      if (selMaschine) {
        const norm = wpNorm(name);
        const opt = Array.prototype
          .slice.call(selMaschine.options || [])
          .find(o =>
            wpNorm(o.value) === norm ||
            wpNorm(o.textContent || "") === norm
          );
        if (opt) {
          selMaschine.value = opt.value;
          selMaschine.dispatchEvent(
            new Event("change", { bubbles: true })
          );
        }
      }
      // Wartungs-Panel √∂ffnen (iPad-safe)
      var wartungTab = document.querySelector(
        '[data-wp-panel="wartung"]'
      );
      if (wartungTab) wartungTab.click();
      if (!wartungTab) {
        var tgl = document.getElementById("toggleWpLogBtn");
        if (tgl) tgl.click();
      }
    } catch (e) {
      console.warn("wpOpenMachineFromName:", e);
    }
  }

  // Rote Badge am Kopf-Button
  function setWartungBadge(on) {
    const btn = document.getElementById("wartungToggleHead");
    if (!btn) return;
    let dot = btn.querySelector(".wp-badge-dot");
    if (on && !dot) {
      dot = document.createElement("span");
      dot.className = "wp-badge-dot";
      Object.assign(dot.style, {
        display: "inline-block",
        width: "10px",
        height: "10px",
        background: "#dc3545",
        borderRadius: "999px",
        marginLeft: "8px",
        verticalAlign: "middle"
      });
      btn.appendChild(dot);
    }
    if (!on && dot) {
      dot.remove();
    }
  }

// Banner + Alert bef√ºllen
function renderGlobalOverdueUI(due) {
  var banner = document.getElementById("wpGlobalOverdueBanner");
  var openBtn = document.getElementById("wpOpenFromBanner");
  var alertBox = document.getElementById("wpGlobalAlert");

  // Banner
  if (banner) {
    if (due && due.length) {
      var msgEl = banner.querySelector("[data-msg]");
      if (msgEl) {
        var over = due.filter(d => d.status === "overdue").length;
        var tod = due.filter(d => d.status === "today").length;
        msgEl.textContent = over
          ? "Es gibt " + over + " √ºberf√§llige und " + tod + " heute f√§llige Wartungen."
          : "Es gibt " + tod + " heute f√§llige Wartungen.";
      }
      banner.style.display = "flex";
    } else {
      banner.style.display = "none";
    }
  }

  // Button im Banner
  if (openBtn) {
    openBtn.onclick = function () {
      if (due && due.length === 1 && due[0] && due[0].machine) {
        if (typeof wpOpenMachineFromName === "function") {
          wpOpenMachineFromName(due[0].machine);
          return;
        }
      }
      var tgl = document.getElementById("toggleWpLogBtn");
      if (tgl) tgl.click();
    };
  }

  // Alert-Liste
  if (alertBox) {
    if (due && due.length) {
      var items = due
        .slice(0, 8)
        .map(function (d) {
          var label = [d.machine || "", d.task || ""].filter(Boolean).join(" ‚Äì ");
          var when = d.nextDue
            ? " (" + d.nextDue + (d.status === "overdue" ? " √ºberf√§llig" : " heute") + ")"
            : "";

          // ‚úÖ NEU: Kennzeichnung f√ºr √ºberf√§llig + Kommentarpflicht
          var needsComment = (d.status === "overdue");
          var commentHint = needsComment ? ' <strong style="color:#842029;">‚Äì Kommentar erforderlich</strong>' : "";

          return (
            '<li><button data-goto="' +
            encodeURIComponent(d.machine || "") +
            '" data-needs-comment="' + (needsComment ? "1" : "0") + '"' +
            ' style="all:unset;cursor:pointer;text-decoration:underline;color:#842029;">' +
            label +
            when +
            commentHint +
            "</button></li>"
          );
        })
        .join("");

      alertBox.innerHTML =
        "<strong>‚ö†Ô∏è Wartung f√§llig:</strong>" +
        '<ul style="margin:6px 0 0 18px;list-style:disc;">' +
        items +
        "</ul>";
      alertBox.style.display = "block";

      var btns = alertBox.querySelectorAll("button[data-goto]");
      for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener("click", function () {
          var name = decodeURIComponent(this.getAttribute("data-goto") || "");
          if (name && typeof wpOpenMachineFromName === "function") {
            wpOpenMachineFromName(name);
          }
        });
      }
    } else {
      alertBox.style.display = "none";
      alertBox.innerHTML = "";
    }
  }
}


  // Start-Check (ohne Dashboard)
  document.addEventListener("DOMContentLoaded", function () {
    (async function () {
      try {
        // wenn m√∂glich, Log aus der Cloud holen
        if (typeof window.wpLogLoad === "function") {
          try {
            await window.wpLogLoad();
          } catch (e) {
            console.warn("wpLogLoad im Start-Check:", e);
          }
        }

        const due = await getDueList();
        setWartungBadge(!!(due && due.length));
        renderGlobalOverdueUI(due);
      } catch (e) {
        console.warn("Globaler Wartungs-Check:", e);
      }
    })();
  });
})();
</script>


  

<div id="dashPanel" style="display:none;margin-top:10px;border:1px solid #ddd;border-radius:8px;padding:12px;position:relative;">
  <div style="display:grid;grid-template-columns:repeat(5,minmax(140px,1fr));gap:10px;align-items:end;">
    <div>
      <label for="f_bearbeitet_am">Bearbeitet am</label>
      <input type="date" id="f_bearbeitet_am" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="f_techniker">Techniker</label>
      <input type="text" id="f_techniker" placeholder="z. B. Merker" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="f_maschine">Maschine</label>
      <input type="text" id="f_maschine" placeholder="z. B. Multivac" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="f_anlagenteil">Anlagenteil</label>
      <input type="text" id="f_anlagenteil" placeholder="z. B. Sensor" style="width:100%;padding:6px;">
    </div>
    <!-- üîé NEU: Auftrags-ID-Filter -->
    <div>
      <label for="f_auftrag_id">Auftrags-ID</label>
      <input type="text" id="f_auftrag_id" placeholder="z. B. REP-2025..." style="width:100%;padding:6px;">
    </div>
  </div>


  <div style="margin-top:8px;">
    <label for="f_provisorium">Provisorium</label>
    <select id="f_provisorium" style="width:100%;padding:6px;max-width:240px;">
      <option value="">Alle</option>
      <option value="mit">Nur mit Provisorium</option>
      <option value="ohne">Nur ohne Provisorium</option>
    </select>
  </div>

  <div style="margin:10px 0;">
    <button type="button" id="dashReload"
            style="padding:6px 10px;border:0;border-radius:6px;background:#e5e5e5;cursor:pointer;">
      üîÑ Neu laden
    </button>
    <button type="button" id="dashClear"
            style="padding:6px 10px;border:0;border-radius:6px;background:#f3f3f3;cursor:pointer;margin-left:6px;">
      ‚ùå Filter l√∂schen
    </button>
 <button type="button" id="dashRangeBtn" data-mode="7"
        style="padding:6px 10px;border:0;border-radius:6px;background:#d9edf7;margin-left:6px;cursor:pointer;">
  üóìÔ∏è Letzte 7 Tage
</button>

  </div>

  <div style="overflow:auto;max-height:50vh;border:1px solid #eee;border-radius:6px;">
    <table id="dashTable" style="width:100%;border-collapse:collapse;font-size:14px;">
      <!-- Sticky-Header bleibt innerhalb des Panels -->
     <thead style="position:sticky;top:0;background:#fafafa;z-index:1;">
  <tr>
    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Datum</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Maschine</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Aufgabe</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Intervall</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Schmiernippel</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Techniker</th>
    <!-- üëá NEU -->
    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">F√§lligkeit (vorher)</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">√úberf√§llig?</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Kommentar zur √úberf√§lligkeit</th>
  </tr>
</thead>

      <tbody id="dashboardBody"></tbody>
    </table>
  </div>

  <div id="dashEmpty" style="display:none;padding:8px;color:#666;">Keine Auftr√§ge gefunden.</div>

  <!-- üîé Analytics-Bl√∂cke -->
  <div id="dashAnalytics" style="display:none; margin-top:12px; padding-top:10px; border-top:1px solid #eee;">
    <div style="font-weight:600; margin-bottom:6px;">üîé H√§ufigste Eintr√§ge (aktuelle Filter)</div>
    <div class="analytics-grid">
      <div>
        <div style="font-weight:600; margin-bottom:6px;">Maschinen ‚Äì Top 5</div>
        <div id="topMachines"></div>
      </div>
      <div>
        <div style="font-weight:600; margin-bottom:6px;">Anlagenteile ‚Äì Top 5</div>
        <div id="topParts"></div>
      </div>
    </div>
  </div>
</div>


<!-- ============================== -->
<!-- üìù Entw√ºrfe-Dashboard-Panel   -->
<!-- ============================== -->
<div id="draftDashPanel"
     class="no-print"
     style="display:none;margin-top:10px;border:1px solid #ddd;border-radius:8px;padding:12px;position:relative;">

  <div style="display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;align-items:end;">
    <div>
      <label for="df_bearbeitet_am">Bearbeitet am</label>
      <input type="date" id="df_bearbeitet_am" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="df_techniker">Techniker</label>
      <input type="text" id="df_techniker" placeholder="z. B. Merker" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="df_maschine">Maschine</label>
      <input type="text" id="df_maschine" placeholder="z. B. Multivac" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="df_anlagenteil">Anlagenteil</label>
      <input type="text" id="df_anlagenteil" placeholder="z. B. Sensor" style="width:100%;padding:6px;">
    </div>
  </div>

  <div style="margin-top:8px;">
    <label for="df_provisorium">Provisorium</label>
    <select id="df_provisorium" style="width:100%;padding:6px;max-width:240px;">
      <option value="">Alle</option>
      <option value="mit">Nur mit Provisorium</option>
      <option value="ohne">Nur ohne Provisorium</option>
    </select>
  </div>

  <div style="margin:10px 0;">
    <button type="button" id="draftDashReload"
            style="padding:6px 10px;border:0;border-radius:6px;background:#e5e5e5;cursor:pointer;">
      üîÑ Neu laden
    </button>
    <button type="button" id="draftDashClear"
            style="padding:6px 10px;border:0;border-radius:6px;background:#f3f3f3;cursor:pointer;margin-left:6px;">
      ‚ùå Filter l√∂schen
    </button>
    <button type="button" id="draftDashRangeBtn" data-mode="30"
            style="padding:6px 10px;border:0;border-radius:6px;background:#d9edf7;margin-left:6px;cursor:pointer;">
      üóìÔ∏è Letzte 30 Tage
    </button>
  </div>

  <div style="overflow:auto;max-height:50vh;border:1px solid #eee;border-radius:6px;">
    <table id="draftDashTable" style="width:100%;border-collapse:collapse;font-size:14px;">
      <thead style="position:sticky;top:0;background:#fafafa;z-index:1;">
        <tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Bearbeitet am</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Techniker</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Maschine</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Anlagenteil</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Provisorium</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Auftrags-ID (Entwurf)</th>
        </tr>
      </thead>
      <tbody id="draftDashboardBody"></tbody>
    </table>
  </div>

  <div id="draftDashEmpty" style="display:none;padding:8px;color:#666;">
    Keine Entw√ºrfe gefunden.
  </div>
</div>


<!-- ‚úÖ BEGIN: Wartungs-Dashboard (Log) + Logik -->
<!-- ===== Wartungs-Dashboard (Log) ===== -->
<div id="wpLogPanel" style="display:none;margin-top:10px;border:1px solid #ddd;border-radius:8px;padding:12px;position:relative;">

  <div style="display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;align-items:end;">
    <div>
      <label for="wpLog_from">Von</label>
      <input type="date" id="wpLog_from" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="wpLog_to">Bis</label>
      <input type="date" id="wpLog_to" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="wpLog_machine">Maschine</label>
      <input type="text" id="wpLog_machine" placeholder="z. B. Minirolle" style="width:100%;padding:6px;">
    </div>
    <div>
      <label for="wpLog_task">Aufgabe</label>
      <input type="text" id="wpLog_task" placeholder="z. B. Vakuumf√ºller" style="width:100%;padding:6px;">
    </div>
  </div>

  <div style="display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;align-items:end;margin-top:10px;">
    <div>
      <label for="wpLog_tech">Techniker</label>
      <input type="text" id="wpLog_tech" placeholder="Name oder Teil" style="width:100%;padding:6px;">
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button type="button" id="wpLogReload"
              style="padding:6px 10px;border:0;border-radius:6px;background:#e5e5e5;cursor:pointer;">
        üîÑ Neu laden
      </button>
      <button type="button" id="wpLogClear"
              style="padding:6px 10px;border:0;border-radius:6px;background:#f3f3f3;cursor:pointer;">
        ‚ùå Filter l√∂schen
      </button>
      <button type="button" id="wpLogRangeBtn" data-mode="30"
              style="padding:6px 10px;border:0;border-radius:6px;background:#d9edf7;cursor:pointer;">
        üóìÔ∏è Letzte 30 Tage
      </button>
    </div>
    <div></div><div></div>
  </div>

  <div style="overflow:auto;max-height:50vh;border:1px solid #eee;border-radius:6px;margin-top:10px;">
    <table id="wpLogTable" style="width:100%;border-collapse:collapse;font-size:14px;">
      <thead style="position:sticky;top:0;background:#fafafa;z-index:1;">
        <tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Datum</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Maschine</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Aufgabe</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Intervall</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Schmiernippel</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Techniker</th>
        </tr>
      </thead>
      <tbody id="wpLogBody"></tbody>
    </table>
  </div>

  <div id="wpLogEmpty" style="display:none;padding:8px;color:#666;">Keine Eintr√§ge gefunden.</div>
</div>








<script>
// ===== Wartungs-Log: Laden/Speichern (Cloud + lokal) =====

const WP_WARTUNG_STORAGE_KEY = "TE15_WARTUNGSLOG";
const WP_WARTUNG_CLOUD_FILENAME = "wartungslog.json";


// lokalen Cache aktualisieren (localStorage + RAM)
function _cacheLocal(list) {
  const payload = Array.isArray(list) ? list : [];
  try {
    localStorage.setItem(WP_WARTUNG_STORAGE_KEY, JSON.stringify(payload));
  } catch (_) {}
  window.__memLog = payload.slice();
}

async function _loadAll() {
  // 0) lokalen Cache lesen
  let list = [];
  try {
    const raw = localStorage.getItem(WP_WARTUNG_STORAGE_KEY);
    if (raw) {
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) list = arr;
    }
  } catch (_) {}

  // 1) ohne Login oder Zielordner nur lokalen Cache verwenden
  if (!window.accessToken) {
    console.log("[WP] _loadAll ‚Äì kein AccessToken, nutze nur lokalen Cache:", list);
    return list;
  }

  try {
    // sicherstellen, dass TARGET gesetzt ist
    if (!window.TARGET || !TARGET.driveId || !TARGET.parentItemId) {
      await resolveShareLinkToFolder();
    }
    if (!window.TARGET || !TARGET.driveId || !TARGET.parentItemId) {
      console.warn("[WP] _loadAll ‚Äì TARGET nicht initialisiert, nutze lokalen Cache.");
      return list;
    }

    const url =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
      `/items/${TARGET.parentItemId}:/${encodeURIComponent(WP_WARTUNG_CLOUD_FILENAME)}:/content`;

    const res = await fetch(url, {
      method: "GET",
      headers: { Authorization: `Bearer ${accessToken}` }
    });

    if (res.status === 404) {
      // Datei gibt es noch nicht ‚Üí leere Liste, aber lokalen Cache aktualisieren
      console.log("[WP] _loadAll ‚Äì wartungslog.json existiert noch nicht, starte leer.");
      list = [];
      _cacheLocal(list);
      return list;
    }

    if (!res.ok) {
      console.warn("[WP] _loadAll ‚Äì Cloud nicht OK, nutze lokalen Cache:", res.status);
      return list;
    }

    const cloudData = await res.json();
    if (Array.isArray(cloudData)) {
      list = cloudData;
      _cacheLocal(list);
      console.log("[WP] _loadAll ‚Äì aus Cloud geladen:", list);
    } else {
      console.warn("[WP] _loadAll ‚Äì Cloud-Daten kein Array, nutze lokalen Cache.");
    }
  } catch (err) {
    console.warn("[WP] _loadAll ‚Äì Cloud-Load fehlgeschlagen, nutze lokalen Cache:", err);
  }

  return list;
}

async function _saveAll(list) {
  const payload = Array.isArray(list) ? list : [];

  // 1) immer lokal speichern
  _cacheLocal(payload);
  console.log("[WP] _saveAll ‚Äì lokal gespeichert:", payload);

  // 2) Cloud nur, wenn wir alles wissen
  if (!window.accessToken) {
    console.warn("[WP] _saveAll ‚Äì kein AccessToken, nur lokal gespeichert.");
    return false;
  }

  try {
    if (!window.TARGET || !TARGET.driveId || !TARGET.parentItemId) {
      await resolveShareLinkToFolder();
    }
    if (!window.TARGET || !TARGET.driveId || !TARGET.parentItemId) {
      console.warn("[WP] _saveAll ‚Äì TARGET nicht initialisiert, nur lokal gespeichert.");
      return false;
    }

    const url =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
      `/items/${TARGET.parentItemId}:/${encodeURIComponent(WP_WARTUNG_CLOUD_FILENAME)}:/content`;

    const blob = new Blob([JSON.stringify(payload, null, 2)], {
      type: "application/json"
    });

    const res = await fetch(url, {
      method: "PUT",
      headers: { Authorization: `Bearer ${accessToken}` },
      body: blob
    });

    if (!res.ok) {
      console.warn("[WP] _saveAll ‚Äì Cloud-Speicher fehlgeschlagen:", res.status);
      return false;
    }

    console.log("[WP] _saveAll ‚Äì Cloud-Speicher OK.");
    return true;
  } catch (err) {
    console.warn("[WP] _saveAll ‚Äì Cloud-Save fehlgeschlagen, lokale Daten bleiben erhalten:", err);
    return false;
  }
}





// ‚úÖ LADEN ‚Äì cloud-first + async
async function loadWpLog() {
  var tbody = document.getElementById("wpLogBody");   // <tbody id="wpLogBody">
  var empty = document.getElementById("wpLogEmpty");  // z.B. <tr id="wpLogEmpty"><td colspan="6">Keine Eintr√§ge</td></tr>
  if (!tbody) return;

  // kleine Helper
  function esc(s){ return String(s==null?"":s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  var norm = (typeof _wpNorm === "function")
    ? _wpNorm
    : function(s){ s = (s==null?"":String(s)); return s.toLowerCase().trim(); };

  // üîß Filter direkt aus den Inputs (kein getWpFilters n√∂tig)
  var from="", to="", mach="", task="", tech="";

  try {
    // Wenn du _wpEl bereits eingebaut hast, nutz es ‚Äì sonst f√§llt es auf getElementById zur√ºck
    var getEl = (typeof _wpEl === "function")
      ? _wpEl
      : function(id){ return document.getElementById(id); };

    var fromEl = getEl("wpLog_from");
    var toEl   = getEl("wpLog_to");
    var mEl    = getEl("wpLog_machine");
    var tEl    = getEl("wpLog_task");
    var techEl = getEl("wpLog_tech");

    from = _wpDateInputToISO(fromEl && fromEl.value ? fromEl.value : "");
    to   = _wpDateInputToISO(toEl   && toEl.value   ? toEl.value   : "");

    mach = norm(mEl    && mEl.value    ? mEl.value    : "");
    task = norm(tEl    && tEl.value    ? tEl.value    : "");
    tech = norm(techEl && techEl.value ? techEl.value : "");
  } catch(e) {}


  // Daten laden (CLOUD-first + Fallback)
  var raw = [];
  try { raw = await _loadAll(); } catch(_) {}
  if (!Array.isArray(raw)) raw = [];

  // üîé Filtern
  var list = [];
  for (var i=0; i<raw.length; i++){
    var e = raw[i] || {};
    var dateISO = e.dateISO || "";

    if (from && dateISO < from) continue;
    if (to   && dateISO > to)   continue;

    if (mach){
      var em = norm(e.machine || "");
      if (em.indexOf(mach) === -1) continue;
    }
    if (task){
      var et = norm(e.taskName || "");
      if (et.indexOf(task) === -1) continue;
    }
    if (tech){
      // Techniker-Suche √ºber mehrere Felder + Fallback auf aktuellen User
      var u = (typeof getSignedInUser === "function") ? getSignedInUser() : { name:"", email:"", upn:"" };
      var haystack = [
        e.technician, e.technicianEmail, e.technicianUpn,
        (!e.technician ? u.name : ""), (!e.technicianEmail ? u.email : ""), (!e.technicianUpn ? u.upn : "")
      ];
      var hay = norm(haystack.filter(Boolean).join(" "));
      if (hay.indexOf(tech) === -1) continue;
    }

    list.push(e);
  }

  // ‚¨áÔ∏è Neueste zuerst (ISO-String-Vergleich)
  list.sort(function(a,b){
    var ad = (a && a.dateISO) ? a.dateISO : "";
    var bd = (b && b.dateISO) ? b.dateISO : "";
    return bd.localeCompare(ad);
  });

// üß± Render (mit Escaping)
var html = "";
for (var j = 0; j < list.length; j++) {
  var r = list[j] || {};
  var inter = (r.intervalDays !== "" && r.intervalDays != null) ? r.intervalDays : "‚Äì";
  var nip   = (r.nipples      !== "" && r.nipples      != null) ? r.nipples      : "‚Äì";

  // Kommentar / Audit-Daten
  var cmt = (r.overdueComment && String(r.overdueComment).trim())
    ? String(r.overdueComment).trim()
    : "";

  var who = (r.overdueCommentedByName && String(r.overdueCommentedByName).trim())
    ? String(r.overdueCommentedByName).trim()
    : (r.technician || "");

  var whenIso = (r.overdueCommentedAt && String(r.overdueCommentedAt).trim())
    ? String(r.overdueCommentedAt).trim()
    : "";

  // ISO (UTC) -> lokale Zeit (de-DE)
  var whenPretty = "";
  if (whenIso) {
    try {
      whenPretty = new Date(whenIso).toLocaleString("de-DE", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    } catch (_) {
      whenPretty = whenIso.slice(0, 16).replace("T", " ");
    }
  }

  // F√§lligkeit vor Durchf√ºhrung (aus dem Log)
  var prevNext = (r.prevNextDue && String(r.prevNextDue).trim())
    ? String(r.prevNextDue).trim()
    : "";

  // war der Auftrag √ºberf√§llig?  (F√§lligkeit < Ausf√ºhrungsdatum)
  var wasOverdue = false;
  if (prevNext && r.dateISO) {
    wasOverdue = (prevNext < r.dateISO);
  }

  // Anzeige "Ja/Nein" mit Farbe
  var overdueCell = wasOverdue
    ? '<span style="color:#b02a37;font-weight:bold;">Ja</span>'
    : '<span style="color:#198754;">Nein</span>';

  // Kommentar-Spalte (sichtbar, nicht nur Tooltip)
  var commentDisplay = "";
  if (cmt) {
    commentDisplay = esc(cmt);
    if (who || whenPretty) {
      commentDisplay += "<br><small>(" +
        esc(who || "unbekannt") +
        (whenPretty ? ", " + esc(whenPretty) : "") +
        ")</small>";
    }
  } else {
    commentDisplay = "‚Äì";
  }

  // optional kleines Icon in der Datums-Spalte
  var tooltip = "";
  if (cmt) {
    tooltip =
      (who ? who : "Unbekannt") +
      (whenPretty ? (" ‚Äì " + whenPretty) : "") +
      ': "' + cmt + '"';
  }
  var cmtIcon = cmt
    ? (' <span aria-label="Kommentar" title="' + esc(tooltip) + '" style="cursor:help;">üí¨</span>')
    : "";

  // Zeile rendern ‚Äì √ºberf√§llige Eintr√§ge leicht rot hinterlegen
  html += "<tr" + (wasOverdue ? ' style="background:#f8d7da;"' : "") + ">"
        +   "<td>" + esc(r.dateISO || "") + cmtIcon + "</td>"
        +   "<td>" + esc(r.machine    || "‚Äì") + "</td>"
        +   "<td>" + esc(r.taskName   || "‚Äì") + "</td>"
        +   "<td>" + esc(inter)              + "</td>"
        +   "<td>" + esc(nip)                + "</td>"
        +   "<td>" + esc(r.technician || "‚Äì") + "</td>"
        +   "<td>" + esc(prevNext || "‚Äì")     + "</td>"
        +   "<td>" + overdueCell              + "</td>"
        +   "<td>" + commentDisplay           + "</td>"
        + "</tr>";
}

tbody.innerHTML = html;


  // Empty-State ein/aus
  if (empty) empty.style.display = list.length ? "none" : "table-row";

  // global aktualisieren (kann anderswo genutzt werden)
  window.wartungslog = raw;
}



/* üßº Filter l√∂schen */
function clearWpFilters() {
  ["wpLog_from","wpLog_to","wpLog_machine","wpLog_task","wpLog_tech"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
  loadWpLog();
}

function setWpRange(btn) {
  var modes = ["30","90","365"];
  var nowMode  = btn.getAttribute("data-mode") || "30";
  var nextMode = modes[(modes.indexOf(nowMode)+1) % modes.length];
  btn.setAttribute("data-mode", nextMode);

  // Button-Label
  btn.textContent = (nextMode === "30") ? "üóìÔ∏è Letzte 30 Tage"
                 : (nextMode === "90") ? "üóìÔ∏è Letzte 90 Tage"
                 : "üóìÔ∏è Letzte 365 Tage";

  // Von/Bis setzen
  var today = new Date();
  var days  = parseInt(nextMode, 10);
  var from  = new Date(today);
  from.setDate(today.getDate() - days + 1);

var toStr  = _toISO(today);
var fromStr = _toISO(from);


  var fromEl = document.getElementById("wpLog_from");
  var toEl   = document.getElementById("wpLog_to");
  if (fromEl) fromEl.value = fromStr;
  if (toEl)   toEl.value   = toStr;

  if (typeof loadWpLog === "function") loadWpLog();
}

/* üîå Verdrahten (wenn DOM geladen ist) */
window.addEventListener("load", function () {
  try {
    var u = (typeof getSignedInUser === "function") ? getSignedInUser() : null;
    var techEl = document.getElementById("techniker1");
    if (techEl && u) {
      var name = (typeof displayNameFromUser === "function") ? displayNameFromUser(u) : (u.name || "");
      if (name && !techEl.value) techEl.value = name;
      if (name) { techEl.readOnly = true; techEl.classList && techEl.classList.add("readonly"); }
    }
  } catch (_) {}

  // üíæ Speichern aus dem Wartungs-Panel
  var saveBtn = document.getElementById("wpSaveTask");
  if (saveBtn && typeof saveWpTask === "function") {
    saveBtn.addEventListener("click", async function () {
      await saveWpTask();
    });
  }

  // üîÑ Wartungs-Log Panel: Buttons
  var reloadBtn = document.getElementById("wpLogReload");
  if (reloadBtn) reloadBtn.addEventListener("click", function () {
    if (typeof loadWpLog === "function") loadWpLog();
  });

  var clearBtn = document.getElementById("wpLogClear");
  if (clearBtn) clearBtn.addEventListener("click", function () {
    if (typeof clearWpFilters === "function") clearWpFilters();
  });

  var rangeBtn = document.getElementById("wpLogRangeBtn");
  if (rangeBtn) {
    rangeBtn.addEventListener("click", function (e) {
      setWpRange(e.currentTarget || rangeBtn);
    });
  }

  // üîç Filterfelder reagieren live
  var ids = ["wpLog_from", "wpLog_to", "wpLog_machine", "wpLog_task", "wpLog_tech"];
  for (var i = 0; i < ids.length; i++) {
    var el = document.getElementById(ids[i]);
    if (el) el.addEventListener("input", function () {
      if (typeof loadWpLog === "function") loadWpLog();
    });
  }

  // ‚ñ∂Ô∏è Falls Panel beim Start schon sichtbar ist: direkt laden
  var panel = document.getElementById("wpLogPanel");
  if (panel && panel.style.display !== "none") {
    if (typeof loadWpLog === "function") loadWpLog();
  }
});

</script>
<!-- ‚úÖ END: Wartungs-Dashboard (Log) + Logik -->




<!-- ‚¨áÔ∏è WICHTIG: Ab hier ist alles im PDF-Container -->
<div id="pdfExportContainer">

 <!-- ===== Stammdaten Kopfbereich (untereinander + Techniker-Dropdowns) ===== -->
<div class="section" style="margin-bottom:16px;">
  <div style="display:grid;grid-template-columns:1fr;gap:12px;">

    <!-- Auftrags-ID -->
    <div>
      <label for="auftrag_id" style="font-weight:bold;">Auftrags-ID</label>
      <input id="auftrag_id" name="auftrag_id" type="text" readonly
             title="Wird automatisch vergeben"
             style="padding:6px;width:100%;background:#f7f7f7;">
    </div>

    <!-- Bearbeitet am -->
    <div>
      <label for="bearbeitet_am" style="font-weight:bold;">Bearbeitet am</label>
      <input id="bearbeitet_am" name="bearbeitet_am" type="date" style="padding:6px;width:100%;">
    </div>

    <!-- Techniker 1 -->
    <div>
      <label for="techniker1" style="font-weight:bold;">Techniker 1</label>
      <select id="techniker1" name="techniker1" style="padding:6px;width:100%;">
        <option value="">Bitte ausw√§hlen</option>
        <option value="Sonstige">Sonstige</option>
      </select>
      <input id="sonstiger_techniker1" type="text" placeholder="Bitte angeben‚Ä¶"
             style="display:none;margin-top:6px;padding:6px;width:100%;">
    </div>

    <!-- Techniker 2 -->
    <div>
      <label for="techniker2" style="font-weight:bold;">Techniker 2 (optional)</label>
      <select id="techniker2" name="techniker2" style="padding:6px;width:100%;">
        <option value="">Bitte ausw√§hlen</option>
        <option value="Sonstige">Sonstige</option>
      </select>
      <input id="sonstiger_techniker2" type="text" placeholder="Bitte angeben‚Ä¶"
             style="display:none;margin-top:6px;padding:6px;width:100%;">
    </div>

  </div>
</div>

<script>
/* üëá Basisliste deiner Techniker ‚Äì einfach erweiterbar */
const TECHNIKER_BASE = [
  "Constantin M√ºller-Seeling",
  "Pascal Merker",
  "Tim Eggers",
  "Udo Mahlmann",
  "Mike Hafermalz",
  "J√∂rg Kowald",
  "Stefan Wulf"
];


/* Dropdown + Sonstige-Funktion aufbauen */
function setupTechnikerSelect(selId, otherId){
  var sel   = document.getElementById(selId);
  var other = document.getElementById(otherId);
  if (!sel) return;

  // Basisliste absichern
  var base = (typeof TECHNIKER_BASE !== "undefined" && Array.isArray(TECHNIKER_BASE)) ? TECHNIKER_BASE : [];

  // Technikerliste bef√ºllen (Duplikate vermeiden)
  for (var i=0; i<base.length; i++){
    var n = String(base[i] || "");
    if (!n) continue;

    var exists = false;
    for (var j=0; j<sel.options.length; j++){
      var o = sel.options[j];
      var ov = (o.value || o.textContent || "").toLowerCase();
      if (ov === n.toLowerCase()){ exists = true; break; }
    }
    if (!exists){
      if (typeof addOptionUnique === "function") addOptionUnique(sel, n);
      else sel.add(new Option(n, n));
    }
  }

  function toggleOther(){
    if (other) other.style.display = (sel.value === "Sonstige") ? "block" : "none";
  }

  sel.addEventListener("change", function(){
    if (sel.value !== "Sonstige" && other && other.value && other.value.trim()){
      var v = other.value.trim();
      if (typeof addOptionUnique === "function") addOptionUnique(sel, v, { autoselect:true });
      else { sel.add(new Option(v, v)); sel.value = v; }
      other.value = "";
    }
    toggleOther();
  });

  if (other){
    other.addEventListener("blur", function(){
      var v = (other.value || "").trim();
      if (!v) return;
      if (typeof addOptionUnique === "function") addOptionUnique(sel, v, { autoselect:true });
      else { sel.add(new Option(v, v)); sel.value = v; }
      other.value = "";
      toggleOther();
    });
  }

  toggleOther();
}

window.addEventListener("load", function(){
  setupTechnikerSelect("techniker1", "sonstiger_techniker1");
  setupTechnikerSelect("techniker2", "sonstiger_techniker2");
});
</script>



  <!-- ‚¨ÜÔ∏è Rest deines Formulars folgt hier (Maschine, Anlagenteil, ‚Ä¶) und bleibt unver√§ndert -->


<!-- ‚úÖ Maschinenausfall -->
<div class="section" style="margin-bottom:12px;">
  <label for="maschinenstillstand" style="display:block;font-weight:bold;margin-top:12px;">Maschinenausfall</label>
  <select id="maschinenstillstand" name="maschinenstillstand" style="width:100%;padding:6px;margin-bottom:10px;">
    <option value="" selected>Bitte ausw√§hlen</option>
    <option value="Ja">Ja</option>
    <option value="Nein">Nein</option>
  </select>

  <div id="ausfallzeit_wrap" style="margin-bottom:10px; display:none;">
    <label for="ausfall_stunden">Ausfallzeit:</label>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <div>
        <input id="ausfall_stunden" name="ausfall_stunden"
               type="number" inputmode="numeric" step="1" min="0" max="999"
               placeholder="Stunden" style="width:110px;padding:6px;" disabled>
        <span>Stunden</span>
      </div>
      <div>
        <input id="ausfall_minuten" name="ausfall_minuten"
               type="number" inputmode="numeric" step="1" min="0" max="59"
               placeholder="Minuten" style="width:110px;padding:6px;" disabled>
        <span>Minuten</span>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Maschine -->
<div class="section" style="margin-bottom:12px;">
  <label for="maschine" style="display:block;font-weight:bold;">Maschine</label>
  <select id="maschine" name="maschine" style="width:100%;padding:6px;" autocomplete="off">
    <option value="">Bitte ausw√§hlen</option>
    <option value="Sonstige">Sonstige</option>
    <option value="CIP-Raum">CIP-Raum</option>
    <option value="Crepacco links">Crepacco links</option>
    <option value="Crepacco rechts">Crepacco rechts</option>
    <option value="Dora 680">Dora 680</option>
    <option value="Dora 780">Dora 780</option>
    <option value="Gem√ºseschleuder">Gem√ºseschleuder</option>
    <option value="Hebekipper">Hebekipper</option>
    <option value="Hei√ükutter links (735187)">Hei√ükutter links (735187)</option>
    <option value="Hei√ükutter links 735187">Hei√ükutter links 735187</option>
    <option value="Hei√ükutter rechts (733131)">Hei√ükutter rechts (733131)</option>
    <option value="Herstellung R√ºhrer 1">Herstellung R√ºhrer 1</option>
    <option value="Herstellung R√ºhrer 2">Herstellung R√ºhrer 2</option>
    <option value="Herstellung R√ºhrer 3">Herstellung R√ºhrer 3</option>
    <option value="Herstellung R√ºhrer 4">Herstellung R√ºhrer 4</option>
    <option value="Herstellung R√ºhrer 5">Herstellung R√ºhrer 5</option>
    <option value="Herstellung R√ºhrer 6">Herstellung R√ºhrer 6</option>
    <option value="Herstellung R√ºhrer 7">Herstellung R√ºhrer 7</option>
    <option value="Kaltkutter">Kaltkutter</option>
    <option value="Kilomaschine">Kilomaschine</option>
    <option value="Kistenwaschmaschine">Kistenwaschmaschine</option>
    <option value="Klarsicht">Klarsicht</option>
    <option value="Knoblauchbrecher/-sch√§ler">Knoblauchbrecher/-sch√§ler</option>
    <option value="K√§seschneider">K√§seschneider</option>
    <option value="K√ºbelwaschmaschine">K√ºbelwaschmaschine</option>
    <option value="Minirolle 1">Minirolle 1</option>
    <option value="Minirolle 2">Minirolle 2</option>
    <option value="Minirolle 3">Minirolle 3</option>
    <option value="Minirolle 4">Minirolle 4</option>
    <option value="Minirolle 5">Minirolle 5</option>
    <option value="Minirolle 6">Minirolle 6</option>
    <option value="Mondini 2">Mondini 2</option>
    <option value="Multivac 1">Multivac 1</option>
    <option value="Multivac 2">Multivac 2</option>
    <option value="Multivac 3">Multivac 3</option>
    <option value="MVA">MVA</option>
    <option value="Palettenwaschmaschine">Palettenwaschmaschine</option>
    <option value="Paprikaschneider">Paprikaschneider</option>
    <option value="Paprikateiler">Paprikateiler</option>
    <option value="Petrella SB">Petrella SB</option>
    <option value="Rundl√§ufer 1">Rundl√§ufer 1</option>
    <option value="Rundl√§ufer 2">Rundl√§ufer 2</option>
    <option value="R√ºhle Maschine 1+2">R√ºhle Maschine 1+2</option>
    <option value="R√ºhrer 1">R√ºhrer 1</option>
    <option value="R√ºhrer 2">R√ºhrer 2</option>
    <option value="R√ºhrer 3">R√ºhrer 3</option>
    <option value="R√ºhrer 4">R√ºhrer 4</option>
    <option value="R√ºhrer 5">R√ºhrer 5</option>
    <option value="R√ºhrer 6">R√ºhrer 6</option>
    <option value="R√ºhrer 7">R√ºhrer 7</option>
    <option value="Schnittlauch-Porree-Schneider Krone">Schnittlauch-Porree-Schneider Krone</option>
    <option value="Separator 780">Separator 780</option>
    <option value="Vorsp√ºlmaschine K√ºbel">Vorsp√ºlmaschine K√ºbel</option>
  </select>

  <label for="sonstige_maschine" id="label-sonstige-maschine" style="display:none;margin-top:8px;">
    Sonstiges (Maschine):
  </label>
  <input id="sonstige_maschine" name="sonstige_maschine" type="text"
         placeholder="Bitte angeben..."
         style="display:none;margin-top:5px;width:100%;padding:6px;">
</div>

<!-- ‚úÖ Anlagenteil -->
<div class="section" style="margin-bottom:12px;">
  <label for="anlagenteil" style="display:block;font-weight:bold;">Anlagenteil</label>
  <select id="anlagenteil" name="anlagenteil" style="width:100%;padding:6px;" autocomplete="off">
    <option value="">Bitte ausw√§hlen</option>
    <option value="Sonstige">Sonstige</option>
    <option value="Magnetschalter">Magnetschalter</option>
    <option value="Abdeckhaube">Abdeckhaube</option>
    <option value="Abdeckplatte">Abdeckplatte</option>
    <option value="Antriebsband">Antriebsband</option>
    <option value="Antriebsrolle">Antriebsrolle</option>
    <option value="Band">Band</option>
    <option value="Buchse">Buchse</option>
    <option value="CEE-Steckdose">CEE-Steckdose</option>
    <option value="CPU">CPU</option>
    <option value="Can Bus Modul">Can Bus Modul</option>
    <option value="Deckelformer">Deckelformer</option>
    <option value="Dichtschnur">Dichtschnur</option>
    <option value="Dichtung">Dichtung</option>
    <option value="Dichtungen">Dichtungen</option>
    <option value="Drehschalter">Drehschalter</option>
    <option value="D√§mpfer">D√§mpfer</option>
    <option value="Ein-Taster">Ein-Taster</option>
    <option value="Elektronik">Elektronik</option>
    <option value="Ersatzwerkzeug">Ersatzwerkzeug</option>
    <option value="FU">FU</option>
    <option value="Feder">Feder</option>
    <option value="Filtereinsatz">Filtereinsatz</option>
    <option value="Harting-Stecker">Harting-Stecker</option>
    <option value="Harting-Verbindung">Harting-Verbindung</option>
    <option value="Heizung">Heizung</option>
    <option value="Hubzylinder">Hubzylinder</option>
    <option value="Ini">Ini</option>
    <option value="Kabel">Kabel</option>
    <option value="Kabel und Lichttaster">Kabel und Lichttaster</option>
    <option value="Kabelverschraubung">Kabelverschraubung</option>
    <option value="Ketten">Ketten</option>
    <option value="Kontakte">Kontakte</option>
    <option value="Kunststoffzahnr√§der">Kunststoffzahnr√§der</option>
    <option value="Lager">Lager</option>
    <option value="Lagerachsen">Lagerachsen</option>
    <option value="Lagerzapfen">Lagerzapfen</option>
    <option value="Leimd√ºse">Leimd√ºse</option>
    <option value="Lichtschranke">Lichtschranke</option>
    <option value="Lichtschranke und Kabel">Lichtschranke und Kabel</option>
    <option value="Lichtschranken">Lichtschranken</option>
    <option value="Lichttaster">Lichttaster</option>
    <option value="Lichttaster und Kabel">Lichttaster und Kabel</option>
    <option value="Luftschlauch">Luftschlauch</option>
    <option value="Magnet">Magnet</option>
    <option value="Modul 121">Modul 121</option>
    <option value="Motor">Motor</option>
    <option value="Netzteil">Netzteil</option>
    <option value="Not-Aus-Schalter">Not-Aus-Schalter</option>
    <option value="PT 100">PT 100</option>
    <option value="Panel">Panel</option>
    <option value="Platine">Platine</option>
    <option value="Poti">Poti</option>
    <option value="Profibus">Profibus</option>
    <option value="Relais">Relais</option>
    <option value="Relais mit Sockel">Relais mit Sockel</option>
    <option value="Rolle">Rolle</option>
    <option value="S7-Steuerung">S7-Steuerung</option>
    <option value="SPS">SPS</option>
    <option value="Schalter">Schalter</option>
    <option value="Schaltergeh√§use">Schaltergeh√§use</option>
    <option value="Schiebef√ºhrung">Schiebef√ºhrung</option>
    <option value="Schlauch">Schlauch</option>
    <option value="Schraube">Schraube</option>
    <option value="Schraube und Dichtung">Schraube und Dichtung</option>
    <option value="Schrauben">Schrauben</option>
    <option value="Sensor">Sensor</option>
    <option value="Sicherheitrelais">Sicherheitrelais</option>
    <option value="Sicherheits-Ausgangsmodul">Sicherheits-Ausgangsmodul</option>
    <option value="Sicherheitsbaugruppe">Sicherheitsbaugruppe</option>
    <option value="Sicherheitsrelais">Sicherheitsrelais</option>
    <option value="Sicherheitsschalter">Sicherheitsschalter</option>
    <option value="Sicherheitsventil">Sicherheitsventil</option>
    <option value="Sicherung">Sicherung</option>
    <option value="Siegelheizung">Siegelheizung</option>
    <option value="Spule">Spule</option>
    <option value="Stator">Stator</option>
    <option value="Steckdose">Steckdose</option>
    <option value="Stecker">Stecker</option>
    <option value="Stecker und Spule">Stecker und Spule</option>
    <option value="Steckereinsatz">Steckereinsatz</option>
    <option value="Steckverbindung">Steckverbindung</option>
    <option value="Stopfen">Stopfen</option>
    <option value="Taster">Taster</option>
    <option value="Tasteroberteil">Tasteroberteil</option>
    <option value="Temperaturf√ºhler">Temperaturf√ºhler</option>
    <option value="Touchpanel">Touchpanel</option>
    <option value="Trichterschalter">Trichterschalter</option>
    <option value="Umlenkrolle">Umlenkrolle</option>
    <option value="Vakuumgenerator">Vakuumgenerator</option>
    <option value="Vakuumpumpe">Vakuumpumpe</option>
    <option value="Vakuumsensor">Vakuumsensor</option>
    <option value="Ventil">Ventil</option>
    <option value="Verriegelungsb√ºgel">Verriegelungsb√ºgel</option>
    <option value="Wartungspaket">Wartungspaket</option>
    <option value="Welle">Welle</option>
    <option value="Zylinder">Zylinder</option>
    <option value="Zylinder und Heizungsregler">Zylinder und Heizungsregler</option>
    <option value="Zylinder und Vakuumventil">Zylinder und Vakuumventil</option>
    <option value="Z√§hler">Z√§hler</option>
    <option value="Dichtring">Dichtring</option>
  </select>

  <label id="label-sonstige-anlagenteil" for="sonstige_anlagenteil" style="display:none;margin-top:8px;">
    Sonstiges (Anlagenteil):
  </label>
  <input id="sonstige_anlagenteil" name="sonstige_anlagenteil" type="text"
         placeholder="Bitte angeben..."
         style="display:none;margin-top:5px;width:100%;padding:6px;">
</div>
<!-- ‚¨áÔ∏è Provisorium-Block mit Bezug auf bestehenden Auftrag -->
<div class="section" style="margin-bottom:12px;">
  <label for="provisorium_aktiv" style="display:block;font-weight:bold;">
    Provisorium eingebaut?
  </label>
  <select id="provisorium_aktiv" name="provisorium_aktiv" style="width:100%;padding:6px;">
    <option value="">Bitte ausw√§hlen</option>
    <option value="Nein" selected>Nein</option>
    <option value="Ja">Ja</option>
  </select>

  <div id="provisorium_details"
       style="display:none;margin-top:10px;border:1px solid #ddd;padding:10px;border-radius:6px;">

    <!-- Art des Provisoriums -->
    <div style="margin-bottom:10px;">
      <label for="provisorium_art" style="font-weight:bold;display:block;">
        Art des Provisoriums
      </label>
      <input id="provisorium_art" name="provisorium_art" type="text"
             placeholder="z. B. provisorische Leitung, Bypass, Br√ºcke ‚Ä¶"
             style="width:100%;padding:6px;">
    </div>

    <!-- G√ºltigkeitszeitraum -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px;">
      <div>
        <label for="provisorium_von" style="font-weight:bold;display:block;">
          Provisorium g√ºltig von
        </label>
        <input id="provisorium_von" name="provisorium_von"
               type="datetime-local"
               style="width:100%;padding:6px;">
      </div>
      <div>
        <label for="provisorium_bis" style="font-weight:bold;display:block;">
          Provisorium g√ºltig bis
        </label>
        <input id="provisorium_bis" name="provisorium_bis"
               type="datetime-local"
               style="width:100%;padding:6px;">
      </div>
    </div>

    <!-- ‚¨áÔ∏è NEU: Bezug auf bestehendes Provisorium -->
    <div style="margin-top:4px;">
      <label for="provisorium_bezug_auftrag_id" style="font-weight:bold;display:block;">
        Bezieht sich auf Provisorium aus Auftrag-ID (optional)
      </label>
      <select id="provisorium_bezug_auftrag_id" name="provisorium_bezug_auftrag_id"
              style="width:100%;padding:6px;">
        <option value="">Kein Bezug / neues Provisorium</option>
      </select>
      <small style="display:block;margin-top:4px;font-size:12px;color:#666;">
        Nur ausf√ºllen, wenn dieser Auftrag ein bestehendes Provisorium aufhebt.
      </small>
    </div>

  </div>
</div>

<!-- ‚¨ÜÔ∏è Ende Provisorium -->
<!-- ‚¨áÔ∏è HIER EINSETZEN: Wartungsplan-Panel -->
<div class="section" id="wartungsplanSection" style="margin:16px 0;">
  <div id="wpWarning" style="display:none;margin-bottom:10px;padding:10px;border:1px solid #dc3545;color:#842029;background:#f8d7da;border-radius:6px;">
    ‚ö†Ô∏è Diese Anlage hat <strong>√ºberf√§llige Wartungen</strong>. Bitte durchf√ºhren!
  </div>

  <div id="wartungsplanPanel" style="display:none;border:1px solid #ddd;border-radius:8px;padding:12px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label style="font-weight:bold;">Anlage (Maschine)</label>
        <div style="font-size:13px;color:#666;">Verkn√ºpft mit Feld ‚ÄûMaschine‚Äú</div>
      </div>
      <div>
        <label style="font-weight:bold;">Status</label><br>
        <span id="wpStatusPill" style="display:inline-block;padding:4px 8px;border-radius:999px;font-size:13px;background:#e9ecef;">‚Äì</span>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label for="wpTaskSelect" style="font-weight:bold;">Schmierstelle / Aufgabe</label>
      <select id="wpTaskSelect" style="width:100%;padding:6px;">
        <option value="">Bitte ausw√§hlen</option>
      </select>
    </div>

    <!-- ‚ûï NEU: Anzahl Schmiernippel -->
    <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label for="wpNipCount" style="font-weight:bold;">Anzahl Schmiernippel</label>
        <input id="wpNipCount" type="number" min="0" step="1" placeholder="z. B. 6" style="width:100%;padding:6px;">
      </div>
      <div></div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(3,minmax(140px,1fr));gap:12px;margin-top:10px;">
      <div>
        <label style="font-weight:bold;">Intervall (Tage)</label>
        <input id="wpIntervalDays" type="number" min="1" step="1" placeholder="z. B. 30" style="width:100%;padding:6px;">
      </div>
      <div>
        <label style="font-weight:bold;">Zuletzt durchgef√ºhrt</label>
        <input id="wpLastDate" type="date" style="width:100%;padding:6px;">
      </div>
      <div>
        <label style="font-weight:bold;">N√§chstes F√§lligkeitsdatum</label>
        <input id="wpNextDue" type="date" readonly style="width:100%;padding:6px;background:#f7f7f7;">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" id="wpAddTask"    style="padding:8px 12px;border:0;border-radius:6px;background:#6c757d;color:#fff;cursor:pointer;">‚ûï Neue Aufgabe</button>
      <button type="button" id="wpSaveTask"   style="padding:8px 12px;border:0;border-radius:6px;background:#0d6efd;color:#fff;cursor:pointer;">üíæ Speichern</button>
      <button type="button" id="wpDeleteTask" style="padding:8px 12px;border:0;border-radius:6px;background:#dc3545;color:#fff;cursor:pointer;">üóëÔ∏è L√∂schen</button>
      <button type="button" id="wpMarkDoneToday" style="padding:8px 12px;border:0;border-radius:6px;background:#198754;color:#fff;cursor:pointer;">‚úÖ Heute durchgef√ºhrt</button>
    </div>

    <div id="wpHint" style="margin-top:8px;color:#666;font-size:13px;">
      Aufgaben sind pro Maschine hinterlegt. Beim Abschluss kannst du die passende Aufgabe mit ‚ÄûHeute durchgef√ºhrt‚Äú markieren.
    </div>
    <!-- üîΩ NEU: Wartungs-Zusammenfassung -->
<div id="wpPrintSummary" style="display:none;margin-top:10px;border:1px dashed #ccc;padding:8px;border-radius:8px;">
  <div style="font-weight:600;margin-bottom:6px;">Wartungs-Zusammenfassung</div>
  <div><strong>Aufgabe:</strong> <span id="wpPrintTask">‚Äì</span></div>
  <div><strong>Intervall (Tage):</strong> <span id="wpPrintInterval">‚Äì</span></div>
  <div><strong>Zuletzt durchgef√ºhrt:</strong> <span id="wpPrintLast">‚Äì</span></div>
  <div><strong>N√§chstes F√§lligkeitsdatum:</strong> <span id="wpPrintNext">‚Äì</span></div>
  <div><strong>Schmiernippel:</strong> <span id="wpPrintNip">‚Äì</span></div>
</div>
  </div>
</div>
<!-- ‚¨ÜÔ∏è Ende Wartungsplan-Panel -->







    <div style="margin-top: 20px;">
  <label style="font-weight: bold; display: block;">Dauer der Reparatur (von - bis Uhrzeit):</label>
  <input id="startzeit" name="start_time" style="margin-right: 10px;" type="time"/>
  <input id="endzeit" name="end_time" style="margin-right: 10px;" type="time"/>
  <input id="dauer" name="dauer" placeholder="Dauer in Stunden" readonly="true" type="text"/>
</div>

<div class="section">
<label for="abschlussdatum">Abschlussdatum der Ausf√ºhrung:</label>
<input id="abschlussdatum" name="abschlussdatum" type="date"/>
</div>
<div class="section">
<label for="fehlerbeschreibung">Fehlerbeschreibung:</label>
<textarea cols="50" id="fehlerbeschreibung" name="fehlerbeschreibung" placeholder="Was war defekt? Was wurde unternommen?" rows="4"></textarea>
</div>
<div class="section">
<label for="reinigung_erforderlich">Reinigung Maschine/Umfeld erforderlich:</label>
<select id="reinigung_erforderlich" name="reinigung_erforderlich">
<option value="ja">Ja</option>
<option value="nein">Nein</option>
</select>
<div style="margin-bottom: 10px;">
<label for="reinigungsart_zusatz">Reinigungsausf√ºhrung:</label>
<select id="reinigungsart_zusatz" name="reinigungsart_zusatz" style="width: 100%; padding: 6px; margin-bottom: 10px;">
<option value="">Bitte ausw√§hlen</option>
<option value="Maschinenpersonal">Maschinenpersonal</option>
<option value="Reinigungsschicht">Reinigungsschicht</option>
<option value="Sonstiges">Sonstiges</option>
</select><input id="sonstige_reinigungsart_zusatz" name="sonstige_reinigungsart_zusatz" placeholder="Bitte angeben..." style="display:none; margin-top: 5px; width: 100%;" type="text"/><input id="reinigungsart_sonstiges" name="reinigungsart_sonstiges" style="display:none; width: 100%; padding: 6px;" type="text"/><label for="reinigungsart_sonstiges" style="display:none;">Sonstiges (Reinigungsausf√ºhrung):</label>
</div>
<div style="margin-bottom: 10px;">
</div>
</div>
<div class="section">
  <p>Die Reparatur ist abgeschlossen und alle eingesetzten Werkzeuge wurden komplett entfernt.</p>
</div>

<div class="page-break"></div>

<div class="section">
  <label for="unterschrift_abnahme">Unterschrift MA Abnahme (Produktkreisfreigabe):</label>
  <canvas class="signature-pad" id="unterschrift_abnahme"></canvas>
  <button onclick="clearSignature(0)" style="margin-top: 8px; display: block;" type="button">Unterschrift l√∂schen</button>
</div>

<div class="page-break"></div>

<div class="section">
  <label for="unterschrift_technik">Unterschrift MA Technik:</label>
  <canvas class="signature-pad" id="unterschrift_technik"></canvas>
  <button type="button" style="margin-top: 8px; display: block;" 
          onclick="clearSignature(1)">Unterschrift l√∂schen</button>

  <div style="margin-top: 24px;">
    <label for="foto" style="font-weight: bold;">Fehlerstelle / Schaden (optional):</label>
    <h2>Fotos f√ºr Reparaturauftrag</h2>
    <input accept="image/*" id="fileInput" multiple type="file" />
    <div class="preview-container" id="previewContainer"></div>
  </div>
</div>


<style>
  .page-break {
    page-break-before: always;
  }
  .preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
  }
  .image-wrapper {
    position: relative;
    display: inline-block;
  }
  .delete-button {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: red;
    color: white;
    border: none;
    padding: 5px;
    cursor: pointer;
    border-radius: 5px;
  }
/* korrekt nur f√ºr Thumbnails der Vorschau */
.preview-container img {
  max-width: 200px;
  max-height: 200px;
  border: 1px solid #ccc;
}

</style>

<script>
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    let uploadedFiles = [];
    fileInput.addEventListener('change', function(event) {
        const files = Array.from(event.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('image-wrapper');
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-button');
                deleteBtn.textContent = 'L√∂schen';
                deleteBtn.addEventListener('click', () => {
                    wrapper.remove();
                    uploadedFiles = uploadedFiles.filter(f => f !== file);
                    console.log("Datei gel√∂scht:", file.name);
                });
                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                previewContainer.appendChild(wrapper);
                uploadedFiles.push(file);
            };
            reader.readAsDataURL(file);
        });
        fileInput.value = '';
    });
</script>

<div class="section">
  <label for="ort_datum">Ort / Datum:</label>
  <input id="ort_datum" name="ort_datum" type="text"/>
</div>


<div style="margin-top: 20px; font-size: 14px; line-height: 1.5; white-space: pre;">
Erstellt: M.Thiemann       Datum: 18.06.2025
Gepr√ºft: M. Hafermalz      Datum: 24.06.2025
Freigegeben: F. Pieper     Datum: 24.06.2025
</div>

</div> <!-- <= HIER und NUR HIER den #pdfExportContainer schlie√üen -->


<!-- ====================== -->
<!-- Buttons au√üerhalb Container -->
<!-- ====================== -->
<div class="no-print" style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px;">
  <button type="button" onclick="saveDraftToOneDrive()">üíæ Entwurf in OneDrive speichern</button>
  <button type="button" onclick="showDraftList()">üìÇ Entwurf aus OneDrive laden</button>
  <button type="button" onclick="generatePDFAndFinish()">‚úÖ Auftrag abschlie√üen & in OneDrive speichern</button>
  <button type="button" onclick="forceUpdate()">‚ôªÔ∏è App aktualisieren (Cache l√∂schen)</button>
</div>

<!-- üì• Schmierplan (Excel) importieren) -->
<div class="no-print" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:4px 0 16px;">
  <input id="xlsxInput" type="file" accept=".xlsx,.xls">
  <button type="button" onclick="importSchmierplanFromExcel()">üì• Excel (Schmierplan) einlesen</button>
</div>

<!-- SheetJS (XLSX) f√ºr den Excel-Import -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


<style>
canvas.signature-pad {
  border: 1px solid #000;
  width: 100%;
  height: 100px;
  touch-action: none;
}
</style>
<style>
canvas.signature-pad {
  border: 1px solid #000;
  background: #fff;
  touch-action: none;
  width: 100%;
  max-width: 600px;
  height: 200px;
}
.signature-container {
  margin-bottom: 20px;
}
button.clear-signature {
  margin-top: 5px;
}
</style>


<script>
function initSignaturePad(canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    const ratio = window.devicePixelRatio || 1;
    const rect  = canvas.getBoundingClientRect();
    canvas.width  = rect.width * ratio;
    canvas.height = rect.height * ratio;
    ctx.scale(ratio, ratio);

    ctx.lineWidth   = 2;
    ctx.lineCap     = 'round';
    ctx.lineJoin    = 'round';
    ctx.strokeStyle = '#000';
  }

  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  let drawing = false;
  // Flag: 0 = keine Unterschrift, 1 = unterschrieben
  canvas.dataset.signed = canvas.dataset.signed || "0";

  function clearCanvasError() {
    canvas.classList.remove('field-error');
    if (canvas.nextElementSibling && canvas.nextElementSibling.classList?.contains('error-text')) {
      canvas.nextElementSibling.remove();
    }
  }

  canvas.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    drawing = true;
    const r = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - r.left, e.clientY - r.top);

    canvas.dataset.signed = "1";   // üëâ jetzt gilt als unterschrieben
    clearCanvasError();
  }, { passive: false });

  canvas.addEventListener("pointermove", (e) => {
    if (!drawing) return;
    const r = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
    ctx.stroke();
  });

  canvas.addEventListener("pointerup",   () => { drawing = false; });
  canvas.addEventListener("pointerleave",() => { drawing = false; });
}

window.addEventListener("load", () => {
  initSignaturePad("unterschrift_abnahme");
  initSignaturePad("unterschrift_technik");
});

</script>



<script>
function clearSignature(index) {
  const canvases = document.querySelectorAll("canvas.signature-pad");
  const canvas   = canvases[index];
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  canvas.dataset.signed = "0";          // üëâ Unterschrift wieder ‚Äûweg‚Äú
  canvas.classList.remove('field-error');
  if (canvas.nextElementSibling && canvas.nextElementSibling.classList?.contains('error-text')) {
    canvas.nextElementSibling.remove();
  }
}

</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // üü¢ Zeitberechnung
  const startTimeInput = document.getElementById("startzeit");
  const endTimeInput   = document.getElementById("endzeit");
  const durationInput  = document.getElementById("dauer");

  function calculateDuration() {
    const start = startTimeInput?.value;
    const end   = endTimeInput?.value;
    if (start && end) {
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let s = new Date(0,0,0,sh,sm), e = new Date(0,0,0,eh,em);
      let diff = e - s; if (diff < 0) diff += 24*60*60*1000;
      const mins = Math.floor(diff/60000), h = Math.floor(mins/60), m = mins%60;
      if (durationInput) {
        durationInput.value = (h ? `${h} h ` : "") + (m ? `${m} min` : (h ? "" : "0 min"));
      }
    }
  }
  startTimeInput?.addEventListener("input", calculateDuration);
  endTimeInput?.addEventListener("input", calculateDuration);

  // "Sonstige"-Felder & Selects
  const maschineSelect            = document.getElementById("maschine");
  const sonstigeMaschineInput     = document.getElementById("sonstige_maschine");
  const labelSonstigeMaschine     = document.getElementById("label-sonstige-maschine");

  const anlagenteilSelect         = document.getElementById("anlagenteil");
  const sonstigeAnlagenteilInput  = document.getElementById("sonstige_anlagenteil");
  const labelSonstigeAnlagenteil  = document.getElementById("label-sonstige-anlagenteil");

  const reinigungsartSelect       = document.getElementById("reinigungsart_zusatz");
  const sonstigeReinigungsartInput = document.getElementById("sonstige_reinigungsart");
  const labelSonstigeReinigungsart = document.getElementById("label-sonstige_reinigungsart_zusatz");

// Provisorium-Felder
const provisoriumSelect      = document.getElementById("provisorium_aktiv");
const provisoriumDetails     = document.getElementById("provisorium_details");
const provisoriumArtInput    = document.getElementById("provisorium_art");
const provisoriumVonInput    = document.getElementById("provisorium_von");
const provisoriumBisInput    = document.getElementById("provisorium_bis");
const provisoriumBezugSelect = document.getElementById("provisorium_bezug_auftrag_id");

function updateMaschineField() {
  const show = maschineSelect && maschineSelect.value === "Sonstige";
  if (sonstigeMaschineInput)  sonstigeMaschineInput.style.display  = show ? "block" : "none";
  if (labelSonstigeMaschine)  labelSonstigeMaschine.style.display  = show ? "block" : "none";
}

function updateAnlagenteilField() {
  const show = anlagenteilSelect && anlagenteilSelect.value === "Sonstige";
  if (sonstigeAnlagenteilInput) sonstigeAnlagenteilInput.style.display = show ? "block" : "none";
  if (labelSonstigeAnlagenteil) labelSonstigeAnlagenteil.style.display = show ? "block" : "none";
}

function updateReinigungsartField() {
  const show = reinigungsartSelect && reinigungsartSelect.value === "Sonstige";
  if (sonstigeReinigungsartInput)  sonstigeReinigungsartInput.style.display  = show ? "block" : "none";
  if (labelSonstigeReinigungsart)  labelSonstigeReinigungsart.style.display  = show ? "block" : "none";
}

function updateProvisoriumField() {
  if (!provisoriumSelect) return;

  const isNewProv = provisoriumSelect.value === "Ja";

  // Kasten f√ºr Provisorium immer anzeigen
  if (provisoriumDetails) {
    provisoriumDetails.style.display = "block";
  }

  // Felder f√ºr *neues* Provisorium nur bei "Ja" aktiv
  if (provisoriumArtInput) {
    provisoriumArtInput.disabled = !isNewProv;
    if (!isNewProv) provisoriumArtInput.value = "";
  }
  if (provisoriumVonInput) {
    provisoriumVonInput.disabled = !isNewProv;
    if (!isNewProv) provisoriumVonInput.value = "";
  }
  if (provisoriumBisInput) {
    provisoriumBisInput.disabled = !isNewProv;
    if (!isNewProv) provisoriumBisInput.value = "";
  }

  // Das Bezug-Dropdown bleibt immer aktiv ‚Äì kein extra Code n√∂tig.
}

maschineSelect?.addEventListener("change",      updateMaschineField);
anlagenteilSelect?.addEventListener("change",   updateAnlagenteilField);
reinigungsartSelect?.addEventListener("change", updateReinigungsartField);
provisoriumSelect?.addEventListener("change",   updateProvisoriumField);

// initialer Zustand
updateMaschineField();
updateAnlagenteilField();
updateReinigungsartField();
updateProvisoriumField();

  // ------------------------------------
async function loadOpenProvisoriumOptions() {
  const sel = document.getElementById("provisorium_bezug_auftrag_id");
  if (!sel) return;

  // Grundoption
  sel.innerHTML =
    '<option value="">Kein Bezug / neues Provisorium</option>';

  // Falls noch kein Token da ist: versuchen, eins zu holen
  if (!accessToken) {
    if (typeof signInAndAcquireToken === "function") {
      try {
        // versucht zuerst still ein Token zu holen, sonst Login-Popup
        await signInAndAcquireToken(true);
      } catch (e) {
        console.warn("loadOpenProvisoriumOptions ‚Äì kein Zugriff auf Graph:", e);
        return; // ohne Token k√∂nnen wir die Liste nicht aus OneDrive laden
      }
    } else {
      // Sicherheitsnetz: Funktion existiert nicht
      console.warn("loadOpenProvisoriumOptions ‚Äì signInAndAcquireToken fehlt");
      return;
    }
  }

  // ab hier solltest du ein accessToken haben
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) return;

  const headers     = { Authorization: `Bearer ${accessToken}` };
  const META_SUFFIX = ".meta.json";
  let   metaItems   = [];

  // 1) Meta-Ordner, falls vorhanden
  if (window.TARGET_META_ITEM_ID) {
    const listMetaUrl =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
      `/items/${TARGET_META_ITEM_ID}/children` +
      `?$top=2000&$select=id,name,file`;
    const res = await fetch(listMetaUrl, { headers });
    if (res.ok) {
      const data = await res.json();
      metaItems = (data.value || []).filter(
        i => i.file && i.name.endsWith(META_SUFFIX)
      );
    }
  }

  // 2) Fallback Hauptordner
  if (!metaItems.length) {
    const listMainUrl =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
      `/items/${TARGET.parentItemId}/children` +
      `?$top=2000&$select=id,name,file`;
    const res = await fetch(listMainUrl, { headers });
    if (res.ok) {
      const data = await res.json();
      metaItems = (data.value || []).filter(
        i => i.file && i.name.endsWith(META_SUFFIX)
      );
    }
  }

  // -------------------------
  // Alle Metas einmal einlesen
  // -------------------------
  const metaList = []; // { meta, auftragsId, maschine, teil }

  for (const m of metaItems) {
    const mres = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${m.id}/content`,
      { headers }
    );
    if (!mres.ok) continue;

    let meta;
    try {
      meta = await mres.json();
    } catch {
      continue;
    }

    const auftragsId =
      meta.auftrags_id ||
      meta.auftrag_id ||
      m.name.replace(META_SUFFIX, "");

    const maschine =
      meta.maschine ||
      meta.maschine_value ||
      meta.maschine_text ||
      meta.sonstige_maschine ||
      "";

    const teil =
      meta.anlagenteil ||
      meta.anlagenteil_value ||
      meta.anlagenteil_text ||
      meta.sonstige_anlagenteil ||
      "";

    metaList.push({ meta, auftragsId, maschine, teil });
  }

  // ----------------------------------------
  // Menge aller bereits "aufgel√∂sten" IDs
  // (also IDs, die in provisorium_bezug_auftrag_id vorkommen)
  // ----------------------------------------
  const resolvedSet = new Set();

  for (const { meta } of metaList) {
    const ref = (meta.provisorium_bezug_auftrag_id || "").trim();
    if (ref) resolvedSet.add(ref);
  }

  // ----------------------------------------
  // Dropdown nur mit offenen Provisorien bef√ºllen:
  // - provisorium_aktiv === "Ja"
  // - auftragsId NICHT in resolvedSet
  // ----------------------------------------
  const options = [];

  for (const { meta, auftragsId, maschine, teil } of metaList) {
    // ‚úÖ nur echte Provisorien
    if (meta.provisorium_aktiv !== "Ja") continue;

    // ‚úÖ bereits von anderem Auftrag "abgearbeitet"? -> nicht anzeigen
    if (resolvedSet.has(auftragsId)) continue;

    // ‚úÖ bis-Datum darf gelesen werden (f√ºr Anzeige / Status),
    //    aber NICHT mehr zum Filtern verwendet werden
    // const bisIso = (meta.provisorium_bis || "").slice(0, 10);

    const label =
      `${auftragsId} ‚Äì ${maschine}${teil ? " / " + teil : ""}`;

    options.push({ value: auftragsId, label });
  }

  const collator = new Intl.Collator("de", {
    numeric: true,
    sensitivity: "base"
  });
  options.sort((a, b) => collator.compare(a.label, b.label));

  for (const o of options) {
    const opt = document.createElement("option");
    opt.value = o.value;
    opt.textContent = o.label;
    sel.appendChild(opt);
  }
}


  // Beim Laden der Seite gleich einmal bef√ºllen
  loadOpenProvisoriumOptions().catch(console.error);


  // üîí Basis-Optionen (HTML-Defaults) einmalig puffern
  const baseMaschineValues =
    maschineSelect ? Array.from(maschineSelect.options).map(o => o.value) : [];
  const baseAnlagenteilValues =
    anlagenteilSelect ? Array.from(anlagenteilSelect.options).map(o => o.value) : [];

  function pruneToBase(selectEl, baseValues) {
    if (!selectEl) return;
    Array.from(selectEl.options).forEach(o => {
      if (!baseValues.includes(o.value)) o.remove();
    });
    if (!baseValues.includes(selectEl.value)) selectEl.value = "";
  }

function rebuildDropdownsFromMaster() {
  const selMs = Array.from(document.querySelectorAll('select#maschine'));
  const selAs = Array.from(document.querySelectorAll('select#anlagenteil'));

  if (!selMs.length && !selAs.length) return;

  const keep = (sel) => sel ? {
    value: sel.value,
    text:  sel.options[sel.selectedIndex]?.textContent?.trim() || ""
  } : null;

  const restore = (sel, kept) => {
    if (!sel || !kept) return;
    if ([...sel.options].some(o => o.value === kept.value)) { sel.value = kept.value; return; }
    const byText = [...sel.options].find(o => (o.textContent || o.innerText).trim() === kept.text);
    if (byText) sel.value = byText.value;
  };

  // Maschine: alle Selects aktualisieren
  selMs.forEach(selM => {
    const kept = keep(selM);
    pruneToBase(selM, baseMaschineValues);
    (masterData.maschinen || []).forEach(n => addOptionUnique(selM, n, { autoselect: false }));
    sortSelectOptions(selM, ["", "Sonstige"]);
    restore(selM, kept);
  });

  // Anlagenteil: alle Selects aktualisieren
  selAs.forEach(selA => {
    const kept = keep(selA);
    pruneToBase(selA, baseAnlagenteilValues);
    (masterData.anlagenteile || []).forEach(n => addOptionUnique(selA, n, { autoselect: false }));
    sortSelectOptions(selA, ["", "Sonstige"]);
    restore(selA, kept);
  });

  // Sonstige-Felder korrekt ein-/ausblenden
  updateMaschineField();
  updateAnlagenteilField();
}


  // global verf√ºgbar
  window.rebuildDropdownsFromMaster = rebuildDropdownsFromMaster;

  // Stammdaten laden und danach Dropdowns neu aufbauen
  loadMasterData().then(rebuildDropdownsFromMaster);

  // üìù "Sonstige"-Werte dauerhaft √ºbernehmen
function tryAddCustomMaschine() {
  if (!sonstigeMaschineInput || !maschineSelect) return;

  var val = (sonstigeMaschineInput.value || "").trim();
  if (!val) return;

  // 1) ins Dropdown einf√ºgen
  if (typeof addOptionUnique === "function") {
    addOptionUnique(maschineSelect, val);   // f√ºgt ein & sortiert (falls eure Funktion das macht)
  } else {
    maschineSelect.add(new Option(val, val));
  }

  // 2) Auswahl auf den neuen Wert setzen (wichtig f√ºrs Pflichtfeld!)
  maschineSelect.value = val;

  // 3) Sicherheit: nochmal sortieren, "" + Sonstige bleiben oben
  if (typeof sortSelectOptions === "function") {
    sortSelectOptions(maschineSelect, ["", "Sonstige"]);
  }

  // 4) Stammdaten-Array aktualisieren + speichern
  if (!masterData) masterData = {};
  if (!Array.isArray(masterData.maschinen)) masterData.maschinen = [];

  var exists = masterData.maschinen.some(function (x) {
    return String(x || "").toLowerCase() === val.toLowerCase();
  });

  if (!exists) {
    masterData.maschinen.push(val);
    masterData.maschinen.sort(function (a, b) {
      return String(a).localeCompare(String(b), "de", { sensitivity: "base" });
    });

    // auch Basisliste erweitern, damit pruneToBase ihn nie wieder l√∂scht
    if (Array.isArray(baseMaschineValues) && baseMaschineValues.indexOf(val) === -1) {
      baseMaschineValues.push(val);
    }

    if (typeof saveMasterData === "function") saveMasterData();
  }

  // 5) Textfeld leeren & ausblenden
  sonstigeMaschineInput.value = "";
  updateMaschineField();
}


function tryAddCustomAnlagenteil() {
  if (!sonstigeAnlagenteilInput || !anlagenteilSelect) return;
  var val = (sonstigeAnlagenteilInput.value || "").trim();
  if (!val) return;

  // 1) ins Dropdown einf√ºgen
  if (typeof addOptionUnique === "function") {
    addOptionUnique(anlagenteilSelect, val);
  } else {
    anlagenteilSelect.add(new Option(val, val));
  }

  // 2) Auswahl setzen
  anlagenteilSelect.value = val;

  // 3) Sicherheit: sortieren
  if (typeof sortSelectOptions === "function") {
    sortSelectOptions(anlagenteilSelect, ["", "Sonstige"]);
  }

  // 4) Stammdaten-Array aktualisieren + speichern
  if (!Array.isArray(masterData.anlagenteile)) masterData.anlagenteile = [];
  var exists = masterData.anlagenteile.some(function (x) {
    return String(x || "").toLowerCase() === val.toLowerCase();
  });

  if (!exists) {
    masterData.anlagenteile.push(val);
    masterData.anlagenteile.sort(function (a, b) {
      return String(a).localeCompare(String(b), "de", { sensitivity: "base" });
    });

    if (Array.isArray(baseAnlagenteilValues) && baseAnlagenteilValues.indexOf(val) === -1) {
      baseAnlagenteilValues.push(val);
    }

    if (typeof saveMasterData === "function") saveMasterData();
  }

  // 5) Textfeld leeren & ausblenden
  sonstigeAnlagenteilInput.value = "";
  updateAnlagenteilField();
}


// Eingabe √ºbernehmen bei Verlassen der Felder
if (sonstigeMaschineInput) {
  sonstigeMaschineInput.addEventListener("blur", tryAddCustomMaschine);

  // ‚úÖ Enter = sofort √ºbernehmen (nicht nur blur)
  sonstigeMaschineInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      tryAddCustomMaschine();
    }
  });
}

if (sonstigeAnlagenteilInput) {
  sonstigeAnlagenteilInput.addEventListener("blur", tryAddCustomAnlagenteil);

  // ‚úÖ Enter = sofort √ºbernehmen (nicht nur blur)
  sonstigeAnlagenteilInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      tryAddCustomAnlagenteil();
    }
  });
}

// ‚úÖ Extra robust: wenn man im Select etwas √§ndert, √ºbernehmen wir ggf. den Text
if (maschineSelect) {
  maschineSelect.addEventListener("change", function () {
    if (sonstigeMaschineInput && sonstigeMaschineInput.value && sonstigeMaschineInput.value.trim()) {
      tryAddCustomMaschine();
    }
  });
}

if (anlagenteilSelect) {
  anlagenteilSelect.addEventListener("change", function () {
    if (sonstigeAnlagenteilInput && sonstigeAnlagenteilInput.value && sonstigeAnlagenteilInput.value.trim()) {
      tryAddCustomAnlagenteil();
    }
  });
}


// üîÅ EXTRA-SICHERHEIT:
// Falls Blur/Enter/Change mal nicht feuert, wird beim Absenden noch einmal versucht,
// aus "Sonstige" + Text einen echten Wert zu machen, BEVOR validiert wird.
var form = document.querySelector("form");
if (form) {
  form.addEventListener("submit", function () {
    if (maschineSelect &&
        maschineSelect.value === "Sonstige" &&
        sonstigeMaschineInput &&
        sonstigeMaschineInput.value &&
        sonstigeMaschineInput.value.trim()) {
      tryAddCustomMaschine();
    }

    if (anlagenteilSelect &&
        anlagenteilSelect.value === "Sonstige" &&
        sonstigeAnlagenteilInput &&
        sonstigeAnlagenteilInput.value &&
        sonstigeAnlagenteilInput.value.trim()) {
      tryAddCustomAnlagenteil();
    }
  }, true); // capture = true ‚Üí l√§uft vor der eigentlichen Validierung
}

});
</script>











<script>
// UUID Generator (v4)
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Lesbare Auftrags-ID
function generateReadableID() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
    return `REP-${year}${month}${day}-${randomPart}`;
}

// Beim Laden die ID setzen
window.addEventListener('load', function() {
    const auftragsID = generateReadableID();
    document.getElementById('auftrag_id').value = auftragsID;
});

</script>







<!-- ‚úÖ MSAL Konfiguration & Login Logik -->

<!-- ‚úÖ MSAL Konfiguration & Login Logik -->
<script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
<script>
  const msalConfig = {
    auth: {
      clientId: "800b6d33-1917-4b4f-abf4-162094f8c862",
      authority: "https://login.microsoftonline.com/f54f53bb-d0ff-4b78-bcf4-4aeeeb924428",
      redirectUri: "https://thiemann423.github.io/Werkstatt-APP/"
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: true },
    system: { allowRedirectInIframe: true }
  };

  const scopes = [
    "User.Read",
    "openid",
    "profile",
    "offline_access",
    "Files.ReadWrite.All",
    "Mail.Send"
  ];

  const msalInstance = new msal.PublicClientApplication(msalConfig);
  window.msalInstance = msalInstance;   // global nutzbar
  let accessToken = "";
  window.accessToken = "";

  // aktuell eingeloggten Benutzer ermitteln
  window.getSignedInUser = function () {
    const msalObj = window.myMSALObj || window.msalInstance;
    const acc = msalObj && typeof msalObj.getAllAccounts === "function"
      ? (msalObj.getAllAccounts()[0] || null)
      : null;

    const name  = acc?.name || acc?.idTokenClaims?.name || "";
    const email = acc?.username || acc?.idTokenClaims?.preferred_username || "";
    const upn   = acc?.idTokenClaims?.upn || email;
    return { name, email, upn };
  };

  function hideLoginHint() {
    const el = document.getElementById("loginHint");
    if (el) el.style.display = "none";
  }
  function showLoginHint() {
    const el = document.getElementById("loginHint");
    if (el) el.style.display = "block";
  }

  // 1) Redirect-Antwort verarbeiten (muss direkt nach msalInstance stehen)
  (async () => {
    try {
      const resp = await msalInstance.handleRedirectPromise();
      if (resp?.accessToken) {
        accessToken = resp.accessToken;
        window.accessToken = accessToken;
      }
      if (resp?.account) {
        msalInstance.setActiveAccount(resp.account);
      }
    } catch (e) {
      console.warn("handleRedirectPromise:", e);
    }
  })();

  // 2) Resolver + Ziel-IDs (GLOBAL!) ‚Äì hier wird festgelegt,
  //    in welchem OneDrive-Ordner Reparatur + Wartung speichern
  const SHARE_URL =
    "https://petrifeinkost-my.sharepoint.com/:f:/g/personal/merten_thiemann_petri-feinkost_de/EkOa1ufucPNDtlfo6B9rxowB7o8nAY4wHK-gcRha74B2AQ?e=NtbXUx";

  const TARGET = { driveId: null, parentItemId: null };
  const DRAFTS_FOLDER_NAME = "Reparatur-Entw√ºrfe";
  let   TARGET_DRAFTS_ITEM_ID = null;

  const META_FOLDER_NAME = "Reparatur-Meta";
  let   TARGET_META_ITEM_ID = null;

  // Hilfsfunktion: Freigabelink ‚Üí shareId
  function _b64Url(u) {
    const bytes = new TextEncoder().encode(u); // nur URL encodieren
    let bin = "";
    for (const b of bytes) bin += String.fromCharCode(b);
    const b64 = btoa(bin)
      .replace(/\+/g, "-")
      .replace(/\//g, "_")
      .replace(/=+$/,"");
    return "u!" + b64;
  }

  // Freigabelink aufl√∂sen, Unterordner anlegen, Cache schreiben
  async function resolveShareLinkToFolder() {
    if (!accessToken) throw new Error("Kein Access Token");

    // --- Cache lesen ---
    const cache = JSON.parse(localStorage.getItem("TARGET_CACHE") || "null");
    if (cache?.shareUrl === SHARE_URL && cache?.driveId && cache?.parentItemId) {
      TARGET.driveId        = cache.driveId;
      TARGET.parentItemId   = cache.parentItemId;
      TARGET_DRAFTS_ITEM_ID = cache.draftsItemId || null;
      TARGET_META_ITEM_ID   = cache.metaItemId   || null;

      // Wenn alles bekannt ist ‚Üí fertig
      if (TARGET_DRAFTS_ITEM_ID && TARGET_META_ITEM_ID) return;
    } else {
      // --- Share-Link ‚Üí Drive & Ordner aufl√∂sen ---
      const encoded = _b64Url(SHARE_URL);
      const res = await fetch(
        `https://graph.microsoft.com/v1.0/shares/${encoded}/driveItem?$select=id,name,parentReference,folder,file`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      if (!res.ok) {
        throw new Error(`shares/driveItem: ${res.status} ${await res.text()}`);
      }
      const item = await res.json();
      const folderItemId = item.folder ? item.id : item.parentReference?.id;
      const driveId      = item.parentReference?.driveId;
      if (!driveId || !folderItemId) {
        throw new Error("Zielordner konnte nicht bestimmt werden.");
      }
      TARGET.driveId      = driveId;
      TARGET.parentItemId = folderItemId;
    }

    // --- Unterordner (Entw√ºrfe + Meta) ermitteln/erstellen ---
    const listUrl =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}` +
      `/children?$select=id,name,folder`;
    const listRes = await fetch(listUrl, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if (!listRes.ok) throw new Error(`children list failed: ${listRes.status}`);
    const children = (await listRes.json()).value || [];

    // Entw√ºrfe
    let drafts = children.find(x => x.name === DRAFTS_FOLDER_NAME && x.folder);
    if (!drafts) {
      const createDrafts = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}/children`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            name: DRAFTS_FOLDER_NAME,
            folder: {},
            "@microsoft.graph.conflictBehavior": "ignore"
          })
        }
      );
      if (createDrafts.ok) drafts = await createDrafts.json();
    }
    TARGET_DRAFTS_ITEM_ID = drafts?.id || null;

    // Meta
    let meta = children.find(x => x.name === META_FOLDER_NAME && x.folder);
    if (!meta) {
      const createMeta = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}/children`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            name: META_FOLDER_NAME,
            folder: {},
            "@microsoft.graph.conflictBehavior": "ignore"
          })
        }
      );
      if (createMeta.ok) meta = await createMeta.json();
    }
    localStorage.setItem("TARGET_CACHE", JSON.stringify({
      shareUrl:      SHARE_URL,
      driveId:       TARGET.driveId,
      parentItemId:  TARGET.parentItemId,
      draftsItemId:  TARGET_DRAFTS_ITEM_ID,
      metaItemId:    TARGET_META_ITEM_ID
    }));

    // ‚ûï WICHTIG: Globale Variablen f√ºr alle anderen Module setzen
    window.TARGET             = TARGET;
    window.TARGET_META_ITEM_ID = TARGET_META_ITEM_ID;
  }


// 3) Login/Token nur per Redirect
async function signInAndAcquireToken(
  interactive = false,
  { rebuild = true } = {}
) {
  try {
    let account =
      msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];

    // noch kein Account -> ggf. interaktiv einloggen
    if (!account && interactive) {
      await msalInstance.loginRedirect({ scopes });
      return; // kommt nach Redirect zur√ºck
    }
    if (!account) {
      showLoginHint();
      return;
    }

    // Token holen
    try {
      const t = await msalInstance.acquireTokenSilent({ scopes, account });
      accessToken = t.accessToken;
      window.accessToken = accessToken;
    } catch (e) {
      await msalInstance.acquireTokenRedirect({ scopes });
      return;
    }

    // OneDrive-Zielordner ermitteln
    try {
      await resolveShareLinkToFolder();
    } catch (e) {
      console.warn("resolveShareLinkToFolder:", e);
    }

    hideLoginHint();

    // Reparatur-Stammdaten (wie bisher)
    if (rebuild) {
      try {
        await loadMasterData();
        window.rebuildDropdownsFromMaster?.();
      } catch (e) {
        console.warn("Reload master after sign-in failed:", e);
      }
    }

    // ‚ûï NEU: Wartungslog aus der Cloud holen + Tabelle aktualisieren
    try {
      if (typeof wpLogLoad === "function") {
        await wpLogLoad();
      }
    } catch (e) {
      console.warn("wpLogLoad nach Sign-In:", e);
    }

    try {
      const panel = document.getElementById("wpLogPanel");
      if (
        panel &&
        panel.style.display === "block" &&
        typeof renderWpLogTable === "function"
      ) {
        renderWpLogTable();
      }
    } catch (e) {
      console.warn("renderWpLogTable nach Sign-In:", e);
    }
  } catch (e) {
    console.error("signInAndAcquireToken:", e);
    showLoginHint();
  }
}




  async function signOut() {
    try {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length > 0) {
        await msalInstance.logoutRedirect({
          account: accounts[0],
          postLogoutRedirectUri: msalConfig.auth.redirectUri
        });
      }
    } catch (e) {
      console.error("signOut:", e);
    }
  }






/* === HIER einf√ºgen: signOut() === */
async function signOut(){
  try{
    const acc = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
    // üëâ lokalen Cache zu Stammdaten wegr√§umen
    localStorage.removeItem("TE15_MASTER");
    localStorage.removeItem("TARGET_CACHE");
    accessToken = "";

    if (acc) {
      await msalInstance.logoutRedirect({ account: acc });
      return;
    }
  } catch(e){
    console.error("logout:", e);
  }
}

/* DOMContentLoaded: erst lokal laden & bauen, dann (still) anmelden und ggf. neu bauen */
document.addEventListener("DOMContentLoaded", async () => {
  const acc = msalInstance.getAllAccounts()[0];
  if (acc) msalInstance.setActiveAccount(acc);

  // 1) Sofort lokale Stammdaten (Cache) laden und Listen bauen
  await loadMasterData();
  window.rebuildDropdownsFromMaster();

  // 2) Versuch: stille Anmeldung (keine Redirects)
  try {
    await signInAndAcquireToken(false);
    // 3) Nach erfolgreichem Login: OneDrive-Stammdaten laden und Listen neu bauen
    await loadMasterData();
    window.rebuildDropdownsFromMaster();
  } catch (e) {
    console.warn("Silent sign-in skipped:", e);
  }
});

</script>






<script>
  function _byId(id){ return document.getElementById(id); }

  function _showFieldError(el, msg){
    if (!el) return;
    el.classList.add('field-error');
    if (el.nextElementSibling && el.nextElementSibling.classList?.contains('error-text')) {
      el.nextElementSibling.remove();
    }
    const m = document.createElement('div');
    m.className = 'error-text';
    m.textContent = msg;
    el.parentNode.insertBefore(m, el.nextSibling);
  }

  function _clearAllFieldErrors(){
    document.querySelectorAll('.field-error').forEach(e => e.classList.remove('field-error'));
    document.querySelectorAll('.error-text').forEach(e => e.remove());
  }

  // beim Tippen/√Ñndern Fehler am jeweiligen Feld entfernen
  function _autoClearOnChange(id, evt='input'){
    const el = _byId(id);
    if (!el) return;
    el.addEventListener(evt, () => {
      el.classList.remove('field-error');
      if (el.nextElementSibling && el.nextElementSibling.classList?.contains('error-text')) {
        el.nextElementSibling.remove();
      }
    });
  }

  // einmalig aktivieren
  document.addEventListener('DOMContentLoaded', () => {
    _autoClearOnChange('bearbeitet_am', 'change');
    _autoClearOnChange('techniker1',    'change');
    _autoClearOnChange('maschine',      'change');
    _autoClearOnChange('sonstige_maschine');
    _autoClearOnChange('anlagenteil',   'change');
    _autoClearOnChange('sonstige_anlagenteil');
    _autoClearOnChange('fehlerbeschreibung', 'input');
  });

  // Pflichtfelder pr√ºfen
function validateBeforeFinish(){
  _clearAllFieldErrors();
  let ok = true;

  // 1) Bearbeitet am
  const fDatum = _byId('bearbeitet_am');
  if (!fDatum?.value) {
    _showFieldError(fDatum, '‚ÄûBearbeitet am‚Äú ist ein Pflichtfeld.');
    ok = false;
  }

  // 2) Techniker 1
  const fTech1 = _byId('techniker1');
  if (!fTech1?.value) {
    _showFieldError(fTech1, '‚ÄûTechniker 1‚Äú ist ein Pflichtfeld.');
    ok = false;
  }

  // 3) Maschine (+ Sonstige-Text)
  const selM = _byId('maschine');
  if (!selM?.value) {
    _showFieldError(selM, '‚ÄûMaschine‚Äú ist ein Pflichtfeld.');
    ok = false;
  } else if (selM.value === 'Sonstige') {
    const txtM = _byId('sonstige_maschine');
    if (!txtM?.value.trim()) {
      _showFieldError(txtM || selM, 'Bitte ‚ÄûSonstiges (Maschine)‚Äú angeben.');
      ok = false;
    }
  }

  // 4) Anlagenteil (+ Sonstige-Text)
  const selA = _byId('anlagenteil');
  if (!selA?.value) {
    _showFieldError(selA, '‚ÄûAnlagenteil‚Äú ist ein Pflichtfeld.');
    ok = false;
  } else if (selA.value === 'Sonstige') {
    const txtA = _byId('sonstige_anlagenteil');
    if (!txtA?.value.trim()) {
      _showFieldError(txtA || selA, 'Bitte ‚ÄûSonstiges (Anlagenteil)‚Äú angeben.');
      ok = false;
    }
  }

  // 5) Fehlerbeschreibung
  const fDesc = _byId('fehlerbeschreibung');
  if (!fDesc?.value.trim()) {
    _showFieldError(fDesc, '‚ÄûFehlerbeschreibung‚Äú ist ein Pflichtfeld.');
    ok = false;
  }

  // 6) Unterschriften (nur beim Abschlie√üen)
  function _checkSignature(canvasId, labelText){
    const c = _byId(canvasId);
    if (!c) return;                         // falls Canvas nicht existiert, nichts pr√ºfen
    if (c.dataset.signed === "1") return;   // bereits unterschrieben

    _showFieldError(c, `‚Äû${labelText}‚Äú ist ein Pflichtfeld.`);
    ok = false;
  }

  _checkSignature('unterschrift_abnahme', 'Unterschrift MA Abnahme (Produktkreisfreigabe)');
  _checkSignature('unterschrift_technik', 'Unterschrift MA Technik');

  if (!ok) {
    document.querySelector('.field-error')
      ?.scrollIntoView({ behavior:'smooth', block:'center' });
    alert('Bitte f√ºllen Sie alle rot markierten Pflichtfelder aus.');
  }

  return ok;
}

</script>





<!-- üîΩ Hier unten startet dein gro√ües Script-Block -->
<script>
// --- Stammdaten (Maschinen & Anlagenteile) --- //
const MASTER_FILE = "Stammdaten-Reparatur.json";
let masterData = { version: 1, maschinen: [], anlagenteile: [] };

// Local-Cache laden
function loadMasterFromLocal() {
  try {
    const s = localStorage.getItem("TE15_MASTER");
    if (s) masterData = JSON.parse(s);
  } catch {}
}

// Local-Cache speichern
function saveMasterToLocal() {
  try {
    localStorage.setItem("TE15_MASTER", JSON.stringify(masterData));
  } catch {}
}

// Stammdaten bewusst leeren + Cache √ºberschreiben
function setEmptyMaster() {
  masterData = { version: 1, maschinen: [], anlagenteile: [] };
  saveMasterToLocal();
}

// Hilfsfunktion: Listen mergen (Strings, Duplikate raus, sortiert)
function mergeStringLists() {
  const all = [];
  for (const arr of arguments) {
    if (Array.isArray(arr)) {
      for (const v of arr) {
        const s = String(v || "").trim();
        if (s) all.push(s);
      }
    }
  }
  const set = new Set(all.map(s => s));
  return Array.from(set).sort((a, b) =>
    a.localeCompare(b, "de", { sensitivity: "base" })
  );
}

// üîΩ Laden (Cloud + lokaler Cache ‚Üí Merge)
async function loadMasterData() {
  try {
    // 1) Lokalen Cache holen (falls vorhanden)
    let localCopy = null;
    try {
      const s = localStorage.getItem("TE15_MASTER");
      if (s) localCopy = JSON.parse(s);
    } catch (e) {
      console.warn("loadMasterData() ‚Äì lokaler Cache defekt:", e);
    }

    // 2) Ohne Token: Nur lokale Daten
    if (!accessToken) {
      if (localCopy && typeof localCopy === "object") {
        masterData = localCopy;
      } else {
        setEmptyMaster();
      }
      return;
    }

    // 3) Zielordner sicherstellen
    try {
      await resolveShareLinkToFolder();
    } catch (e) {
      console.warn("loadMasterData() ‚Äì resolveShareLinkToFolder:", e);
    }
    if (!TARGET.driveId || !TARGET.parentItemId) {
      console.warn("loadMasterData() ‚Äì kein TARGET, nutze nur lokale Daten");
      if (localCopy && typeof localCopy === "object") {
        masterData = localCopy;
        saveMasterToLocal();
      } else {
        setEmptyMaster();
      }
      return;
    }

    const headers = { Authorization: `Bearer ${accessToken}` };
    const baseUrl =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
      `/items/${TARGET.parentItemId}:/${encodeURIComponent(MASTER_FILE)}`;

    // 4) Cloud-Inhalt versuchen zu laden
    let cloudData = null;
    try {
      const res = await fetch(baseUrl + ":/content", { headers });
      if (res.status === 404) {
        // Datei existiert noch nicht ‚Üí nur lokaler Cache
        console.info("loadMasterData() ‚Äì Master-Datei existiert noch nicht (404).");
      } else if (res.ok) {
        const json = await res.json();
        if (json && typeof json === "object") {
          cloudData = json;
        }
      } else {
        console.warn("loadMasterData() ‚Äì HTTP-Fehler:", res.status);
      }
    } catch (e) {
      console.warn("loadMasterData() ‚Äì Fehler beim Lesen aus Cloud:", e);
    }

    // 5) Basisstruktur
    const cloud = cloudData || {};
    cloud.version      ??= 1;
    cloud.maschinen    ??= [];
    cloud.anlagenteile ??= [];

    const local = localCopy || {};
    local.version      ??= 1;
    local.maschinen    ??= [];
    local.anlagenteile ??= [];

    // 6) Merge: Cloud + Lokal ‚Üí masterData
    masterData = {
      version: cloud.version || local.version || 1,
      maschinen: mergeStringLists(cloud.maschinen, local.maschinen),
      anlagenteile: mergeStringLists(cloud.anlagenteile, local.anlagenteile)
    };

    // 7) Zusammengef√ºhrte Version cachen
    saveMasterToLocal();
  } catch (e) {
    console.warn("loadMasterData() ‚Äì genereller Fehler, nutze lokalen Cache:", e);
    loadMasterFromLocal();
  }
}

// üîΩ Speichern (Cloud + Lokal + aktuelle masterData ‚Üí Merge ‚Üí Upload)
async function saveMasterData() {
  // 0) Immer lokale Kopie sichern
  saveMasterToLocal();

  // Ohne Token: nur lokal speichern
  if (!accessToken) {
    console.warn("saveMasterData() ‚Äì kein AccessToken, nur lokal gespeichert.");
    return;
  }

  // 1) Zielordner sichern
  try {
    await resolveShareLinkToFolder();
  } catch (e) {
    console.warn("saveMasterData() ‚Äì resolveShareLinkToFolder:", e);
  }
  if (!TARGET.driveId || !TARGET.parentItemId) {
    console.warn("saveMasterData() ‚Äì kein TARGET, speichere nur lokal.");
    return;
  }

  const headers = { Authorization: `Bearer ${accessToken}` };
  const baseUrl =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${TARGET.parentItemId}:/${encodeURIComponent(MASTER_FILE)}`;

  try {
    // 2) Nochmals lokalen Cache lesen (falls sich etwas ge√§ndert hat)
    let localCopy = null;
    try {
      const s = localStorage.getItem("TE15_MASTER");
      if (s) localCopy = JSON.parse(s);
    } catch (e) {
      console.warn("saveMasterData() ‚Äì lokaler Cache defekt:", e);
    }

    // 3) Aktuelle Cloud-Version holen (wenn Datei existiert)
    let cloudData = null;
    try {
      const res = await fetch(baseUrl + ":/content", { headers });
      if (res.status === 404) {
        console.info("saveMasterData() ‚Äì Master-Datei existiert noch nicht, wird neu angelegt.");
      } else if (res.ok) {
        const json = await res.json();
        if (json && typeof json === "object") {
          cloudData = json;
        }
      } else {
        console.warn("saveMasterData() ‚Äì Cloud-GET Fehler:", res.status);
      }
    } catch (e) {
      console.warn("saveMasterData() ‚Äì Fehler beim Lesen aus Cloud:", e);
    }

    const cloud = cloudData || {};
    cloud.version      ??= 1;
    cloud.maschinen    ??= [];
    cloud.anlagenteile ??= [];

    const local = localCopy || {};
    local.version      ??= 1;
    local.maschinen    ??= [];
    local.anlagenteile ??= [];

    const current = masterData || {};
    current.version      ??= 1;
    current.maschinen    ??= [];
    current.anlagenteile ??= [];

    // 4) Merge: Cloud + Local + Current ‚Üí merged
    const merged = {
      version: cloud.version || local.version || current.version || 1,
      maschinen: mergeStringLists(
        cloud.maschinen,
        local.maschinen,
        current.maschinen
      ),
      anlagenteile: mergeStringLists(
        cloud.anlagenteile,
        local.anlagenteile,
        current.anlagenteile
      )
    };

    // 5) merged ‚Üí masterData + lokal schreiben
    masterData = merged;
    saveMasterToLocal();

    // 6) In Cloud hochladen (per Name, neu oder √ºberschreiben)
    const blob = new Blob([JSON.stringify(masterData, null, 2)], {
      type: "application/json"
    });

    const resp = await fetch(baseUrl + ":/content", {
      method: "PUT",
      headers,
      body: blob
    });
    if (!resp.ok) {
      console.warn("saveMasterData() ‚Äì Upload fehlgeschlagen:", resp.status, await resp.text());
    }
  } catch (e) {
    console.warn("saveMasterData() ‚Äì Fehler beim Speichern (Cloud):", e);
  }
}



/* === Neu: Sortier-Helfer (deutsche Sortierung, numerisch) === */
function sortSelectOptions(selectEl, stickyTopValues = ["", "Sonstige"]) {
  if (!selectEl) return;
  const collator = new Intl.Collator("de", { numeric: true, sensitivity: "base" });

  const opts    = Array.from(selectEl.options);
  const current = selectEl.value;

  // Platzhalter / Sonstige oben lassen
  const sticky = opts.filter(o => stickyTopValues.includes(o.value));
  const rest   = opts.filter(o => !stickyTopValues.includes(o.value));

  rest.sort((a, b) => collator.compare(
    (a.textContent || a.innerText || a.value).trim(),
    (b.textContent || b.innerText || b.value).trim()
  ));

  // Neu aufbauen
  selectEl.options.length = 0;
  sticky.forEach(o => selectEl.add(new Option(o.text, o.value)));
  rest.forEach(o   => selectEl.add(new Option(o.text, o.value)));

  // Auswahl erhalten
  selectEl.value = current;
}

// === Neu: Einf√ºgen + immer sortieren, optional autoselect ===
function addOptionUnique(selectEl, label, { autoselect = false } = {}) {
  const value = (label || "").trim();
  if (!selectEl || !value) return;

  const exists = [...selectEl.options].some(o =>
    ((o.textContent || o.innerText || o.value).trim().toLowerCase() === value.toLowerCase())
  );

  if (!exists) {
    selectEl.add(new Option(value, value)); // Position egal ‚Äì danach sortieren
  }

  // "" = ‚ÄûBitte ausw√§hlen‚Äú, "Sonstige" bleibt oben
  sortSelectOptions(selectEl, ["", "Sonstige"]);

  if (autoselect) selectEl.value = value; // nur auf Wunsch ausw√§hlen
}


/* ‚¨áÔ∏è NEU: Dropdowns aus Stammdaten vollst√§ndig neu aufbauen */
window.rebuildDropdownsFromMaster = function () {
  const selMs = Array.from(document.querySelectorAll('select#maschine'));
  const selAs = Array.from(document.querySelectorAll('select#anlagenteil'));
  if (!selMs.length && !selAs.length) return;

  const keep = (sel) => sel ? {
    value: sel.value,
    text:  sel.options[sel.selectedIndex]?.textContent?.trim() || ""
  } : null;

  const restore = (sel, kept) => {
    if (!sel || !kept) return;
    if ([...sel.options].some(o => o.value === kept.value)) { sel.value = kept.value; return; }
    const byText = [...sel.options].find(o => (o.textContent || o.innerText).trim() === kept.text);
    if (byText) sel.value = byText.value;
  };

  // Maschine: alle Selects aktualisieren
  selMs.forEach(selM => {
    const kept = keep(selM);

    // Basisoptionen nur aus dem HTML-Build behalten
    const baseMaschine = Array.from(selM.options).map(o => o.value);
    Array.from(selM.options).forEach(o => { if (!baseMaschine.includes(o.value)) o.remove(); });

    (masterData.maschinen || []).forEach(n => addOptionUnique(selM, n));
    sortSelectOptions(selM, ["", "Sonstige"]);
    restore(selM, kept);

    // ‚ÄûSonstige‚Äú-Felder korrekt ein-/ausblenden
    selM.dispatchEvent(new Event('change'));
  });

  // Anlagenteil: alle Selects aktualisieren
  selAs.forEach(selA => {
    const kept = keep(selA);

    const baseTeile = Array.from(selA.options).map(o => o.value);
    Array.from(selA.options).forEach(o => { if (!baseTeile.includes(o.value)) o.remove(); });

    (masterData.anlagenteile || []).forEach(n => addOptionUnique(selA, n));
    sortSelectOptions(selA, ["", "Sonstige"]);
    restore(selA, kept);

    selA.dispatchEvent(new Event('change'));
  });
};
/* ‚¨ÜÔ∏è ENDE neu */



  // ====================
  // Draft-Funktionen
  // ====================

const fieldIds = [
  "auftrag_id",
  "bearbeitet_am",
  "techniker1",
  "techniker2",
  "maschinenstillstand",
  "ausfall_stunden",
  "ausfall_minuten",
  "maschine",
  "sonstige_maschine",
  "anlagenteil",
  "sonstige_anlagenteil",
  "startzeit",
  "endzeit",
  "dauer",
  "abschlussdatum",
  "fehlerbeschreibung",
  "reinigung_erforderlich",
  "reinigungsart_zusatz",
  "sonstige_reinigungsart_zusatz",
  "reinigungsart_sonstiges",

  // üîº NEU: Provisorium-Felder kommen mit in den Entwurf
  "provisorium_aktiv",
  "provisorium_art",
  "provisorium_von",
  "provisorium_bis",
  "provisorium_bezug_auftrag_id",   // ‚¨ÖÔ∏è NEU
  "ort_datum"
];
function addOptionSorted(select, value, autoSelect = true) {
  value = value.trim();
  if (!value) return;

  const exists = Array.from(select.options)
    .some(o => o.value.toLowerCase() === value.toLowerCase());

  if (exists) {
    if (autoSelect) select.value = value;
    return;
  }

  const opt = new Option(value, value);

  const opts = Array.from(select.options);
  const insertBefore = opts.find(o =>
    o.value.localeCompare(value, "de", { sensitivity: "base" }) > 0
  );

  if (insertBefore) {
    select.insertBefore(opt, insertBefore);
  } else {
    select.appendChild(opt);
  }

  if (autoSelect) select.value = value;
}


  // ====================
  // OneDrive-Upload (robuster, mit Fehlertext)
  // ====================
  async function uploadToOneDrive(filename, blob, mime = "application/pdf", parentIdOverride = null) {
    if (!accessToken) { alert("‚ö†Ô∏è Kein Zugriffstoken. Bitte anmelden."); return false; }
    if (!TARGET.driveId || !TARGET.parentItemId) { alert("‚ö†Ô∏è Zielordner nicht initialisiert."); return false; }

    const parentId = parentIdOverride || TARGET.parentItemId;  // <‚Äî NEU
    const url =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
      `/items/${parentId}:/${encodeURIComponent(filename)}:/content`;

    try {
      const res = await fetch(url, {
        method: "PUT",
        headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": mime },
        body: blob
      });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        console.error("Upload-Fehler:", res.status, text);
      }
      return res.ok;
    } catch (err) {
      console.error("Fehler beim Upload:", err);
      return false;
    }
  }

  // ====================
  // Formular ‚Üí statischer Inhalt (f√ºr PDF)
  // ====================
function convertFormElementsToStaticText(container){
  const d = container.ownerDocument;

  // 1) Action-Buttons & Dateiuploads ausblenden
  container.querySelectorAll('button, input[type="file"], .delete-button')
           .forEach(el => el.style.display = 'none');

  // 2) Vorschau-Bilder ohne Beschr√§nkung (f√ºr das PDF)
  container.querySelectorAll('.preview-container img').forEach(img => {
    img.style.maxWidth = '100%';
    img.style.maxHeight = 'none';
    img.style.border = '0';
    img.loading = 'eager';
  });

// 3) SELECT/INPUT ‚Üí Daten-Attribut ‚Äûdata-selected-text‚Äú respektieren
container.querySelectorAll('select').forEach(sel => {
  const label = container.querySelector(`label[for="${sel.id}"]`);
  const row   = d.createElement('div'); 
  row.className = 'print-field';
  row.classList.add('avoid-break');                 // ‚Üê hinzugef√ºgt
  const l     = d.createElement('div'); l.className = 'print-label';
  const v     = d.createElement('div'); v.className = 'print-value';
  l.textContent = label?.textContent?.trim() || sel.name || '';
  v.textContent = sel.getAttribute('data-selected-text') || sel.value || '';
  if (label) label.remove();                        // Original-Label entfernen
  sel.replaceWith(row); row.append(l, v);
});


// 4) TEXTAREA ‚Üí IMMER in statischen Text umwandeln (sonst wird abgeschnitten)
container.querySelectorAll('textarea').forEach(ta => {
  const label = container.querySelector(`label[for="${ta.id}"]`);
  const row   = d.createElement('div'); 
  row.className = 'print-field';
  row.classList.add('avoid-break');
  const l     = d.createElement('div'); l.className = 'print-label';
  const v     = d.createElement('div'); v.className = 'print-value';
  l.textContent = label?.textContent?.trim() || ta.name || '';

  // Zeilenumbr√ºche konsistent machen, √ºberfl√ºssige Leerzeichen entfernen
  let txt = (ta.value || '').replace(/\r\n/g, '\n');
  txt = txt.replace(/[ \t]+/g, ' ').trim();
  v.textContent = txt;

  if (label) label.remove();
  ta.replaceWith(row); row.append(l, v);
});


// 5) Normale Inputs (date, time, text, number ‚Ä¶) in statischen Text wandeln
container.querySelectorAll('input').forEach(inp => {
  if (/^(button|submit|file|checkbox|radio)$/i.test(inp.type)) return; // ignorieren
  const label = container.querySelector(`label[for="${inp.id}"]`);
  const row   = d.createElement('div'); 
  row.className = 'print-field';
  row.classList.add('avoid-break');                 // ‚Üê hinzugef√ºgt
  const l     = d.createElement('div'); l.className = 'print-label';
  const v     = d.createElement('div'); v.className = 'print-value';
  l.textContent = label?.textContent?.trim() || inp.name || '';
  v.textContent = (inp.value || '').trim();
  if (label) label.remove();
  inp.replaceWith(row); row.append(l, v);
});


  // 6) Doppelte Zeilen (falls entstanden) bereinigen
  const rows = Array.from(container.querySelectorAll('.print-field'));
  for (let i = 1; i < rows.length; i++) {
    const prev = rows[i - 1];
    const curr = rows[i];
    if (prev && curr && prev.textContent.trim() === curr.textContent.trim()) {
      curr.remove();
    }
  }
}













// ====================
// Auftrag abschlie√üen ‚Üí PDF erzeugen & hochladen
// ====================


async function generatePDFAndFinish() {
  // 0) Lib + Login
  await loadHtml2PdfIfNeeded();
  if (!window.html2pdf) { alert("html2pdf konnte nicht geladen werden."); return; }

  await signInAndAcquireToken(true);
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }

  const src = document.getElementById("pdfExportContainer");
  if (!src) { alert("Container nicht gefunden."); return; }

  // ‚úÖ Pflichtfelder NUR beim Abschluss pr√ºfen
  if (!validateBeforeFinish()) return;

  // ‚úÖ Wartung (optional): aktuelle Wartungsaufgabe als "heute durchgef√ºhrt" markieren
  try { await window.wpMarkCurrentTaskDone?.(); }
  catch (e) { console.warn('wpMarkCurrentTaskDone:', e); }

  // A) Canvas aus dem ORIGINAL sichern (id -> DataURL)
  const signatureMap = new Map(
    Array.from(src.querySelectorAll('canvas')).map(c => {
      try { return [c.id, c.toDataURL('image/png')]; }
      catch (e) { console.warn('toDataURL fehlgeschlagen', e); return [c.id, null]; }
    })
  );

  // B) Offscreen-Iframe
  const frame = document.getElementById('pdfSandbox');
  if (!frame) { alert("PDF-Frame fehlt."); return; }
  const doc = frame.contentDocument || frame.contentWindow?.document;
  if (!doc) { alert("PDF-Dokumentkontext nicht verf√ºgbar."); return; }

doc.write(`<!doctype html>
<html lang="de"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=794, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
  html,body{margin:0;padding:0;background:#fff;}
  #root{width:794px; box-sizing:border-box; padding:0;}
  html,body,#root{-webkit-text-size-adjust:none;text-size-adjust:none;}
  #root, #root *{ font-family:"Inter", Arial, sans-serif !important; line-height:1.35; box-sizing:border-box; }
  #pdfExportContainerClone{ width:794px; padding:20px; margin:0 auto; background:#fff; }

  /* ‚úÖ Flex statt Grid, verhindert √úberlappungen bei langen Texten */
  .print-field{
    display:flex !important;
    flex-wrap:nowrap !important;
    align-items:flex-start !important;
    gap:12px !important;
    padding:6px 0 !important;
    border-bottom:1px solid #e9e9e9 !important;
  }
  .print-label{
    font-weight:700;
    white-space:normal !important;
    overflow-wrap:anywhere !important;
    word-break:break-word !important;
    min-width:0 !important;
    flex:0 0 38% !important;
    max-width:38% !important;
    padding-right:12px !important;
  }
  .print-value{
    white-space:pre-wrap !important;
    overflow-wrap:anywhere !important;
    word-break:break-word !important;
    hyphens:auto !important;
    line-height:1.4 !important;
    margin-bottom:6px !important;
    min-width:0 !important;
    flex:1 1 62% !important;
    max-width:62% !important;
  }

  .print-field > * { min-width:0; }
  .avoid-break{ break-inside:avoid; page-break-inside:avoid; }
  img{ max-width:100% !important; height:auto !important; border:0 !important; display:block; }
  canvas{ display:block !important; }
  h1{ font-size:24px; margin:0 0 8px; text-align:center; }
  @page { size: A4; margin: 0; }
</style>
</head><body><div id="root"></div></body></html>`);
doc.close();


  // C) html2pdf INS IFRAME laden (falls n√∂tig)
  if (!frame.contentWindow.html2pdf) {
    await new Promise((resolve, reject) => {
      const s = doc.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      s.onload = resolve;
      s.onerror = () => reject(new Error('html2pdf im Iframe konnte nicht geladen werden.'));
      doc.head.appendChild(s);
    });
  }

  // üîé Helper: sichtbaren Text f√ºr Select ermitteln (inkl. ‚ÄûSonstige‚Äú-Felder)
  const selectedText = (selId) => {
    const sel = document.getElementById(selId);
    if (!sel) return "";
    let text = (sel.options?.[sel.selectedIndex]?.text || sel.value || "").trim();
    if (selId === "reinigung_erforderlich") {
      const v = (sel.value || "").toLowerCase();
      if (v === "ja") return "Ja";
      if (v === "nein") return "Nein";
    }
    if (selId === "maschine" && sel.value === "Sonstige") {
      const t = document.getElementById("sonstige_maschine")?.value?.trim();
      if (t) text = t;
    }
    if (selId === "anlagenteil" && sel.value === "Sonstige") {
      const t = document.getElementById("sonstige_anlagenteil")?.value?.trim();
      if (t) text = t;
    }
    return text;
  };

  // D) Inhalt klonen
  const clone = src.cloneNode(true);
  clone.id = 'pdfExportContainerClone';
  clone.classList.add('pdf-snapshot');
  clone.style.width = '794px';
  clone.style.maxWidth = '794px';
  clone.style.margin = '0';
  clone.style.padding = '20px';
  clone.style.background = '#ffffff';

  // --- üÜï Wartungsblock nur ins PDF, wenn ausgef√ºllt ---
  function wartungHasUserInput() {
    const selTask  = document.getElementById('wpTaskSelect')?.value?.trim();
    const interval = document.getElementById('wpIntervalDays')?.value?.trim();
    const lastDate = document.getElementById('wpLastDate')?.value?.trim();
    const nextDue  = document.getElementById('wpNextDue')?.value?.trim();
    return !!(selTask || interval || lastDate || nextDue);
  }

  const wartungSectionInClone = clone.querySelector('#wartungsplanSection');
  if (!wartungHasUserInput()) {
    // kompletten Bereich im PDF ausblenden
    wartungSectionInClone?.remove();
  } else {
    // Buttons/Hinweise im PDF entfernen (nur Darstellung)
    clone.querySelector('#wpHint')?.remove();
    clone.querySelectorAll('#wartungsplanPanel button').forEach(b => b.remove());
    clone.querySelector('#wpWarning')?.remove();

    // --- üÜï Werte der Wartungsfelder explizit vom Original √ºbernehmen ---
    (function copyWartungValuesIntoClone(){
      const copyInput = (id) => {
        const o = document.getElementById(id);
        const c = clone.querySelector('#' + id);
        if (o && c) c.value = o.value;
      };
      const copySelect = (id) => {
        const o = document.getElementById(id);
        const c = clone.querySelector('#' + id);
        if (!o || !c) return;
        c.value = o.value;
        Array.from(c.options).forEach(opt => opt.selected = (opt.value === o.value));
        const text = o.options?.[o.selectedIndex]?.text?.trim() || o.value || '';
        c.setAttribute('data-selected-text', text);
      };

      copySelect('wpTaskSelect');
      copyInput('wpIntervalDays');
      copyInput('wpLastDate');
      copyInput('wpNextDue');

      // Status-Pill Text sichern (rein kosmetisch)
      const pillOrig  = document.getElementById('wpStatusPill');
      const pillClone = clone.querySelector('#wpStatusPill');
      if (pillOrig && pillClone) pillClone.textContent = pillOrig.textContent;
    })();
  }
  // --- üÜï Ende Wartungsblock-Logik ---

  // Select-Werte + sichtbare Texte √ºbernehmen (f√ºr die PDF-Umwandlung)
  clone.querySelectorAll('select').forEach(sel => {
    const orig = document.getElementById(sel.id);
    if (!orig) return;
    sel.value = orig.value;
    Array.from(sel.options).forEach(o => o.selected = (o.value === orig.value));
    sel.setAttribute('data-selected-text', selectedText(sel.id));
  });

  // Canvas -> IMG
  clone.querySelectorAll('canvas').forEach(c => {
    const url = signatureMap.get(c.id);
    if (!url) return;
    const img = doc.createElement('img');
    img.src = url;
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.className = 'avoid-break';
    c.parentNode.replaceChild(img, c);
  });

  // In iFrame einf√ºgen & in statischen Inhalt wandeln
  doc.getElementById('root').appendChild(clone);
  convertFormElementsToStaticText(clone);
  clone.querySelectorAll('.preview-container img').forEach(img => {
    img.style.maxWidth = '100%';
    img.style.maxHeight = '';
    img.style.border = '0';
    img.style.display = 'block';
  });

  try {
    // E) Laden abwarten
    if (doc.fonts && doc.fonts.ready) { await doc.fonts.ready; }
    const imgs = doc.images;
    await Promise.all([...imgs].map(img => img.complete ? Promise.resolve()
      : new Promise(res => { img.onload = img.onerror = res; })));

    // F) Dateiname
    const auftragIdField = document.getElementById("auftrag_id");
    let auftragId = auftragIdField?.value?.trim();
    if (!auftragId) {
      const datePart = new Date().toISOString().split("T")[0].replace(/-/g, "");
      auftragId = `REP-${datePart}-${crypto.randomUUID().slice(0,4).toUpperCase()}`;
      if (auftragIdField) auftragIdField.value = auftragId;
    }
    const filename = `${auftragId}.pdf`;

    // G) html2pdf-Optionen
    const height = doc.getElementById('root').scrollHeight;
    const opt = {
      margin: 0,
      filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        scrollX: 0, scrollY: 0,
        windowWidth: 794,
        windowHeight: height,
        logging: false,
        foreignObjectRendering: false
      },
      jsPDF: { unit: 'px', format: [794, 1123], orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    // H) Rendern
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    const h2p = frame.contentWindow.html2pdf;
    const worker  = h2p().set(opt).from(doc.getElementById('root')).toPdf();
    const pdfBlob = await worker.get('pdf').then(pdf => pdf.output('blob'));

    // I) Upload & UI
    const success = await uploadToOneDrive(filename, pdfBlob);
    if (success) {
      // ---- META-Datei f√ºr das Dashboard mitschreiben ----
  const meta = {
    auftrags_id:        auftragId,
    pdfName:            filename,
    bearbeitet_am:      document.getElementById("bearbeitet_am")?.value || "",
    techniker1:         selectedText("techniker1"),
    techniker2:         (selectedText("techniker2") || "").replace(/^‚Äì$/, ""),
    maschine_value:     document.getElementById("maschine")?.value || "",
    maschine_text:      selectedText("maschine"),
    anlagenteil_value:  document.getElementById("anlagenteil")?.value || "",
    anlagenteil_text:   selectedText("anlagenteil"),

    // üîº NEU: Provisorium wandert mit in die Meta-Datei
    provisorium_aktiv:  document.getElementById("provisorium_aktiv")?.value || "",
    provisorium_art:    document.getElementById("provisorium_art")?.value || "",
    provisorium_von:    document.getElementById("provisorium_von")?.value || "",
    provisorium_bis:    document.getElementById("provisorium_bis")?.value || "",
      provisorium_bezug_auftrag_id:
    document.getElementById("provisorium_bezug_auftrag_id")?.value || "",
  };


      // ‚¨áÔ∏è sicherstellen, dass der Meta-Ordner existiert/aufgel√∂st ist
      if (!TARGET_META_ITEM_ID) {
        try { await resolveShareLinkToFolder(); }
        catch(e){ console.warn("resolveShareLinkToFolder (Meta) fehlgeschlagen:", e); }
      }

      const metaBlob = new Blob([JSON.stringify(meta, null, 2)], { type: "application/json" });

      // bevorzugt in den Meta-Ordner, sonst Fallback Hauptordner
      const metaOk = await uploadToOneDrive(
        `${auftragId}.meta.json`,
        metaBlob,
        "application/json",
        TARGET_META_ITEM_ID || TARGET.parentItemId
      );
      if (!metaOk) console.warn("Meta-Upload fehlgeschlagen");

      alert("‚úÖ PDF erfolgreich in OneDrive gespeichert!");
      await deleteDraftFile?.();
      document.getElementById("abschlussScreen").style.display = "flex";

      try { if (document.getElementById("dashPanel")) await loadDashboard(); } catch {}
    } else {
      alert("‚ö†Ô∏è Fehler beim Hochladen in OneDrive.");
    }
  } catch (err) {
    console.error("‚ùå Fehler bei PDF-Erstellung/Upload:", err);
    alert("‚ùå PDF konnte nicht erstellt oder hochgeladen werden.");
  } finally {
    try { doc.body.innerHTML = '<div id="root"></div>'; } catch {}
  }
}




// ====================
// Sonstiges
// ====================
function forceUpdate() {
  (async () => {
    try {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      if (window.caches?.keys) {
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n)));
      }
      alert("‚úÖ Cache & Service Worker gel√∂scht. Seite wird neu geladen.");
      const url = new URL(location.href);
      url.searchParams.set('_', Date.now());
      location.replace(url.toString());
    } catch (e) {
      console.warn("forceUpdate() Fehler:", e);
      location.reload();
    }
  })();
}


// üíæ ENTWURF SPEICHERN
async function saveDraftToOneDrive() {
  await signInAndAcquireToken(true);
  await resolveShareLinkToFolder();
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const draftData = {};
  fieldIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) draftData[id] = el.value;
  });

  const draftJson = JSON.stringify(draftData, null, 2);
  const blob = new Blob([draftJson], { type: "application/json" });

  const auftragId = document.getElementById('auftrag_id')?.value || "ohne-id";
  const draftFilename = `Entwurf-${auftragId}.json`;

  // Falls der Unterordner existiert, dorthin; sonst in den Hauptordner
  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;

  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${parentId}:/${encodeURIComponent(draftFilename)}:/content`;

  const res = await fetch(url, {
    method: "PUT",
    headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": "application/json" },
    body: blob
  });

  if (res.ok) { alert("‚úÖ Entwurf erfolgreich gespeichert!"); }
  else { alert("‚ö†Ô∏è Fehler beim Speichern des Entwurfs."); }
}


// üì• ENTWURF LADEN
async function loadDraftFromOneDrive(fileName, fileId = null) {
  // üîÅ Merker f√ºr sp√§teres L√∂schen / Wiederverwenden
  if (fileName) {
    window.currentDraftFileName = fileName;
  }
  // fileId nur √ºberschreiben, wenn sie mitgegeben wurde
  if (fileId !== null) {
    window.currentDraftFileId = fileId;
  }

  if (!accessToken) {
    alert("Bitte zuerst anmelden.");
    return;
  }
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) {
    alert("Zielordner nicht initialisiert.");
    return;
  }

  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;
  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${parentId}:/${encodeURIComponent(fileName)}:/content`;

  // Helper: fehlende Option in einem <select> hinzuf√ºgen und ausw√§hlen
  function ensureSelectValue(selId, value, autoselect = true) {
    const sel = document.getElementById(selId);
    if (!sel || value == null || value === "") return;
    const exists = [...sel.options].some(o =>
      (o.value || o.textContent).trim().toLowerCase() === String(value).trim().toLowerCase()
    );
    if (!exists) {
      if (typeof addOptionUnique === "function") {
        addOptionUnique(sel, String(value), { autoselect });
      } else {
        sel.add(new Option(String(value), String(value)));
        if (autoselect) sel.value = String(value);
      }
    } else if (autoselect) {
      sel.value = String(value);
    }
  }

  try {
    const res = await fetch(url, {
      method: "GET",
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if (!res.ok) {
      alert("‚ö†Ô∏è Fehler beim Laden des Entwurfs.");
      return;
    }

    const draftData = await res.json();

    // 1) Standard-Felder direkt setzen
    fieldIds.forEach(id => {
      const el = document.getElementById(id);
      if (el && draftData[id] !== undefined) el.value = draftData[id];
    });

    // 2) Techniker-Dropdowns sicherstellen (Option ggf. nachtragen)
    if (draftData.techniker1) ensureSelectValue("techniker1", draftData.techniker1);
    if (draftData.techniker2) ensureSelectValue("techniker2", draftData.techniker2);

    // 3) Maschine / Anlagenteil + ‚ÄûSonstige‚Äú-Felder korrekt setzen
    // Maschine
    if (draftData.sonstige_maschine && draftData.sonstige_maschine.trim()) {
      const sel = document.getElementById("maschine");
      const txt = document.getElementById("sonstige_maschine");
      if (sel) sel.value = "Sonstige";
      if (txt) txt.value = draftData.sonstige_maschine.trim();
    } else if (draftData.maschine) {
      ensureSelectValue("maschine", draftData.maschine, true);
    }

    // Anlagenteil
    if (draftData.sonstige_anlagenteil && draftData.sonstige_anlagenteil.trim()) {
      const sel = document.getElementById("anlagenteil");
      const txt = document.getElementById("sonstige_anlagenteil");
      if (sel) sel.value = "Sonstige";
      if (txt) txt.value = draftData.sonstige_anlagenteil.trim();
    } else if (draftData.anlagenteil) {
      ensureSelectValue("anlagenteil", draftData.anlagenteil, true);
    }

    // 4) UI-Abh√§ngigkeiten aktualisieren (Sonstige-Felder, Provisorium usw.)
    document.getElementById("maschine")?.dispatchEvent(new Event("change"));
    document.getElementById("anlagenteil")?.dispatchEvent(new Event("change"));
    document.getElementById("techniker1")?.dispatchEvent(new Event("change"));
    document.getElementById("techniker2")?.dispatchEvent(new Event("change"));
    // Provisorium-Panel je nach Auswahl ein-/ausblenden
    document.getElementById("provisorium_aktiv")?.dispatchEvent(new Event("change"));

    alert("‚úÖ Entwurf erfolgreich geladen!");
  } catch (err) {
    console.error("Fehler beim Laden:", err);
    alert("‚ùå Fehler beim Laden des Entwurfs.");
  }
}




// üìÇ ENTWURFSLISTE ANZEIGEN
async function showDraftList() {
  if (!accessToken) { alert("Bitte zuerst anmelden."); return; }
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { alert("Zielordner nicht initialisiert."); return; }

  const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;

  try {
    const res = await fetch(
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${parentId}/children?$select=id,name,file,folder`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    const data = await res.json();
    const files = (data.value || []).filter(item => item.name.endsWith(".json"));
    if (!files.length) { alert("‚ö†Ô∏è Keine Entw√ºrfe gefunden."); return; }

    let list = "Verf√ºgbare Entw√ºrfe:\n\n";
    files.forEach((f, i) => { list += `${i + 1}: ${f.name}\n`; });

    const numberInput = prompt("Bitte die Nummer des Entwurfs eingeben:\n\n" + list);
    const idx = parseInt(numberInput, 10) - 1;

    if (!isNaN(idx) && files[idx]) {
      // F√ºr sp√§teres L√∂schen merken wir uns Name + ID
      window.currentDraftFileName = files[idx].name;
      window.currentDraftFileId   = files[idx].id;

      await loadDraftFromOneDrive(files[idx].name);
    } else {
      alert("‚ö†Ô∏è Ung√ºltige Nummer.");
    }
  } catch (err) {
    console.error("Fehler beim Abrufen der Liste:", err);
    alert("‚ùå Fehler beim Abrufen der Entw√ºrfe.");
  }
}



// üóëÔ∏è ENTWURF L√ñSCHEN
async function deleteDraftFile() {
  if (!accessToken) return;
  await resolveShareLinkToFolder();
  if (!TARGET.driveId || !TARGET.parentItemId) { console.warn("Zielordner nicht initialisiert."); return; }

  // Bevorzugt mit der gespeicherten Item-ID l√∂schen
  if (window.currentDraftFileId) {
    try {
      await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${window.currentDraftFileId}`,
        { method: "DELETE", headers: { Authorization: `Bearer ${accessToken}` } }
      );
      console.log("‚úÖ Entwurfsdatei gel√∂scht:", window.currentDraftFileName);
      window.currentDraftFileName = null;
      window.currentDraftFileId = null;
    } catch (err) {
      console.error("‚ùå Fehler beim L√∂schen der Entwurfsdatei:", err);
    }
    return;
  }

  // Fallback: Wenn nur der Name bekannt ist
  if (window.currentDraftFileName) {
    try {
      const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;
      const res = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${parentId}/children?$select=id,name`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      const data = await res.json();
      const match = (data.value || []).find(x => x.name === window.currentDraftFileName);
      if (!match) { console.warn("Datei nicht gefunden:", window.currentDraftFileName); return; }

      await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${match.id}`,
        { method: "DELETE", headers: { Authorization: `Bearer ${accessToken}` } }
      );
      console.log("‚úÖ Entwurfsdatei gel√∂scht:", window.currentDraftFileName);
      window.currentDraftFileName = null;
      window.currentDraftFileId = null;
    } catch (err) {
      console.error("‚ùå Fehler beim L√∂schen der Entwurfsdatei:", err);
    }
  }
}

window.confirmUpdate = function () {
  const modal = document.getElementById('updateModal');
  if (modal) modal.style.display = 'none';

  const msg = document.getElementById('confirmationMessage');
  if (msg) {
    msg.style.display = 'block';
    setTimeout(() => { msg.style.display = 'none'; }, 2500);
  }
};

// ===== Dashboard (mit 30-Tage-Schalter) =====
const META_SUFFIX = '.meta.json';

// false = nur letzte 30 Tage, true = alle
window.showAllOrders = false;
  // Zeitraum im Dashboard: '7', '30' oder 'all'
window.dashRangeMode = '7';


document.addEventListener('DOMContentLoaded', () => {
  // ==============================
  // üìä Normales Reparatur-Dashboard
  // ==============================
  const panel    = document.getElementById('dashPanel');
  const toggle   = document.getElementById('toggleDashBtn');
  const reload   = document.getElementById('dashReload');
  const clearBtn = document.getElementById('dashClear');
  const rangeBtn = document.getElementById('dashRangeBtn');

  // aktueller Zeitraum aus dem Button lesen (Fallback: 7 Tage)
  if (rangeBtn) {
    window.dashRangeMode = rangeBtn.dataset.mode || '7';
  }

  toggle?.addEventListener('click', () => {
    const show = panel.style.display === 'none' || !panel.style.display;
    panel.style.display = show ? 'block' : 'none';
    if (show) loadDashboard();
  });

  reload?.addEventListener('click', loadDashboard);

  clearBtn?.addEventListener('click', () => {
    ['f_bearbeitet_am','f_techniker','f_maschine','f_anlagenteil','f_provisorium','f_auftrag_id'].forEach(id => {
      const el = document.getElementById(id); if (el) el.value = '';
    });
    window.dashRangeMode = '7';
    if (rangeBtn){
      rangeBtn.dataset.mode = '7';
      rangeBtn.textContent  = 'üóìÔ∏è Letzte 7 Tage';
    }
    applyFiltersToDashboard();
  });

  // Zeitraum: 7 Tage -> 30 Tage -> Alle -> 7 Tage ...
  rangeBtn?.addEventListener('click', () => {
    const current = rangeBtn.dataset.mode || window.dashRangeMode || '7';
    let next  = '7';
    let label = 'üóìÔ∏è Letzte 7 Tage';

    if (current === '7') {
      next  = '30';
      label = 'üóìÔ∏è Letzte 30 Tage';
    } else if (current === '30') {
      next  = 'all';
      label = 'üóìÔ∏è Alle Auftr√§ge';
      const d = document.getElementById('f_bearbeitet_am'); if (d) d.value = '';
    } else {
      next  = '7';
      label = 'üóìÔ∏è Letzte 7 Tage';
    }

    window.dashRangeMode = next;
    rangeBtn.dataset.mode = next;
    rangeBtn.textContent  = label;
    applyFiltersToDashboard();
  });

  // Filter-Inputs
  ['f_bearbeitet_am','f_techniker','f_maschine','f_anlagenteil','f_auftrag_id'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', applyFiltersToDashboard);
  });

  // Select reagiert auf change
  document.getElementById('f_provisorium')?.addEventListener('change', applyFiltersToDashboard);



  // ==============================
  // üìù Entw√ºrfe-Dashboard
  // ==============================
  const draftPanel    = document.getElementById('draftDashPanel');
  const draftToggle   = document.getElementById('toggleDraftDashBtn');
  const draftReload   = document.getElementById('draftDashReload');
  const draftClearBtn = document.getElementById('draftDashClear');
  const draftRangeBtn = document.getElementById('draftDashRangeBtn');

  // Panel auf/zu
  draftToggle?.addEventListener('click', () => {
    const show = draftPanel.style.display === 'none' || !draftPanel.style.display;
    draftPanel.style.display = show ? 'block' : 'none';
    if (show) loadDraftDashboard();       // <- liest Entw√ºrfe aus OneDrive
  });

  // Reload
  draftReload?.addEventListener('click', loadDraftDashboard);

  // Filter l√∂schen
  draftClearBtn?.addEventListener('click', () => {
    ['df_bearbeitet_am','df_techniker','df_maschine','df_anlagenteil','df_provisorium'].forEach(id => {
      const el = document.getElementById(id); if (el) el.value = '';
    });
    window.showAllDrafts = false;
    if (draftRangeBtn){ draftRangeBtn.dataset.mode = '30'; draftRangeBtn.textContent = 'üóìÔ∏è Letzte 30 Tage'; }
    applyFiltersToDraftDashboard();
  });

  // Letzte 30 Tage / alle Entw√ºrfe
  draftRangeBtn?.addEventListener('click', () => {
    const mode = draftRangeBtn.dataset.mode || '30';
    if (mode === '30') {
      window.showAllDrafts = true;
      draftRangeBtn.dataset.mode = 'all';
      draftRangeBtn.textContent  = 'üóìÔ∏è Alle Entw√ºrfe';
      const d = document.getElementById('df_bearbeitet_am'); if (d) d.value = '';
    } else {
      window.showAllDrafts = false;
      draftRangeBtn.dataset.mode = '30';
      draftRangeBtn.textContent  = 'üóìÔ∏è Letzte 30 Tage';
    }
    applyFiltersToDraftDashboard();
  });

  // Filter-Inputs der Entw√ºrfe
  ['df_bearbeitet_am','df_techniker','df_maschine','df_anlagenteil'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', applyFiltersToDraftDashboard);
  });
  document.getElementById('df_provisorium')?.addEventListener('change', applyFiltersToDraftDashboard);


  // ==============================
  // üõ†Ô∏è Wartungsbereich im Kopf
  // ==============================
  const wartungHeadBtn = document.getElementById('wartungToggleHead');
  if (wartungHeadBtn) {
    wartungHeadBtn.addEventListener('click', () => {
      const panel   = document.getElementById('wartungsplanPanel');    // Panel aus dem Wartungsplan-HTML
      const section = document.getElementById('wartungsplanSection');  // Umrahmende Section

      if (!panel || !section) {
        alert('Wartungsbereich ist noch nicht eingebaut.');
        return;
      }
      const willShow = panel.style.display === 'none' || !panel.style.display;
      panel.style.display = willShow ? 'block' : 'none';
      wartungHeadBtn.textContent = willShow ? 'üõ†Ô∏è Wartung (zu)' : 'üõ†Ô∏è Wartung';

      if (willShow) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  }
});




async function loadDashboard(){
  await signInAndAcquireToken(true);
  await resolveShareLinkToFolder();

  const tbody = document.querySelector('#dashTable tbody');
  const empty = document.getElementById('dashEmpty');
  if (!tbody) return;

  tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;">Lade‚Ä¶</td></tr>';
  if (empty) empty.style.display = 'none';

  try{
    const headers = { Authorization: `Bearer ${accessToken}` };

    // PDFs im Hauptordner
    const listPdfUrl =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET.parentItemId}` +
      `/children?$top=2000&$select=id,name,webUrl,file,folder`;
    const pdfRes = await fetch(listPdfUrl, { headers });
    const mainItems = (await pdfRes.json()).value || [];

    const pdfMap = new Map(
      mainItems.filter(i => i.file && /\.pdf$/i.test(i.name))
               .map(i => [i.name, i.webUrl])
    );

    // META-Dateien zuerst im Meta-Ordner suchen
    let metaItems = [];
    if (TARGET_META_ITEM_ID) {
      const listMetaUrl =
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${TARGET_META_ITEM_ID}` +
        `/children?$top=2000&$select=id,name,file`;
      const metaRes = await fetch(listMetaUrl, { headers });
      if (metaRes.ok){
        const data = await metaRes.json();
        metaItems = (data.value || []).filter(i => i.file && i.name.endsWith(META_SUFFIX));
      }
    }

    // Fallback in Hauptordner
    if (!metaItems.length){
      metaItems = mainItems.filter(i => i.file && i.name.endsWith(META_SUFFIX));
    }

    const rows = [];

    for (const m of metaItems){
      const mres = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${m.id}/content`,
        { headers }
      );
      if (!mres.ok) continue;
      const meta = await mres.json();

      const auftragsId = (meta.auftrags_id || m.name.replace(META_SUFFIX,'')).trim();
      const pdfName    = meta.pdfName || `${auftragsId}.pdf`;

      // --- PROVISORIEN-Status bestimmen ---
      let provFlag   = 0;
      let provStatus = "none";
      let provText   = "";

      if (meta.provisorium_aktiv === "Ja") {
        provFlag = 1;

        const art    = meta.provisorium_art || "";
        const vonStr = meta.provisorium_von || "";
        const bisStr = meta.provisorium_bis || "";

        const todayIso = new Date().toISOString().slice(0,10);
        let statusText = "";

        if (!bisStr) {
          provStatus = "open"; // aktiv, kein Enddatum
          statusText = "‚ö† aktiv";
        } else {
          const bisIso      = bisStr.slice(0,10);
          const bisDateDisp = new Date(bisStr).toLocaleDateString("de-DE");

          if (bisIso >= todayIso) {
            provStatus = "active";
            statusText = "‚ö† aktiv bis " + bisDateDisp;
          } else {
            provStatus = "done";
            statusText = "‚úì beendet am " + bisDateDisp;
          }
        }

        provText = (art ? art + " ‚Äì " : "") + statusText;
      }
    const provRef = (meta.provisorium_bezug_auftrag_id || "").trim();

    // Falls dieser Auftrag selbst kein Provisorium setzt,
    // aber ein anderes aufhebt, trotzdem Text anzeigen
    if (!provText && provRef) {
      provText = "Aufl√∂sung Provisorium " + provRef;
    }

      rows.push({
        dateIso:  meta.bearbeitet_am || '',
        dateDisp: meta.bearbeitet_am ? new Date(meta.bearbeitet_am).toLocaleDateString('de-DE') : '',
        tech:     [meta.techniker1, meta.techniker2].filter(Boolean).join(', '),
        maschine: meta.maschine_text || meta.maschine_value || '',
        teil:     meta.anlagenteil_text || meta.anlagenteil_value || '',

        provText,
        provFlag,
        provStatus,
        provRef,
        id:  auftragsId,
        url: pdfMap.get(pdfName) || null
      });
    }
    // ---------------------------------------------
    // Verkn√ºpfungen: welches Provisorium wurde durch
    // welchen Auftrag aufgel√∂st?
    // ---------------------------------------------
    const resolvedByMap = {};

    // 1) Map aufbauen: Provisorium-ID -> [Auftrags-IDs, die es aufl√∂sen]
    rows.forEach(r => {
      const ref = (r.provRef || "").trim();
      if (!ref) return;
      if (!resolvedByMap[ref]) resolvedByMap[ref] = [];
      resolvedByMap[ref].push(r.id);
    });

    // 2) Bei den Ursprungs-Provisorien Text anh√§ngen
    rows.forEach(r => {
      const resolvers = resolvedByMap[r.id];
      if (!resolvers || !resolvers.length) return;

      const listStr = resolvers.join(", ");
      r.provText =
        (r.provText ? r.provText + " ‚Äì " : "") +
        "aufgel√∂st durch " + listStr;
    });

    // Sortieren nach Datum
    rows.sort((a,b) => (b.dateIso||'').localeCompare(a.dateIso||''));

    if (!rows.length){
      tbody.innerHTML = '';
      if (empty) empty.style.display = 'block';
      const dashBox = document.getElementById('dashAnalytics');
      if (dashBox) dashBox.style.display = 'none';
      return;
    }

    // Tabellenzeilen rendern
    tbody.innerHTML = rows.map(r => {
      const idCell = r.url ? `<a href="${r.url}" target="_blank" rel="noopener">${r.id}</a>` : r.id;

      let rowStyle = "";
      if (r.provStatus === "open" || r.provStatus === "active") {
        rowStyle = ' style="background:#fff3cd;"';
      }

      return `<tr${rowStyle}>
        <td data-k="bearbeitet_am" data-iso="${r.dateIso}">${r.dateDisp}</td>
        <td data-k="techniker">${r.tech}</td>
        <td data-k="maschine">${r.maschine}</td>
        <td data-k="anlagenteil">${r.teil}</td>
        <td data-k="provisorium" data-prov="${r.provFlag}" data-provstatus="${r.provStatus}">${r.provText}</td>
        <td data-k="auftrag_id">${idCell}</td>
      </tr>`;
    }).join('');

    applyFiltersToDashboard(); // l√∂st auch Analytics & Provisorium-Statistik aus

  } catch(e){
    console.error('Dashboard:', e);
    tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;">Fehler beim Laden.</td></tr>';
    const dashBox = document.getElementById('dashAnalytics');
    if (dashBox) dashBox.style.display = 'none';
  }
}

/* üîé NEU: Balkenliste rendern */
function renderTop(map, targetId){
  const target = document.getElementById(targetId);
  if(!target) return;
  const entries = [...map.entries()];
  const total   = entries.reduce((a,[,n]) => a+n, 0) || 1;

  const top = entries
    .sort((a,b) => b[1]-a[1] || a[0].localeCompare(b[0],'de'))
    .slice(0,5);

  target.innerHTML = top.length ? top.map(([label,count])=>{
    const pct = Math.round((count/total)*100);
    return `<div class="bar-row" data-label="${label}">
      <div class="bar-label" title="${label}">${label}</div>
      <div class="bar"><div class="bar-fill" style="width:${pct}%"></div></div>
      <div class="bar-count">${count}</div>
    </div>`;
  }).join('') : `<div style="color:#666">Keine Daten</div>`;

  // Klick = Filter setzen
  target.querySelectorAll('.bar-row').forEach(row=>{
    row.addEventListener('click', ()=>{
      const label = row.dataset.label || '';
      const inputId = (targetId === 'topMachines') ? 'f_maschine' : 'f_anlagenteil';
      const inp = document.getElementById(inputId);
      if (inp){ inp.value = label; applyFiltersToDashboard(); }
    });
  });
}

/* üîé NEU: Auswertung der aktuell sichtbaren Zeilen */
function updateAnalytics(){
  const rows = [...document.querySelectorAll('#dashTable tbody tr')]
    .filter(tr => tr.style.display !== 'none');

  const dashBox = document.getElementById('dashAnalytics');
  if (!dashBox) return;

  if (!rows.length){
    dashBox.style.display = 'none';
    return;
  }

  const machines = new Map();
  const parts    = new Map();

  rows.forEach(tr=>{
    const m = tr.querySelector('[data-k="maschine"]')?.textContent.trim() || '';
    const a = tr.querySelector('[data-k="anlagenteil"]')?.textContent.trim() || '';
    if (m) machines.set(m, (machines.get(m)||0) + 1);
    if (a) parts.set(a,    (parts.get(a)||0)    + 1);
  });

  renderTop(machines, 'topMachines');
  renderTop(parts,    'topParts');
  dashBox.style.display = 'block';
}

function applyFiltersToDashboard(){
  const valDate = (document.getElementById('f_bearbeitet_am')?.value || '').trim(); // ISO
  const valTech = (document.getElementById('f_techniker')?.value     || '').trim().toLowerCase();
  const valMach = (document.getElementById('f_maschine')?.value      || '').trim().toLowerCase();
  const valTeil = (document.getElementById('f_anlagenteil')?.value   || '').trim().toLowerCase();
  const valProv = (document.getElementById('f_provisorium')?.value   || '').trim(); // "", "mit", "ohne"
  const valId   = (document.getElementById('f_auftrag_id')?.value    || '').trim().toLowerCase();

  const rows = document.querySelectorAll('#dashTable tbody tr');
  let shown = 0;

  const now       = new Date();
  const rangeMode = window.dashRangeMode || '7';   // '7' | '30' | 'all'
  let   rangeDays = null;

  if (rangeMode === '7')      rangeDays = 7;
  else if (rangeMode === '30') rangeDays = 30;

  const rangeLimit = rangeDays != null
    ? new Date(now.getTime() - rangeDays * 24 * 60 * 60 * 1000)
    : null;

  rows.forEach(tr => {
    const cDate = tr.querySelector('[data-k="bearbeitet_am"]');
    const cTech = tr.querySelector('[data-k="techniker"]');
    const cMac  = tr.querySelector('[data-k="maschine"]');
    const cTeil = tr.querySelector('[data-k="anlagenteil"]');
    const cProv = tr.querySelector('[data-k="provisorium"]');
    const cId   = tr.querySelector('[data-k="auftrag_id"]');

    let ok = true;

    // Textfilter
    if (valTech && !(cTech?.textContent || '').toLowerCase().includes(valTech)) ok = false;
    if (valMach && !(cMac ?.textContent || '').toLowerCase().includes(valMach)) ok = false;
    if (valTeil && !(cTeil?.textContent || '').toLowerCase().includes(valTeil)) ok = false;
    if (valId   && !(cId  ?.textContent || '').toLowerCase().includes(valId  )) ok = false;

    // Provisorium-Filter
    if (ok && valProv === 'mit') {
      const flag = cProv?.dataset.prov || '0';
      if (flag !== '1') ok = false;
    }
    if (ok && valProv === 'ohne') {
      const flag = cProv?.dataset.prov || '0';
      if (flag !== '0') ok = false;
    }

    // Datumsfilter per Eingabefeld (zeigt nur >= ausgew√§hltem Datum)
    if (ok && valDate) {
      const rowIso = cDate?.dataset.iso || '';
      if (!rowIso || rowIso < valDate) ok = false;
    }

    // Bereich ‚Äûletzte 7/30 Tage‚Äú, nur wenn kein explizites Datum gew√§hlt ist
    if (ok && !valDate && rangeLimit) {
      const rowIso = cDate?.dataset.iso || '';
      if (rowIso) {
        const d = new Date(rowIso);
        if (!(d >= rangeLimit)) ok = false;
      }
    }

    tr.style.display = ok ? '' : 'none';
    if (ok) shown++;
  });

  const empty = document.getElementById('dashEmpty');
  if (empty) empty.style.display = shown ? 'none' : 'block';

  // üîé nach jedem Filter neu berechnen
  updateAnalytics();
  if (typeof updateProvisoriumStats === 'function') {
    updateProvisoriumStats();
  }
}


// ===== /Dashboard =====

</script>

  <script>
// ==========================================
// üìù Entw√ºrfe-Dashboard ‚Äì Daten & Filter
// ==========================================

// false = nur letzte 30 Tage, true = alle
window.showAllDrafts = false;
// Merker f√ºr Datei ‚Üí Item-ID (wichtig, damit sp√§ter l√∂schen klappt)
window.draftFileIndex = {};

// Entw√ºrfe laden
async function loadDraftDashboard() {
  await signInAndAcquireToken(true);
  await resolveShareLinkToFolder();

  const tbody = document.querySelector('#draftDashTable tbody');
  const empty = document.getElementById('draftDashEmpty');
  if (!tbody) return;

  tbody.innerHTML = '<tr><td colspan="6" style="padding:8px;">Lade‚Ä¶</td></tr>';
  if (empty) empty.style.display = 'none';

  try {
    if (!TARGET.driveId || !TARGET.parentItemId) {
      throw new Error('TARGET nicht initialisiert');
    }

    const headers = { Authorization: `Bearer ${accessToken}` };
    const parentId = TARGET_DRAFTS_ITEM_ID || TARGET.parentItemId;

    const listUrl =
      `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${parentId}` +
      `/children?$top=2000&$select=id,name,file`;
    const res = await fetch(listUrl, { headers });
    if (!res.ok) throw new Error('Liste der Entw√ºrfe konnte nicht geladen werden');
    const items = (await res.json()).value || [];

    const draftFiles = items.filter(i => i.file && i.name.endsWith('.json'));

    const rows = [];
    window.draftFileIndex = {};

    for (const item of draftFiles) {
      window.draftFileIndex[item.name] = item.id;

      const contentRes = await fetch(
        `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}/items/${item.id}/content`,
        { headers }
      );
      if (!contentRes.ok) continue;

      let draft;
      try {
        draft = await contentRes.json();
      } catch {
        continue;
      }

      const dateIso  = draft.bearbeitet_am || '';
      const dateDisp = dateIso ? new Date(dateIso).toLocaleDateString('de-DE') : '';

      const tech = [draft.techniker1, draft.techniker2].filter(Boolean).join(', ');
      const maschine =
        draft.maschine ||
        draft.maschine_value ||
        draft.maschine_text ||
        draft.sonstige_maschine ||
        '';
      const teil =
        draft.anlagenteil ||
        draft.anlagenteil_value ||
        draft.anlagenteil_text ||
        draft.sonstige_anlagenteil ||
        '';

      const auftragsId =
        draft.auftrag_id ||
        draft.auftrags_id ||
        item.name.replace(/\.json$/i, '');
      
const bezugId = (draft.provisorium_bezug_auftrag_id || '').trim();

      // Provisorium aus Draft falls vorhanden
      let provFlag   = 0;
      let provStatus = 'none';
      let provText   = '';

      if (draft.provisorium_aktiv === 'Ja') {
        provFlag = 1;
        const art    = draft.provisorium_art || '';
        const vonStr = draft.provisorium_von || '';
        const bisStr = draft.provisorium_bis || '';

        const todayIso = new Date().toISOString().slice(0,10);
        let statusText = '';

        if (!bisStr) {
          provStatus = 'open';
          statusText = '‚ö† aktiv';
        } else {
          const bisIso      = bisStr.slice(0,10);
          const bisDateDisp = new Date(bisStr).toLocaleDateString('de-DE');
          if (bisIso >= todayIso) {
            provStatus = 'active';
            statusText = '‚ö† aktiv bis ' + bisDateDisp;
          } else {
            provStatus = 'done';
            statusText = '‚úì beendet am ' + bisDateDisp;
          }
        }
        provText = (art ? art + ' ‚Äì ' : '') + statusText;
      }

     rows.push({
  dateIso,
  dateDisp,
  tech,
  maschine,
  teil,
  provText,
  provFlag,
  provStatus,
  id: auftragsId,
  bezugId,              // üîπ neu
  fileName: item.name,
  fileId: item.id
});

    }
// üîó Provisorien-Verkn√ºpfung f√ºr Anzeige im Dashboard
const rowsById = new Map();

// Map: Auftrags-ID -> alle zugeh√∂rigen Zeilen
for (const r of rows) {
  const key = (r.id || '').trim();
  if (!key) continue;
  if (!rowsById.has(key)) rowsById.set(key, []);
  rowsById.get(key).push(r);
}

// Jetzt durch alle Zeilen laufen und Verkn√ºpfungen eintragen
for (const r of rows) {
  const ref = (r.bezugId || '').trim();
  if (!ref) continue; // kein Bezug ‚Üí nichts zu tun

  // Text f√ºr den "aufl√∂senden" Auftrag
  const selfSuffix = `l√∂st Provisorium aus ${ref} ab`;
  r.provText = r.provText
    ? `${r.provText} ‚Äì ${selfSuffix}`
    : selfSuffix;

  // Text f√ºr den urspr√ºnglichen Provisoriums-Auftrag
  const originRows = rowsById.get(ref);
  if (originRows && originRows.length) {
    originRows.forEach(or => {
      const otherSuffix = `aufgel√∂st durch ${r.id}`;
      if (!or.provText || !or.provText.includes(otherSuffix)) {
        or.provText = or.provText
          ? `${or.provText} ‚Äì ${otherSuffix}`
          : otherSuffix;
      }
    });
  }
}

    rows.sort((a, b) => (b.dateIso || '').localeCompare(a.dateIso || ''));

    if (!rows.length) {
      tbody.innerHTML = '';
      if (empty) empty.style.display = 'block';
      return;
    }

    tbody.innerHTML = rows.map(r => {
      let rowStyle = '';
      if (r.provStatus === 'open' || r.provStatus === 'active') {
        rowStyle = ' style="background:#fff3cd;"';
      }

      const link = `
        <a href="#"
           class="draft-open-link"
           data-file="${encodeURIComponent(r.fileName)}"
           data-id="${r.fileId}">
          ${r.id}
        </a>`;

      return `<tr${rowStyle}>
        <td data-k="bearbeitet_am" data-iso="${r.dateIso}">${r.dateDisp}</td>
        <td data-k="techniker">${r.tech}</td>
        <td data-k="maschine">${r.maschine}</td>
        <td data-k="anlagenteil">${r.teil}</td>
        <td data-k="provisorium" data-prov="${r.provFlag}" data-provstatus="${r.provStatus}">${r.provText}</td>
        <td data-k="auftrag_id">${link}</td>
      </tr>`;
    }).join('');

    // Klick auf Auftrags-ID ‚Üí Entwurf laden
    tbody.querySelectorAll('.draft-open-link').forEach(a => {
      a.addEventListener('click', async ev => {
        ev.preventDefault();
        const fileName = decodeURIComponent(a.dataset.file || '');
        const fileId   = a.dataset.id || null;

        if (!fileName) return;

        window.currentDraftFileName = fileName;
        window.currentDraftFileId   = fileId;

        try {
          await loadDraftFromOneDrive(fileName);
          // Formular ins Blickfeld holen
          document.getElementById('auftrag_id')
                  ?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (e) {
          console.error('Entwurf aus Dashboard laden:', e);
          alert('‚ùå Entwurf konnte nicht geladen werden.');
        }
      });
    });

    applyFiltersToDraftDashboard();
  } catch (e) {
    console.error('Draft-Dashboard:', e);
    tbody.innerHTML = '<tr><td colspan="6" style="padding:8px;">Fehler beim Laden.</td></tr>';
  }
}

    
function applyFiltersToDraftDashboard() {
  const valDate = (document.getElementById('df_bearbeitet_am')?.value || '').trim(); // ISO
  const valTech = (document.getElementById('df_techniker')?.value     || '').trim().toLowerCase();
  const valMach = (document.getElementById('df_maschine')?.value      || '').trim().toLowerCase();
  const valTeil = (document.getElementById('df_anlagenteil')?.value   || '').trim().toLowerCase();
  const valProv = (document.getElementById('df_provisorium')?.value   || '').trim(); // "", "mit", "ohne"

  const rows = document.querySelectorAll('#draftDashTable tbody tr');
  let shown = 0;

  const now   = new Date();
  const last30 = new Date(now.getTime() - 30*24*60*60*1000);

  rows.forEach(tr => {
    const cDate = tr.querySelector('[data-k="bearbeitet_am"]');
    const cTech = tr.querySelector('[data-k="techniker"]');
    const cMac  = tr.querySelector('[data-k="maschine"]');
    const cTeil = tr.querySelector('[data-k="anlagenteil"]');
    const cProv = tr.querySelector('[data-k="provisorium"]');

    let ok = true;

    if (valTech && !(cTech?.textContent || '').toLowerCase().includes(valTech)) ok = false;
    if (valMach && !(cMac ?.textContent || '').toLowerCase().includes(valMach)) ok = false;
    if (valTeil && !(cTeil?.textContent || '').toLowerCase().includes(valTeil)) ok = false;

    if (ok && valProv === 'mit') {
      const flag = cProv?.dataset.prov || '0';
      if (flag !== '1') ok = false;
    }
    if (ok && valProv === 'ohne') {
      const flag = cProv?.dataset.prov || '0';
      if (flag !== '0') ok = false;
    }

    if (ok && valDate) {
      const rowIso = cDate?.dataset.iso || '';
      if (!rowIso || rowIso < valDate) ok = false;
    }

    if (ok && !window.showAllDrafts) {
      const rowIso = cDate?.dataset.iso || '';
      if (rowIso) {
        const d = new Date(rowIso);
        if (!(d >= last30)) ok = false;
      }
    }

    tr.style.display = ok ? '' : 'none';
    if (ok) shown++;
  });

  const empty = document.getElementById('draftDashEmpty');
  if (empty) empty.style.display = shown ? 'none' : 'block';
}
</script>

<script>
/* ===== Wartungsplan ‚Äì Daten & OneDrive-Speicher ===== */
// const WP_FILE = "Wartungsplaene.json";   // schon weiter oben definiert

/** Struktur: { [maschinenName]: [ { id, name, intervalDays, lastDateISO, nipples } ] } */

// ===============================
// Wartungspl√§ne ‚Äì Kern-Helfer
// ===============================
let wartungsplaene = {};
let _wpIdx = {}; // { normMaschinenName: tasks[] }

// Namen robust vergleichen (Umlaute/√ü/Mehrfach-Spaces egal)
function wpNorm(s){
  return String(s || "")
    .toLowerCase()
    .replace(/√ü/g, "ss")
    // alt: .replace(/\p{Diacritic}/gu, "")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")   // diakritische Zeichen entfernen
    .replace(/\s+/g, " ")
    .trim();
}


// Index EINMAL bauen (nutzt wpNorm)
function wpBuildIndex(){
  _wpIdx = {};
  for (const [m, tasks] of Object.entries(wartungsplaene || {})){
    _wpIdx[wpNorm(m)] = Array.isArray(tasks) ? tasks : [];
  }
}
function wpRebuildIndex(){ wpBuildIndex(); } // <- KEIN wpIndex!

// ===============================
// Datums-/Status-Helfer
// ===============================
function wpTodayISO(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function wpAddDays(iso, days){
  if (!iso) return "";
  const d = new Date(iso); d.setDate(d.getDate()+Number(days||0));
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function wpComputeNext(lastDate, intervalDays){
  if (!lastDate || !intervalDays) return "";
  return wpAddDays(lastDate, intervalDays);
}
function wpStatus(nextIso){
  if (!nextIso) return {label:"‚Äì",level:"none",bg:"#e9ecef",fg:"#000"};
  const t = wpTodayISO();
  if (nextIso < t) return {label:"√úberf√§llig",level:"overdue",bg:"#f8d7da",fg:"#842029"};
  const daysLeft = Math.floor((new Date(nextIso) - new Date(t))/86400000);
  if (daysLeft <= 3) return {label:"Bald f√§llig",level:"soon",bg:"#fff3cd",fg:"#664d03"};
  return {label:"OK",level:"ok",bg:"#d1e7dd",fg:"#0f5132"};
}

// ===============================
// MAIL-REGELN (Default-Intervalle)
// ===============================
// - Alle Vakuumf√ºller: t√§glich
// - Antriebseinheit Multivac 4 / Petrella SB: w√∂chentlich
// - Alles andere: alle 4 Wochen
const WP_RULES = {
  daily:  [/vakuumf√ºller/i],
  weekly: [/\bmultivac\s*4\b/i, /\bpetrella\s*sb\b/i]
};
// Maschine + (optional) Aufgabenname => Default-Intervall in Tagen
function wpMailRuleInterval(machineName = "", taskName = "") {
  const m = String(machineName || "").trim();
  const t = String(taskName   || "").trim();
  if (WP_RULES.daily .some(rx => rx.test(m))) return 1;   // t√§glich
  if (WP_RULES.weekly.some(rx => rx.test(m))) return 7;   // w√∂chentlich
  if (/antrieb/i.test(t))                    return 7;    // Aufgabe deutet Antrieb ‚Üí weekly
  return 28;                                              // sonst 4 Wochen
}
// Intervallfeld (und NextDue/Status) gem√§√ü Regel vorschlagen
function wpApplyMailRules(opts){
  opts = opts || {};
  var force = !!opts.force;

  var E = (typeof wpEls === "function") ? wpEls() : {};
  var selMaschine = E.selMaschine, selTask = E.selTask, interval = E.interval, last = E.last, next = E.next, pill = E.pill;
  if (!interval) return;

  var machineName = "";
  if (selMaschine) {
    if (selMaschine.value) machineName = selMaschine.value;
    else if (selMaschine.options && selMaschine.options[selMaschine.selectedIndex])
      machineName = selMaschine.options[selMaschine.selectedIndex].text || "";
  }

  var taskText = "";
  if (selTask) {
    if (selTask.options && selTask.options[selTask.selectedIndex])
      taskText = (selTask.options[selTask.selectedIndex].text || "").trim();
    if (!taskText && selTask.value) taskText = selTask.value;
  }

  if (!force && interval.value) return;

  var days = wpMailRuleInterval(machineName, taskText);
  interval.value = String(days);

  if (last && /^\d{4}-\d{2}-\d{2}$/.test(last.value) && next) {
    next.value = wpComputeNext(last.value, days);
  }
  var st = wpStatus((next && next.value) || "");
  if (pill) { pill.textContent = st.label; pill.style.background = st.bg; pill.style.color = st.fg; }
}


// const WP_FILE = "Wartungsplaene.json"; // schon weiter oben definiert
const WP_CACHE_KEY = "TE15_WARTUNGSPLAENE";


async function wpLoad() {
  // 1) Cache lesen (nur als Fallback)
  let cacheObj = {};
  try {
    const raw = localStorage.getItem(WP_CACHE_KEY);
    cacheObj = raw ? JSON.parse(raw) : {};
  } catch (e) {
    console.warn("[WP] Cache parse failed:", e);
    cacheObj = {};
  }

  wartungsplaene = {}; // Standard: erstmal leer

  const hasToken = !!(typeof window !== "undefined" && window.accessToken);

  // 2) Wenn angemeldet: IMMER versuchen, aus OneDrive (Hauptordner) zu laden
  if (hasToken) {
    try {
      // sicherstellen, dass TARGET gesetzt ist
      if (!window.TARGET || !TARGET.driveId || !TARGET.parentItemId) {
        try { await resolveShareLinkToFolder(); } catch (_) {}
      }

      if (window.TARGET && TARGET.driveId && TARGET.parentItemId) {
        const url =
          "https://graph.microsoft.com/v1.0/drives/" +
          window.TARGET.driveId +
          "/items/" +
          window.TARGET.parentItemId +
          ":/" + encodeURIComponent(WP_FILE) + ":/content";

        const r = await fetch(url, {
          headers: { Authorization: "Bearer " + window.accessToken }
        });

        if (r && r.ok) {
          try {
            wartungsplaene = await r.json();
          } catch (eJson) {
            wartungsplaene = JSON.parse(await r.text());
          }

          // Cloud-Daten in Cache schreiben
          try {
            localStorage.setItem(WP_CACHE_KEY, JSON.stringify(wartungsplaene));
          } catch (eSet) {}
        } else if (r && r.status === 404) {
          // Datei gibt es noch nicht ‚Üí leere Struktur
          wartungsplaene = {};
          try { localStorage.setItem(WP_CACHE_KEY, JSON.stringify(wartungsplaene)); } catch (eSet) {}
        } else {
          console.warn("[WP] OneDrive load not OK, nutze Cache:", r && r.status);
          wartungsplaene = cacheObj;
        }
      } else {
        console.warn("[WP] TARGET ohne parentItemId, nutze Cache.");
        wartungsplaene = cacheObj;
      }
    } catch (e) {
      console.warn("[WP] OneDrive load failed, nutze Cache:", e);
      wartungsplaene = cacheObj;
    }
  } else {
    // 3) Nicht angemeldet ‚Üí nur lokalen Cache verwenden
    wartungsplaene = cacheObj;
  }

  // 4) Index bauen & UI ansto√üen
  try {
    wpBuildIndex();
  } catch (e) {
    console.warn("[WP] build index failed:", e);
  }

  console.info("[WP] geladen:", Object.keys(wartungsplaene || {}).length, "Maschinen");

  try {
    if (typeof wpRefreshTaskList     === "function") wpRefreshTaskList();
    if (typeof wpStatusUpdateForTask === "function") wpStatusUpdateForTask(null);
  } catch (e) {
    console.warn("[WP] init UI failed:", e);
  }
}





// Speichern (Cache + OneDrive)
async function wpSave(){
  // immer lokal
  try { localStorage.setItem("TE15_WARTUNGSPLAENE", JSON.stringify(wartungsplaene)); } catch {}
  wpRebuildIndex();

  // ohne Login / Zielordner keine Cloud-Speicherung
  if (!window.accessToken) return;
  if (!window.TARGET || !TARGET.driveId || !TARGET.parentItemId) {
    try { await resolveShareLinkToFolder(); } catch (_) {}
  }
  if (!window.TARGET || !TARGET.driveId || !TARGET.parentItemId) return;

  const url =
    `https://graph.microsoft.com/v1.0/drives/${TARGET.driveId}` +
    `/items/${TARGET.parentItemId}:/${encodeURIComponent(WP_FILE)}:/content`;

  const blob = new Blob([JSON.stringify(wartungsplaene, null, 2)], {
    type:"application/json"
  });

  try{
    await fetch(url, {
      method:"PUT",
      headers:{ Authorization:`Bearer ${accessToken}` },
      body: blob
    });
  }catch(e){
    console.warn("wpSave() ‚Äì Cloud-Speicher fehlgeschlagen:", e);
  }
}





/* ===== Wartungsplan ‚Äì UI (final, stabil, inkl. Nippel & Banner) ===== */
function wpEls(){
  return {
    panel: document.getElementById("wartungsplanPanel"),
    section: document.getElementById("wartungsplanSection"),
    warn: document.getElementById("wpWarning"),
    pill: document.getElementById("wpStatusPill"),
    selTask: document.getElementById("wpTaskSelect"),
    interval: document.getElementById("wpIntervalDays"),
    last: document.getElementById("wpLastDate"),
    next: document.getElementById("wpNextDue"),
    nip: document.getElementById("wpNipCount"),
    btnAdd: document.getElementById("wpAddTask"),
    btnSave: document.getElementById("wpSaveTask"),
    btnDel: document.getElementById("wpDeleteTask"),
    btnDone: document.getElementById("wpMarkDoneToday"),
    selMaschine: document.getElementById("maschine")
  };
}

/* ---------- Maschine-Key sicherstellen ---------- */
function wpEnsureMachineKey(name){
  if (!name) return null;
  const key = Object.keys(wartungsplaene).find(k => wpNorm(k) === wpNorm(name)) || name;
  if (!wartungsplaene[key]) wartungsplaene[key] = [];

  return key;
}

/* ---------- Aufgabenliste f√ºr gew√§hlte Maschine ---------- */
function wpRefreshTaskList() {
  const { selTask, selMaschine } = wpEls();
  if (!selTask) return;

  // iPad-kompatibel: kein ?. mehr
  const mRaw = ((selMaschine && selMaschine.value) ? selMaschine.value : '').trim();
  const mNorm = wpNorm(mRaw);

  const direct = (wartungsplaene && wartungsplaene[mRaw]) ? wartungsplaene[mRaw] : [];
  const idx    = (_wpIdx && _wpIdx[mNorm]) ? _wpIdx[mNorm] : [];
  const tasks  = (direct.length ? direct : idx) || [];

  selTask.innerHTML =
    '<option value="">Bitte ausw√§hlen</option>' +
    tasks.map(t =>
`<option value="${(t && t.id) || ''}" data-interval="${(t && t.intervalDays) || ''}" data-nipples="${(t && t.nipples) || ''}">

         ${(t && t.name) || ''}
       </option>`
    ).join('');

  if (typeof wpStatusUpdateForTask === 'function') wpStatusUpdateForTask(null);
}


/* ---------- Aktuell gew√§hlten Task bestimmen ---------- */
function wpCurrentTask(){
const { selMaschine, selTask } = wpEls();
const m  = (selMaschine && selMaschine.value) ? selMaschine.value : "";
const id = (selTask && selTask.value) ? selTask.value : "";
  const list = wartungsplaene[m] || _wpIdx[wpNorm(m)] || [];
  return list.find(t => String(t.id) === String(id)) || null;
}

/* ---------- Statusfelder aktualisieren ---------- */
function wpStatusUpdateForTask(task) {
  const els = wpEls();
  const interval    = els.interval;
  const last        = els.last;
  const next        = els.next;
  const pill        = els.pill;
  const nip         = els.nip;
  const selMaschine = els.selMaschine;

  function clear() {
    if (interval) interval.value = "";
    if (last)     last.value     = "";
    if (next)     next.value     = "";
    if (nip)      nip.value      = "";
    if (pill) {
      pill.textContent     = "‚Äì";
      pill.style.background = "#e9ecef";
      pill.style.color      = "#000";
    }
  }

  if (!task) {
    clear();
    return;
  }

  // Helper f√ºr int-Werte
  function toInt(v) {
    var n = parseInt(v, 10);
    return (Number.isFinite(n) && n > 0) ? n : "";
  }

  // 1) Intervall √ºbernehmen
  var inter = toInt(task.intervalDays);
  if (interval) interval.value = inter || "";

  // 2) Letztes Datum: zuerst aus Plan, dann wenn m√∂glich aus Wartungslog
  var lastIso = (task.lastDateISO && isIsoDate(task.lastDateISO))
    ? task.lastDateISO
    : "";

  try {
    var list = Array.isArray(window.wartungslog) ? window.wartungslog : [];
    if (list.length && selMaschine) {
      var mVal  = (selMaschine.value || "").trim();
      var tName = (task.name || "").trim();
      var best  = lastIso;

      for (var i = 0; i < list.length; i++) {
        var e = list[i] || {};
        var em = (e.machine  || "").trim();
        var et = (e.taskName || "").trim();
        if (em === mVal && et === tName) {
          var d = (e.dateISO || "").trim();
          if (d && (!best || d > best)) best = d;  // neuestes Datum merken
        }
      }
      if (best) lastIso = best;
    }
  } catch (err) {
    console.warn("wpStatusUpdateForTask: wartungslog lookup failed", err);
  }

  if (last) last.value = lastIso;

  // 3) N√§chstes F√§lligkeitsdatum berechnen
  var nextVal = "";
  if (lastIso && inter) {
    if (typeof recomputeNextDue === "function") {
      // nutzt die Felder wpLastDate + wpIntervalDays
      recomputeNextDue();
      if (next) nextVal = next.value || "";
    } else {
      nextVal = wpComputeNext(lastIso, inter);
      if (next) next.value = nextVal;
    }
  } else {
    if (next) next.value = "";
  }

  // 4) Schmiernippel √ºbernehmen
  var n = toInt(task.nipples);
  if (nip) nip.value = n ? String(n) : "";

  // 5) Status-Pill (OK / Heute / √úberf√§llig)
  if (pill) {
    var label = "‚Äì";
    var bg    = "#e9ecef";
    var col   = "#000";

    if (nextVal) {
      var today = (typeof todayISO === "function")
        ? todayISO()
        : _toISO(new Date());

      if (nextVal < today) {
        label = "√úberf√§llig";
        bg    = "#f8d7da";
        col   = "#721c24";
      } else if (nextVal === today) {
        label = "Heute f√§llig";
        bg    = "#fff3cd";
        col   = "#856404";
      } else {
        label = "OK";
        bg    = "#d4edda";
        col   = "#155724";
      }
    }

    pill.textContent     = label;
    pill.style.background = bg;
    pill.style.color      = col;
  }
}



function wpOverdueTasks(machineName){
  const tasks = wartungsplaene[machineName] || _wpIdx[wpNorm(machineName)] || [];

  return tasks.filter(t => {
    const inter = toInt(t.intervalDays || 0, 0);
    const last  = isIsoDate(t.lastDateISO) ? t.lastDateISO : "";
    const next  = wpComputeNext(last, inter);
    return wpStatus(next).level === "overdue";
  });
}


// Alle Maschinen pr√ºfen und √ºberf√§llige Aufgaben einsammeln
function wpOverdueAll(){
  const res = [];
  const wp = window.wartungsplaene || {};
  for (const [machine, tasks] of Object.entries(wp)){
    if (!Array.isArray(tasks)) continue;
    const overdue = tasks.filter(t => {
      const inter = toInt(t.intervalDays || 0, 0);
      const last  = isIsoDate(t.lastDateISO) ? t.lastDateISO : "";
      const next  = wpComputeNext(last, inter);
      return wpStatus(next).level === "overdue";
    });
    if (overdue.length) res.push({ machine, overdue });
  }
  return res;
}


// üî¥ Globaler Banner: zeigt entweder f√ºr die gew√§hlte Maschine ODER global
function wpUpdateGlobalBanner(){
  const banner = document.getElementById('wpGlobalOverdueBanner');
  if (!banner) return;

  const { selMaschine } = wpEls();
  const selected = ((selMaschine && selMaschine.value) ? selMaschine.value : "").trim();

  // Wenn eine Maschine gew√§hlt ist: bisheriges Verhalten
  if (selected){
    const list = wpOverdueTasks(selected);
    if (!list.length){
      banner.style.display = "none";
      return;
    }
    const msgEl = banner.querySelector('[data-msg]');
    if (msgEl){
      const names = list.map(t => t.name).slice(0,3).join(', ');
      const more  = list.length > 3 ? ` (+${list.length - 3} weitere)` : '';
      msgEl.textContent = `Maschine ‚Äû${selected}‚Äú: ${list.length} Wartung(en) √ºberf√§llig ‚Äì ${names}${more}`;
    }
    banner.style.display = "flex";
    return;
  }

  // Keine Maschine gew√§hlt ‚Üí global pr√ºfen
  const all   = wpOverdueAll();
  const total = all.reduce((a, x) => a + x.overdue.length, 0);

  if (!total){
    banner.style.display = "none";
    return;
  }

  const first      = all[0];
  const firstNames = first.overdue.map(t => t.name).slice(0,3).join(', ');
  const rest       = total - first.overdue.length;

  const msgEl = banner.querySelector('[data-msg]');
  if (msgEl){
    // Kleiner, aber informativer Globaltext
    msgEl.textContent =
      `${total} √ºberf√§llige Wartung(en) in ${all.length} Maschine(n) ‚Äì ` +
      `z. B. ‚Äû${first.machine}‚Äú: ${firstNames}${rest>0 ? ` (+${rest} weitere)` : ''}`;
  }
  banner.style.display = "flex";

  // Optional: Wenn der Banner-Button ‚ÄûWartung √∂ffnen‚Äú existiert,
  // und noch keine Maschine gew√§hlt ist, w√§hle beim Klick die erste betroffene.
  var openBtn = document.getElementById('wpOpenFromBanner') ||
                (banner && banner.querySelector && banner.querySelector('[data-open]'));

  if (openBtn){
    openBtn.onclick = function () {
      try{
        var els = (typeof wpEls === "function") ? wpEls() : {};
        var selMaschine = els ? els.selMaschine : null;

        if (selMaschine && !selMaschine.value && first && first.machine){
          // 1) exakter Name
          selMaschine.value = first.machine;

          // 2) falls nicht exakt vorhanden: suche per Normalisierung
          if (selMaschine.value !== first.machine){
            var norm = (typeof wpNorm === "function") ? wpNorm(first.machine)
                                                      : String(first.machine||"").toLowerCase().trim();
            var opt = Array.prototype.slice.call(selMaschine.options || []).find(function(o){
              var ov = (typeof wpNorm === "function") ? wpNorm(o.value)       : String(o.value||"").toLowerCase().trim();
              var ot = (typeof wpNorm === "function") ? wpNorm(o.textContent||"") : String(o.textContent||"").toLowerCase().trim();
              return ov === norm || ot === norm;
            });
            if (opt) selMaschine.value = opt.value;
          }

          // Change-Event feuern
          try {
            selMaschine.dispatchEvent(new Event('change', { bubbles:true }));
          } catch(_){
            var evt = document.createEvent('HTMLEvents');
            evt.initEvent('change', true, false);
            selMaschine.dispatchEvent(evt);
          }
        }
      } catch(e){ /* schlucken, UI geht weiter */ }

      // Panel √∂ffnen
      var panel = document.getElementById('wartungsplanPanel');
      if (panel && panel.style) panel.style.display = 'block';

      var headBtn = document.getElementById('wartungToggleHead');
      if (headBtn) headBtn.textContent = 'üõ†Ô∏è Wartung (zu)';

      // Scrollen ‚Äì iPad-kompatibel
      var sec = document.getElementById('wartungsplanSection');
      if (sec){
        try { sec.scrollIntoView({ behavior:'smooth', block:'start' }); }
        catch(_) { sec.scrollIntoView(true); }
      }
    };
  }
} // Ende wpUpdateGlobalBanner


/* ---------- Recalc ---------- */
function wpRecalc() {
  const { interval, last, next, pill, nip } = wpEls();
  const inter   = toInt(((interval && interval.value) || 0), 0);
  const lastIso = (last && isIsoDate(last.value)) ? last.value : "";
  const nextVal = (lastIso && inter) ? wpComputeNext(lastIso, inter) : "";
  if (next) next.value = nextVal;

  if (nip && typeof nip.value !== "undefined") {
    nip.value = (nip.value === null || typeof nip.value === "undefined") ? "" : String(nip.value);
  }

  const st = wpStatus(nextVal || "");
  if (pill) {
    pill.textContent = st.label;
    pill.style.background = st.bg;
    pill.style.color = st.fg;
  }
}


/* ---------- Helpers & Warning (einmal global) ---------- */
function isIsoDate(s){ return /^\d{4}-\d{2}-\d{2}$/.test(String(s||'')); }

function toInt(v, fallback){
  var s = (v === null || v === undefined) ? '' : String(v);
  var n = parseInt(s.replace(/[^\d-]/g,''), 10);
  return Number.isFinite(n) ? n : (fallback === undefined ? "" : fallback);
}



function wpEvalWarning(){
  var E = wpEls();
  var selMaschine = E.selMaschine, warn = E.warn;
  var m = ((selMaschine && selMaschine.value) ? selMaschine.value : "").trim();

  var tasks = m ? (window.wartungsplaene && window.wartungsplaene[m] || []) : [];
  var overdue = 0, soon = 0;
  for (var i=0; i<tasks.length; i++){
    var t = tasks[i] || {};
    var inter = toInt(t.intervalDays || 0, 0);
    var last  = (/^\d{4}-\d{2}-\d{2}$/.test(t.lastDateISO)) ? t.lastDateISO : "";
    var next  = wpComputeNext(last, inter);
    var st    = wpStatus(next);
    if (st.level === "overdue") overdue++;
    else if (st.level === "soon") soon++;
  }

  if (warn){
    if (overdue || soon){
      var parts=[];
      if (overdue) parts.push('‚ö†Ô∏è <strong>'+overdue+'</strong> √ºberf√§llige Wartung'+(overdue>1?'en':''));
      if (soon)    parts.push('‚è≥ <strong>'+soon   +'</strong> bald f√§llige Wartung'+(soon>1?'en':''));
      warn.style.display="block"; warn.innerHTML = parts.join(" ‚Ä¢ ");
    } else { warn.style.display="none"; warn.textContent=""; }
  }
  if (typeof wpUpdateGlobalBanner === "function") { try{ wpUpdateGlobalBanner(); }catch(e){} }
}




/* ---------- Ende Fix-Block ---------- */
function wpSyncPrintSummary(task){
  const box = document.getElementById('wpPrintSummary');
  if (!box) return;

  if (!task){
    box.style.display = 'none';
    return;
  }

  const inter = toInt((task && task.intervalDays) || 0, 0);
  const last  = (task && isIsoDate(task.lastDateISO)) ? task.lastDateISO : "";
  const next  = (last && inter > 0) ? wpComputeNext(last, inter) : "";

  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || "‚Äì"; };

  set('wpPrintTask',      (task && task.name) || "");
  set('wpPrintInterval',  inter ? String(inter) : "");
  set('wpPrintLast',      last || "");
  set('wpPrintNext',      next || "");

  // kein Nullish-Coalescing
  var nip = (task && task.nipples);
  nip = (nip === null || nip === undefined || nip === "") ? "" : String(nip);
  set('wpPrintNip', nip);

  box.style.display = 'block';
}


  
function setupWartungsplanUI(){
  const E = wpEls();
  if (!E.section) return;

  // Banner-Button
  (function(){
    var btn = document.getElementById('wpOpenFromBanner');
    if (btn) {
      btn.addEventListener('click', function(){
        if (E.panel) E.panel.style.display = 'block';
        var headBtn = document.getElementById('wartungToggleHead');
        if (headBtn) headBtn.textContent = 'üõ†Ô∏è Wartung (zu)';
        E.section.scrollIntoView({ behavior:'smooth', block:'start' });
      });
    }
  })();

  // ‚îÄ‚îÄ Maschine ge√§ndert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (E.selMaschine){
    E.selMaschine.onchange = function(){
      if (typeof wpRefreshTaskList     === "function") wpRefreshTaskList();
      if (typeof wpStatusUpdateForTask === "function") wpStatusUpdateForTask(null);
      if (typeof wpEvalWarning         === "function") wpEvalWarning();
      if (typeof wpUpdateGlobalBanner  === "function") wpUpdateGlobalBanner();
      if (typeof wpSyncPrintSummary    === "function") wpSyncPrintSummary(null);
      if (typeof wpSyncImageButton     === "function") wpSyncImageButton(null);   // üëà Button verstecken
    };
  }

  // ‚îÄ‚îÄ Aufgabe ge√§ndert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (E.selTask){
    E.selTask.onchange = function(){
      const t = (typeof wpCurrentTask === "function") ? wpCurrentTask() : null;
      if (typeof wpStatusUpdateForTask === "function") wpStatusUpdateForTask(t);

      // Intervall nur vorschlagen, wenn im Datensatz noch keins steht
      if (!t || !toInt((t && t.intervalDays), "")) {
        try { if (typeof wpApplyMailRules === "function") wpApplyMailRules({ force:false }); } catch (e) {}
      }

      if (typeof wpUpdateGlobalBanner === "function")  wpUpdateGlobalBanner();
      if (typeof wpSyncPrintSummary   === "function")  wpSyncPrintSummary(t);
      if (typeof wpSyncImageButton    === "function")  wpSyncImageButton(t);      // üëà Button setzen
    };
  }

  // Eingaben ‚Üí F√§lligkeit neu berechnen
  if (E.interval) E.interval.addEventListener('input', function(){
    if (typeof wpRecalc === "function") wpRecalc();
  });

  // NEU: "Zuletzt durchgef√ºhrt"
  if (E.last) E.last.addEventListener('change', async function(){
    const t = (typeof wpCurrentTask === "function") ? wpCurrentTask() : null;
    if (!t) return;

    let v = (E.last.value || "").trim();
    const mm = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    if (mm) { v = mm[3] + '-' + mm[2] + '-' + mm[1]; E.last.value = v; }
    t.lastDateISO = (/^\d{4}-\d{2}-\d{2}$/.test(v)) ? v : "";

    if (typeof wpSave        === "function") await wpSave();
    if (typeof wpRecalc      === "function") wpRecalc();
    if (typeof wpEvalWarning === "function") wpEvalWarning();
    if (typeof wpUpdateGlobalBanner === "function") wpUpdateGlobalBanner();
    if (typeof wpSyncPrintSummary   === "function") wpSyncPrintSummary(t);
    if (typeof wpSyncImageButton    === "function") wpSyncImageButton(t);        // üëà Button aktualisieren
  });

// (5) ‚îÄ‚îÄ Neue Aufgabe anlegen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (E.btnAdd) E.btnAdd.addEventListener('click', async function(){
  const machineVal = (E.selMaschine && E.selMaschine.value) ? E.selMaschine.value : "";
  const m = (typeof wpEnsureMachineKey === "function") ? wpEnsureMachineKey(machineVal) : machineVal;
  if (!m){ alert("Bitte zuerst eine Maschine w√§hlen."); return; }

  const name = prompt("Bezeichnung der Wartungsaufgabe (z. B. 'Kette schmieren'):");
  if (!name) return;

  const t = { id: (crypto && crypto.randomUUID ? crypto.randomUUID() : String(Date.now())),
              name, intervalDays: 30, lastDateISO: "" };

  // Nippel aus Eingabefeld √ºbernehmen
  const nipVal = toInt((E.nip && E.nip.value) ? E.nip.value : "", NaN);
  if (Number.isFinite(nipVal) && nipVal >= 0) t.nipples = nipVal;

  if (!wartungsplaene[m]) wartungsplaene[m] = [];
  wartungsplaene[m].push(t);

  if (typeof wpSave === "function") await wpSave();

  if (typeof wpRefreshTaskList  === "function") wpRefreshTaskList();
  if (E.selTask) E.selTask.value = t.id;

  try { if (typeof wpApplyMailRules === "function") wpApplyMailRules({ force:true }); } catch (e) {}

  if (typeof wpStatusUpdateForTask === "function") wpStatusUpdateForTask(t);
  if (typeof wpEvalWarning         === "function") wpEvalWarning();
  if (typeof wpUpdateGlobalBanner  === "function") wpUpdateGlobalBanner();
  if (typeof wpSyncPrintSummary    === "function") wpSyncPrintSummary(t);
});

// Speichern
if (E.btnSave) E.btnSave.addEventListener('click', async function(){
  const t = (typeof wpCurrentTask === "function") ? wpCurrentTask() : null;
  if (!t){ alert("Bitte eine Aufgabe w√§hlen."); return; }

  // Intervall √ºbernehmen/validieren
  let inter = toInt((E.interval && E.interval.value) ? E.interval.value : "", NaN);
  if (!Number.isFinite(inter) || inter < 1) inter = "";
  t.intervalDays = inter;

  // Datum normalisieren
  let v = (E.last && E.last.value) ? E.last.value.trim() : "";
  const mm = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (mm) { v = mm[3] + '-' + mm[2] + '-' + mm[1]; if (E.last) E.last.value = v; }
  t.lastDateISO = (/^\d{4}-\d{2}-\d{2}$/.test(v)) ? v : "";

  // Nippelzahl √ºbernehmen
  const nipVal = toInt((E.nip && E.nip.value) ? E.nip.value : "", NaN);
  if (Number.isFinite(nipVal) && nipVal >= 0) t.nipples = nipVal; else delete t.nipples;

  if (typeof wpSave        === "function") await wpSave();
  if (typeof wpRecalc      === "function") wpRecalc();
  if (typeof wpEvalWarning === "function") wpEvalWarning();
  if (typeof wpUpdateGlobalBanner === "function") wpUpdateGlobalBanner();
  if (typeof wpSyncPrintSummary   === "function") wpSyncPrintSummary(t);
});

// L√∂schen
if (E.btnDel) E.btnDel.addEventListener('click', async function(){
  const m  = (E.selMaschine && E.selMaschine.value) ? E.selMaschine.value : "";
  const id = (E.selTask && E.selTask.value) ? E.selTask.value : "";
  if (!m || !id) return;
  if (!confirm("Diese Wartungsaufgabe wirklich l√∂schen?")) return;

  wartungsplaene[m] = (wartungsplaene[m] || []).filter(function(x){ return String(x.id) !== String(id); });
  if (typeof wpSave === "function") await wpSave();

  if (typeof wpRefreshTaskList     === "function") wpRefreshTaskList();
  if (typeof wpStatusUpdateForTask === "function") wpStatusUpdateForTask(null);
  if (typeof wpEvalWarning         === "function") wpEvalWarning();
  if (typeof wpUpdateGlobalBanner  === "function") wpUpdateGlobalBanner();
  if (typeof wpSyncPrintSummary    === "function") wpSyncPrintSummary(null);
});
if (E.btnDone) E.btnDone.addEventListener("click", async function () {
  const t = (typeof wpCurrentTask === "function") ? wpCurrentTask() : null;
  if (!t) { alert("Bitte eine Aufgabe w√§hlen."); return; }

  // √úberf√§lligkeit auf Basis des bisherigen Standes pr√ºfen (BEVOR wir lastDateISO √ºberschreiben)
  const today = wpTodayISO();
  const prevLast = (t.lastDateISO || "").trim();
  const prevNext = (prevLast && t.intervalDays) ? wpComputeNext(prevLast, t.intervalDays) : "";
  const isOverdue = (prevNext && prevNext < today);

  let overdueComment = "";
  if (isOverdue) {
    overdueComment = prompt(
      "‚ö†Ô∏è Diese Wartung ist √úBERF√ÑLLIG.\nBitte kurz kommentieren, warum sie √ºberf√§llig ist:",
      ""
    );

    overdueComment = (overdueComment || "").trim();

    if (!overdueComment) {
      alert("Abgebrochen: F√ºr √ºberf√§llige Wartungen ist ein Kommentar Pflicht.");
      return;
    }

    // optional: Mindestl√§nge
    if (overdueComment.length < 10) {
      alert("Bitte etwas ausf√ºhrlicher kommentieren (mind. 10 Zeichen).");
      return;
    }
  }

  // Heute erst JETZT setzen
  t.lastDateISO = today;

  try {
    if (typeof wpLogExecution === "function") {
      await wpLogExecution({
        dateISO       : t.lastDateISO,
        machine       : (E.selMaschine && E.selMaschine.value) ? E.selMaschine.value : "",
        taskName      : t.name,
        intervalDays  : t.intervalDays,
        nipples       : t.nipples,
        technician    : (E.selTechniker1 && E.selTechniker1.value) ? E.selTechniker1.value : "",
        overdueComment: overdueComment,  // ‚úÖ neu
        prevNextDue   : prevNext         // optional
      });
    }
  } catch (e) {
    console.error("[WP] Fehler bei 'Heute durchgef√ºhrt'", e);
    alert("Speichern fehlgeschlagen. Bitte erneut versuchen.");
    return; // ‚úÖ wichtig
  }

  if (typeof wpRecalc === "function") wpRecalc();
  if (typeof wpEvalWarning === "function") wpEvalWarning();
  if (typeof wpUpdateGlobalBanner === "function") wpUpdateGlobalBanner();
  if (typeof wpSyncPrintSummary === "function") wpSyncPrintSummary(t);
});



// Initialisieren
if (typeof wpRefreshTaskList === "function") wpRefreshTaskList();
const initTask = (typeof wpCurrentTask === "function") ? wpCurrentTask() : null;
if (typeof wpStatusUpdateForTask === "function") wpStatusUpdateForTask(initTask);
if (typeof wpEvalWarning         === "function") wpEvalWarning();
if (typeof wpUpdateGlobalBanner  === "function") wpUpdateGlobalBanner();
if (typeof wpSyncPrintSummary    === "function") wpSyncPrintSummary(initTask);

}


/* ---------- Init ---------- */

document.addEventListener("DOMContentLoaded", async function () {
  if (typeof wpLoad    === "function") await wpLoad();
  if (typeof wpLogLoad === "function") await wpLogLoad();

  // Wartungs-UI initialisieren
  if (typeof setupWartungsplanUI === "function") setupWartungsplanUI();

  // aktuellen Task holen und alle Anzeigen synchronisieren
  if (typeof wpRefreshTaskList === "function") wpRefreshTaskList();
  const cur = (typeof wpCurrentTask === "function") ? wpCurrentTask() : null;

  if (typeof wpStatusUpdateForTask === "function") wpStatusUpdateForTask(cur);
  if (typeof wpEvalWarning         === "function") wpEvalWarning();
  if (typeof wpUpdateGlobalBanner  === "function") wpUpdateGlobalBanner();
  if (typeof wpSyncPrintSummary    === "function") wpSyncPrintSummary(cur);
  if (typeof wpSyncImageButton     === "function") wpSyncImageButton(cur);  // üëà neu: Bild-Button setzen

  // √úberf√§llige Aufgaben pr√ºfen (wie bisher)
  try {
    if (typeof window.wpCheckOverdueAndNotify === "function") {
      window.wpCheckOverdueAndNotify({ sendMail: false });
    }
  } catch (e) {}
});

</script>






<script>
(function hookLogin(){
  var orig = window.signInAndAcquireToken;
  if (typeof orig === "function"){
    window.signInAndAcquireToken = async function(){
      var r = await orig.apply(this, arguments);
      try {
        if (typeof window.wpLoad === "function")            { await window.wpLoad(); }
        if (typeof window.wpLogLoad === "function")         { await window.wpLogLoad(); }
        if (typeof window.loadWpLog === "function")         { await window.loadWpLog(); }

        if (typeof window.wpBuildIndex === "function")      { window.wpBuildIndex(); }
        if (typeof window.wpRefreshTaskList === "function"){ window.wpRefreshTaskList(); }
        if (typeof window.wpCurrentTask === "function" &&
            typeof window.wpStatusUpdateForTask === "function"){
              window.wpStatusUpdateForTask(window.wpCurrentTask());
        }
        if (typeof window.wpEvalWarning === "function")     { window.wpEvalWarning(); }
        if (typeof window.wpUpdateGlobalBanner === "function"){ window.wpUpdateGlobalBanner(); }
        if (typeof window.wpCheckOverdueAndNotify === "function"){
          window.wpCheckOverdueAndNotify({ sendMail:true });
        }
      } catch(e){}
      return r;
    };
  }
})();


</script>


<script>

// ===== Wartungs-Dashboard (Log) =====
// *** Selbstversorgender Block: nutzt localStorage und deine bestehenden Felder ***

// Ein global geteilter Key ‚Äì ok so


function _wpNorm(s){ return String(s||"").toLowerCase().trim(); }
function _wpFmtISO(s){ return s || ""; }
function _byId(id){ return document.getElementById(id); }
function _toISO(d){
  if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
  var dt = (d instanceof Date) ? d : new Date();
  return dt.getFullYear() + "-" + String(dt.getMonth()+1).padStart(2,"0") + "-" + String(dt.getDate()).padStart(2,"0");
}

// sel: Element ODER ID-String
function _getSelectText(sel){
  var el = (typeof sel === "string") ? _byId(sel) : sel;
  if (!el) return "";
  var opt = (el.options && el.options[el.selectedIndex]) ? el.options[el.selectedIndex] : null;
  var txt = opt ? (opt.textContent || opt.innerText || "") : "";
  return (txt || el.value || "").trim();
}

// kleines Helferlein zum sicheren Lesen von .value
function _val(id){
  var el = _byId(id);
  return (el && typeof el.value !== "undefined") ? el.value : "";
}

function _collectEntryFromForm(opts){
  opts = opts || {};
  var useTodayIfEmpty = !!opts.useTodayIfEmpty;
  var todayISO = _toISO(new Date());

  var dateRaw = _val("wpLastDate");
  var dateISO = dateRaw || (useTodayIfEmpty ? todayISO : "");

  // angemeldeten User (Fallback)
  var u = (typeof getSignedInUser === "function") ? getSignedInUser() : { name:"", email:"" };

  // Formularwert (Techniker) hat Vorrang
  var techFromForm = (_val("techniker1") || _val("f_techniker")).trim();

  var inter = parseInt(_val("wpIntervalDays"), 10);
  if (!Number.isFinite(inter)) inter = "";

  var nip = parseInt(_val("wpNipCount"), 10);
  if (!Number.isFinite(nip)) nip = "";

  return {
    dateISO      : _toISO(dateISO),
    machine      : _val("maschine") || "",
    taskName     : _getSelectText("wpTaskSelect") || _val("wpTaskSelect") || "",
    intervalDays : inter,
    nipples      : nip,
    technician       : techFromForm || u.name || "",
    technicianEmail  : u.email || ""
  };
}







// ===== Ausf√ºhrung einer Wartung + Speichern (cloud-first) =====
// ===== Ausf√ºhrung einer Wartung + Speichern (cloud-first) =====
async function wpLogExecution(entry) {
  // 1) Eingabe absichern
  var src = (entry && typeof entry === "object") ? entry : {};

  // aktuell angemeldeter User (Fallback)
  var u = (typeof getSignedInUser === "function")
    ? getSignedInUser()
    : { name: "", email: "", upn: "" };

  // 2) Felder normalisieren
  var dateISO;
  try {
    if (typeof _toISO === "function") {
      dateISO = _toISO(src.dateISO || new Date());
    } else {
      var d = src.dateISO ? new Date(src.dateISO) : new Date();
      dateISO = d.toISOString().slice(0, 10);
    }
  } catch (_) {
    dateISO = (new Date()).toISOString().slice(0, 10);
  }

  var machine      = src.machine  ? String(src.machine).trim()  : "";
  var taskName     = src.taskName ? String(src.taskName).trim() : "";
  var intervalDays = (src.intervalDays === "" || src.intervalDays == null) ? "" : Number(src.intervalDays);
  var nipples      = (src.nipples      === "" || src.nipples      == null) ? "" : Number(src.nipples);

  var technician = (src.technician && String(src.technician).trim())
    ? String(src.technician).trim()
    : (u.name || "");

  var technicianEmail = (src.technicianEmail && String(src.technicianEmail).trim())
    ? String(src.technicianEmail).trim()
    : (u.email || "");

  var technicianUpn = (src.technicianUpn && String(src.technicianUpn).trim())
    ? String(src.technicianUpn).trim()
    : (u.upn || "");

  // ‚úÖ Kommentar + optional prevNextDue normalisieren
  var overdueComment = (src.overdueComment && String(src.overdueComment).trim())
    ? String(src.overdueComment).trim()
    : "";

  var prevNextDue = (src.prevNextDue && String(src.prevNextDue).trim())
    ? String(src.prevNextDue).trim()
    : "";

  // 3) finaler Eintrag
  var e = {
    dateISO        : dateISO,
    machine        : machine,
    taskName       : taskName,
    intervalDays   : intervalDays,
    nipples        : nipples,
    technician     : technician,
    technicianEmail: technicianEmail,
    technicianUpn  : technicianUpn,

    // ‚úÖ optional: hilft sp√§ter f√ºrs Nachvollziehen
    prevNextDue    : prevNextDue,

    // ‚úÖ Audit: Kommentar + wer/wann
    overdueComment        : overdueComment,
    overdueCommentedAt    : overdueComment ? (new Date()).toISOString() : "",
    overdueCommentedByName: overdueComment ? technician : "",
    overdueCommentedByUpn : overdueComment ? technicianUpn : ""
  };

  // 4) Bisherige Liste laden (Cloud ‚Üí local ‚Üí RAM)
  let list = [];
  try { list = await _loadAll(); } catch (_) { list = []; }
  if (!Array.isArray(list)) list = [];

  list.push(e);

  // 5) Speichern (lokal + Cloud)
  try {
    await _saveAll(list);
  } catch (err) {
    console.warn("[WP] saveAll failed:", err);
  }

  // globale Kopie aktualisieren
  window.wartungslog = list.slice();

  // 6) UI aktualisieren
  try {
    if (typeof loadWpLog === "function") {
      await loadWpLog();
    } else if (typeof renderWpLogTable === "function") {
      renderWpLogTable();
    }
  } catch (e) {
    console.warn("[WP] Fehler beim Refresh des Wartungs-Logs:", e);
  }

  try {
    if (typeof window.wpRefreshOverdueUI === "function") {
      window.wpRefreshOverdueUI();
    }
  } catch (e) {
    console.warn("[WP] Fehler beim Overdue-Refresh:", e);
  }

  return e;
}








// ‚ûï Fallback-Anzeige f√ºr die Techniker-Spalte (f√ºr alte/leere Eintr√§ge)
function displayTechnicianFor(entry){
  if (entry && entry.technician && entry.technician.trim()) return entry.technician;
  const u = (typeof getSignedInUser === 'function') ? getSignedInUser() : null;
  return (u && u.name) ? u.name : "‚Äì";
}


function _wpDateInputToISO(s){
  s = (s == null) ? "" : String(s).trim();
  if (!s) return "";

  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // deutsch: 5.1.2025 oder 05.01.2025
  var m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if (m) {
    var dd = String(m[1]).padStart(2,"0");
    var mm = String(m[2]).padStart(2,"0");
    return m[3] + "-" + mm + "-" + dd;
  }

  // 2025.12.15
  m = s.match(/^(\d{4})\.(\d{2})\.(\d{2})$/);
  if (m) return m[1] + "-" + m[2] + "-" + m[3];

  // fallback: lieber nichts filtern statt falsch filtern
  return "";
}




function wpLogApplyFilters(list){
  // Elemente sicher holen (JETZT scoped)
  var fromEl = _wpEl("wpLog_from");
  var toEl   = _wpEl("wpLog_to");
  var mEl    = _wpEl("wpLog_machine");
  var tEl    = _wpEl("wpLog_task");
  var techEl = _wpEl("wpLog_tech");

  var fromRaw = (fromEl && typeof fromEl.value !== "undefined") ? fromEl.value : "";
  var toRaw   = (toEl   && typeof toEl.value   !== "undefined") ? toEl.value   : "";

  var from = _wpDateInputToISO(fromRaw);
  var to   = _wpDateInputToISO(toRaw);

  var m    = _wpNorm(mEl    && typeof mEl.value    !== "undefined" ? mEl.value    : "");
  var t    = _wpNorm(tEl    && typeof tEl.value    !== "undefined" ? tEl.value    : "");
  var tech = _wpNorm(techEl && typeof techEl.value !== "undefined" ? techEl.value : "");

  var arr = Array.isArray(list) ? list : [];

  return arr.filter(function(e){
    var dateISO = (e && e.dateISO) ? e.dateISO : "";

    if (from && dateISO < from) return false;
    if (to   && dateISO > to)   return false;

    if (m){
      var em = _wpNorm(e && e.machine ? e.machine : "");
      if (!em.includes(m)) return false;
    }

    if (t){
      var et = _wpNorm(e && e.taskName ? e.taskName : "");
      if (!et.includes(t)) return false;
    }

    if (tech){
      var u = (typeof getSignedInUser === "function") ? getSignedInUser() : { name:"", email:"", upn:"" };
      var hay = [
        e ? e.technician : "", e ? e.technicianEmail : "", e ? e.technicianUpn : "",
        (!e || !e.technician ? u.name : ""), (!e || !e.technicianEmail ? u.email : ""), (!e || !e.technicianUpn ? u.upn : "")
      ].filter(Boolean).map(_wpNorm).join(" ");

      if (!hay.includes(tech)) return false;
    }

    return true;
  }).sort(function(a,b){
    var ad = (a && a.dateISO) ? a.dateISO : "";
    var bd = (b && b.dateISO) ? b.dateISO : "";
    return bd.localeCompare(ad);
  });
}



function renderWpLogTable(){
  var body  = _byId("wpLogBody");   // <tbody id="wpLogBody">
  var empty = _byId("wpLogEmpty");  // optional: <tr id="wpLogEmpty">‚Ä¶</tr>
  if (!body) return;

  // Daten holen + filtern (Guard)
  var source = Array.isArray(window.wartungslog) ? window.wartungslog : [];
  var rows   = (typeof wpLogApplyFilters === "function") ? wpLogApplyFilters(source) : source;

  // Empty-State
  if (!rows || !rows.length){
    body.innerHTML = "";
    if (empty) empty.style.display = "table-row"; // oder "block", je nach Markup
    return;
  }
  if (empty) empty.style.display = "none";

  // kleine TD-Helferfunktion (kein Arrow)
  function td(txt){
    return '<td style="padding:8px;border-bottom:1px solid #eee;">' + txt + '</td>';
  }

  // Zeilen aufbauen (ohne Arrow, ohne Nullish-Coalescing)
  var html = "";
  for (var i=0; i<rows.length; i++){
    var e = rows[i] || {};
    var inter = (e.intervalDays !== "" && e.intervalDays != null) ? e.intervalDays : "‚Äì";
    var nip   = (e.nipples      !== "" && e.nipples      != null) ? e.nipples      : "‚Äì";

    var tech  = (typeof displayTechnicianFor === "function")
      ? displayTechnicianFor(e)
      : (e.technician || "‚Äì");

    html += '<tr>'
          +   td(_wpFmtISO(e.dateISO))
          +   td(e.machine  || '‚Äì')
          +   td(e.taskName || '‚Äì')
          +   td(inter)
          +   td(nip)
          +   td(tech)
          + '</tr>';
  }

  body.innerHTML = html;
}


async function toggleWpLogPanel(){
  var p = _byId("wpLogPanel");
  if (!p) return;
  var orders = _byId("dashPanel");
  if (orders && orders.style.display === "block") orders.style.display = "none";

  var willOpen = (p.style.display==="none" || !p.style.display);
  p.style.display = willOpen ? "block" : "none";

  if (willOpen){
    if (typeof wpLogLoad === "function") await wpLogLoad();
    renderWpLogTable();
  }
}


function bindWpLogUi(){
  var ids = ["wpLog_from","wpLog_to","wpLog_machine","wpLog_task","wpLog_tech"];

  for (var i=0; i<ids.length; i++){
    var el = _wpEl(ids[i]);
    if (el) el.addEventListener("input", renderWpLogTable);
  }

  var btnReload = _wpEl("wpLogReload");
  if (btnReload) btnReload.addEventListener("click", async function(){
    try {
      if (typeof wpLogLoad === "function") await wpLogLoad();
    } catch (e) {
      console.warn("wpLogLoad beim Reload:", e);
    }
    renderWpLogTable();
  });

  var btnClear = _wpEl("wpLogClear");
  if (btnClear) btnClear.addEventListener("click", function(){
    for (var i=0; i<ids.length; i++){
      var el = _wpEl(ids[i]); if (el) el.value = "";
    }
    var rangeBtn = _wpEl("wpLogRangeBtn");
    if (rangeBtn) { rangeBtn.dataset.mode = "30"; rangeBtn.textContent = "üóìÔ∏è Letzte 30 Tage"; }
    renderWpLogTable();
  });

  var rangeBtn = _wpEl("wpLogRangeBtn");
  if (rangeBtn) rangeBtn.addEventListener("click", function(ev){
    var btn   = ev.currentTarget || ev.target;
    var mode  = String((btn && btn.dataset && btn.dataset.mode) || "30");

    var today = new Date();
    var from  = new Date(today);

    if (mode === "30"){
      from.setDate(from.getDate() - 30);
      btn.dataset.mode = "90";
      btn.textContent  = "üóìÔ∏è Letzte 90 Tage";
    } else if (mode === "90"){
      from.setDate(from.getDate() - 90);
      btn.dataset.mode = "7";
      btn.textContent  = "üóìÔ∏è Letzte 7 Tage";
    } else {
      from.setDate(from.getDate() - 7);
      btn.dataset.mode = "30";
      btn.textContent  = "üóìÔ∏è Letzte 30 Tage";
    }

    var elFrom = _wpEl("wpLog_from"); if (elFrom) elFrom.value = _toISO(from);
    var elTo   = _wpEl("wpLog_to");   if (elTo)   elTo.value   = _toISO(today);

    renderWpLogTable();
  });
}




var saveBtn = _byId("wpSaveTask");
if (saveBtn) saveBtn.addEventListener("click", async function(){
  var entry = _collectEntryFromForm({useTodayIfEmpty:true});
  await wpLogExecution(entry);
  

  var pnl=_byId("wpLogPanel");
  if (pnl && pnl.style.display === "block") renderWpLogTable();
  alert("Wartung gespeichert!");
});

var doneBtn = _byId("wpMarkDoneToday");
if (doneBtn) doneBtn.addEventListener("click", async function () {
  // üîí Doppel-/Mehrfachklick verhindern, solange wir verarbeiten
  if (doneBtn.dataset.busy === "1") return;
  doneBtn.dataset.busy = "1";

  try {
    var todayISO = _toISO(new Date());
    var lastEl   = _byId("wpLastDate");
    var nextEl   = _byId("wpNextDue");

    // ‚õî Bereits heute eingetragen? Dann nichts nochmal machen
    if (lastEl && lastEl.value === todayISO) {
      alert("Diese Aufgabe wurde heute bereits als durchgef√ºhrt markiert.");
      doneBtn.dataset.busy = "0";      // Busy-Flag wieder freigeben
      return;
    }

    // üëâ Bisheriges F√§lligkeitsdatum merken (f√ºr √úberf√§lligkeit + Audit)
    var prevNext = (nextEl && nextEl.value) ? String(nextEl.value).trim() : "";
    var isOverdue = false;
    if (prevNext) {
      // ISO-Strings kann man lexikografisch vergleichen
      isOverdue = (prevNext < todayISO);
    }

    // üí¨ Kommentar nur bei √ºberf√§lliger Wartung erzwingen
    var overdueComment = "";
    if (isOverdue) {
      overdueComment = prompt(
        "‚ö†Ô∏è Diese Wartung ist √úBERF√ÑLLIG.\nBitte kurz kommentieren, warum sie √ºberf√§llig ist:",
        ""
      );
      overdueComment = (overdueComment || "").trim();

      if (!overdueComment) {
        alert("Abgebrochen: F√ºr √ºberf√§llige Wartungen ist ein Kommentar Pflicht.");
        doneBtn.dataset.busy = "0";
        return;
      }
      if (overdueComment.length < 10) {
        alert("Bitte etwas ausf√ºhrlicher kommentieren (mind. 10 Zeichen).");
        doneBtn.dataset.busy = "0";
        return;
      }
    }

    // Heutiges Datum in ‚ÄûZuletzt durchgef√ºhrt‚Äú schreiben
    if (lastEl) lastEl.value = todayISO;

    // F√§lligkeit sauber √ºber die neue Logik berechnen
    if (typeof recomputeNextDue === "function") {
      recomputeNextDue();
    }

    // ‚úÖ Eintrag aus Formular holen und Kommentar anh√§ngen
    var entry = _collectEntryFromForm({ useTodayIfEmpty: true });
    entry.overdueComment = overdueComment || "";
    entry.prevNextDue    = prevNext || "";

    await wpLogExecution(entry);

    var pnl = _byId("wpLogPanel");
    if (pnl && pnl.style.display === "block") renderWpLogTable();
  } catch (e) {
    console.error("wpMarkDoneToday:", e);
    alert("Speichern fehlgeschlagen. Bitte erneut versuchen.");
  } finally {
    // üîì Button wieder freigeben (auch bei Abbruch/Fehler)
    doneBtn.dataset.busy = "0";
  }
});
;

document.addEventListener("DOMContentLoaded", () => {
  // UI-Events f√ºrs Wartungs-Dashboard verdrahten
  try {
    bindWpLogUi();
  } catch (e) {
    console.warn("bindWpLogUi:", e);
  }

  // still versuchen, den Benutzer anzumelden
  // -> holt auch OneDrive-Ordner + Wartungslog
  signInAndAcquireToken(false, { rebuild: true });
});




</script>
<script>
// === 1) F√§lligkeit immer sauber nachziehen ===
(function(){
  const byId = (id)=>document.getElementById(id);



// Kompatibilit√§t f√ºr alten Code
// Kompatibilit√§t f√ºr alten Code
window.todayISO = window.todayISO || function () {
  return _toISO(new Date());
};




function recomputeNextDue(){
  var lastEl = byId("wpLastDate");          // Zuletzt durchgef√ºhrt
  var intvEl = byId("wpIntervalDays");
  var out    = byId("wpNextDue");
  if (!out) return;

  var last = (lastEl && typeof lastEl.value !== "undefined") ? lastEl.value : "";
  var intv = parseInt((intvEl && intvEl.value ? intvEl.value : "0"), 10) || 0;

  if (!last || !intv) { out.value = ""; return; }

  var d = new Date(last);
  if (isNaN(d.getTime())) { out.value = ""; return; } // ung√ºltiges Datum abfangen

  d.setDate(d.getDate() + intv);                      // funktioniert auch bei Intervall = 1

  // üîß ISO-Datum setzen ‚Äì zuerst _toISO, dann ggf. toISO, sonst manuell
  if (typeof _toISO === "function") {
    out.value = _toISO(d);
  } else if (typeof toISO === "function") {
    out.value = toISO(d);
  } else {
    out.value =
      d.getFullYear() + "-" +
      String(d.getMonth() + 1).padStart(2, "0") + "-" +
      String(d.getDate()).padStart(2, "0");
  }
}


// bei manuellen √Ñnderungen neu berechnen
// Wartungs-Log: Wiring beim Laden
window.addEventListener("load", function () {
  // Zeitraum-Button einmal ausl√∂sen (optional)
  var rangeBtn = document.getElementById("wpLogRangeBtn");
  if (rangeBtn && typeof setWpRange === "function") setWpRange(rangeBtn);

  // Initial laden
  if (typeof loadWpLog === "function") loadWpLog();

  // Buttons
  var reloadBtn = document.getElementById("wpLogReload");
  if (reloadBtn) reloadBtn.addEventListener("click", function(){ if (typeof loadWpLog==="function") loadWpLog(); });

  var clearBtn = document.getElementById("wpLogClear");
  if (clearBtn && typeof clearWpFilters === "function")
    clearBtn.addEventListener("click", function(){ clearWpFilters(); });

  var toggleBtn = document.getElementById("toggleWpLogBtn");
  if (toggleBtn) {
    toggleBtn.addEventListener("click", function(){
      // nach dem √ñffnen kurz warten, dann rendern
      setTimeout(function(){ if (typeof loadWpLog==="function") loadWpLog(); }, 60);
    });
  }

  // Live-Filter
  var ids = ["wpLog_from","wpLog_to","wpLog_machine","wpLog_task","wpLog_tech"];
  for (var i=0; i<ids.length; i++){
    var el = document.getElementById(ids[i]);
    if (el) el.addEventListener("input", function(){ if (typeof loadWpLog==="function") loadWpLog(); });
  }

  // Falls Panel beim Start schon offen ist
  var panel = document.getElementById("wpLogPanel");
  if (panel && panel.style.display !== "none") { if (typeof loadWpLog==="function") loadWpLog(); }
});

})();   // ‚Üê schlie√üt die erste IIFE

(function(){
  const byId = (id)=>document.getElementById(id);
  const PLACEHOLDER_TEXT = "Bitte ausw√§hlen";

  // Snapshots je Maschine (Key = Maschinenwert)
  const SNAPSHOT_BY_MACHINE = new Map();
  let childObserver = null, docObserver = null;
  let currentSelect = null;
  let restoring = false;

  function norm(s){ return String(s||"").trim().toLowerCase(); }
function getMachineKey(){
  var el = byId("maschine");
  var v = (el && typeof el.value !== "undefined") ? el.value : "";
  v = (v == null ? "" : String(v)).trim();
  return v || "__default__";
}


  /* ---------- Helfer ---------- */
  function takeSnapshotForMachine(sel){
    if (!sel || !sel.options.length) return;
    const key  = getMachineKey();
    const snap = Array.from(sel.options).map(o => ({ v:o.value, t:o.textContent }));
    SNAPSHOT_BY_MACHINE.set(key, snap);
  }

  function ensurePlaceholder(sel){
    if (!sel) return;
    if (!sel.options.length){
      sel.add(new Option(PLACEHOLDER_TEXT, ""));
      sel.value = "";
      return;
    }
    const first = sel.options[0];
    if (!first || norm(first.textContent) !== norm(PLACEHOLDER_TEXT)){
      const hasPH = Array.from(sel.options)
        .some(o => norm(o.textContent) === norm(PLACEHOLDER_TEXT) && o.value === "");
      if (!hasPH) sel.insertBefore(new Option(PLACEHOLDER_TEXT, ""), sel.firstChild);
      sel.value = "";
    }
  }

  function restoreOptionsIfEmpty(sel){
    if (!sel || restoring) return;
    if (sel.options.length > 0) return;

    restoring = true;
    try{
      const key  = getMachineKey();
      const snap = SNAPSHOT_BY_MACHINE.get(key) || SNAPSHOT_BY_MACHINE.get("__default__");
      sel.innerHTML = "";
      if (snap && snap.length){
        snap.forEach(o => sel.add(new Option(o.t, o.v)));
      }
      ensurePlaceholder(sel);
    } finally { restoring = false; }
  }

  // ‚§µÔ∏è global verf√ºgbar machen (wichtig f√ºr iPad/Safari)
  window.takeSnapshotForMachine = window.takeSnapshotForMachine || takeSnapshotForMachine;
  window.restoreOptionsIfEmpty  = window.restoreOptionsIfEmpty  || restoreOptionsIfEmpty;
  window.ensurePlaceholder      = window.ensurePlaceholder      || ensurePlaceholder;

  function attachChildObserver(sel){
    if (!sel) return;
    if (childObserver) childObserver.disconnect();
    childObserver = new MutationObserver(() => {
      if (!sel.options.length) restoreOptionsIfEmpty(sel);
    });
    childObserver.observe(sel, { childList: true });
  }

  function attachToSelect(){
    const sel = byId("wpTaskSelect");
    if (!sel) return false;
    currentSelect = sel;

    // Nach kleinem Delay snappen (falls anderes Skript gerade bef√ºllt)
    setTimeout(()=>{
      // Default-Snapshot einmalig merken
      if (!SNAPSHOT_BY_MACHINE.has("__default__") && sel.options.length){
        SNAPSHOT_BY_MACHINE.set(
          "__default__", Array.from(sel.options).map(o => ({v:o.value, t:o.textContent}))
        );
      }

      takeSnapshotForMachine(sel);
      restoreOptionsIfEmpty(sel);       // falls leer ‚Üí wieder bef√ºllen
      ensurePlaceholder(sel);

      // Fallback: wenn danach noch leer, aus Pl√§nen bef√ºllen
      if ((!sel.options || sel.options.length === 0) &&
          typeof rebuildWpTaskSelectFromPlans === "function") {
        if (!rebuildWpTaskSelectFromPlans() && typeof ensureNotEmpty === "function") {
          ensureNotEmpty();
        }
      }

      attachChildObserver(sel);
    }, 150);

    return true;
  }

  function watchForReplacement(){
    if (docObserver) docObserver.disconnect();
    docObserver = new MutationObserver(()=>{
      const sel = byId("wpTaskSelect");
      if (sel && sel !== currentSelect){
        currentSelect = sel;
        takeSnapshotForMachine(sel);
        restoreOptionsIfEmpty(sel);
        ensurePlaceholder(sel);

        // Fallback auch hier
        if ((!sel.options || sel.options.length === 0) &&
            typeof rebuildWpTaskSelectFromPlans === "function") {
          if (!rebuildWpTaskSelectFromPlans() && typeof ensureNotEmpty === "function") {
            ensureNotEmpty();
          }
        }

        attachChildObserver(sel);
      }
    });
    docObserver.observe(document.body, { childList: true, subtree: true });
  }

function onMachineChange(){
  setTimeout(function(){
    var sel = byId("wpTaskSelect");
    if (!sel) return;

    if (typeof window.takeSnapshotForMachine === "function") window.takeSnapshotForMachine(sel);
    if (typeof window.restoreOptionsIfEmpty  === "function") window.restoreOptionsIfEmpty(sel);
    if (typeof window.ensurePlaceholder      === "function") window.ensurePlaceholder(sel);

    if ((!sel.options || sel.options.length === 0) &&
        typeof rebuildWpTaskSelectFromPlans === "function") {
      if (!rebuildWpTaskSelectFromPlans() && typeof ensureNotEmpty === "function") {
        ensureNotEmpty();
      }
    }
  }, 150);
}

/* ---------- Wiring ---------- */
window.addEventListener("load", function(){
  if (typeof attachToSelect === "function") attachToSelect();
  if (typeof watchForReplacement === "function") watchForReplacement();

  var m = byId("maschine");
  if (m) m.addEventListener("change", onMachineChange);

  var btn = byId("toggleWpLogBtn");
  if (btn) {
    btn.addEventListener("click", function(){
      setTimeout(function(){
        var sel = byId("wpTaskSelect");
        if (!sel) return;

        if (typeof window.takeSnapshotForMachine === "function") window.takeSnapshotForMachine(sel);
        if (typeof window.restoreOptionsIfEmpty  === "function") window.restoreOptionsIfEmpty(sel);
        if (typeof window.ensurePlaceholder      === "function") window.ensurePlaceholder(sel);

        if ((!sel.options || sel.options.length === 0) &&
            typeof rebuildWpTaskSelectFromPlans === "function") {
          if (!rebuildWpTaskSelectFromPlans() && typeof ensureNotEmpty === "function") {
            ensureNotEmpty();
          }
        }
      }, 150);
    });
  }
});          // schlie√üt den load-Event-Handler
})();        // schlie√üt die √§u√üere IIFE `(function(){ ... })`

</script>


<script>
/* ===== Overdue-Alarm f√ºr Wartung: Badge + Hinweis + optionaler Beep =====
   - Nimmt letzte Ausf√ºhrung pro (Maschine + Aufgabe) aus window.wartungslog
   - nextDue = lastDate + intervalDays
   - "√úberf√§llig" wenn nextDue < heute
   - Roter Punkt am Button + Hinweisleiste im Panel
   - Optional: kurzer Beep beim √ñffnen
*/
(function(){
  // ===== Allgemeine Helfer =====
  function _wpNorm(s){ return String(s||"").toLowerCase().trim(); }
  function _wpFmtISO(s){ return s || ""; }
  function _byId(id){ return document.getElementById(id); }
  function _toISO(d){
    if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    const dt = d instanceof Date ? d : new Date();
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
  }

  // ===== Wartungs-Helfer (Datum, Vergleiche etc.) =====
  function toISO(d){
    if (typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    const dt = d instanceof Date ? d : new Date();
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
  }
  function addDays(iso, n){
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d)) return "";
    d.setDate(d.getDate() + Number(n || 0));
    return toISO(d);
  }
  function cmpISO(a, b){
    return a === b ? 0 : (a < b ? -1 : 1); // nur YYYY-MM-DD
  }

// ===== Wartungsberechnung (cloud-ready, async) =====
async function computeDueMap(){
  // Stelle sicher, dass window.wartungslog gef√ºllt ist
  try {
    if (typeof wpLogLoad === "function") {
      const maybePromise = wpLogLoad();
      if (maybePromise && typeof maybePromise.then === "function") {
        await maybePromise; // async Variante warten
      }
    } else if (typeof _loadAll === "function") {
      // Fallback: direkt aus Cloud/Cache laden
      try {
        const raw = await _loadAll();
        window.wartungslog = Array.isArray(raw) ? raw : [];
      } catch { window.wartungslog = []; }
    }
  } catch { /* ignorieren, unten mit leerer Liste weiter */ }

  const list = Array.isArray(window.wartungslog) ? window.wartungslog : [];
  const map = new Map();

  // === Deine bestehende Aggregationslogik hier beibehalten ===
  // Beispiel (falls du so etwas schon hattest):
  // key = Maschine + '|' + Aufgabe
  for (const e of list) {
    const key = (e.machine || "") + "|" + (e.taskName || "");
    const curr = map.get(key) || {
      machine: e.machine || "",
      taskName: e.taskName || "",
      lastDate: null,
      intervalDays: e.intervalDays || "",
      nextDue: null,
      status: "ok"
    };

    // lastDate aktualisieren
    const d = e.dateISO || e.date || "";
    if (d && (!curr.lastDate || d > curr.lastDate)) curr.lastDate = d;

    // intervalDays konsolidieren (falls leer, behalten)
    if (e.intervalDays != null && e.intervalDays !== "") curr.intervalDays = e.intervalDays;

    map.set(key, curr);
  }

  // nextDue & status berechnen (falls du das so machst)
const today = toISO(new Date());          // lokales YYYY-MM-DD
  for (const [key, row] of map) {
    if (row.lastDate && row.intervalDays) {
      const dt = new Date(row.lastDate);
      dt.setDate(dt.getDate() + Number(row.intervalDays));
      row.nextDue = toISO(dt);                  // lokales YYYY-MM-DD
      row.status = (row.nextDue < today) ? "overdue" : "ok";
      map.set(key, row);
    }
  }

  return map;
}



function anyDueOrOverdue(dueMap){
  const t = todayISO();
  for (const [,v] of dueMap) {
    if (v.nextDue && v.nextDue <= t) return true; // heute ODER √ºberf√§llig
  }
  return false;
}

function listDueOrOverdue(dueMap){
  // robust: nutze window.todayISO() wenn vorhanden, sonst toISO(new Date())
  const t = (typeof window.todayISO === 'function')
              ? window.todayISO()
              : toISO(new Date());

  const out = [];
  // akzeptiert Map oder Plain-Object
  const it = (dueMap instanceof Map)
    ? dueMap
    : new Map(Object.entries(dueMap || {}));

  for (const [, v] of it) {
    const next = v && v.nextDue ? String(v.nextDue) : "";
    // ISO-Strings lassen sich lexikographisch vergleichen
    if (next && next <= t) out.push(v);
  }
  return out.sort((a,b)=> (a.nextDue||"").localeCompare(b.nextDue||""));
}

  // --- E-Mail-Versand bei f√§lligen/√ºberf√§lligen Wartungen -----------------
  window.wpSendOverdueMail = async function(dueList) {
    try {
      if (!window.accessToken) {
        console.warn("[WP] Kein accessToken, Mail kann nicht gesendet werden.");
        return;
      }
      if (!Array.isArray(dueList) || !dueList.length) return;

      // HTML-Tabelle f√ºr die Mail bauen
      var rows = dueList.map(function(v){
        var machine = (v.machine || v.maschine || "").toString();
        var task    = (v.task || v.taskName || "").toString();
        var nextDue = (v.nextDue || "").toString();
        var status  = (v.status || "").toString();
        return "<tr>"
             + "<td>" + machine + "</td>"
             + "<td>" + task    + "</td>"
             + "<td>" + nextDue + "</td>"
             + "<td>" + status  + "</td>"
             + "</tr>";
      }).join("");

  var bodyHtml =
  "<p>Hinweis aus der Wartungs-App:</p>"
  + "<p>Es liegen Wartungen an, die heute f√§llig oder bereits √ºberf√§llig sind.</p>"
  + '<table border="1" cellspacing="0" cellpadding="4">'
  +   "<thead>"
  +     "<tr>"
  +       "<th>Maschine</th>"
  +       "<th>Aufgabe</th>"
  +       "<th>F√§llig am</th>"
  +       "<th>Status</th>"
  +     "</tr>"
  +   "</thead>"
  +   "<tbody>" + rows + "</tbody>"
  + "</table>"
  + "<p>Bitte im Wartungs-Dashboard pr√ºfen.</p>";


      var mail = {
        message: {
          subject: "Wartungs-Hinweis: " + dueList.length + " Aufgabe(n) f√§llig/√ºberf√§llig",
          body: {
            contentType: "HTML",
            content: bodyHtml
          },
          toRecipients: [
            { emailAddress: { address: "mike.hafermalz@petri-feinkost.de" } },
            { emailAddress: { address: "merten.thiemann@petri-feinkost.de" } }
          ]
        },
        saveToSentItems: true
      };

      var res = await fetch("https://graph.microsoft.com/v1.0/me/sendMail", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + window.accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(mail)
      });

      if (!res.ok) {
        var txt = "";
        try { txt = await res.text(); } catch(_) {}
        console.error("[WP] sendMail fehlgeschlagen:", res.status, txt);
      } else {
        console.log("[WP] Warn-Mail erfolgreich gesendet.");
      }
    } catch (e) {
      console.error("[WP] Fehler beim Mailversand:", e);
    }
  };

  // --- √ñffentliche Funktion: pr√ºfen + optional Mail senden -----------------
  window.wpCheckOverdueAndNotify = async function(opts) {
    opts = opts || {};
    var sendMail = !!opts.sendMail;

    // 1) F√§lligkeitsdaten berechnen (wie in refreshOverdueUI)
    var map = new Map();
    try {
      if (typeof computeDueMap === "function") {
        var maybe = computeDueMap();
        map = (maybe && typeof maybe.then === "function") ? await maybe : (maybe || new Map());
      }
    } catch(e){ map = new Map(); }

    // 2) heute/√ºberf√§llige Wartungen ermitteln
    var dueList = [];
    try {
      if (typeof listDueOrOverdue === "function") {
        dueList = listDueOrOverdue(map) || [];
      }
    } catch(e){
      console.warn("[WP] listDueOrOverdue Fehler:", e);
      dueList = [];
    }

    if (!dueList.length) {
      console.log("[WP] Keine f√§lligen Wartungen, keine Mail n√∂tig.");
      return;
    }

    // 3) Nur einmal pro Tag eine Mail (pro Browser)
    var d = new Date();
    var today = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
    var LS_KEY = "WP_LAST_OVERDUE_MAIL_DATE";
    var lastDate = null;
    try { lastDate = localStorage.getItem(LS_KEY); } catch(_) {}

    if (sendMail && lastDate === today) {
      console.log("[WP] Warn-Mail heute bereits gesendet.");
      return;
    }

    // 4) E-Mail senden
    if (sendMail) {
      if (typeof window.wpSendOverdueMail === "function") {
        await window.wpSendOverdueMail(dueList);
        try { localStorage.setItem(LS_KEY, today); } catch(_) {}
      } else {
        console.warn("[WP] wpSendOverdueMail nicht definiert.");
      }
    }
  };

  // Roter Punkt am Button + Title/ARIA
  function updateButtonBadge(isOverdue){
    const btn = byId("toggleWpLogBtn");
    if (!btn) return;
    // kleinen roten Punkt rechts neben dem Text einf√ºgen/entfernen
    let dot = btn.querySelector(".wpBadge");
    if (isOverdue) {
      if (!dot) {
        dot = document.createElement("span");
        dot.className = "wpBadge";
        dot.setAttribute("aria-hidden","true");
        dot.style.cssText = "display:inline-block;margin-left:8px;width:8px;height:8px;border-radius:50%;background:#e53935;vertical-align:middle;";
        btn.appendChild(dot);
      }
      btn.setAttribute("title","√úberf√§llige Wartung vorhanden (Alt+W)");
      btn.setAttribute("aria-label","Wartungs-Dashboard ‚Äì √úberf√§llig");
    } else {
      if (dot) dot.remove();
      btn.removeAttribute("title");
      btn.removeAttribute("aria-label");
    }
  }

  // Hinweisbalken im Panel
  function ensurePanelBanner(){
    const panel = byId("wpLogPanel");
    if (!panel) return null;
    let bar = byId("wpOverdueBar");
    if (!bar) {
      bar = document.createElement("div");
      bar.id = "wpOverdueBar";
      bar.style.cssText = "display:none;margin:-12px -12px 12px -12px;padding:10px 12px;background:#fdecea;color:#b71c1c;border-bottom:1px solid #f5c6c6;border-radius:8px 8px 0 0;font-size:14px;";
      bar.textContent = "Achtung: Es gibt √ºberf√§llige Wartungen. Bitte pr√ºfen.";
      panel.insertBefore(bar, panel.firstChild);
    }
    return bar;
  }

  // kurzer Beep (nur nach User-Interaktion zuverl√§ssig)
  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = 880; // A5
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime + 0.02);
      o.start(); o.stop(ctx.currentTime + 0.15);
    } catch(e) {}
  }

// ‚úÖ Async Variante ‚Äì wartet auf computeDueMap()
async function refreshOverdueUI(opts){
  opts = opts || {};
  var beepOnOverdue = !!opts.beepOnOverdue;

  // computeDueMap sicher aufrufen & abwarten
  var map = new Map();
  try {
    if (typeof computeDueMap === "function") {
      const maybe = computeDueMap();
      map = (maybe && typeof maybe.then === "function") ? await maybe : (maybe || new Map());
    }
  } catch(e){ map = new Map(); }

  // todayISO robust holen (alte oder neue Variante)
  function getToday(){
    if (typeof window.todayISO === "function") return window.todayISO();
    if (typeof toISO === "function") return toISO(new Date());
    var d = new Date();
    return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
  }

  // heute/√ºberf√§llige sammeln (synchron)
  var dueList = [];
  try { dueList = (typeof listDueOrOverdue === "function") ? listDueOrOverdue(map) : []; } catch(_) {}

  // Badge aktualisieren
  if (typeof updateButtonBadge === "function") {
    try { updateButtonBadge(dueList.length > 0); } catch(e){}
  }

  // Panel-Hinweisleiste (Dashboard)
  var bar = (typeof ensurePanelBanner === "function") ? ensurePanelBanner() : null;
  if (bar){
    if (dueList.length) {
      bar.style.display = "block";
      bar.textContent = "Hinweis: " + dueList.length + " Wartung(en) heute/√ºberf√§llig.";
    } else {
      bar.style.display = "none";
    }
  }

  // Optionaler akustischer Hinweis
  if (dueList.length && beepOnOverdue && typeof beep === "function") {
    try { beep(); } catch(e){}
  }

  // üîî Globaler Hinweis/Banner au√üerhalb des Dashboards
  if (typeof renderGlobalOverdueUI === "function") {
    var today = getToday();
    var globalDue = [];
    for (var i=0;i<dueList.length;i++){
      var v = dueList[i] || {};
      var nextDue = v.nextDue || "";
      globalDue.push({
        machine: v.machine || "",
        task: v.taskName || "",
        nextDue: nextDue,
        status: (nextDue < today) ? "overdue" : ((nextDue === today) ? "today" : "ok")
      });
    }
    try { renderGlobalOverdueUI(globalDue); } catch(e){}
  }
}


// Beim Panel-√ñffnen -> Hinweis aktualisieren + optional Beep
var btn = byId("toggleWpLogBtn");
if (btn) {
  btn.addEventListener("click", function () {
    setTimeout(async function () {
      try { await refreshOverdueUI({ beepOnOverdue: true }); } catch (e) {}
    }, 60);
  });
}

// Nach ‚ÄûSpeichern‚Äú / ‚ÄûHeute durchgef√ºhrt‚Äú aktualisieren
function safe(id){
  var el = byId(id);
  if (el) {
    el.addEventListener("click", function(){
      setTimeout(async function(){
        try { await refreshOverdueUI(); } catch(e){}
      }, 60);
    });
  }
}
safe("wpSaveTask");
safe("wpMarkDoneToday");

// Falls Log-Funktion direkt genutzt wird, nach jedem Schreiben refreshen
if (typeof window.wpLogExecution === "function") {
  (function () {
    var orig = window.wpLogExecution;
    window.wpLogExecution = async function (entry) {
      var r = await orig.apply(this, arguments);
      try { await refreshOverdueUI(); } catch (e) {}
      return r;
    };
  })();
}


// Tastenk√ºrzel: Alt+W toggelt Panel und refresht UI
window.addEventListener("keydown", async function (e) {
  if (e.altKey && (e.key === "w" || e.key === "W")) {
    e.preventDefault();
    var p = byId("wpLogPanel");
    if (!p) { alert("Hinweis: #wpLogPanel nicht gefunden."); return; }
    var open = (p.style.display === "" || p.style.display === "none");
    p.style.display = open ? "block" : "none";
    try { if (open && typeof wpLogLoad === "function") {
      const ret = wpLogLoad();
      if (ret && typeof ret.then === "function") await ret;
    }} catch (err) {}
    try { if (open && typeof renderWpLogTable === "function") renderWpLogTable(); } catch (err) {}
    setTimeout(async function(){ try { await refreshOverdueUI({ beepOnOverdue: true }); } catch (err) {} }, 60);
  }
});

// Optional: regelm√§√üige Pr√ºfung, falls Seite lange offen bleibt (alle 6h)
setInterval(async function(){
  try { await refreshOverdueUI(); } catch(e){}
}, 6 * 60 * 60 * 1000);
})();               // schlie√üt die IIFE
</script>
  
<!-- === Auto-Bef√ºllung f√ºr "Schmierstelle/Aufgabe" aus Wartungspl√§nen === -->
<script>
(function(){
  var byId = function(id){ return document.getElementById(id); };
  var PLACEHOLDER = "Bitte ausw√§hlen";

  function getPlans(){
    var wp = window.wartungsplaene || window.wp || window._wp || window._wpData || window.WARTUNGSPLAENE || null;
    return (wp && typeof wp === "object") ? wp : null;
  }

  function extractTaskNames(list){
    if (!Array.isArray(list)) return [];
    return list.map(function(x){
      if (typeof x === "string") return x;
      if (x && typeof x === "object") return String(x.name || x.aufgabe || x.title || x.task || "").trim();
      return "";
    }).filter(Boolean);
  }

  function rebuildWpTaskSelectFromPlans(){
    var sel = byId("wpTaskSelect");
    var mEl = byId("maschine");
    var machine = (mEl && mEl.value) ? mEl.value : "";
    if (!sel || !machine) return false;

    var plans = getPlans();
    if (!plans) return false;

    var keys = Object.keys(plans);
    var key = keys.find(function(k){ return k === machine; }) ||
              keys.find(function(k){ return k.toLowerCase().trim() === machine.toLowerCase().trim(); });
    if (!key) return false;

    var tasks = extractTaskNames((plans[key] && (plans[key].tasks || plans[key].aufgaben)) || plans[key]);
    if (!tasks.length) return false;

    sel.innerHTML = "";
    sel.add(new Option(PLACEHOLDER, ""));
    tasks.forEach(function(t){ sel.add(new Option(t, t)); });
    sel.value = "";
    return true;
  }

  function ensureNotEmpty(){
    var sel = byId("wpTaskSelect");
    if (!sel) return;
    if (!sel.options || sel.options.length === 0){
      sel.add(new Option(PLACEHOLDER, ""));
      sel.value = "";
    }
  }

  // iPad-safe ohne ?.addEventListener
  window.addEventListener("load", function(){
    // Beim Laden versuchen zu f√ºllen
    if (!rebuildWpTaskSelectFromPlans()) ensureNotEmpty();

    // Beim Maschinenwechsel neu f√ºllen
    var m = byId("maschine");
    if (m && m.addEventListener){
      m.addEventListener("change", function(){
        setTimeout(function(){
          if (!rebuildWpTaskSelectFromPlans()) ensureNotEmpty();
        }, 120);
      });
    }

    // Beim √ñffnen des Dashboards: robust nachf√ºllen (mit Guards + Fallback)
    var tgl = byId("toggleWpLogBtn");
    if (tgl && tgl.addEventListener){
      tgl.addEventListener("click", function(){
        setTimeout(function(){
          var sel = byId("wpTaskSelect");
          if (!sel) return;

          if (typeof window.takeSnapshotForMachine === "function") window.takeSnapshotForMachine(sel);
          if (typeof window.restoreOptionsIfEmpty  === "function") window.restoreOptionsIfEmpty(sel);
          if (typeof window.ensurePlaceholder      === "function") window.ensurePlaceholder(sel);

          // Falls noch leer: aus Pl√§nen bef√ºllen
          if ((!sel.options || sel.options.length === 0) &&
              typeof rebuildWpTaskSelectFromPlans === "function") {
            if (!rebuildWpTaskSelectFromPlans() && typeof ensureNotEmpty === "function") ensureNotEmpty();
          }
        }, 150);
      });
    }
  });
})();
</script>



  <script>
/* ===== Wartungs-Init beim Seitenstart (iPad-safe) ===== */
(function(){
  function safe(fn){ try{ fn && fn(); }catch(e){} }

  // 1) Log aus Storage in den RAM laden ‚Äì async-Variante NICHT hier aufrufen
  if (!Array.isArray(window.wartungslog)) {
    window.wartungslog = [];
  }


  // 2) Alte/neue Feldnamen mappen (falls Funktion vorhanden)
  safe(function(){ if (typeof wpLogLoad === "function") wpLogLoad(); });

  // 3) Dashboard-Tabelle rendern, wenn das Element existiert
  safe(function(){
    if (document.getElementById("wpLogBody") && typeof loadWpLog === "function") {
      loadWpLog();
    }
  });

  // 4) Overdue-Badge/Banner aktualisieren (falls vorhanden)
  safe(function(){ if (typeof wpRefreshOverdueUI === "function") wpRefreshOverdueUI(); });
})();
</script>
  <script>
  // Kompatibilit√§t zu √§lteren Aufrufen
  window.wpLoad = window.wpLoad || function(){
    try {
      if (typeof wpLogLoad === "function") wpLogLoad();
    } catch(e){}
  };

  window.wpSave = window.wpSave || function(entry){
    try {
      if (typeof wpLogExecution === "function") wpLogExecution(entry);
    } catch(e){}
  };
  </script>
<script>
// Wartungs-Daten beim Seitenstart global bereitstellen
window.addEventListener("load", async function () {
  try {
    if (typeof _loadAll === "function") {
      const data = await _loadAll();                    // aus Cloud oder localStorage
      window.wartungslog = Array.isArray(data) ? data.slice() : [];
      console.log("[WP] wartungslog beim Start gesetzt:", window.wartungslog);
    } else {
      console.warn("[WP] _loadAll ist nicht definiert ‚Äì kann wartungslog nicht initialisieren.");
    }
  } catch (e) {
    console.warn("[WP] Fehler beim Initialisieren von wartungslog:", e);
    window.wartungslog = [];
  }
});
</script>

<!-- üì∑ Bilder-Popup -->
<div id="imageModal" class="no-print"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
            z-index:99999;align-items:center;justify-content:center;flex-direction:column;">

  <button onclick="closeImageModal()"
          style="position:absolute;top:20px;right:20px;
                 font-size:26px;background:#fff;border:0;border-radius:8px;
                 padding:6px 14px;cursor:pointer;">
    ‚úñ
  </button>

  <div id="imageModalContent"
       style="max-width:95%;max-height:90%;display:flex;
              gap:20px;flex-wrap:wrap;justify-content:center;">
  </div>
</div>
<script>
// √∂ffnet das Bilder-Fenster
function openImageModal(images){
  const modal = document.getElementById("imageModal");
  const box   = document.getElementById("imageModalContent");

  // Container konfigurieren: vertikal, mit Scroll
  box.innerHTML = "";
  box.style.display = "block";
  box.style.overflowY = "auto";
  box.style.maxHeight = "90vh";
  box.style.padding = "10px";

  if (!images || !images.length){
    box.innerHTML = "<p style='color:white;font-size:20px;text-align:center;'>Keine Bilder vorhanden</p>";
  } else {
    images.forEach((img, index) => {
      const wrap = document.createElement("div");
      wrap.style.textAlign = "center";
      wrap.style.color = "white";
      wrap.style.marginBottom = "20px";

      const title = document.createElement("div");
      title.textContent = (img.title || "") + (images.length > 1 ? ` (${index+1}/${images.length})` : "");
      title.style.marginBottom = "6px";
      title.style.fontSize = "18px";
      title.style.fontWeight = "bold";

      const image = document.createElement("img");
      image.src = img.src;
      image.style.maxWidth = "90%";
      image.style.maxHeight = "70vh";
      image.style.borderRadius = "10px";
      image.style.boxShadow = "0 0 10px black";
      image.style.display = "block";
      image.style.margin = "0 auto";

      wrap.appendChild(title);
      wrap.appendChild(image);
      box.appendChild(wrap);
    });
  }

  modal.style.display = "flex";
}


// schlie√üt das Bilder-Fenster
function closeImageModal(){
  document.getElementById("imageModal").style.display = "none";
}

// sorgt f√ºr den "üì∑ Bilder anzeigen"-Button
function wpSyncImageButton(task){
  var panel = document.getElementById("wartungsplanPanel");
  if (!panel) return;

  // alten Button entfernen
  var old = document.getElementById("wpImageBtn");
  if (old) old.remove();

  // kein Task oder keine Bilder ‚Üí kein Button
  if (!task || !task.images || !task.images.length) return;

  var btn = document.createElement("button");
  btn.id = "wpImageBtn";
  btn.type = "button";
  btn.textContent = "üì∑ Bilder anzeigen";
  btn.className = "no-print";
  btn.style.marginTop = "10px";
  btn.style.padding = "8px 12px";
  btn.style.borderRadius = "8px";
  btn.style.border = "0";
  btn.style.cursor = "pointer";
  btn.style.background = "#0d6efd";
  btn.style.color = "white";

  btn.addEventListener("click", function(){
    openImageModal(task.images);
  });

  panel.appendChild(btn);
}
</script>



</body>
</html>
